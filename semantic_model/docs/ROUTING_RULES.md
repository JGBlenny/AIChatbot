# 對話智能分流規則

## 🚦 三種處理流程

### 1️⃣ 快速通道（向量檢索）- 50ms
**適用對話類型：**
```
✅ 客服電話多少
✅ 營業時間
✅ 地址在哪裡
✅ 押金是多少
✅ 繳費日期
✅ 逾期會怎樣
```
**特徵：** 簡單、直接、答案固定

### 2️⃣ 精準通道（語義模型）- 500ms
**適用對話類型：**
```
🎯 電費帳單寄送區間     → 需觸發表單 ID 1296
🎯 我要報修            → 需觸發報修表單
🎯 申請退租            → 需觸發退租流程
🎯 申請停車位          → 需觸發申請表單
🎯 查詢電費寄送時間     → 需精確匹配
```
**特徵：** 需要觸發表單、需要高準確度、涉及流程

### 3️⃣ 平衡通道（兩階段）- 300ms
**適用對話類型：**
```
🔄 為什麼電費這麼貴
🔄 如何降低電費
🔄 租屋規定有哪些
🔄 可以養寵物嗎
🔄 退租流程是什麼
```
**特徵：** 複雜問題、需要理解但不觸發表單

## 📋 完整分流規則表

| 用戶查詢範例 | 流程選擇 | 原因 | 延遲 |
|------------|---------|------|------|
| **基本資訊類** | | | |
| 客服電話 | 向量檢索 | 答案固定 | 50ms |
| 營業時間 | 向量檢索 | 答案固定 | 50ms |
| 公司地址 | 向量檢索 | 答案固定 | 50ms |
| **費用查詢類** | | | |
| 租金多少 | 向量檢索 | 簡單查詢 | 50ms |
| 押金規定 | 向量檢索 | 簡單查詢 | 50ms |
| 管理費包含什麼 | 兩階段 | 需要詳細說明 | 300ms |
| 電費怎麼算 | 兩階段 | 複雜計算 | 300ms |
| **表單觸發類** | | | |
| 電費帳單寄送區間 | 語義模型 | 需觸發表單 1296 | 500ms |
| 電費寄送時間查詢 | 語義模型 | 需觸發表單 1296 | 500ms |
| 我要報修 | 語義模型 | 需觸發報修表單 | 500ms |
| 冷氣壞了 | 語義模型 | 需觸發報修表單 | 500ms |
| 申請退租 | 語義模型 | 需觸發退租流程 | 500ms |
| 申請停車位 | 語義模型 | 需觸發申請表單 | 500ms |
| **流程說明類** | | | |
| 如何入住 | 兩階段 | 多步驟流程 | 300ms |
| 退租流程 | 兩階段 | 多步驟流程 | 300ms |
| 如何繳費 | 兩階段 | 多種方式 | 300ms |
| **規定詢問類** | | | |
| 可以養寵物嗎 | 兩階段 | 需要詳細條件 | 300ms |
| 可以轉租嗎 | 兩階段 | 需要詳細條件 | 300ms |
| 租約期限 | 向量檢索 | 答案明確 | 50ms |
| **問題解釋類** | | | |
| 為什麼電費這麼貴 | 兩階段 | 需要分析 | 300ms |
| 為什麼要收管理費 | 兩階段 | 需要解釋 | 300ms |
| **緊急情況** | | | |
| 停電了 | 語義模型 | 可能需要報修 | 500ms |
| 漏水了 | 語義模型 | 需要緊急處理 | 500ms |
| **問候/閒聊** | | | |
| 你好 | 直接回應 | 不需檢索 | 10ms |
| 謝謝 | 直接回應 | 不需檢索 | 10ms |

## 🔧 實作程式碼

```python
class DialogueRouter:
    """對話分流器"""

    # 需要語義模型的關鍵字組合
    SEMANTIC_TRIGGERS = [
        ["電費", "帳單", "寄送"],    # 電費帳單相關
        ["電費", "區間"],            # 電費區間查詢
        ["報修"],                   # 報修相關
        ["申請", "退租"],            # 退租申請
        ["申請", "停車"],            # 停車位申請
        ["冷氣", "壞"],             # 設備故障
        ["漏水"],                   # 緊急情況
        ["停電"]                    # 緊急情況
    ]

    # 簡單查詢模式
    SIMPLE_PATTERNS = [
        "電話", "地址", "營業時間",
        "押金", "租金", "繳費日期"
    ]

    # 複雜查詢指標
    COMPLEX_INDICATORS = [
        "為什麼", "如何", "怎麼",
        "流程", "規定", "可以嗎"
    ]

    def route(self, query: str) -> str:
        """決定查詢路由"""

        # 1. 檢查是否需要語義模型（最高優先級）
        for triggers in self.SEMANTIC_TRIGGERS:
            if all(word in query for word in triggers):
                return "semantic_model"  # 500ms

        # 2. 檢查是否為簡單查詢
        if any(pattern in query for pattern in self.SIMPLE_PATTERNS):
            return "vector_search"  # 50ms

        # 3. 檢查是否為複雜查詢
        if any(indicator in query for indicator in self.COMPLEX_INDICATORS):
            return "two_stage"  # 300ms

        # 4. 預設使用向量檢索
        return "vector_search"  # 50ms
```

## 📊 效益分析

### 全部使用語義模型 vs 智能分流

| 指標 | 全語義模型 | 智能分流 | 改善 |
|-----|----------|---------|-----|
| 平均延遲 | 500ms | 191ms | **-62%** |
| 高峰期QPS | 2 | 5 | **+150%** |
| 伺服器成本 | $1000/月 | $400/月 | **-60%** |
| 準確度 | 95% | 92% | -3% |

### 建議配置
```yaml
# 80% 查詢走快速通道（向量）
# 15% 查詢走精準通道（語義）
# 5% 查詢走平衡通道（兩階段）

預期結果：
- 整體延遲降低 60%
- 成本降低 60%
- 準確度保持 92%+
- 表單觸發準確度 95%+
```

## 🎯 關鍵決策點

1. **表單觸發類必須用語義模型**
   - 錯誤的表單會造成用戶體驗問題
   - 500ms 延遲可接受

2. **簡單FAQ可用向量檢索**
   - 答案固定，不需要深度理解
   - 50ms 快速返回

3. **複雜問題用兩階段**
   - 平衡速度與準確度
   - 300ms 合理延遲

## 💡 優化建議

1. **熱門查詢快取**
   ```python
   # Redis 快取前 100 個熱門查詢
   if query in cache:
       return cache[query]  # <10ms
   ```

2. **異步預載**
   ```python
   # 用戶輸入時預載可能的結果
   async def on_user_typing(partial_query):
       preload_candidates(partial_query)
   ```

3. **動態調整閾值**
   ```python
   # 根據系統負載動態調整
   if system_load > 0.8:
       use_more_vector_search()  # 降級保護
   else:
       use_more_semantic_model()  # 提高準確度
   ```