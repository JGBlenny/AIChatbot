# 對話分流決策樹

## 🌳 分流決策邏輯（由上到下判斷）

```
用戶查詢進來
    ↓
第1關：是否需要觸發表單？
    ↓
[判斷條件]
• 電費 + 帳單/寄送 → 是（表單1296）
• 報修/故障/壞了 → 是（報修表單）
• 申請 + 退租 → 是（退租表單）
• 申請 + 停車 → 是（停車表單）
    ↓
  是 → 【語義模型】500ms ✅
  否 → 繼續判斷↓

第2關：是簡單查詢嗎？
    ↓
[判斷條件]
• 包含：電話/地址/時間/多少錢
• 且長度 < 10 字
    ↓
  是 → 【向量檢索】50ms ⚡
  否 → 繼續判斷↓

第3關：是複雜問題嗎？
    ↓
[判斷條件]
• 包含：為什麼/怎麼/如何/流程
    ↓
  是 → 【兩階段】300ms ⚖️
  否 → 【向量檢索】50ms（預設）
```

## 🎯 實際範例對照

| 用戶說 | 第1關 | 第2關 | 第3關 | 最終路由 |
|--------|------|------|------|---------|
| **電費帳單寄送區間** | ✅ 需要表單1296 | - | - | 語義模型 |
| **我要報修** | ✅ 需要報修表單 | - | - | 語義模型 |
| **客服電話多少** | ❌ | ✅ 簡單查詢 | - | 向量檢索 |
| **營業時間** | ❌ | ✅ 簡單查詢 | - | 向量檢索 |
| **為什麼電費這麼貴** | ❌ | ❌ | ✅ 複雜問題 | 兩階段 |
| **如何申請退租流程** | ✅ 需要退租表單 | - | - | 語義模型 |
| **可以養寵物嗎** | ❌ | ❌ | ❌ | 向量檢索 |

## 🔍 判斷細節

### 需要表單的關鍵字組合：
```python
if ("電費" in query and "帳單" in query) or \
   ("電費" in query and "寄送" in query):
    return "語義模型"  # 需要表單1296

if "報修" in query or \
   ("壞" in query and any(設備 in query for 設備 in ["冷氣","電燈","水龍頭"])):
    return "語義模型"  # 需要報修表單

if "申請" in query and "退租" in query:
    return "語義模型"  # 需要退租表單
```

### 簡單查詢特徵：
```python
simple_words = ["電話", "地址", "時間", "多少", "幾號"]
if any(word in query for word in simple_words) and len(query) < 10:
    return "向量檢索"  # 快速返回
```

### 複雜查詢特徵：
```python
complex_words = ["為什麼", "怎麼", "如何", "流程", "步驟"]
if any(word in query for word in complex_words):
    return "兩階段"  # 需要理解
```

## 📊 分流比例預估

根據一般客服對話統計：

```
向量檢索（50ms）：70% 查詢
├─ 簡單FAQ：40%（電話、地址、時間）
├─ 一般查詢：20%（租金、押金）
└─ 其他：10%

語義模型（500ms）：20% 查詢
├─ 報修類：8%
├─ 電費查詢：5%
├─ 申請類：5%
└─ 其他表單：2%

兩階段（300ms）：10% 查詢
├─ 解釋類：5%（為什麼）
└─ 流程類：5%（如何、步驟）
```

## 💡 核心原則

1. **表單優先** - 寧可慢一點，也不能觸發錯誤表單
2. **簡單快速** - 能用向量就不用語義
3. **按需升級** - 複雜問題才用兩階段

這樣整體平均延遲：
- 70% × 50ms + 20% × 500ms + 10% × 300ms = **165ms**
- 比全部用語義模型（500ms）快 **70%**！