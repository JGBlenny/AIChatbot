# 效能測試腳本

此目錄包含系統效能測試腳本。

---

## 📁 測試腳本

### `test_chat_performance.py`

完整的對話流程效能測試腳本。

#### 功能
- 測試 4 個類別共 18 個問題
- 每個問題重複 3 次測試
- 測量端到端響應時間
- 生成詳細效能報告

#### 測試類別

1. **高信心度問題** (5個)
   - 「租金每個月幾號要繳？」
   - 「我想養寵物可以嗎？」
   - 「退租需要提前多久告知？」
   - 「房租包含哪些費用？」
   - 「租約到期如何續約？」

2. **中等信心度問題** (5個)
   - 「電費是怎麼算的？」
   - 「冷氣壞了怎麼辦？」
   - 「可以提前解約嗎？」
   - 「房間可以釘釘子嗎？」
   - 「停車位怎麼收費？」

3. **低信心度問題** (5個)
   - 「附近有什麼好吃的餐廳？」
   - 「這個社區安全嗎？」
   - 「我的鄰居很吵怎麼辦？」
   - 「今天天氣如何？」
   - 「你能幫我訂披薩嗎？」

4. **複雜問題** (3個)
   - 「我的租金明細是什麼？」
   - 「幫我查詢我的繳費記錄」
   - 「我的合約什麼時候到期？」

#### 使用方式

```bash
# 基本執行
python3 tests/performance/test_chat_performance.py

# 輸出會包含：
# - 實時進度顯示
# - 即時結果反饋
# - 最終統計報告
# - JSON 詳細數據（保存至 /tmp/）
```

#### 輸出示例

```
================================================================================
RAG 對話流程完整效能測試
================================================================================
測試時間: 2025-10-21 16:27:55
API 端點: http://localhost:8100
業者 ID: 1
每個問題重複次數: 3
================================================================================

📂 測試類別: HIGH_CONFIDENCE
--------------------------------------------------------------------------------

[1/18] 測試問題: 租金每個月幾號要繳？
   平均時間: 6310.19 ms
   範圍: 4995.32 - 8569.59 ms
   信心度: 0.59 (medium)
   意圖類型: data_query
   檢索文檔數: 2
   需要人工: 是
...
```

#### 配置參數

在腳本中可修改的配置：

```python
# API 配置
RAG_API_BASE = "http://localhost:8100"
VENDOR_ID = 1

# 測試參數
repeat_per_question = 3  # 每個問題重複次數
```

#### 輸出文件

測試完成後會生成：

1. **JSON 詳細報告**
   - 路徑: `/tmp/chat_performance_report_YYYYMMDD_HHMMSS.json`
   - 包含所有原始數據和統計分析

2. **控制台報告**
   - 全局統計
   - 各類別分析
   - 信心度分布
   - 慢查詢識別
   - 效能評級

---

## 🔧 自定義測試

### 添加新測試問題

編輯 `TEST_QUESTIONS` 字典：

```python
TEST_QUESTIONS = {
    "custom_category": [
        "自定義問題 1",
        "自定義問題 2",
        # ...
    ]
}
```

### 修改重複次數

```python
await tester.run_tests(repeat_per_question=5)  # 改為 5 次
```

### 測試特定類別

```python
# 只測試高信心度問題
for category in ["high_confidence"]:
    for question in TEST_QUESTIONS[category]:
        # ...
```

---

## 📊 效能基準

### 當前基準 (2025-10-21)

| 類別 | 平均時間 | 成功率 |
|------|---------|--------|
| 高信心度 | 4,522 ms | 100% |
| 中等信心度 | 1,899 ms | 80% |
| 低信心度 | 2,728 ms | 80% |
| 複雜問題 | 2,436 ms | 100% |
| **全局** | **2,948 ms** | **88.9%** |

### 目標基準

| 類別 | 目標時間 | 目標成功率 |
|------|---------|-----------|
| 所有類別 | < 1,000 ms | 99.9% |

---

## 🐛 常見問題

### Q: 測試失敗怎麼辦？

**A**: 檢查以下項目：
1. 確認所有服務運行：`docker-compose ps`
2. 檢查 API 健康：`curl http://localhost:8100/health`
3. 查看錯誤日誌：`docker logs aichatbot-rag-orchestrator`

### Q: 為什麼有些問題會 500 錯誤？

**A**: 可能原因：
- 後端處理異常（需查看日誌）
- 資料庫連接問題
- LLM API 失敗

### Q: 如何提高測試速度？

**A**:
1. 減少重複次數：`repeat_per_question=1`
2. 減少測試問題數量
3. 移除 `asyncio.sleep(0.5)` 延遲

---

## 📝 貢獻指南

### 添加新測試類型

1. 在 `TEST_QUESTIONS` 中添加新類別
2. 更新報告生成邏輯
3. 添加相應的文檔說明

### 改進報告格式

編輯 `PerformanceTester.print_report()` 方法。

---

**最後更新**: 2025-10-21
