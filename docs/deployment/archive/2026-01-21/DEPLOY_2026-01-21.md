# 🚀 2026-01-21 生產環境部署指南

**部署日期**：2026-01-21
**預計停機時間**：< 10 分鐘
**Git Commit**：193bcfa
**部署優先級**：⚠️ **Critical P0**（修復 API 整合功能）

---

## 📌 本次更新概述

本次更新包含 **Critical 優先級的 API 整合修復**和多項重要功能增強：

1. ✅ **Knowledge Admin API 整合修復**（Critical P0）
2. ✅ **API Endpoints 動態管理功能**
3. ✅ **表單系統增強**
4. ✅ **文檔結構優化**
5. ⚠️ **5 個資料庫遷移**

**統計**：
- 56 個文件變更
- +21,135 行新增
- -82 行刪除

---

## 🔥 Critical 修復：Knowledge Admin API 整合

### 問題描述

Knowledge Admin 後端 API 缺少 `action_type` 和 `api_config` 欄位支援，導致：

❌ **前端傳送的 API 關聯設定無法保存到資料庫**
❌ **編輯知識時無法顯示現有的 API 關聯設定**
❌ **API 整合功能完全無法透過 UI 操作**

### 修復內容

#### 後端修復（knowledge-admin/backend/app.py）

1. **Pydantic 模型**：加入 `action_type` 和 `api_config` 欄位
2. **INSERT 語句**：插入時保存這兩個欄位
3. **UPDATE 語句**：更新時修改這兩個欄位
4. **GET 端點**：查詢和列表返回這兩個欄位
5. **Import**：加入 `from psycopg2.extras import Json`

**修改位置**：
- Line 10: Import 加入 `Json`
- Line 95-96: Pydantic 模型加入兩個欄位
- Line 268-269: GET 單一知識加入欄位
- Line 161-163: GET 列表加入欄位
- Line 513, 525-526: INSERT 加入欄位
- Line 374-375, 388-389: UPDATE 加入欄位

#### 前端修復（knowledge-admin/frontend/src/views/KnowledgeView.vue）

統一使用 `endpoint` 欄位（移除 `endpoint_id` 兼容邏輯）：
- Line 771: 構建時使用 `endpoint`
- Line 1049: 保存時使用 `endpoint`
- Line 962: 載入時讀取 `endpoint`

### 修復後效果

✅ 可透過前端 UI 新增帶有 API 關聯的知識
✅ 可編輯和修改現有的 API 關聯
✅ 編輯時正確顯示現有的關聯類型
✅ 完整的 CRUD 生命週期支援
✅ 對話流程可正確觸發 API 調用

---

## 🆕 新功能：API Endpoints 動態管理

### 功能說明

新增完整的 API Endpoints 管理系統，允許透過 UI 動態配置 API 端點，無需修改代碼。

### 新增文件

1. **前端 UI**：`knowledge-admin/frontend/src/views/ApiEndpointsView.vue`
   - API 端點列表
   - 新增/編輯/刪除端點
   - 測試 API 連接

2. **後端路由**：`rag-orchestrator/routers/api_endpoints.py`
   - GET /api/api-endpoints - 列出所有端點
   - POST /api/api-endpoints - 新增端點
   - PUT /api/api-endpoints/{id} - 更新端點
   - DELETE /api/api-endpoints/{id} - 刪除端點

3. **通用處理器**：`rag-orchestrator/services/universal_api_handler.py`
   - 動態調用 API 端點
   - 參數處理和驗證
   - 錯誤處理

4. **帳單 API 服務**：`rag-orchestrator/services/billing_api.py`
   - 帳單查詢 API 實現

---

## 🔧 表單系統增強

### 主要改進

1. **form_manager.py**：
   - 增強表單處理邏輯
   - 改進表單欄位驗證
   - 優化表單流程控制

2. **chat.py**：
   - 優化對話流程，支援 API 調用整合
   - 改進表單觸發邏輯（+192 行）
   - 增強錯誤處理

3. **forms.py**：
   - 改進表單路由處理
   - 增加表單狀態管理

---

## 📚 文檔重組

### 重組內容

1. **創建新目錄**：
   - `docs/api/` - API 相關文檔
   - `docs/frontend/` - 前端相關文檔

2. **移動文件**：
   - 11 個文件重新歸檔
   - 1 個臨時文件移除
   - 更新 `docs/INDEX.md` 所有鏈接

3. **新增文檔**：
   - 3 份 API 整合修復報告
   - 1 份文檔重組報告

**詳見**：`docs/DOCS_REORGANIZATION_REPORT_2026-01-21.md`

---

## 💾 資料庫遷移

### 必須執行的遷移（5 個）

| 遷移文件 | 說明 | 優先級 |
|---------|------|--------|
| `add_action_type_and_api_config.sql` | 新增知識庫動作類型和 API 配置欄位 | **Critical** |
| `create_api_endpoints_table.sql` | 創建 API 端點管理表 | **High** |
| `upgrade_api_endpoints_dynamic.sql` | 升級為動態 API 管理 | High |
| `configure_billing_inquiry_examples.sql` | 配置帳單查詢範例數據 | Medium |
| `remove_handler_function_column.sql` | 移除已棄用的 handler_function 欄位 | Low |

---

## ⚠️ 部署前檢查

- [ ] 已閱讀本部署指南
- [ ] 確認生產服務器有足夠磁碟空間（至少 3GB）
- [ ] 確認有資料庫備份權限
- [ ] 確認可以短暫停機（< 10 分鐘）
- [ ] 已通知相關人員
- [ ] 確認已測試 API 整合功能（測試環境）

---

## 📋 部署步驟

### 步驟 1：部署前檢查

```bash
cd /path/to/AIChatbot

# 檢查當前狀態
git status
git log --oneline -3

# 檢查服務狀態
docker-compose -f docker-compose.prod.yml ps
```

**確認**：
- [ ] 當前在 main 分支
- [ ] 工作目錄乾淨
- [ ] 所有服務運行正常

---

### 步驟 2：備份資料庫（Critical！）

```bash
# 備份主資料庫
docker-compose -f docker-compose.prod.yml exec -T postgres \
  pg_dump -U aichatbot aichatbot_admin > backup_2026-01-21_$(date +%H%M%S).sql

# 確認備份成功
ls -lh backup_*.sql | tail -1
```

**預期**：備份文件大小 > 1MB

---

### 步驟 3：拉取最新代碼

```bash
# 拉取代碼
git pull origin main

# 確認拉取到正確的 commit
git log --oneline -3
```

**預期看到**：
```
193bcfa feat: Knowledge Admin API 整合修復與文檔重組
e8f735d docs: 重構文件目錄結構，消除重複並建立完整索引
5501929 fix: 移除 rag-orchestrator 所有對 form_intro 的引用
```

---

### 步驟 4：執行資料庫遷移

#### 4.1 Critical 遷移：action_type 和 api_config

```bash
cat database/migrations/add_action_type_and_api_config.sql | \
  docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin
```

**驗證**：
```bash
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c \
  "SELECT column_name, data_type, column_default
   FROM information_schema.columns
   WHERE table_name='knowledge_base'
   AND column_name IN ('action_type', 'api_config');"
```

**預期輸出**：
```
   column_name   |   data_type   |    column_default
-----------------+---------------+---------------------
 action_type     | character varying | 'direct_answer'::character varying
 api_config      | jsonb         |
```

#### 4.2 創建 API Endpoints 表

```bash
cat database/migrations/create_api_endpoints_table.sql | \
  docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin
```

**驗證**：
```bash
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c \
  "SELECT table_name FROM information_schema.tables
   WHERE table_schema='public' AND table_name='api_endpoints';"
```

**預期輸出**：`api_endpoints`

#### 4.3 升級 API Endpoints（動態管理）

```bash
cat database/migrations/upgrade_api_endpoints_dynamic.sql | \
  docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin
```

#### 4.4 配置帳單查詢範例

```bash
cat database/migrations/configure_billing_inquiry_examples.sql | \
  docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin
```

#### 4.5 移除已棄用欄位

```bash
cat database/migrations/remove_handler_function_column.sql | \
  docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin
```

---

### 步驟 5：重建並部署後端

#### 5.1 停止服務

```bash
docker-compose -f docker-compose.prod.yml stop rag-orchestrator knowledge-admin-api
```

#### 5.2 重建鏡像

```bash
# 重建 rag-orchestrator（主要變更）
docker-compose -f docker-compose.prod.yml build --no-cache rag-orchestrator

# 重建 knowledge-admin-api（Critical 修復）
docker-compose -f docker-compose.prod.yml build --no-cache knowledge-admin-api
```

#### 5.3 啟動服務

```bash
docker-compose -f docker-compose.prod.yml up -d rag-orchestrator knowledge-admin-api

# 等待啟動
sleep 15
```

---

### 步驟 6：部署前端

#### 6.1 重新構建前端

```bash
# 進入前端目錄
cd knowledge-admin/frontend

# 安裝依賴（package.json 有變更）
npm install

# 編譯前端
npm run build

# 返回根目錄
cd ../..
```

#### 6.2 重啟前端服務

```bash
# 方法 1：重新載入 nginx
docker exec aichatbot-knowledge-admin-web nginx -s reload

# 方法 2：重啟容器（如果方法 1 不成功）
docker-compose -f docker-compose.prod.yml restart knowledge-admin-web
```

---

### 步驟 7：驗證部署

#### 7.1 檢查服務狀態

```bash
# 檢查容器狀態
docker-compose -f docker-compose.prod.yml ps

# 預期：所有服務都是 Up
```

#### 7.2 健康檢查

```bash
# 後端健康檢查
curl -s http://localhost:8100/health
# 預期：{"status":"ok"}

# Knowledge Admin API 健康檢查
curl -s http://localhost:8000/health
# 預期：{"status":"ok"}

# 前端健康檢查
curl -s -o /dev/null -w "%{http_code}" http://localhost:8087
# 預期：200
```

#### 7.3 檢查日誌

```bash
# rag-orchestrator 日誌
docker-compose -f docker-compose.prod.yml logs --tail 100 rag-orchestrator | grep -i error

# knowledge-admin-api 日誌
docker-compose -f docker-compose.prod.yml logs --tail 100 knowledge-admin-api | grep -i error

# 前端日誌
docker-compose -f docker-compose.prod.yml logs --tail 50 knowledge-admin-web
```

**確認**：
- [ ] 沒有 ERROR 級別日誌
- [ ] 沒有服務啟動失敗
- [ ] 路由註冊成功

---

### 步驟 8：功能測試

#### 8.1 測試 API 整合修復（Critical！）

1. **登入 Knowledge Admin**：`http://your-server:8087`

2. **測試新增知識 + API 關聯**：
   - 進入「知識管理」
   - 點擊「新增知識」
   - 填寫知識內容
   - **關聯功能**：選擇「API」
   - **API 端點**：選擇「查詢帳單」
   - 點擊「儲存」

3. **驗證保存成功**：
   ```bash
   docker-compose -f docker-compose.prod.yml exec -T postgres \
     psql -U aichatbot -d aichatbot_admin -c \
     "SELECT id, question_summary, action_type, jsonb_pretty(api_config)
      FROM knowledge_base
      ORDER BY id DESC LIMIT 1;"
   ```

   **預期輸出**：
   ```
    id  | question_summary | action_type |        jsonb_pretty
   -----+------------------+-------------+---------------------------
    XXX | 我要查詢帳單     | api_call    | {
        |                  |             |   "endpoint": "billing_inquiry",
        |                  |             |   "params": {},
        |                  |             |   "combine_with_knowledge": true
        |                  |             | }
   ```

4. **測試編輯功能**：
   - 點擊剛才新增的知識「編輯」
   - **確認「關聯功能」顯示「API」**（不是「無」）
   - **確認「API 端點」正確顯示**

5. **測試對話觸發**：
   ```bash
   curl -s -X POST "http://localhost:8100/api/v1/message" \
     -H "Content-Type: application/json" \
     -d '{
       "message": "我要查詢帳單",
       "vendor_id": 1,
       "target_user": "customer",
       "session_id": "test-api-001",
       "user_id": "test-user"
     }' | python3 -m json.tool
   ```

   **預期**：返回帳單查詢結果（如果配置了 Mock API）

#### 8.2 測試 API Endpoints 管理

1. **訪問 API Endpoints 管理頁面**：`http://your-server:8087/api-endpoints`

2. **測試列表功能**：
   - 應該顯示現有的 API 端點列表
   - 包含「查詢帳單」等端點

3. **測試新增端點**：
   - 點擊「新增端點」
   - 填寫端點資訊
   - 測試保存

#### 8.3 測試表單系統

```bash
# 測試表單觸發
curl -s -X POST "http://localhost:8100/api/v1/message" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "我要報修",
    "vendor_id": 2,
    "target_user": "tenant",
    "session_id": "test-form-001",
    "user_id": "test-user"
  }' | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data.get('form_triggered'):
    print('✅ 表單已觸發')
    print('表單 ID:', data.get('form_id'))
else:
    print('❌ 表單未觸發')
"
```

---

## ✅ 部署完成檢查清單

### 代碼部署

- [ ] Git 代碼已拉取到最新（193bcfa）
- [ ] 資料庫備份已完成
- [ ] 5 個 Migration 已全部執行
- [ ] rag-orchestrator 已重建並啟動
- [ ] knowledge-admin-api 已重建並啟動
- [ ] knowledge-admin-web 已重建並啟動

### 健康檢查

- [ ] 所有容器狀態為 Up
- [ ] 後端健康檢查通過
- [ ] 前端健康檢查通過
- [ ] 日誌無嚴重錯誤

### 功能測試

- [ ] ✅ **Critical: 新增知識 + API 關聯測試通過**
- [ ] ✅ **Critical: 編輯知識顯示 API 關聯測試通過**
- [ ] ✅ **Critical: 對話觸發 API 調用測試通過**
- [ ] API Endpoints 管理頁面正常
- [ ] 表單系統功能正常

---

## 🔄 回滾方案（如果出問題）

### 回滾代碼

```bash
# 查看 commit 歷史
git log --oneline -5

# 回滾到部署前的 commit
git checkout e8f735d  # 上一個穩定版本
```

### 回滾資料庫（逆序執行）

```bash
# 1. 恢復 handler_function 欄位
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c \
  "ALTER TABLE api_endpoints ADD COLUMN handler_function VARCHAR(100);"

# 2. 刪除範例數據（如果需要）
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c \
  "DELETE FROM knowledge_base WHERE action_type = 'api_call' AND created_at > '2026-01-21';"

# 3. 降級 api_endpoints 表（如果需要完全回滾）
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c \
  "DROP TABLE IF EXISTS api_endpoints;"

# 4. 刪除 action_type 和 api_config 欄位
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c \
  "ALTER TABLE knowledge_base DROP COLUMN IF EXISTS action_type, DROP COLUMN IF EXISTS api_config;"
```

### 重建並重啟服務

```bash
# 重建後端
docker-compose -f docker-compose.prod.yml build --no-cache rag-orchestrator knowledge-admin-api
docker-compose -f docker-compose.prod.yml up -d rag-orchestrator knowledge-admin-api

# 重建前端
cd knowledge-admin/frontend
git checkout e8f735d -- .
npm run build
cd ../..
docker exec aichatbot-knowledge-admin-web nginx -s reload
```

---

## 📊 預期改善效果

### API 整合修復

✅ **Critical 問題解決**：完整支援透過 UI 配置知識的 API 關聯
✅ 新增/編輯/查詢知識時，action_type 和 api_config 正確處理
✅ 前端編輯時正確顯示現有的 API 關聯
✅ 對話流程可正確觸發 API 調用

### API Endpoints 管理

✅ 無需修改代碼即可新增/修改 API 端點
✅ 動態配置 API 端點參數
✅ 提升系統靈活性

### 表單系統

✅ 表單處理邏輯更健壯
✅ 表單與 API 調用整合更順暢
✅ 錯誤處理更完善

### 文檔系統

✅ 文檔結構清晰，易於查找
✅ 維護成本降低
✅ 新增完整的 API 整合修復文檔

---

## 🐛 常見問題排查

### Q1: 新增知識時，API 關聯無法保存

**症狀**：前端提交成功，但資料庫 action_type 和 api_config 仍為 NULL

**排查步驟**：

1. 檢查 Migration 是否執行：
   ```bash
   docker-compose -f docker-compose.prod.yml exec -T postgres \
     psql -U aichatbot -d aichatbot_admin -c \
     "\d knowledge_base" | grep -E "(action_type|api_config)"
   ```

2. 檢查後端日誌：
   ```bash
   docker-compose -f docker-compose.prod.yml logs knowledge-admin-api | grep -i "action_type\|api_config"
   ```

3. 檢查 knowledge-admin-api 是否重建：
   ```bash
   docker-compose -f docker-compose.prod.yml ps knowledge-admin-api
   # 檢查 Created 時間是否是今天
   ```

### Q2: 編輯知識時，關聯功能顯示「無」

**症狀**：資料庫有 action_type 和 api_config，但前端顯示「無」

**排查步驟**：

1. 檢查 GET 端點是否返回欄位：
   ```bash
   curl -s http://localhost:8000/api/knowledge/[ID] | python3 -m json.tool | grep -E "(action_type|api_config)"
   ```

2. 檢查前端是否正確讀取：
   - 打開瀏覽器開發者工具
   - Network 標籤查看 API 返回
   - Console 標籤查看錯誤

3. 清除瀏覽器快取（Ctrl+Shift+R）

### Q3: Migration 執行失敗

**症狀**：執行 SQL 時報錯

**常見原因**：

1. **欄位已存在**：
   ```
   ERROR: column "action_type" of relation "knowledge_base" already exists
   ```
   **解決**：正常，Migration 使用 `IF NOT EXISTS`，可忽略

2. **權限不足**：
   ```
   ERROR: must be owner of table knowledge_base
   ```
   **解決**：檢查資料庫用戶權限

3. **資料庫連接失敗**：
   ```
   ERROR: could not connect to server
   ```
   **解決**：檢查 postgres 服務是否運行

### Q4: 服務無法啟動

**檢查日誌**：
```bash
docker-compose -f docker-compose.prod.yml logs --tail 200 rag-orchestrator
docker-compose -f docker-compose.prod.yml logs --tail 200 knowledge-admin-api
```

**常見原因**：
- 端口衝突
- 環境變數缺失
- 依賴服務未啟動
- Python 模組缺失（需要重建鏡像）

---

## 📞 需要支援

如果部署過程遇到問題，請提供：

1. **錯誤訊息或截圖**

2. **服務日誌**：
   ```bash
   docker-compose -f docker-compose.prod.yml logs --tail 500 > logs_2026-01-21.txt
   ```

3. **環境資訊**：
   ```bash
   echo "=== Docker 容器狀態 ===" > env_info.txt
   docker-compose -f docker-compose.prod.yml ps >> env_info.txt

   echo -e "\n=== Git 狀態 ===" >> env_info.txt
   git log --oneline -5 >> env_info.txt
   git status >> env_info.txt

   echo -e "\n=== 資料庫版本 ===" >> env_info.txt
   docker-compose -f docker-compose.prod.yml exec -T postgres \
     psql -U aichatbot -d aichatbot_admin -c "\d knowledge_base" | \
     grep -E "(action_type|api_config)" >> env_info.txt
   ```

4. **測試結果**：
   - 哪些功能測試通過
   - 哪些功能測試失敗
   - 具體錯誤現象

---

## 📝 部署記錄

**執行人員**：_________________

**執行時間**：_________________

**部署狀態**：☐ 成功  ☐ 失敗  ☐ 回滾

### 驗證結果

- [ ] 資料庫遷移：☐ 全部通過  ☐ 部分失敗
- [ ] 服務啟動：☐ 正常  ☐ 異常
- [ ] API 整合測試：☐ 通過  ☐ 失敗
- [ ] API Endpoints 管理：☐ 正常  ☐ 異常
- [ ] 表單系統測試：☐ 通過  ☐ 失敗
- [ ] 日誌檢查：☐ 正常  ☐ 異常

### 備註

```
（記錄任何特殊情況或注意事項）
```

---

## 🔗 相關文檔

### 修復報告

- [API 整合完整修復報告](../../fixes/2026-01-21-api-integration-fix.md)
- [API 整合深度分析](../../fixes/2026-01-21-api-integration-analysis.md)
- [API 整合快速參考](../../fixes/2026-01-21-api-integration-quick-ref.md)

### 測試指南

- [API 整合測試指南](../../testing/api-integration-testing-guide.md)

### 文檔重組

- [文檔重組報告](../../DOCS_REORGANIZATION_REPORT_2026-01-21.md)

### 設計文檔

- [知識動作系統設計](../../design/KNOWLEDGE_ACTION_SYSTEM_DESIGN.md)
- [API 配置指南](../../design/API_CONFIGURATION_GUIDE.md)
- [動態 API 架構](../../design/IMPROVED_API_ARCHITECTURE.md)

---

**最後更新**：2026-01-21
**維護者**：Claude Code
**版本**：1.0

---

**文件結束**
