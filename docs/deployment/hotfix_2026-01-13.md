# ğŸš¨ ç·Šæ€¥ä¿®æ­£ï¼šçŸ¥è­˜ ID 1262 æ„åœ–åˆ†é¡éŒ¯èª¤

## å•é¡Œæè¿°

**ç—‡ç‹€ï¼š** Vendor 2 æŸ¥è©¢ã€Œä½ å¥½ï¼Œæˆ‘è¦çºŒç´„ï¼Œæ–°çš„åˆç´„ç”šéº¼æ™‚å€™æœƒæä¾›?ã€æ‰¾ä¸åˆ°çŸ¥è­˜

**æ ¹æœ¬åŸå› ï¼š** çŸ¥è­˜ ID 1262 è¢«éŒ¯èª¤åˆ†é¡åˆ° intent 105ï¼ˆä¸€èˆ¬çŸ¥è­˜ï¼‰ï¼Œå°è‡´è¢«æ„åœ–éæ¿¾å™¨æ’é™¤

**å½±éŸ¿ç¯„åœï¼š** æ‰€æœ‰çºŒç´„ç›¸é—œæŸ¥è©¢

---

## ğŸ“‹ ä¿®æ­£æ­¥é©Ÿï¼ˆåœ¨ç”Ÿç”¢æœå‹™å™¨åŸ·è¡Œï¼‰

### 1. SSH ç™»å…¥ç”Ÿç”¢æœå‹™å™¨

```bash
ssh user@your-production-server
cd /path/to/AIChatbot
```

### 2. å‚™ä»½ç•¶å‰è³‡æ–™ï¼ˆä¿éšªèµ·è¦‹ï¼‰

```bash
# å‚™ä»½ knowledge_intent_mapping è¡¨
docker-compose -f docker-compose.prod.yml exec -T postgres \
  pg_dump -U aichatbot -d aichatbot_admin -t knowledge_intent_mapping \
  > backup_intent_mapping_$(date +%Y%m%d_%H%M%S).sql

# ç¢ºèªå‚™ä»½
ls -lh backup_intent_mapping_*.sql
```

### 3. æª¢æŸ¥ç•¶å‰éŒ¯èª¤ç‹€æ…‹

```bash
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "
SELECT
    kb.id,
    kb.question_summary,
    kim.intent_id,
    i.name as intent_name
FROM knowledge_base kb
LEFT JOIN knowledge_intent_mapping kim ON kb.id = kim.knowledge_id
LEFT JOIN intents i ON kim.intent_id = i.id
WHERE kb.id = 1262;
"
```

**é æœŸè¼¸å‡ºï¼ˆéŒ¯èª¤ç‹€æ…‹ï¼‰ï¼š**
```
  id  | question_summary | intent_id | intent_name
------+------------------+-----------+-------------
 1262 | ä½ å¥½ï¼Œæˆ‘è¦çºŒç´„... |       105 | ä¸€èˆ¬çŸ¥è­˜      âŒ
```

### 4. åŸ·è¡Œä¿®æ­£ï¼ˆä½¿ç”¨ SQL è…³æœ¬ï¼‰

**æ–¹æ³• Aï¼šç›´æ¥åŸ·è¡Œ SQL å‘½ä»¤**

```bash
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin << 'EOF'
-- åˆªé™¤éŒ¯èª¤çš„æ˜ å°„
DELETE FROM knowledge_intent_mapping WHERE knowledge_id = 1262;

-- æ·»åŠ æ­£ç¢ºçš„æ˜ å°„ï¼ˆintent 10 = ç§ŸæœŸï¼åˆ°æœŸï¼‰
INSERT INTO knowledge_intent_mapping (knowledge_id, intent_id, intent_type, confidence)
VALUES (1262, 10, 'primary', 1.0);

-- é©—è­‰
SELECT
    kb.id,
    kb.question_summary,
    kim.intent_id,
    i.name as intent_name
FROM knowledge_base kb
LEFT JOIN knowledge_intent_mapping kim ON kb.id = kim.knowledge_id
LEFT JOIN intents i ON kim.intent_id = i.id
WHERE kb.id = 1262;
EOF
```

**æ–¹æ³• Bï¼šä½¿ç”¨ SQL æ–‡ä»¶ï¼ˆå¦‚æœå·²ä¸Šå‚³ï¼‰**

```bash
# å…ˆä¸Šå‚³ HOTFIX_knowledge_1262_classification.sql åˆ°æœå‹™å™¨
# ç„¶å¾ŒåŸ·è¡Œï¼š
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin < HOTFIX_knowledge_1262_classification.sql
```

**é æœŸè¼¸å‡ºï¼ˆæ­£ç¢ºç‹€æ…‹ï¼‰ï¼š**
```
DELETE 1
INSERT 0 1

  id  | question_summary | intent_id | intent_name
------+------------------+-----------+---------------
 1262 | ä½ å¥½ï¼Œæˆ‘è¦çºŒç´„... |        10 | ç§ŸæœŸï¼åˆ°æœŸ    âœ…
```

### 5. é‡å•Ÿ rag-orchestrator æœå‹™

```bash
# é‡å•Ÿæœå‹™ä»¥é‡æ–°è¼‰å…¥æ„åœ–æ˜ å°„
docker-compose -f docker-compose.prod.yml restart rag-orchestrator

# ç­‰å¾…æœå‹™å•Ÿå‹•
sleep 10

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker-compose -f docker-compose.prod.yml ps rag-orchestrator
```

**é æœŸè¼¸å‡ºï¼š** ç‹€æ…‹æ‡‰è©²æ˜¯ `Up`

---

## âœ… é©—è­‰ä¿®æ­£

### æ¸¬è©¦ 1ï¼šæª¢æŸ¥è³‡æ–™åº«

```bash
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "
SELECT
    kb.id,
    kb.question_summary,
    kim.intent_id,
    i.name as intent_name,
    kim.intent_type
FROM knowledge_base kb
LEFT JOIN knowledge_intent_mapping kim ON kb.id = kim.knowledge_id
LEFT JOIN intents i ON kim.intent_id = i.id
WHERE kb.id = 1262;
"
```

**é æœŸï¼š** intent_id = 10ï¼ˆç§ŸæœŸï¼åˆ°æœŸï¼‰

### æ¸¬è©¦ 2ï¼šAPI æ¸¬è©¦

```bash
curl -s -X POST "http://localhost:8100/api/v1/message" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä½ å¥½ï¼Œæˆ‘è¦çºŒç´„ï¼Œæ–°çš„åˆç´„ç”šéº¼æ™‚å€™æœƒæä¾›?",
    "vendor_id": 2,
    "target_user": "tenant"
  }' | python3 -c "
import sys, json
data = json.load(sys.stdin)
print('Found knowledge:', data.get('source_count', 0))
if data.get('sources'):
    print('Top knowledge ID:', data['sources'][0].get('id'))
    print('Answer length:', len(data.get('answer', '')))
"
```

**é æœŸè¼¸å‡ºï¼š**
```
Found knowledge: 5
Top knowledge ID: 1262
Answer length: 200+
```

### æ¸¬è©¦ 3ï¼šå‰ç«¯æ¸¬è©¦

1. é–‹å•Ÿç€è¦½å™¨ï¼š`http://your-server:8087/chat-test`
2. é¸æ“‡ **Vendor 2**ï¼ˆä¿¡ç¾©åŒ…ç§Ÿä»£ç®¡ï¼‰
3. è¼¸å…¥ï¼šã€Œä½ å¥½ï¼Œæˆ‘è¦çºŒç´„ï¼Œæ–°çš„åˆç´„ç”šéº¼æ™‚å€™æœƒæä¾›?ã€
4. **é æœŸï¼š** æ‡‰è©²è¿”å›å®Œæ•´çš„çºŒç´„å›ç­”

---

## ğŸ”„ å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°

### æª¢æŸ¥ Intent 10 æ˜¯å¦æœ‰ embedding

```bash
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "
SELECT id, name, embedding IS NOT NULL as has_embedding
FROM intents
WHERE id = 10;
"
```

**å¦‚æœ has_embedding = fï¼ˆæ²’æœ‰ embeddingï¼‰ï¼š**

```bash
# ç”Ÿæˆ intent 10 çš„ embedding
curl -s -X POST "http://localhost:8100/api/v1/intents/regenerate-embeddings"

# ç­‰å¾…å®Œæˆ
sleep 5

# é‡å•Ÿæœå‹™
docker-compose -f docker-compose.prod.yml restart rag-orchestrator
```

### æª¢æŸ¥çŸ¥è­˜æœ¬èº«æ˜¯å¦æœ‰ embedding

```bash
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "
SELECT id, question_summary, embedding IS NOT NULL as has_embedding
FROM knowledge_base
WHERE id = 1262;
"
```

**å¦‚æœ has_embedding = fï¼š**

```bash
# é‡æ–°ç”ŸæˆçŸ¥è­˜ embedding
curl -s -X POST "http://localhost:8087/api/knowledge/regenerate-embeddings"
```

### æª¢æŸ¥ Vendor 2 é…ç½®

```bash
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "
SELECT id, name, business_types
FROM vendors
WHERE id = 2;
"
```

**é æœŸï¼š** business_types æ‡‰åŒ…å« `{full_service, property_management}`

---

## ğŸ“Š å®Œæ•´è¨ºæ–·è…³æœ¬

å¦‚æœä¸Šè¿°ä¿®æ­£å¾Œé‚„æ˜¯æ‰¾ä¸åˆ°ï¼ŒåŸ·è¡Œæ­¤è¨ºæ–·è…³æœ¬ï¼š

```bash
#!/bin/bash
echo "========================================="
echo "çŸ¥è­˜ ID 1262 å®Œæ•´è¨ºæ–·"
echo "========================================="

echo -e "\n1. æª¢æŸ¥çŸ¥è­˜æœ¬èº«ï¼š"
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "
SELECT
    id,
    question_summary,
    vendor_id,
    business_types,
    target_user,
    embedding IS NOT NULL as has_embedding
FROM knowledge_base
WHERE id = 1262;"

echo -e "\n2. æª¢æŸ¥æ„åœ–æ˜ å°„ï¼š"
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "
SELECT
    kb.id,
    kim.intent_id,
    i.name as intent_name,
    kim.intent_type,
    i.embedding IS NOT NULL as intent_has_embedding
FROM knowledge_base kb
LEFT JOIN knowledge_intent_mapping kim ON kb.id = kim.knowledge_id
LEFT JOIN intents i ON kim.intent_id = i.id
WHERE kb.id = 1262;"

echo -e "\n3. æª¢æŸ¥ Vendor 2 é…ç½®ï¼š"
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "
SELECT id, name, business_types
FROM vendors
WHERE id = 2;"

echo -e "\n4. API æ¸¬è©¦ï¼š"
curl -s -X POST "http://localhost:8100/api/v1/message" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ä½ å¥½ï¼Œæˆ‘è¦çºŒç´„ï¼Œæ–°çš„åˆç´„ç”šéº¼æ™‚å€™æœƒæä¾›?",
    "vendor_id": 2,
    "target_user": "tenant",
    "include_debug_info": true
  }' | python3 -c "
import sys, json
data = json.load(sys.stdin)
print('Intent:', data.get('intent_name'))
print('Found:', data.get('source_count', 0), 'knowledge(s)')
print('Processing path:', data.get('debug_info', {}).get('processing_path'))
if data.get('sources'):
    print('Top knowledge:', data['sources'][0].get('id'))
"

echo -e "\n========================================="
```

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q1: ä¿®æ­£å¾Œé‡å•Ÿï¼Œä½†é‚„æ˜¯æ‰¾ä¸åˆ°

**A:** æª¢æŸ¥æœå‹™æ—¥èªŒ

```bash
docker-compose -f docker-compose.prod.yml logs --tail 100 rag-orchestrator | grep -i "intent\|error"
```

### Q2: Intent è­˜åˆ¥ä¸æ­£ç¢º

**A:** é€™ä¸å½±éŸ¿çŸ¥è­˜æª¢ç´¢ã€‚åªè¦ intent 10 æœ‰ embeddingï¼ŒçŸ¥è­˜æª¢ç´¢æœƒä½¿ç”¨èªç¾©åŒ¹é…ã€‚

### Q3: éœ€è¦å›æ»¾å—ï¼Ÿ

**A:** å›æ»¾æ­¥é©Ÿï¼š

```bash
# é‚„åŸå‚™ä»½
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin < backup_intent_mapping_YYYYMMDD_HHMMSS.sql

# é‡å•Ÿæœå‹™
docker-compose -f docker-compose.prod.yml restart rag-orchestrator
```

---

## ğŸ“ éœ€è¦æ”¯æ´

å¦‚æœä¿®æ­£å¾Œé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œè«‹æä¾›ï¼š

1. è¨ºæ–·è…³æœ¬çš„å®Œæ•´è¼¸å‡º
2. rag-orchestrator æ—¥èªŒï¼ˆæœ€è¿‘ 100 è¡Œï¼‰
3. API æ¸¬è©¦çš„å®Œæ•´ responseï¼ˆå« debug_infoï¼‰

---

**åŸ·è¡Œäººå“¡ï¼š** _________________
**åŸ·è¡Œæ™‚é–“ï¼š** _________________
**ä¿®æ­£ç‹€æ…‹ï¼š** â˜ æˆåŠŸ  â˜ å¤±æ•—
**é©—è­‰çµæœï¼š** â˜ é€šé  â˜ æœªé€šé

---

ç”Ÿæˆæ—¥æœŸï¼š2026-01-13
é è¨ˆåŸ·è¡Œæ™‚é–“ï¼š5 åˆ†é˜
