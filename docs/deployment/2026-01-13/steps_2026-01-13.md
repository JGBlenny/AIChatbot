# ğŸ“¦ ç·šä¸Šéƒ¨ç½²æ­¥é©Ÿ (2026-01-13)

## ğŸ¯ æœ¬æ¬¡æ›´æ–°å…§å®¹

1. **æ„åœ–ç®¡ç†é é¢ï¼šæ‰¹é‡ç”Ÿæˆå‘é‡åŠŸèƒ½**
   - æ·»åŠ ã€ŒğŸ”„ æ‰¹é‡ç”Ÿæˆå‘é‡ã€æŒ‰éˆ•
   - é¡¯ç¤ºæ„åœ–å‘é‡ç‹€æ…‹ï¼ˆâœ“/âœ—ï¼‰
   - å¾Œç«¯ APIï¼š`POST /api/v1/intents/regenerate-embeddings`

2. **çµ±ä¸€å‘½åï¼šuser_role â†’ target_user**
   - âš ï¸ **åŒ…å«è³‡æ–™åº«é·ç§»**ï¼š`chat_history.user_role` â†’ `chat_history.target_user`
   - å‰ç«¯çµ±ä¸€ä½¿ç”¨ `target_user`
   - å¾Œç«¯å‘å¾Œå…¼å®¹ï¼ˆ`user_role` æ¨™è¨˜ç‚ºå»¢æ£„ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é …

- âœ… æœ¬æ¬¡éƒ¨ç½²**æœ‰è³‡æ–™åº«çµæ§‹è®Šæ›´**
- âœ… éœ€è¦åŸ·è¡Œ SQL é·ç§»è…³æœ¬
- âœ… éœ€è¦é‡æ–°å»ºç½®å‰ç«¯
- â±ï¸ é è¨ˆåœæ©Ÿæ™‚é–“ï¼š**5-10 åˆ†é˜**

---

## ğŸ“‹ éƒ¨ç½²æ­¥é©Ÿ

### 0. æº–å‚™å·¥ä½œ

```bash
# åˆ‡æ›åˆ°é …ç›®ç›®éŒ„
cd /path/to/AIChatbot

# ç¢ºèªç•¶å‰ç‹€æ…‹
git status
docker-compose -f docker-compose.prod.yml ps
```

---

### 1. å‚™ä»½è³‡æ–™åº«ï¼ˆå¿…é ˆï¼ï¼‰

```bash
# å‚™ä»½æ•´å€‹è³‡æ–™åº«
docker-compose -f docker-compose.prod.yml exec postgres pg_dump -U aichatbot aichatbot_admin > backup_$(date +%Y%m%d_%H%M%S).sql

# ç¢ºèªå‚™ä»½æ–‡ä»¶
ls -lh backup_*.sql
```

---

### 2. æ‹‰å–æœ€æ–°ä»£ç¢¼

```bash
# æ‹‰å–æœ€æ–°ä»£ç¢¼
git pull origin main

# ç¢ºèªæ‹‰å–åˆ°æœ€æ–° commit
git log --oneline -3
# æ‡‰è©²çœ‹åˆ°ï¼š
# 4c11d04 refactor: çµ±ä¸€ä½¿ç”¨ target_user å–ä»£ user_role
# a0394b9 fix: ä¿®æ­£çŸ¥è­˜åŒ¯å‡ºçš„ ID é‡è¤‡å’Œé †åºå•é¡Œ
```

---

### 3. åŸ·è¡Œè³‡æ–™åº«é·ç§»

```bash
# âš ï¸ é—œéµæ­¥é©Ÿï¼šé‡å‘½å chat_history.user_role â†’ target_user
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin < database/migrations/rename_chat_history_user_role_to_target_user.sql

# é©—è­‰é·ç§»æˆåŠŸ
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "\d chat_history" | grep target_user

# æ‡‰è©²çœ‹åˆ°ï¼š
# target_user | character varying(50) | ...
```

---

### 4. é‡æ–°å»ºç½®å‰ç«¯

```bash
# é€²å…¥å‰ç«¯ç›®éŒ„
cd knowledge-admin/frontend

# å»ºç½®ï¼ˆä½¿ç”¨ç”Ÿç”¢ç’°å¢ƒé…ç½®ï¼‰
npm run build

# å›åˆ°é …ç›®æ ¹ç›®éŒ„
cd ../..
```

**é æœŸè¼¸å‡ºï¼š**
```
âœ“ 171 modules transformed.
dist/index.html
dist/assets/index-*.css
dist/assets/index-*.js
âœ“ built in X.XXs
```

---

### 5. é‡å•Ÿæœå‹™

```bash
# é‡å•Ÿç›¸é—œæœå‹™
docker-compose -f docker-compose.prod.yml restart rag-orchestrator knowledge-admin-web

# ç­‰å¾…æœå‹™å•Ÿå‹•
sleep 10

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker-compose -f docker-compose.prod.yml ps
```

**æ‰€æœ‰æœå‹™æ‡‰è©²é¡¯ç¤º `Up`**

---

### 6. é©—è­‰éƒ¨ç½²

#### 6.1 é©—è­‰è³‡æ–™åº«é·ç§»

```bash
# æª¢æŸ¥ chat_history æ¬„ä½åç¨±
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c \
  "SELECT column_name FROM information_schema.columns WHERE table_name='chat_history' AND column_name IN ('user_role', 'target_user');"

# æ‡‰è©²åªçœ‹åˆ° target_userï¼Œæ²’æœ‰ user_role
```

#### 6.2 é©—è­‰ API æ­£å¸¸é‹ä½œ

```bash
# æ¸¬è©¦æ–°åƒæ•¸ target_user
curl -s -X POST "http://localhost:8100/api/v1/message" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æ¸¬è©¦",
    "vendor_id": 1,
    "target_user": "tenant"
  }' | grep -q "answer" && echo "âœ… target_user åƒæ•¸æ­£å¸¸" || echo "âŒ å¤±æ•—"

# æ¸¬è©¦èˆŠåƒæ•¸å‘å¾Œå…¼å®¹
curl -s -X POST "http://localhost:8100/api/v1/message" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æ¸¬è©¦",
    "vendor_id": 1,
    "user_role": "customer"
  }' | grep -q "answer" && echo "âœ… user_role å‘å¾Œå…¼å®¹æ­£å¸¸" || echo "âŒ å¤±æ•—"
```

#### 6.3 é©—è­‰æ„åœ–å‘é‡åŠŸèƒ½

```bash
# æª¢æŸ¥æ„åœ–æ˜¯å¦è¿”å› has_embedding æ¬„ä½
curl -s "http://localhost:8100/api/v1/intents" | grep -q "has_embedding" && \
  echo "âœ… æ„åœ– API æ­£å¸¸" || echo "âŒ å¤±æ•—"
```

#### 6.4 å‰ç«¯é é¢æ¸¬è©¦

1. **é–‹å•Ÿç€è¦½å™¨**ï¼šè¨ªå• `http://your-server:8087/intents`
2. **æª¢æŸ¥åŠŸèƒ½**ï¼š
   - âœ… çœ‹åˆ°ã€ŒğŸ”„ æ‰¹é‡ç”Ÿæˆå‘é‡ã€æŒ‰éˆ•
   - âœ… è¡¨æ ¼æœ‰ã€Œå‘é‡ã€æ¬„ä½é¡¯ç¤º âœ“ æˆ– âœ—
   - âœ… é»æ“Šæ‰¹é‡ç”ŸæˆæŒ‰éˆ•èƒ½æ­£å¸¸åŸ·è¡Œ

3. **æ¸¬è©¦èŠå¤©é é¢**ï¼šè¨ªå• `http://your-server:8087/chat-test`
   - âœ… èƒ½æ­£å¸¸ç™¼é€è¨Šæ¯
   - âœ… èƒ½æ­£å¸¸æ”¶åˆ°å›è¦†

---

### 7. æª¢æŸ¥æ—¥èªŒï¼ˆé¸åšï¼‰

```bash
# æª¢æŸ¥ rag-orchestrator æ—¥èªŒ
docker-compose -f docker-compose.prod.yml logs --tail 50 rag-orchestrator

# æª¢æŸ¥ knowledge-admin-web æ—¥èªŒ
docker-compose -f docker-compose.prod.yml logs --tail 50 knowledge-admin-web

# æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
docker-compose -f docker-compose.prod.yml logs --tail 100 | grep -i error
```

---

## ğŸ› å•é¡Œæ’æŸ¥

### å•é¡Œ 1ï¼šè³‡æ–™åº«é·ç§»å¤±æ•—

**éŒ¯èª¤è¨Šæ¯ï¼š**
```
ERROR: column "user_role" does not exist
```

**åŸå› ï¼š** æ¬„ä½å¯èƒ½å·²ç¶“é·ç§»é

**è§£æ±ºï¼š**
```bash
# æª¢æŸ¥ç•¶å‰æ¬„ä½
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin -c "\d chat_history"

# å¦‚æœå·²ç¶“æ˜¯ target_userï¼Œå‰‡è·³éé·ç§»
```

---

### å•é¡Œ 2ï¼šå‰ç«¯é¡¯ç¤ºèˆŠç‰ˆæœ¬

**ç—‡ç‹€ï¼š** æ„åœ–é é¢æ²’æœ‰ã€Œæ‰¹é‡ç”Ÿæˆå‘é‡ã€æŒ‰éˆ•

**è§£æ±ºï¼š**
```bash
# æ¸…é™¤ç€è¦½å™¨å¿«å–
# Chrome: Ctrl+Shift+Delete

# æˆ–å¼·åˆ¶åˆ·æ–°
# Chrome: Ctrl+Shift+R
# Firefox: Ctrl+F5

# é‡æ–°å»ºç½®å‰ç«¯
cd knowledge-admin/frontend
npm run build
cd ../..
docker-compose -f docker-compose.prod.yml restart knowledge-admin-web
```

---

### å•é¡Œ 3ï¼šAPI è¿”å› 500 éŒ¯èª¤

**ç—‡ç‹€ï¼š** èª¿ç”¨ API æ™‚è¿”å›å…§éƒ¨éŒ¯èª¤

**æ’æŸ¥ï¼š**
```bash
# æŸ¥çœ‹è©³ç´°éŒ¯èª¤
docker-compose -f docker-compose.prod.yml logs rag-orchestrator --tail 100

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker-compose -f docker-compose.prod.yml ps

# é‡å•Ÿå•é¡Œæœå‹™
docker-compose -f docker-compose.prod.yml restart rag-orchestrator
```

---

## âœ… éƒ¨ç½²å®Œæˆæª¢æŸ¥æ¸…å–®

- [ ] è³‡æ–™åº«å·²å‚™ä»½
- [ ] ä»£ç¢¼å·²æ‹‰å–åˆ°æœ€æ–°ç‰ˆæœ¬
- [ ] è³‡æ–™åº«é·ç§»å·²åŸ·è¡Œä¸¦é©—è­‰
- [ ] å‰ç«¯å·²é‡æ–°å»ºç½®
- [ ] æœå‹™å·²é‡å•Ÿä¸”ç‹€æ…‹æ­£å¸¸
- [ ] API æ¸¬è©¦é€šéï¼ˆtarget_user å’Œ user_roleï¼‰
- [ ] å‰ç«¯é é¢åŠŸèƒ½æ­£å¸¸
- [ ] æ—¥èªŒç„¡åš´é‡éŒ¯èª¤

---

## ğŸ”„ å›æ»¾æ­¥é©Ÿï¼ˆå¦‚æœå‡ºå•é¡Œï¼‰

```bash
# 1. åœæ­¢æœå‹™
docker-compose -f docker-compose.prod.yml stop

# 2. é‚„åŸè³‡æ–™åº«
docker-compose -f docker-compose.prod.yml exec -T postgres \
  psql -U aichatbot -d aichatbot_admin < backup_YYYYMMDD_HHMMSS.sql

# 3. å›æ»¾ä»£ç¢¼
git reset --hard HEAD~1

# 4. é‡æ–°å»ºç½®å‰ç«¯
cd knowledge-admin/frontend
npm run build
cd ../..

# 5. å•Ÿå‹•æœå‹™
docker-compose -f docker-compose.prod.yml up -d
```

---

## ğŸ“ è¯ç¹«æ”¯æ´

å¦‚æœé‡åˆ°å•é¡Œï¼Œè«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š
1. éŒ¯èª¤è¨Šæ¯æˆªåœ–
2. æœå‹™æ—¥èªŒï¼š`docker-compose -f docker-compose.prod.yml logs`
3. éƒ¨ç½²åŸ·è¡Œåˆ°å“ªä¸€æ­¥

---

**éƒ¨ç½²äººå“¡ï¼š** _________________
**éƒ¨ç½²æ—¥æœŸï¼š** _________________
**éƒ¨ç½²ç‹€æ…‹ï¼š** â˜ æˆåŠŸ  â˜ å¤±æ•—  â˜ å›æ»¾

---

ç”Ÿæˆæ—¥æœŸï¼š2026-01-13
æ–‡ä»¶ç‰ˆæœ¬ï¼š1.0
