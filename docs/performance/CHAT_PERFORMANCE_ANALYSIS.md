# RAG 對話流程完整效能評估報告

**測試日期**: 2025-10-21
**測試工具**: `/tests/performance/test_chat_performance.py`
**測試環境**: Docker Compose (本地開發環境)
**業者 ID**: 1

---

## 📊 執行摘要

### 整體效能指標

| 指標 | 數值 | 評級 |
|------|------|------|
| **平均響應時間** | **2,947.54 ms** (~3秒) | 🟠 C (尚可) |
| **中位數時間** | 2,058.98 ms (~2秒) | - |
| **最小時間** | 1,478.63 ms (~1.5秒) | - |
| **最大時間** | 7,032.70 ms (~7秒) | - |
| **標準差** | 1,767.22 ms | ⚠️ 高波動 |
| **成功率** | 88.89% | ⚠️ 需改進 |
| **總測試數** | 18 個問題 × 3 次重複 | - |

### 效能評級標準
- 🟢 **A (優秀)**: < 1秒
- 🟡 **B (良好)**: 1-2秒
- 🟠 **C (尚可)**: 2-3秒
- 🔴 **D (需改進)**: > 3秒

---

## 📂 分類效能分析

### 1. 高信心度問題 (High Confidence)
**預期**: 有明確知識庫內容，應快速回答
**實際**: ⚠️ **最慢的類別**

| 指標 | 數值 |
|------|------|
| 平均時間 | **4,522.49 ms** (~4.5秒) 🔴 |
| 中位數 | 6,077.10 ms (~6秒) |
| 範圍 | 1,532 - 7,033 ms |
| 成功率 | 100% ✅ |

**典型案例**:
- ❌ **最慢**: 「租約到期如何續約？」- 7,032 ms (7秒)
  - Processing time: 7,295 ms
  - 檢索文檔: 2 個
  - 信心度: 0.675 (medium)
  - 意圖: hybrid

- ❌ **次慢**: 「租金每個月幾號要繳？」- 6,310 ms (6秒)
  - Processing time: 8,383 ms
  - 檢索文檔: 2 個
  - 信心度: 0.586 (medium)
  - 意圖: data_query

- ✅ **最快**: 「房租包含哪些費用？」- 1,532 ms
  - 檢索文檔: 0 個（無相關知識）
  - 信心度: 0.00 (low)

**問題分析**:
1. **矛盾現象**: 預期高信心度的問題最快，實際上最慢
2. **原因**: 這些問題檢索到了文檔，但觸發了更複雜的 LLM 處理
3. **LLM 延遲**: 主要時間消耗在 LLM 生成答案（6-8秒）

---

### 2. 中等信心度問題 (Medium Confidence)

| 指標 | 數值 |
|------|------|
| 平均時間 | **1,899.22 ms** (~1.9秒) 🟡 |
| 中位數 | 1,855.08 ms |
| 範圍 | 1,704 - 2,094 ms |
| 成功率 | 80% ⚠️ |

**失敗案例**:
- ❌ 「停車位怎麼收費？」- **100% 失敗** (HTTP 500)
  - 平均時間: 1,704 ms (在失敗前)
  - 需調查後端錯誤

---

### 3. 低信心度問題 (Low Confidence)

| 指標 | 數值 |
|------|------|
| 平均時間 | **2,727.92 ms** (~2.7秒) 🟠 |
| 中位數 | 2,868.43 ms |
| 範圍 | 1,479 - 3,514 ms |
| 成功率 | 80% ⚠️ |

**典型案例**:
- 「這個社區安全嗎？」- 3,514 ms
  - 意圖: unclear
  - 需要記錄為未釐清問題

**失敗案例**:
- ❌ 「我的鄰居很吵怎麼辦？」- **100% 失敗** (HTTP 500)

---

### 4. 複雜問題 (Complex)
**特點**: 需要 API 整合、參數注入

| 指標 | 數值 |
|------|------|
| 平均時間 | **2,435.85 ms** (~2.4秒) 🟡 |
| 中位數 | 1,797.10 ms |
| 範圍 | 1,778 - 3,732 ms |
| 成功率 | 100% ✅ |

**典型案例**:
- 「幫我查詢我的繳費記錄」- 3,732 ms
  - Processing time: 4,420 ms
  - 檢索文檔: 1 個
  - 信心度: 0.538 (medium)

---

## ⏱️ 時間分解分析

### 響應時間組成

從測試數據分析，單次對話的時間組成：

```
總響應時間 = 網絡延遲 + 後端處理時間
後端處理時間 = 意圖分類 + RAG檢索 + LLM生成 + 信心度評估 + 其他
```

### 實際測量數據

| 問題 | 總時間 (ms) | 後端處理 (ms) | 網絡延遲 (ms) | 檢索文檔數 |
|------|-------------|---------------|---------------|-----------|
| 租約到期如何續約？ | 7,033 | 7,295 | -262* | 2 |
| 租金每個月幾號要繳？ | 6,310 | 8,383 | -2,073* | 2 |
| 退租需要提前多久告知？ | 6,077 | 6,935 | -858* | 1 |
| 附近有什麼好吃的餐廳？ | 3,243 | 3,902 | -659* | 0 |
| 幫我查詢我的繳費記錄 | 3,732 | 4,420 | -688* | 1 |

*註: 負值表示後端報告的處理時間大於客戶端測量的總時間，可能的原因：
- 時間測量點不同（後端包含更多步驟）
- 時鐘不同步
- 並行處理被計入

### 推斷的時間分解

基於代碼分析和測量數據：

1. **意圖分類** (~200-500 ms)
   - LLM API 調用
   - 輕量級處理

2. **RAG 檢索** (~500-1,000 ms)
   - 向量搜索
   - 文檔排序
   - 與檢索文檔數量成正比

3. **LLM 答案生成** (~3,000-6,000 ms) ⚠️ **主要瓶頸**
   - 最耗時的步驟
   - 依賴外部 LLM API
   - 與上下文長度相關

4. **信心度評估** (~200-500 ms)
   - 規則評估
   - 輕量級計算

5. **未釐清問題記錄** (~500-1,000 ms)
   - 僅在低信心度時觸發
   - 包含向量生成和去重檢測

---

## 🔍 效能瓶頸分析

### 主要瓶頸排名

#### 1. 🔴 LLM API 延遲 (最嚴重)
**影響**: 60-80% 的總響應時間
**表現**:
- 有文檔的問題: 6-8 秒
- 無文檔的問題: 2-4 秒

**證據**:
- 「租約到期如何續約？」: 7.3秒處理時間，2個文檔
- 「我想養寵物可以嗎？」: 1.8秒處理時間，0個文檔

**建議**:
- ✅ 考慮使用更快的 LLM 模型（如 GPT-3.5-turbo）
- ✅ 減少 prompt 長度（精簡系統提示詞）
- ✅ 實施 LLM 響應緩存機制
- ✅ 對常見問題使用預生成答案

---

#### 2. 🟠 RAG 檢索時間 (中等)
**影響**: 10-20% 的總響應時間
**表現**:
- 檢索 0 個文檔: ~1.5-2 秒
- 檢索 1-2 個文檔: ~3-7 秒

**建議**:
- 優化向量索引（調整 HNSW 參數）
- 限制檢索文檔數量（目前似乎是 top-2）
- 實施結果緩存

---

#### 3. 🟡 向量化延遲 (輕微)
**影響**: ~5-10% 的總響應時間
**表現**:
- Embedding API 調用: ~100-300 ms
- 批量處理: 可能更慢

**建議**:
- 確認 Embedding API 使用高效模型
- 考慮本地部署 embedding 模型

---

#### 4. ⚠️ 系統穩定性問題
**成功率**: 88.89%（2/18 問題失敗）

**失敗案例**:
1. 「停車位怎麼收費？」- HTTP 500
2. 「我的鄰居很吵怎麼辦？」- HTTP 500

**建議**:
- 調查具體錯誤原因（需查看完整日誌）
- 加強錯誤處理和降級機制
- 添加重試邏輯

---

## 📈 信心度分布分析

### 實際分布

| 信心度等級 | 數量 | 百分比 | 平均時間 |
|-----------|------|--------|---------|
| High (≥0.8) | 0 | 0% | - |
| Medium (0.6-0.8) | 4 | 22.2% | ~6,163 ms |
| Low (<0.6) | 12 | 66.7% | ~2,068 ms |
| 失敗 | 2 | 11.1% | ~1,592 ms |

### 關鍵發現

1. **沒有高信心度回答** 🔴
   - 所有問題的信心度都低於 0.8
   - 最高信心度：0.675（「租約到期如何續約？」）
   - 表示知識庫覆蓋不足

2. **中等信心度反而最慢**
   - 平均 6,163 ms vs 低信心度 2,068 ms
   - 原因：需要更複雜的 LLM 處理和文檔整合

3. **低信心度佔主導** (66.7%)
   - 大部分問題觸發「需要人工」
   - 系統實際上主要在處理未知問題

---

## 🎯 與用戶體驗的關聯

### 體驗評級

| 響應時間 | 用戶體驗 | 適用場景 | 當前覆蓋率 |
|---------|---------|---------|-----------|
| < 1秒 | ⭐⭐⭐⭐⭐ 極佳 | 實時對話 | 0% |
| 1-2秒 | ⭐⭐⭐⭐ 良好 | 一般查詢 | 27.8% |
| 2-3秒 | ⭐⭐⭐ 尚可 | 複雜查詢 | 33.3% |
| 3-5秒 | ⭐⭐ 較慢 | 可接受範圍 | 16.7% |
| > 5秒 | ⭐ 太慢 | 需改進 | 22.2% |

### 用戶期望 vs 實際表現

**理想目標**:
- 90% 的問題 < 2秒
- 99% 的問題 < 3秒

**當前狀態**:
- 27.8% 的問題 < 2秒 ❌
- 61.1% 的問題 < 3秒 ❌

**結論**: 當前效能**無法滿足理想用戶體驗目標**

---

## 💡 優化建議

### 短期優化 (1-2週)

#### 1. LLM 優化 (預期改進: 50-60%)
- [ ] **使用更快的模型**: GPT-3.5-turbo 替代 GPT-4
  - 預期: 6-8秒 → 2-3秒
- [ ] **精簡 Prompt**: 減少系統提示詞長度
  - 預期: 減少 10-20% 時間
- [ ] **並行處理**: 意圖分類和 RAG 檢索並行
  - 預期: 減少 500-1000 ms

#### 2. 錯誤修復 (預期改進: 成功率 → 100%)
- [ ] **調查 500 錯誤**: 修復失敗的2個問題
- [ ] **添加重試機制**: 對 LLM API 失敗進行重試
- [ ] **降級策略**: LLM 失敗時返回預設回答

#### 3. 緩存機制 (預期改進: 20-30%)
- [ ] **問題緩存**: 相同問題直接返回
- [ ] **向量緩存**: 緩存常見問題的 embedding
- [ ] **RAG 結果緩存**: 緩存檢索結果

---

### 中期優化 (1-2個月)

#### 4. 知識庫擴充 (改進信心度)
- [ ] **增加知識條目**: 覆蓋更多常見問題
  - 目標: 高信心度(≥0.8) 比例 > 50%
- [ ] **優化知識質量**: 提高語義相似度匹配準確度
- [ ] **添加 FAQ 快速匹配**: 繞過 LLM 直接返回

#### 5. 架構優化
- [ ] **流式響應**: 實施 Server-Sent Events (SSE)
  - 用戶感知延遲降低
- [ ] **分階段返回**: 先返回意圖，再返回完整答案
- [ ] **本地 Embedding**: 部署本地 embedding 模型

---

### 長期優化 (3-6個月)

#### 6. 智能路由
- [ ] **問題分類**: 簡單問題走快速通道
- [ ] **自適應策略**: 根據問題複雜度選擇不同處理流程
- [ ] **預測性緩存**: 預測熱門問題並預加載

#### 7. 基礎設施
- [ ] **LLM 本地化**: 部署自託管 LLM（如 Llama 2）
- [ ] **CDN 部署**: 多地區部署減少網絡延遲
- [ ] **GPU 加速**: RAG 檢索和 LLM 推理加速

---

## 📊 預期效果

### 優化後的目標

| 階段 | 平均時間 | 改進幅度 | P95 | 成功率 |
|------|---------|---------|-----|--------|
| **當前** | 2,948 ms | - | 7,033 ms | 88.9% |
| **短期** (2週) | 1,500 ms | -49% | 3,500 ms | 100% |
| **中期** (2月) | 800 ms | -73% | 2,000 ms | 100% |
| **長期** (6月) | 500 ms | -83% | 1,200 ms | 99.9% |

---

## 📝 測試數據詳情

### TOP 5 最慢問題

| 排名 | 問題 | 時間 (ms) | 原因 |
|------|------|----------|------|
| 1 | 租約到期如何續約？ | 7,033 | LLM + 2 文檔 |
| 2 | 租金每個月幾號要繳？ | 6,310 | LLM + 2 文檔 |
| 3 | 退租需要提前多久告知？ | 6,077 | LLM + 1 文檔 |
| 4 | 幫我查詢我的繳費記錄 | 3,732 | 複雜查詢 |
| 5 | 這個社區安全嗎？ | 3,514 | 未釐清問題處理 |

### TOP 5 最快問題

| 排名 | 問題 | 時間 (ms) | 原因 |
|------|------|----------|------|
| 1 | 我的鄰居很吵怎麼辦？* | 1,479 | 失敗（500錯誤）|
| 2 | 房租包含哪些費用？ | 1,532 | 無文檔，簡單回答 |
| 3 | 我想養寵物可以嗎？ | 1,660 | 無文檔 |
| 4 | 停車位怎麼收費？* | 1,704 | 失敗（500錯誤）|
| 5 | 我的合約什麼時候到期？ | 1,778 | 無文檔 |

*失敗案例不計入有效比較

---

## 🔗 相關資源

- **原始測試數據**: `/tmp/chat_performance_report_20251021_163044.json`
- **測試腳本**: `/tests/performance/test_chat_performance.py`
- **執行命令**: `python3 tests/performance/test_chat_performance.py`

---

**報告生成時間**: 2025-10-21
**下次測試建議**: 優化後 1 週進行對比測試
