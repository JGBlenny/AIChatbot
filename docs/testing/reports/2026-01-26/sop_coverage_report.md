# Vendor SOP 檢索涵蓋率測試報告

**測試日期**: 2026-01-26
**測試範圍**: 30 個常見租客問題
**測試對象**: vendor_id=2 的 SOP (共 56 個)

---

## 📊 測試結果統計

| 項目 | 數量 | 百分比 |
|------|------|--------|
| 總測試問題 | 30 | 100% |
| ✅ 成功檢索 | 17 | 56.7% |
| ❌ 未檢索到 | 13 | 43.3% |
| ⚠️  API 錯誤 | 0 | 0% |

---

## 🔍 核心問題分析

### 問題根因：相似度閾值過高

當前閾值設定為 **0.55**，導致 8 個有對應 SOP 的問題被過濾：

| 問題 | SOP ID | SOP 名稱 | 相似度 | 差距 |
|------|--------|---------|--------|------|
| 馬桶堵塞 | 1648 | 馬桶堵塞: | 0.5303 | -0.0197 |
| 想要續約 | 1628 | 如何續約： | 0.5352 | -0.0148 |
| 浴室抽風機很吵 | 1651 | 浴室抽風機異音: | 0.5346 | -0.0154 |
| 電費怎麼繳 | 1632 | 電費繳納: | 0.4991 | -0.0509 |
| 滯納金怎麼算 | 1617 | 滯納金: | 0.4886 | -0.0614 |
| 馬桶堵住了 | 1648 | 馬桶堵塞: | 0.4758 | -0.0742 |
| 跳電了 | 1653 | 跳電: | 0.4682 | -0.0818 |
| 天花板漏水 | 1649 | 建築物漏水: | < 0.55 | - |

---

## ✅ 成功檢索案例 (17個)

### 租金繳費 (3/5)
- ✅ 租金每個月幾號要繳？ → [1613] 租金帳單:
- ✅ 租金可以用什麼方式付款？ → [1629] 租金支付方式
- ✅ 可以開收據或發票嗎？ → [1631] 收據或發票如何提供
- ❌ 忘記繳房租會怎樣？
- ❌ 電費要怎麼繳？

### 合約相關 (4/5)
- ✅ 可以提前退租嗎？ → [1626] 如何點退:
- ✅ 退租的時候押金怎麼退？ → [1627] 押金返還:
- ✅ 簽約前需要注意什麼？ → [172, 124, 99, 337, 205] 5個相關SOP
- ✅ 租約到期怎麼辦？ → [1625] 提前終止：
- ❌ 想要續約怎麼辦？

### 設備維修 (5/7)
- ✅ 冰箱不冷了怎麼辦？ → [1646] 冰箱不冷:
- ✅ 冷氣不冷而且有異味 → [802, 789, 796, 799, 803] 5個相關SOP
- ✅ 熱水器沒有熱水 → [1652] 瓦斯熱水器不熱:
- ✅ 洗衣機一直顯示錯誤 → [1647] 洗衣機顯示錯誤代碼:
- ❌ 馬桶堵住了可以報修嗎？
- ❌ 房間突然跳電了
- ❌ 浴室抽風機很吵

### 緊急狀況 (1/3)
- ✅ 水管漏水了怎麼辦？ → [1645] 水管漏水：
- ❌ 天花板漏水
- ❌ 房間突然停電

### 生活相關 (0/3)
- ❌ 垃圾要怎麼丟？
- ❌ 有什麼生活規則要遵守？
- ❌ 可以養寵物嗎？

### 費用問題 (2/4)
- ✅ 什麼是定金？ → [1615] 定金:
- ✅ 退租要付清潔費嗎？ → [1609] 退租清潔費:
- ❌ 押金要繳多少？
- ❌ 滯納金怎麼算？

### 平台操作 (3/3)
- ✅ 怎麼登入租客平台？ → [82, 105, 108] 3個相關SOP
- ✅ 怎麼查詢我的繳費記錄？ → [97, 119, 147, 95, 1246] 5個相關SOP
- ✅ 在哪裡可以看租約？ → [1611] 抄錶: (⚠️ 誤配)

---

## ❌ 未涵蓋問題分析

### 類型 1: 有 SOP 但相似度不足 (8個)

**原因**:
- 問題措辭簡短，語義資訊少
- SOP item_name 也較簡短
- 向量相似度計算偏低

**問題清單**:
1. [租金繳費] 忘記繳房租會怎樣？ → 應找到 [1617] 滯納金:
2. [租金繳費] 電費要怎麼繳？ → 應找到 [1632] 電費繳納:
3. [合約相關] 想要續約怎麼辦？ → 應找到 [1628] 如何續約：
4. [設備維修] 馬桶堵住了可以報修嗎？ → 應找到 [1648] 馬桶堵塞:
5. [設備維修] 房間突然跳電了 → 應找到 [1653] 跳電:
6. [設備維修] 浴室抽風機很吵 → 應找到 [1651] 浴室抽風機異音:
7. [緊急狀況] 天花板漏水 → 應找到 [1649] 建築物漏水:
8. [費用問題] 押金要繳多少？ → 應找到 [1607] 押金：

### 類型 2: 缺少對應 SOP (5個)

**生活相關問題 (3個)**:
- 垃圾要怎麼丟？ → 資料庫有 [1619] 垃圾收取規範: (相似度 0.4024)
- 有什麼生活規則要遵守？ → 資料庫有 [1620] 住戶生活規約 (相似度偏低)
- 可以養寵物嗎？ → **真正缺少 SOP**

**其他 (2個)**:
- 房間突然停電 → 與 [1653] 跳電: 意義接近但語義差異大
- 忘記繳房租會怎樣？ → [1617] 滯納金: 內容有關但未明確說明「逾期後果」

---

## 💡 改善建議

### 方案 A：調整相似度閾值 ⭐⭐⭐⭐⭐ (推薦)

**實施**: 將閾值從 `0.55` 降低至 `0.50` 或 `0.48`

**修改位置**:
- `rag-orchestrator/services/sop_orchestrator.py` 第 125 行
- `rag-orchestrator/services/vendor_sop_retriever.py` 相關方法

**預期改善**:
- ✅ 馬桶相關: 0.5303 → 通過
- ✅ 續約: 0.5352 → 通過
- ✅ 浴室抽風機: 0.5346 → 通過
- ✅ 電費: 0.4991 → 通過 (閾值 0.48)
- 涵蓋率: **56.7% → 66.7%~73.3%**

**風險**:
- 可能增加誤配機率（需測試驗證）

---

### 方案 B：擴充 SOP 內容

**實施**: 為簡短的 SOP 添加更多描述性文字

**範例**:
```
Before: "馬桶堵塞:"
After:  "馬桶堵塞處理方法：當您的馬桶堵住、馬桶不通、馬桶阻塞時"
```

**優點**:
- 不改變檢索邏輯
- 提升語義豐富度

**缺點**:
- 需要人工修改 56 個 SOP
- 工作量較大

---

### 方案 C：補充缺失 SOP

**建議新增 SOP**:
1. 「寵物飼養規定」- 明確說明是否允許養寵物
2. 「逾期繳費說明」- 詳細說明忘記繳房租的後果（關聯滯納金）
3. 「停電處理流程」- 區分「跳電」vs「停電」

**優點**:
- 解決真正的 SOP 缺口

**缺點**:
- 需要業務端提供內容

---

### 方案 D：動態閾值 (進階)

**實施**: 根據 SOP 類型使用不同閾值
- 緊急維修類: 0.48 (寬鬆)
- 合約流程類: 0.55 (嚴格)

**優點**:
- 更精準的控制

**缺點**:
- 實作複雜度高

---

## 🎯 推薦行動方案

### 短期 (立即可執行)
1. ✅ **調整閾值至 0.50** (方案 A)
2. ✅ 重新測試並驗證誤配率
3. ✅ 監控生產環境反饋

### 中期 (1-2週)
1. 📝 補充 3 個缺失的 SOP (方案 C)
2. 📝 擴充 10 個高頻但簡短的 SOP (方案 B)

### 長期 (可選)
1. 🔬 研究動態閾值機制 (方案 D)
2. 📊 收集用戶真實問題語料，持續優化

---

## 📈 測試詳細數據

完整測試結果已儲存至: `test_sop_coverage_results.json`

測試腳本:
- `test_sop_coverage.py` - 批次測試腳本
- `check_similarity.py` - 相似度檢查腳本
- `test_single_question.py` - 單一問題測試

---

**報告產生日期**: 2026-01-26
**下次複測建議**: 調整閾值後立即重測
