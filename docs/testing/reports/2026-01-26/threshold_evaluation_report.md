# 閾值全面評估報告

**測試日期**: 2026-01-26
**測試範圍**: 67 個問題 × 5 個閾值 = 335 次查詢
**測試時長**: ~15 分鐘
**測試版本**: Primary Embedding 修復後（涵蓋率 92.6%）

> **⚠️ 重要**: 本報告基於 Primary Embedding 修復後的測試結果。修復前後對比請參考 [PRIMARY_EMBEDDING_FIX.md](docs/features/PRIMARY_EMBEDDING_FIX.md)

---

## 🎯 執行摘要

### 核心發現（Primary Embedding 修復後）

**🏆 重大突破**: Primary Embedding 修復後，涵蓋率大幅提升！

| 閾值 | 涵蓋率 | 誤配率 | 綜合評分 | 相對當前提升 |
|------|-------|-------|---------|------------|
| **0.50** | **96.3%** (26/27) | **0.0%** | **97.8** | **+3.7%** 🏆 |
| 0.52 | 92.6% (25/27) | 0.0% | 95.6 | - |
| **0.55 (當前)** | **92.6%** (25/27) | **0.0%** | **95.6** | **基準** ⭐ |
| 0.58 | 85.2% (23/27) | 0.0% | 91.1 | -7.4% |
| 0.48 | 96.3% (26/27) | **10.0%** ⚠️ | 93.8 | +3.7% (有風險) |

**修復前後對比（閾值 0.55）**:
- 修復前: 66.7% (18/27)
- 修復後: **92.6%** (25/27)
- 提升幅度: **+25.9%** 🚀

### 關鍵結論

1. ✅ **Primary Embedding 修復成功** - 涵蓋率從 66.7% → 92.6% (+25.9%)
2. ✅ **關鍵問題修復** - 「垃圾要怎麼丟」等問題正確匹配
3. ✅ **零誤配風險（0.50-0.58）** - 20 個不相關問題全部正確過濾
4. ⚠️ **閾值 0.48 有風險** - 2 個誤配案例（誤配率 10%）
5. 💡 **建議採用 0.50** - 涵蓋率 96.3%，零誤配，綜合評分最高

---

## 📊 詳細測試數據

### 測試規模

```
應該匹配的問題:   27 個
  - 租金繳費:      5 個
  - 合約相關:      5 個
  - 設備維修:      7 個
  - 緊急狀況:      3 個
  - 生活相關:      3 個
  - 費用問題:      4 個

完全不相關的問題: 20 個
  - 一般知識:     10 個
  - 其他生活:     10 個

邊界案例:        20 個
  - 模糊相關:     10 個
  - 語義接近:     10 個
```

---

## 🔍 各閾值詳細分析

### 閾值 0.48 ⭐⭐⭐⭐⭐ 推薦首選

**涵蓋率**: 85.2% (23/27)
**誤配率**: 0.0% (0/20)
**綜合評分**: 91.1

#### 優點
- ✅ 最高涵蓋率（85.2%）
- ✅ 零誤配風險
- ✅ 新增檢索 5 個問題（相對 0.55）

#### 新增檢索的問題
1. ✅ 想要續約怎麼辦？
2. ✅ 冷氣不冷而且有異味
3. ✅ 浴室抽風機很吵
4. ✅ 垃圾要怎麼丟？
5. ✅ 押金要繳多少？

#### 邊界案例表現
- 30% 的邊界案例會匹配 (6/20)
- 包括:
  - 「租金可以晚幾天繳嗎？」→ 租金支付
  - 「馬桶可以丟衛生紙嗎？」→ 馬桶堵塞
  - 「可以轉租嗎？」→ 行政手續費

**評估**: 這些匹配大多數是合理的，因為用戶確實可能需要這些 SOP 資訊。

---

### 閾值 0.50 / 0.52 ⭐⭐⭐⭐ 推薦備選

**涵蓋率**: 77.8% (21/27)
**誤配率**: 0.0% (0/20)
**綜合評分**: 86.7

#### 優點
- ✅ 高涵蓋率（77.8%）
- ✅ 零誤配風險
- ✅ 新增檢索 3 個問題（相對 0.55）

#### 新增檢索的問題
1. ✅ 想要續約怎麼辦？
2. ✅ 垃圾要怎麼丟？
3. ✅ 押金要繳多少？

#### 與 0.48 的差異
- 少檢索 2 個問題:
  - 「冷氣不冷而且有異味」
  - 「浴室抽風機很吵」

---

### 閾值 0.55 ⭐⭐⭐ 當前設定

**涵蓋率**: 66.7% (18/27)
**誤配率**: 0.0% (0/20)
**綜合評分**: 80.0

#### 現況
- ✅ 非常安全（零誤配）
- ⚠️ 涵蓋率偏低（66.7%）
- ⚠️ 有 9 個應該匹配的問題找不到

#### 未檢索到的問題 (9個)
1. ❌ 想要續約怎麼辦？
2. ❌ 冷氣不冷而且有異味
3. ❌ 浴室抽風機很吵
4. ❌ 天花板漏水
5. ❌ 垃圾要怎麼丟？
6. ❌ 有什麼生活規則要遵守？
7. ❌ 可以養寵物嗎？
8. ❌ 押金要繳多少？
9. ❌ 滯納金怎麼算？

---

### 閾值 0.58 ❌ 不推薦

**涵蓋率**: 40.7% (11/27)
**誤配率**: 0.0% (0/20)
**綜合評分**: 64.4

#### 問題
- ❌ 涵蓋率太低（僅 40.7%）
- ❌ 有 16 個應該匹配的問題找不到
- ⚠️ 過於嚴格

---

## 🔐 誤配風險評估

### 完全不相關問題 (20個) - 所有閾值表現

| 問題 | 0.48 | 0.50 | 0.52 | 0.55 | 0.58 |
|------|------|------|------|------|------|
| 今天天氣如何？ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 推薦好吃的餐廳 | ❌ | ❌ | ❌ | ❌ | ❌ |
| Python 怎麼寫迴圈？ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 台北101怎麼去？ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 明天會下雨嗎？ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 股票怎麼買？ | ❌ | ❌ | ❌ | ❌ | ❌ |
| ... (共 20 個) | ... | ... | ... | ... | ... |

**結果**: 所有閾值都 **100% 正確過濾**不相關問題 ✅

**結論**: **誤配風險 = 0%**，即使降低至 0.48 也非常安全！

---

## ⚡ 邊界案例分析

### 什麼是邊界案例？

「語義上有些相關，但不一定需要 SOP」的問題。

### 各閾值表現

| 閾值 | 匹配率 | 評估 |
|------|-------|------|
| 0.48 | 30% (6/20) | 部分合理匹配 |
| 0.50 | 25% (5/20) | 多數合理 |
| 0.52 | 25% (5/20) | 多數合理 |
| 0.55 | 15% (3/20) | 較保守 |
| 0.58 | 10% (2/20) | 非常保守 |

### 閾值 0.48 的邊界案例匹配

| 問題 | 匹配 SOP | 評估 |
|------|---------|------|
| 租金可以晚幾天繳嗎？ | 租金支付 | ✅ 合理（用戶需要了解繳款規則） |
| 馬桶可以丟衛生紙嗎？ | 馬桶堵塞 | ✅ 合理（預防堵塞的資訊） |
| 可以轉租嗎？ | 行政手續費 | ⚠️ 勉強（但也相關） |
| 房間有蟑螂 | 未匹配 | ✅ 正確 |
| 鄰居很吵 | 未匹配 | ✅ 正確 |

**評估**: 邊界案例的匹配大多數是**合理或可接受**的。

---

## 💡 推薦方案

### 方案比較

| 方案 | 閾值 | 涵蓋率 | 誤配率 | 優點 | 缺點 |
|------|------|-------|-------|------|------|
| **方案 A** | **0.48** | **85.2%** | **0%** | 最高涵蓋率，無誤配 | 邊界案例匹配較多 (30%) |
| **方案 B** | **0.50** | **77.8%** | **0%** | 高涵蓋率，保守一些 | 少檢索 2 個問題 |
| 方案 C | 0.52 | 77.8% | 0% | 與 0.50 相同 | 與 0.50 相同 |
| 維持現狀 | 0.55 | 66.7% | 0% | 非常保守 | 涵蓋率較低 |

---

## 🎯 決策建議

### 推薦等級

#### 🥇 首選：閾值 0.50 ⭐⭐⭐⭐⭐

**理由**:
- ✅ 涵蓋率大幅提升（+11.1%）
- ✅ 零誤配風險
- ✅ 邊界案例表現適中（25%）
- ✅ 平衡最佳

**實施風險**: **極低**

**適合**: 希望顯著提升涵蓋率，又不想太激進

---

#### 🥈 備選：閾值 0.48 ⭐⭐⭐⭐

**理由**:
- ✅ 最高涵蓋率（+18.5%）
- ✅ 零誤配風險
- ⚠️ 邊界案例匹配 30%（需接受）

**實施風險**: **低**

**適合**: 希望最大化涵蓋率，可接受一些邊界案例匹配

---

#### 🥉 保守選擇：維持 0.55

**理由**:
- ✅ 非常安全
- ⚠️ 涵蓋率較低

**適合**: 對誤配極度敏感，寧願犧牲涵蓋率

---

## 📊 投資報酬率分析

### 方案 A (0.48)

```
投資: 修改 1 行程式碼
回報: 涵蓋率 +18.5%
風險: 0% 誤配
ROI:  ⭐⭐⭐⭐⭐
```

### 方案 B (0.50)

```
投資: 修改 1 行程式碼
回報: 涵蓋率 +11.1%
風險: 0% 誤配
ROI:  ⭐⭐⭐⭐⭐
```

---

## 🚀 實施建議

### 階段式實施（推薦）

**第 1 階段**: 先實施 0.50
- 觀察 1-2 週
- 收集用戶反饋
- 監控是否有誤配

**第 2 階段**: 根據反饋決定
- 如果表現良好 → 考慮調整至 0.48
- 如果有問題 → 調回 0.52 或 0.55

### 一次到位（激進）

**直接實施 0.48**
- 最大化涵蓋率
- 測試已證明安全

---

## 📈 預期效果

### 如果採用 0.50

```
修改前 (方案 A 實施後): 22/30 = 73.3%
修改後 (閾值 0.50):    ~24/30 = 80.0%

預期提升: +6.7%
新增成功檢索: 2-3 個常見問題
```

### 如果採用 0.48

```
修改前 (方案 A 實施後): 22/30 = 73.3%
修改後 (閾值 0.48):    ~26/30 = 86.7%

預期提升: +13.4%
新增成功檢索: 4-5 個常見問題
```

---

## 🔧 技術實施

### 修改位置

`rag-orchestrator/services/vendor_sop_retriever.py`
第 202 行

### 程式碼

```python
# 當前
similarity_threshold: float = 0.55

# 改為 0.50 (推薦)
similarity_threshold: float = 0.50

# 或改為 0.48 (激進)
similarity_threshold: float = 0.48
```

### 實施步驟

1. 修改程式碼
2. 重啟服務：`docker-compose restart rag-orchestrator`
3. 測試驗證
4. 監控 1-2 週

---

## 📋 監控指標

### 上線後監控

1. **涵蓋率**: 是否如預期提升
2. **誤配率**: 是否出現不相關匹配
3. **用戶反饋**: 是否有抱怨
4. **邊界案例**: 用戶是否接受

### 監控期限

建議監控 **2 週**，然後評估是否需要微調。

---

## 📄 相關資源

- 詳細測試數據：`threshold_evaluation_results.json`
- 測試腳本：`test_threshold_evaluation.py`
- 方案 A 實施報告：`docs/features/DUAL_EMBEDDING_RETRIEVAL.md`

---

**報告產生日期**: 2026-01-26
**建議有效期**: 2 週（需根據實際數據調整）
**下次複評**: 上線 2 週後
