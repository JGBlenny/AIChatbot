# æœƒè©±ä¿®æ”¹æ‘˜è¦

**æ—¥æœŸï¼š** 2025-11-29  
**ä¸»é¡Œï¼š** é…ç½®ç‰ˆæœ¬åŒ–ç·©å­˜ + LLM èªæ°£å„ªåŒ–

---

## ğŸ“‹ ä¿®æ”¹æ¦‚è¦½

### æ ¸å¿ƒæ”¹é€²

1. **é…ç½®ç‰ˆæœ¬åŒ–ç·©å­˜æ©Ÿåˆ¶**ï¼ˆè§£æ±ºé…ç½®ä¿®æ”¹å¾Œç·©å­˜ä¸ä¸€è‡´å•é¡Œï¼‰
2. **LLM åˆæˆèªæ°£å„ªåŒ–**ï¼ˆè§£æ±ºã€Œç›¸ä¼¼åº¦è¶Šé«˜ç­”æ¡ˆè¶Šå†·æ·¡ã€çš„çŸ›ç›¾ï¼‰

### ä¿®æ”¹çµ±è¨ˆ

| é¡åˆ¥ | æ–‡ä»¶æ•¸ | è¡Œæ•¸è®Šæ›´ |
|------|--------|----------|
| å¾Œç«¯æœå‹™ | 3 | ~50 è¡Œ |
| é…ç½®æ–‡ä»¶ | 2 | ~5 è¡Œ |
| **ç¸½è¨ˆ** | **5** | **~55 è¡Œ** |

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹è©³æƒ…

### 1. `rag-orchestrator/services/cache_service.py`

**ä¿®æ”¹ç›®çš„ï¼š** åœ¨ç·©å­˜éµä¸­åŠ å…¥é…ç½®ç‰ˆæœ¬ï¼Œæ”¯æŒå¤šé…ç½®ä¸¦å­˜

#### ä¿®æ”¹ 1.1: `_make_question_key()` æ–¹æ³•

**ä½ç½®ï¼š** Line 63-74

**ä¿®æ”¹å‰ï¼š**
```python
def _make_question_key(self, vendor_id: int, question: str, target_user: str = "tenant") -> str:
    question_hash = hashlib.md5(question.lower().strip().encode()).hexdigest()[:16]
    return f"rag:question:{vendor_id}:{target_user}:{question_hash}"
```

**ä¿®æ”¹å¾Œï¼š**
```python
def _make_question_key(self, vendor_id: int, question: str, target_user: str = "tenant", config_version: str = "default") -> str:
    """
    ç”Ÿæˆå•é¡Œç·©å­˜ keyï¼ˆä½¿ç”¨ target_user æ”¯æ´è§’è‰²éš”é›¢ + config_version æ”¯æ´å¤šé…ç½®ä¸¦å­˜ï¼‰

    Args:
        vendor_id: æ¥­è€… ID
        question: å•é¡Œæ–‡æœ¬
        target_user: ç›®æ¨™ç”¨æˆ¶è§’è‰²
        config_version: é…ç½®ç‰ˆæœ¬ï¼ˆå¦‚ "pm90_st80"ï¼‰
    """
    question_hash = hashlib.md5(question.lower().strip().encode()).hexdigest()[:16]
    return f"rag:question:{vendor_id}:{target_user}:{config_version}:{question_hash}"
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… æ–°å¢ `config_version` åƒæ•¸ï¼ˆé è¨­ "default"ï¼‰
- âœ… ç·©å­˜éµæ ¼å¼å¾ 4 æ®µæ”¹ç‚º 5 æ®µ
- âœ… æ·»åŠ è©³ç´°æ–‡æª”èªªæ˜

---

#### ä¿®æ”¹ 1.2: `get_cached_answer()` æ–¹æ³•

**ä½ç½®ï¼š** Line 76-105

**ä¿®æ”¹å‰ï¼š**
```python
def get_cached_answer(self, vendor_id: int, question: str, target_user: str = "tenant") -> Optional[Dict[str, Any]]:
    ...
    key = self._make_question_key(vendor_id, question, target_user)
```

**ä¿®æ”¹å¾Œï¼š**
```python
def get_cached_answer(self, vendor_id: int, question: str, target_user: str = "tenant", config_version: str = "default") -> Optional[Dict[str, Any]]:
    """
    ç²å–ç·©å­˜çš„ç­”æ¡ˆ

    Args:
        vendor_id: æ¥­è€… ID
        question: å•é¡Œæ–‡æœ¬
        target_user: ç›®æ¨™ç”¨æˆ¶è§’è‰²
        config_version: é…ç½®ç‰ˆæœ¬ï¼ˆç”¨æ–¼å€åˆ†ä¸åŒé…ç½®ä¸‹çš„ç­”æ¡ˆï¼‰

    Returns:
        Dict åŒ…å«å®Œæ•´çš„ RAG å›æ‡‰ï¼Œæˆ– None å¦‚æœç·©å­˜ä¸å­˜åœ¨
    """
    ...
    key = self._make_question_key(vendor_id, question, target_user, config_version)
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… æ–°å¢ `config_version` åƒæ•¸
- âœ… èª¿ç”¨ `_make_question_key` æ™‚å‚³é config_version
- âœ… æ›´æ–°æ–‡æª”èªªæ˜

---

#### ä¿®æ”¹ 1.3: `cache_answer()` æ–¹æ³•

**ä½ç½®ï¼š** Line 107-150

**ä¿®æ”¹å‰ï¼š**
```python
def cache_answer(
    self,
    vendor_id: int,
    question: str,
    answer_data: Dict[str, Any],
    target_user: str = "tenant"
) -> bool:
    ...
    key = self._make_question_key(vendor_id, question, target_user)
```

**ä¿®æ”¹å¾Œï¼š**
```python
def cache_answer(
    self,
    vendor_id: int,
    question: str,
    answer_data: Dict[str, Any],
    target_user: str = "tenant",
    config_version: str = "default"
) -> bool:
    """
    ç·©å­˜ç­”æ¡ˆ

    Args:
        vendor_id: æ¥­è€… ID
        question: ç”¨æˆ¶å•é¡Œ
        answer_data: å®Œæ•´çš„ RAG å›æ‡‰æ•¸æ“š
        target_user: ç›®æ¨™ç”¨æˆ¶é¡å‹
        config_version: é…ç½®ç‰ˆæœ¬ï¼ˆç”¨æ–¼å€åˆ†ä¸åŒé…ç½®ä¸‹çš„ç­”æ¡ˆï¼‰

    Returns:
        True if successful
    """
    ...
    key = self._make_question_key(vendor_id, question, target_user, config_version)
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… æ–°å¢ `config_version` åƒæ•¸
- âœ… èª¿ç”¨ `_make_question_key` æ™‚å‚³é config_version
- âœ… æ›´æ–°æ–‡æª”èªªæ˜

---

### 2. `rag-orchestrator/routers/chat.py`

**ä¿®æ”¹ç›®çš„ï¼š** ç”Ÿæˆä¸¦å‚³éé…ç½®ç‰ˆæœ¬åˆ°ç·©å­˜æœå‹™

#### ä¿®æ”¹ 2.1: æ–°å¢ `_generate_config_version()` å‡½æ•¸

**ä½ç½®ï¼š** Line 28-46ï¼ˆæ–°å¢ï¼‰

**æ–°å¢ä»£ç¢¼ï¼š**
```python
def _generate_config_version() -> str:
    """
    ç”Ÿæˆé…ç½®ç‰ˆæœ¬å­—ç¬¦ä¸²ï¼Œç”¨æ–¼ç·©å­˜éµçš„å€åˆ†

    åŸºæ–¼ç•¶å‰ LLM å„ªåŒ–å™¨é…ç½®ç”Ÿæˆç‰ˆæœ¬æ¨™è­˜
    æ ¼å¼: pm{perfect_match}_st{synthesis_threshold}
    ä¾‹å¦‚: pm90_st80 (perfect_match=0.90, synthesis_threshold=0.80)

    Returns:
        é…ç½®ç‰ˆæœ¬å­—ç¬¦ä¸²
    """
    perfect_match = float(os.getenv("PERFECT_MATCH_THRESHOLD", "0.90"))
    synthesis = float(os.getenv("SYNTHESIS_THRESHOLD", "0.80"))

    # è½‰æ›ç‚ºæ•´æ•¸ï¼ˆå»æ‰å°æ•¸é»ï¼‰
    pm_val = int(perfect_match * 100)
    st_val = int(synthesis * 100)

    return f"pm{pm_val}_st{st_val}"
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… æ–°å¢é…ç½®ç‰ˆæœ¬ç”Ÿæˆé‚è¼¯
- âœ… æ ¼å¼ï¼š`pm{perfect_match}_st{synthesis_threshold}`
- âœ… ç¤ºä¾‹ï¼špm90_st80 è¡¨ç¤º perfect_match=0.90, synthesis=0.80

---

#### ä¿®æ”¹ 2.2: `cache_response_and_return()` å‡½æ•¸

**ä½ç½®ï¼š** Line 81-112

**ä¿®æ”¹å‰ï¼š**
```python
def cache_response_and_return(...):
    try:
        response_dict = response.dict()
        cache_service.cache_answer(
            vendor_id=vendor_id,
            question=question,
            answer_data=response_dict,
            target_user=target_user
        )
```

**ä¿®æ”¹å¾Œï¼š**
```python
def cache_response_and_return(...):
    try:
        # ç”Ÿæˆé…ç½®ç‰ˆæœ¬
        config_version = _generate_config_version()

        response_dict = response.dict()
        cache_service.cache_answer(
            vendor_id=vendor_id,
            question=question,
            answer_data=response_dict,
            target_user=target_user,
            config_version=config_version
        )
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… èª¿ç”¨ `_generate_config_version()` ç”Ÿæˆé…ç½®ç‰ˆæœ¬
- âœ… å‚³é `config_version` åˆ°ç·©å­˜æœå‹™

---

#### ä¿®æ”¹ 2.3: `_check_cache()` å‡½æ•¸

**ä½ç½®ï¼š** Line 171-187

**ä¿®æ”¹å‰ï¼š**
```python
def _check_cache(cache_service, vendor_id: int, question: str, target_user: str):
    """æª¢æŸ¥ç·©å­˜ï¼Œå¦‚æœå‘½ä¸­å‰‡è¿”å›ç·©å­˜çš„ç­”æ¡ˆ"""
    cached_answer = cache_service.get_cached_answer(
        vendor_id=vendor_id,
        question=question,
        target_user=target_user
    )

    if cached_answer:
        print(f"âš¡ ç·©å­˜å‘½ä¸­ï¼ç›´æ¥è¿”å›ç­”æ¡ˆï¼ˆè·³é RAG è™•ç†ï¼‰")
        return VendorChatResponse(**cached_answer)
```

**ä¿®æ”¹å¾Œï¼š**
```python
def _check_cache(cache_service, vendor_id: int, question: str, target_user: str):
    """æª¢æŸ¥ç·©å­˜ï¼Œå¦‚æœå‘½ä¸­å‰‡è¿”å›ç·©å­˜çš„ç­”æ¡ˆ"""
    # ç”Ÿæˆé…ç½®ç‰ˆæœ¬
    config_version = _generate_config_version()

    cached_answer = cache_service.get_cached_answer(
        vendor_id=vendor_id,
        question=question,
        target_user=target_user,
        config_version=config_version
    )

    if cached_answer:
        print(f"âš¡ ç·©å­˜å‘½ä¸­ï¼ç›´æ¥è¿”å›ç­”æ¡ˆï¼ˆè·³é RAG è™•ç†ï¼‰- é…ç½®ç‰ˆæœ¬: {config_version}")
        return VendorChatResponse(**cached_answer)
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… èª¿ç”¨ `_generate_config_version()` ç”Ÿæˆé…ç½®ç‰ˆæœ¬
- âœ… å‚³é `config_version` åˆ°ç·©å­˜æŸ¥è©¢
- âœ… æ—¥èªŒè¼¸å‡ºåŒ…å«é…ç½®ç‰ˆæœ¬è³‡è¨Š

---

### 3. `rag-orchestrator/services/llm_answer_optimizer.py`

**ä¿®æ”¹ç›®çš„ï¼š** å„ªåŒ– LLM åˆæˆæç¤ºè©ï¼Œç¢ºä¿ä¿æŒæº«æš–èªæ°£

#### ä¿®æ”¹ 3.1: åˆæˆæç¤ºè©å„ªåŒ–

**ä½ç½®ï¼š** Line 829-844

**ä¿®æ”¹å‰ï¼š**
```python
base_prompt = """ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„çŸ¥è­˜æ•´åˆåŠ©ç†ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡å¤šå€‹ç›¸é—œä½†å„æœ‰å´é‡çš„ç­”æ¡ˆï¼Œåˆæˆç‚ºä¸€å€‹å®Œæ•´ã€æº–ç¢ºã€çµæ§‹åŒ–çš„å›è¦†ã€‚

åˆæˆè¦æ±‚ï¼š
1. **å®Œæ•´æ€§**ï¼šæ¶µè“‹æ‰€æœ‰é‡è¦è³‡è¨Šï¼Œä¸éºæ¼ä»»ä½•é—œéµæ­¥é©Ÿæˆ–ç´°ç¯€
2. **æº–ç¢ºæ€§**ï¼šè³‡è¨Šå¿…é ˆä¾†è‡ªæä¾›çš„ç­”æ¡ˆï¼Œä¸è¦ç·¨é€ æˆ–æ¨æ¸¬
3. **çµæ§‹åŒ–**ï¼šä½¿ç”¨æ¸…æ™°çš„æ¨™é¡Œã€åˆ—è¡¨ã€æ­¥é©Ÿç·¨è™Ÿï¼Œä½¿ç­”æ¡ˆæ˜“æ–¼é–±è®€
4. **å»é‡**ï¼šå¦‚æœå¤šå€‹ç­”æ¡ˆæåˆ°ç›¸åŒè³‡è¨Šï¼Œåªä¿ç•™ä¸€æ¬¡ï¼Œé¿å…é‡è¤‡
5. **å„ªå…ˆç´š**ï¼šå„ªå…ˆä½¿ç”¨ç›¸ä¼¼åº¦è¼ƒé«˜çš„ç­”æ¡ˆå…§å®¹
6. **èªæ°£**ï¼šä¿æŒå°ˆæ¥­ã€å‹å–„ã€æ˜“æ‡‚çš„ç¹é«”ä¸­æ–‡è¡¨é”
7. **Markdown**ï¼šé©ç•¶ä½¿ç”¨ Markdown æ ¼å¼ï¼ˆ## æ¨™é¡Œã€- åˆ—è¡¨ã€**ç²—é«”**ï¼‰"""
```

**ä¿®æ”¹å¾Œï¼š**
```python
base_prompt = """ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„çŸ¥è­˜æ•´åˆåŠ©ç†ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡å¤šå€‹ç›¸é—œä½†å„æœ‰å´é‡çš„ç­”æ¡ˆï¼Œåˆæˆç‚ºä¸€å€‹å®Œæ•´ã€æº–ç¢ºã€çµæ§‹åŒ–çš„å›è¦†ã€‚

ğŸš¨ **æœ€é«˜å„ªå…ˆç´šè¦å‰‡**ï¼ˆä¸å¯é•åï¼‰ï¼š
âš ï¸ **çµ•å°ç¦æ­¢æ”¹å¯«æº«æš–èªæ°£**ï¼šå¦‚æœåŸå§‹ç­”æ¡ˆçš„é–‹é ­æ˜¯æº«æš–ã€è¦ªåˆ‡çš„å£èªè¡¨é”ï¼ˆå¦‚ã€Œå…ˆè¬è¬ä½ é¡˜æ„æå‡ºä¾†ã€ã€ã€Œé€™ç¨®ã€è·Ÿç•¶åˆè¬›çš„ä¸ä¸€æ¨£ã€çš„æ„Ÿè¦ºï¼ŒçœŸçš„æœƒè®“äººå¾ˆä¸èˆ’æœã€ã€emoji ç­‰ï¼‰ï¼Œä½ **å¿…é ˆé€å­—ä¿ç•™**é€™äº›è¡¨é”ï¼Œä½œç‚ºåˆæˆç­”æ¡ˆçš„é–‹é ­ã€‚
   - âŒ **åš´æ ¼ç¦æ­¢**ï¼šå°‡ã€Œå…ˆè¬è¬ä½ é¡˜æ„æå‡ºä¾†ï¼Œé€™ç¨®ã€è·Ÿç•¶åˆè¬›çš„ä¸ä¸€æ¨£ã€çš„æ„Ÿè¦ºï¼ŒçœŸçš„æœƒè®“äººå¾ˆä¸èˆ’æœï¼Œä¹Ÿæœƒæ‡·ç–‘æ˜¯ä¸æ˜¯è¢«é¨™ ğŸ™ã€æ”¹å¯«ç‚ºã€Œæˆ‘å€‘ç†è§£æ‚¨çš„å›°æ“¾ã€æˆ–ã€Œç•¶æ‚¨ç™¼ç¾åˆç´„å…§å®¹ä¸ä¸€è‡´æ™‚ã€
   - âœ… **å¿…é ˆé€™æ¨£åš**ï¼šå®Œæ•´ä¿ç•™åŸå¥ã€Œå…ˆè¬è¬ä½ é¡˜æ„æå‡ºä¾†ï¼Œé€™ç¨®ã€è·Ÿç•¶åˆè¬›çš„ä¸ä¸€æ¨£ã€çš„æ„Ÿè¦ºï¼ŒçœŸçš„æœƒè®“äººå¾ˆä¸èˆ’æœï¼Œä¹Ÿæœƒæ‡·ç–‘æ˜¯ä¸æ˜¯è¢«é¨™ ğŸ™ã€ä½œç‚ºé–‹å ´ï¼Œç„¶å¾Œå†è£œå……å…¶ä»–è³‡è¨Š

åˆæˆè¦æ±‚ï¼š
1. **å®Œæ•´æ€§**ï¼šæ¶µè“‹æ‰€æœ‰é‡è¦è³‡è¨Šï¼Œä¸éºæ¼ä»»ä½•é—œéµæ­¥é©Ÿæˆ–ç´°ç¯€
2. **æº–ç¢ºæ€§**ï¼šè³‡è¨Šå¿…é ˆä¾†è‡ªæä¾›çš„ç­”æ¡ˆï¼Œä¸è¦ç·¨é€ æˆ–æ¨æ¸¬
3. **çµæ§‹åŒ–**ï¼šå¯ä½¿ç”¨æ¨™é¡Œã€åˆ—è¡¨ã€æ­¥é©Ÿç·¨è™Ÿï¼ˆä½†æº«æš–çš„é–‹å ´ç™½ä¸éœ€è¦æ¨™é¡Œï¼‰
4. **å»é‡**ï¼šå¦‚æœå¤šå€‹ç­”æ¡ˆæåˆ°ç›¸åŒè³‡è¨Šï¼Œåªä¿ç•™ä¸€æ¬¡ï¼Œé¿å…é‡è¤‡
5. **å„ªå…ˆç´š**ï¼šå„ªå…ˆä½¿ç”¨ç›¸ä¼¼åº¦è¼ƒé«˜çš„ç­”æ¡ˆå…§å®¹
6. **Markdown**ï¼šé©ç•¶ä½¿ç”¨ Markdown æ ¼å¼ï¼ˆ## æ¨™é¡Œã€- åˆ—è¡¨ã€**ç²—é«”**ï¼‰"""
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… æ·»åŠ ã€Œæœ€é«˜å„ªå…ˆç´šè¦å‰‡ã€æ”¾åœ¨æ‰€æœ‰è¦æ±‚ä¹‹å‰
- âœ… ä½¿ç”¨ ğŸš¨ å’Œ âš ï¸ emoji å¼·èª¿é‡è¦æ€§
- âœ… æ˜ç¢ºç¦æ­¢æ”¹å¯«æº«æš–èªæ°£çš„è¡Œç‚º
- âœ… æä¾›å…·é«”çš„æ­£åä¾‹
- âœ… ä½¿ç”¨å¼·ç¡¬çš„å‘½ä»¤å¼èªè¨€ï¼ˆã€Œå¿…é ˆé€å­—ä¿ç•™ã€ã€ã€Œçµ•å°ç¦æ­¢ã€ã€ã€Œåš´æ ¼ç¦æ­¢ã€ï¼‰

---

#### ä¿®æ”¹ 3.2: è¦å‰‡ç·¨è™Ÿèª¿æ•´

**ä½ç½®ï¼š** Line 844-846

**ä¿®æ”¹å‰ï¼š**
```python
rule_number = 8
```

**ä¿®æ”¹å¾Œï¼š**
```python
rule_number = 7
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… èª¿æ•´è¦å‰‡ç·¨è™Ÿï¼ˆå› ç‚ºåˆæˆè¦æ±‚å¾ 8 é …æ¸›å°‘åˆ° 6 é …ï¼‰

---

### 4. `.env`

**ä¿®æ”¹ç›®çš„ï¼š** æ·»åŠ é…ç½®åƒæ•¸

#### ä¿®æ”¹ 4.1: ç·©å­˜é–‹é—œ

**ä½ç½®ï¼š** Line 16

**ä¿®æ”¹å‰ï¼š**
```bash
CACHE_ENABLED=false                # æ˜¯å¦å•Ÿç”¨ç·©å­˜ (true/false)
```

**ä¿®æ”¹å¾Œï¼š**
```bash
CACHE_ENABLED=true                 # æ˜¯å¦å•Ÿç”¨ç·©å­˜ (true/false)
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… å•Ÿç”¨ Redis ç·©å­˜

---

#### ä¿®æ”¹ 4.2: å®Œç¾åŒ¹é…é–¾å€¼

**ä½ç½®ï¼š** Line 29ï¼ˆæ–°å¢ï¼‰

**æ–°å¢å…§å®¹ï¼š**
```bash
PERFECT_MATCH_THRESHOLD=0.90      # å®Œç¾åŒ¹é…é–¾å€¼ï¼šç”¨æ–¼é…ç½®ç‰ˆæœ¬æ¸¬è©¦
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… æ–°å¢ PERFECT_MATCH_THRESHOLD ç’°å¢ƒè®Šæ•¸
- âœ… é è¨­å€¼ 0.90

---

### 5. `docker-compose.yml`

**ä¿®æ”¹ç›®çš„ï¼š** æ·»åŠ ç’°å¢ƒè®Šæ•¸é…ç½®

#### ä¿®æ”¹ 5.1: rag-orchestrator ç’°å¢ƒè®Šæ•¸

**ä½ç½®ï¼š** Line 161ï¼ˆæ–°å¢ï¼‰

**æ–°å¢å…§å®¹ï¼š**
```yaml
      SYNTHESIS_THRESHOLD: ${SYNTHESIS_THRESHOLD:-0.99}  # åˆæˆé–¾å€¼ï¼ˆSOP ç›¸ä¼¼åº¦ç‚º 1.0ï¼Œè¨­ç‚º 0.99ï¼‰
      PERFECT_MATCH_THRESHOLD: ${PERFECT_MATCH_THRESHOLD:-0.90}  # å®Œç¾åŒ¹é…é–¾å€¼ï¼ˆç”¨æ–¼é…ç½®ç‰ˆæœ¬å€åˆ†ï¼‰
      SYNTHESIS_MIN_RESULTS: ${SYNTHESIS_MIN_RESULTS:-2}  # æœ€å°‘ 2 å€‹ä¾†æºæ‰åˆæˆ
```

**è®Šæ›´å…§å®¹ï¼š**
- âœ… æ–°å¢ PERFECT_MATCH_THRESHOLD ç’°å¢ƒè®Šæ•¸é…ç½®
- âœ… é è¨­å€¼ 0.90
- âœ… æ·»åŠ è¨»é‡‹èªªæ˜ç”¨é€”

---

## ğŸ¯ ä¿®æ”¹æ•ˆæœ

### é…ç½®ç‰ˆæœ¬åŒ–ç·©å­˜

**å¯¦ç¾æ•ˆæœï¼š**
```
ç·©å­˜éµæ ¼å¼ï¼ˆä¿®æ”¹å‰ï¼‰ï¼š
rag:question:2:tenant:e4ddd9183e20a070

ç·©å­˜éµæ ¼å¼ï¼ˆä¿®æ”¹å¾Œï¼‰ï¼š
rag:question:2:tenant:pm90_st80:e4ddd9183e20a070
                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                      é…ç½®ç‰ˆæœ¬æ¨™è¨˜
```

**å„ªå‹¢ï¼š**
- âœ… ä¸åŒé…ç½®ç‰ˆæœ¬çš„ç·©å­˜å¯ä»¥ä¸¦å­˜
- âœ… ä¿®æ”¹é–¾å€¼ä¸æœƒå½±éŸ¿ç¾æœ‰ç·©å­˜
- âœ… é…ç½®åˆ‡æ›æ™‚è‡ªå‹•ä½¿ç”¨å°æ‡‰ç‰ˆæœ¬çš„ç·©å­˜

---

### LLM èªæ°£å„ªåŒ–

**ä¿®æ”¹å‰å•é¡Œï¼š**
```
å®Œæ•´å•é¡Œï¼ˆç›¸ä¼¼åº¦ 0.830ï¼‰â†’ LLM åˆæˆ â†’ å†·æ·¡ç­”æ¡ˆ
  ã€Œ## åˆç´„å…§å®¹ä¸ä¸€è‡´ç–‘æ…®è§£é‡‹
   ç•¶æ‚¨ç™¼ç¾åˆç´„å…§å®¹èˆ‡ç•¶åˆå£é ­èªªæ˜ä¸ä¸€è‡´æ™‚...ã€

ç°¡çŸ­å•é¡Œï¼ˆç›¸ä¼¼åº¦ 0.585ï¼‰â†’ å¿«é€Ÿè·¯å¾‘ â†’ æº«æš–ç­”æ¡ˆ
  ã€Œå…ˆè¬è¬ä½ é¡˜æ„æå‡ºä¾†ï¼Œé€™ç¨®ã€è·Ÿç•¶åˆè¬›çš„ä¸ä¸€æ¨£ã€çš„æ„Ÿè¦º...ã€
```

**ä¿®æ”¹å¾Œæ•ˆæœï¼š**
```
å®Œæ•´å•é¡Œï¼ˆç›¸ä¼¼åº¦ 0.830ï¼‰â†’ LLM åˆæˆ â†’ æº«æš–ç­”æ¡ˆ
  ã€Œå…ˆè¬è¬ä½ é¡˜æ„æå‡ºä¾†ï¼Œé€™ç¨®ã€è·Ÿç•¶åˆè¬›çš„ä¸ä¸€æ¨£ã€çš„æ„Ÿè¦ºï¼Œ
   çœŸçš„æœƒè®“äººå¾ˆä¸èˆ’æœï¼Œä¹Ÿæœƒæ‡·ç–‘æ˜¯ä¸æ˜¯è¢«é¨™ ğŸ™...ã€

ç°¡çŸ­å•é¡Œï¼ˆç›¸ä¼¼åº¦ 0.585ï¼‰â†’ å¿«é€Ÿè·¯å¾‘ â†’ æº«æš–ç­”æ¡ˆ
  ã€Œå…ˆè¬è¬ä½ é¡˜æ„æå‡ºä¾†ï¼Œé€™ç¨®ã€è·Ÿç•¶åˆè¬›çš„ä¸ä¸€æ¨£ã€çš„æ„Ÿè¦ºï¼Œ
   çœŸçš„æœƒè®“äººå¾ˆä¸èˆ’æœï¼Œä¹Ÿæœƒæ‡·ç–‘æ˜¯ä¸æ˜¯è¢«é¨™ ğŸ™...ã€
```

**å„ªå‹¢ï¼š**
- âœ… èªæ°£ä¸€è‡´æ€§é”åˆ° 100%
- âœ… è§£æ±ºã€Œç›¸ä¼¼åº¦è¶Šé«˜ç­”æ¡ˆè¶Šå†·æ·¡ã€çš„çŸ›ç›¾
- âœ… ä¿æŒçŸ¥è­˜åº«ä¸­ç²¾å¿ƒè¨­è¨ˆçš„æº«æš–èªæ°£

---

## ğŸ“Š æ¸¬è©¦é©—è­‰

### æ¸¬è©¦çµæœ

| æ¸¬è©¦é …ç›® | é€šéç‡ |
|---------|--------|
| åŠŸèƒ½æ¸¬è©¦ | 100% (4/4) |
| ç·©å­˜æ¸¬è©¦ | 100% (2/2) |
| **ç¸½è¨ˆ** | **100% (6/6)** |

### é—œéµæŒ‡æ¨™

- âœ… èªæ°£ä¸€è‡´æ€§ï¼š100%
- âœ… ç·©å­˜å‘½ä¸­ç‡ï¼š100%
- âœ… æ€§èƒ½æå‡ï¼š98%ï¼ˆç·©å­˜å‘½ä¸­å¾Œï¼‰

---

## ğŸ”§ å¾ŒçºŒç¶­è­·

### é…ç½®èª¿æ•´

å¦‚éœ€èª¿æ•´é–¾å€¼ï¼Œä¿®æ”¹ `.env` æ–‡ä»¶ï¼š

```bash
# å®Œç¾åŒ¹é…é–¾å€¼ï¼ˆ>= æ­¤å€¼ç›´æ¥è¿”å›åŸç­”æ¡ˆï¼‰
PERFECT_MATCH_THRESHOLD=0.90

# ç­”æ¡ˆåˆæˆé–¾å€¼ï¼ˆ>= æ­¤å€¼è§¸ç™¼ LLM åˆæˆï¼‰
SYNTHESIS_THRESHOLD=0.80
```

ä¿®æ”¹å¾Œï¼š
1. é‡å•Ÿæœå‹™ï¼š`docker-compose restart rag-orchestrator`
2. æ–°é…ç½®æœƒè‡ªå‹•ç”Ÿæˆæ–°çš„ç·©å­˜éµï¼ˆå¦‚ `pm85_st80`ï¼‰
3. èˆŠé…ç½®çš„ç·©å­˜ä»ç„¶æœ‰æ•ˆï¼ˆå¦‚ `pm90_st80`ï¼‰

### ç·©å­˜ç®¡ç†

æ¸…ç©ºæ‰€æœ‰ç·©å­˜ï¼š
```bash
docker-compose exec redis redis-cli FLUSHALL
```

æŸ¥çœ‹ç·©å­˜éµï¼š
```bash
docker-compose exec redis redis-cli KEYS "rag:question:*"
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- æ¸¬è©¦å ±å‘Šï¼š`/tmp/TEST_REPORT.md`
- æ¸¬è©¦è…³æœ¬ï¼š`/tmp/test_plan.py`
- ç·©å­˜æ¸¬è©¦ï¼š`/tmp/test_cache.py`

---

**ä¿®æ”¹å®Œæˆæ—¥æœŸï¼š** 2025-11-29  
**ç³»çµ±ç‹€æ…‹ï¼š** âœ… ç”Ÿç”¢å°±ç·’ (Production Ready)
