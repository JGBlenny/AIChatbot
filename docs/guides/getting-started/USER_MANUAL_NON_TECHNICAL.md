# 信義 AI 客服系統使用手冊（非技術版）

> **適用對象**：客服人員、業務人員、測試人員、管理層
> **最後更新**：2025-12-05
> **版本**：v2.0（已根據實際程式碼驗證修正）

---

## 目錄

1. [系統簡介](#系統簡介)
2. [對話邏輯說明](#對話邏輯說明)
3. [判斷機制](#判斷機制)
4. [如何有效測試](#如何有效測試)
5. [常見問題類型](#常見問題類型)
6. [測試檢查清單](#測試檢查清單)
7. [問題排查指南](#問題排查指南)

---

## 系統簡介

### 什麼是 AI 客服系統？

信義 AI 客服系統是一個**智能問答機器人**，能夠：

- ✅ **自動回答**租客、房東的常見問題
- ✅ **理解意圖**：知道用戶真正想問什麼
- ✅ **個性化回應**：根據不同角色（租客/房東/物管）給出不同答案
- ✅ **多層檢索**：優先使用 SOP，找不到時自動降級到知識庫或 AI 生成

### 系統核心能力

```
使用者提問 → 檢查緩存 → AI 理解意圖 → 搜尋 SOP/知識庫 → 優化答案 → 返回結果
```

---

## 對話邏輯說明

### 完整對話流程

當使用者提出問題時，系統會經過以下 **9 個步驟**：

```
┌─────────────────────────────────────────────────────────┐
│  步驟 1: 驗證業者狀態                                       │
│  確認業者 ID 有效且已啟用                                    │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步驟 2: 檢查緩存                                          │
│  如果相同問題最近被問過，直接返回緩存答案                      │
│  （提升回應速度，減少 AI 調用成本）                           │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步驟 3: 意圖分類                                          │
│  AI 判斷：這是什麼類型的問題？                               │
│  例如：「租金繳納」、「設備報修」、「合約問題」等                │
│  信心度：0.92（高信心，範圍 0-1）                            │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步驟 4: 檢索 SOP（最高優先級）                             │
│  不管意圖是什麼，都先嘗試在 SOP 中尋找答案                    │
│  ✅ 找到 SOP → 跳到步驟 9 使用 SOP 答案                      │
│  ❌ 沒找到 → 繼續往下                                       │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步驟 5: 處理不明確意圖                                     │
│  如果意圖是 "unclear"（信心度低）                            │
│  → 嘗試 RAG 向量搜尋（語義相似度檢索）                        │
│  → 找到答案則返回，找不到則記錄並返回兜底答案                   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步驟 6: 獲取意圖 ID                                       │
│  從資料庫查詢意圖對應的 ID                                   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步驟 7: 檢索知識庫（混合模式）                              │
│  使用意圖 + 向量相似度混合檢索                               │
│  - 過濾條件：意圖匹配、業者匹配、角色匹配                      │
│  - 排序依據：Scope 權重 > 相似度 > 人工優先級                 │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步驟 8: 處理找不到知識的情況                               │
│  如果知識庫沒有結果：                                        │
│  1️⃣ 優先檢查是否為參數型問題（如：繳費日期、客服電話）           │
│  2️⃣ 使用 RAG Fallback（降低相似度門檻再搜尋一次）             │
│  3️⃣ 都找不到 → 返回兜底答案並記錄到測試場景庫                  │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  步驟 9: LLM 優化並返回答案                                │
│  使用 AI 優化答案語氣、補充細節、替換參數                      │
│  - 注入業者參數（如：公司名稱、聯絡電話）                      │
│  - 根據信心度決定是否合成多個答案                             │
│  - 緩存答案以供後續使用                                      │
└─────────────────────────────────────────────────────────┘
```

### 範例說明

#### 範例 1: 租金繳納（標準流程）

**使用者問：**「租金每個月幾號要繳？」

**系統處理流程：**

1. **驗證業者** → 業者 ID=1，狀態正常 ✅
2. **檢查緩存** → 無緩存
3. **意圖分類** → 「租金繳納」（信心度 0.95）
4. **檢索 SOP** → 找到「租金繳納流程」SOP ✅
5. **跳過步驟 5-8**（已找到 SOP）
6. **LLM 優化** → 替換 `{{payment_day}}` 為實際日期「5 號」

**最終回答：**

```
租金繳納期限為每月 5 日前。

您可以透過以下方式繳納：
1. 登入 JGB 系統（網址：https://jgb.com）
2. 點選「租金繳納」功能
3. 選擇繳納月份並完成付款

⚠️ 逾期說明：超過期限將依合約收取滯納金

如有任何問題，請聯繫客服：0800-123-456
```

---

#### 範例 2: 意圖不明確的問題

**使用者問：**「那個怎麼弄？」

**系統處理流程：**

1-3. （同範例 1）
4. **意圖分類** → 「unclear」（信心度 0.35，太低）
5. **檢索 SOP** → 無相關 SOP
6. **處理 unclear** → 使用 RAG 向量搜尋
7. **RAG 結果** → 找不到相似內容
8. **記錄場景** → 記錄到測試場景庫
9. **返回兜底答案**

**最終回答：**

```
抱歉，我不太確定您指的是哪個部分。

為了更好地協助您，能否請您提供更多資訊？例如：
• 您想詢問租金繳納方式嗎？
• 或是設備報修流程？
• 或是其他問題？

如需立即協助，請撥打客服專線：0800-123-456
```

---

#### 範例 3: 知識庫檢索

**使用者問：**「可以養寵物嗎？」

**系統處理流程：**

1-3. （同範例 1）
4. **意圖分類** → 「物業規定」（信心度 0.88）
5. **檢索 SOP** → 無相關 SOP（此問題依房源而異）
6. **獲取意圖 ID** → intent_id = 8
7. **檢索知識庫** →
   - 找到 2 筆知識
   - 排序：customized scope (權重 1000) > 相似度 0.92
8. **LLM 優化** → 根據信心度 high，直接使用知識

**最終回答：**

```
關於寵物飼養規定：

本房源【允許飼養小型寵物】，但需遵守以下規範：
• 限飼養體重 10 公斤以下的貓或狗
• 需保持環境清潔，不得影響鄰居
• 退租時需進行寵物清潔（費用由租客負擔）

⚠️ 注意：未經許可飼養大型犬或特殊寵物，將視為違約

詳細規定請參考租賃合約第 X 條。
```

---

## 判斷機制

### 1. 意圖判斷（系統如何理解問題）

系統使用 **OpenAI Function Calling** 進行意圖分類，能識別以下意圖：

| 意圖類別 | 說明 | 範例問題 |
|---------|------|---------|
| 租金繳納 | 關於租金支付 | 「租金怎麼繳？」「幾號繳房租？」 |
| 合約問題 | 關於租約內容 | 「合約可以提前解約嗎？」 |
| 設備報修 | 設施故障維修 | 「冷氣壞了怎麼辦？」「水管漏水」 |
| 押金退還 | 押金相關 | 「退租時押金何時退？」 |
| 物業規定 | 社區規範 | 「可以養寵物嗎？」「可以裝潢嗎？」 |
| 投訴處理 | 客訴問題 | 「我要投訴」「你們都不處理」 |
| unclear | 無法判斷 | 「那個怎麼用？」「幫我處理一下」 |

**信心度評分標準：**（範圍 0-1，小數表示）

- **0.9-1.0**：非常確定，問題明確屬於此意圖
- **0.7-0.9**：較為確定，問題很可能屬於此意圖
- **0.5-0.7**：不太確定，問題可能屬於此意圖
- **< 0.5**：不確定，可能不屬於此意圖

**系統處理方式：**

| 信心度範圍 | 意圖判斷 | 系統行為 |
|-----------|---------|---------|
| ≥ 0.7 | 確定 | 直接使用該意圖進行檢索 |
| < 0.7 | unclear | 返回 unclear，使用 RAG 向量搜尋（不依賴意圖） |

> **重要**：文件中的信心度都是 **0-1 的小數**，不是百分比。
> 例如：0.85 表示 85% 信心度，0.70 表示 70% 信心度。

---

### 2. 角色判斷（誰在提問）

系統會根據 **API 請求中的 target_user 參數**判斷角色：

| 角色 | 英文代碼 | 關注重點 | 知識過濾 |
|-----|---------|---------|---------|
| 租客 | `tenant` | 租金、報修、使用規定 | 顯示標記為 tenant 或通用的知識 |
| 房東 | `landlord` | 租金收取、合約、稅務 | 顯示標記為 landlord 或通用的知識 |
| 管理師 | `property_manager` | 處理流程、系統操作 | 顯示標記為 property_manager 或通用的知識 |
| 系統管理 | `system_admin` | B2B 系統操作 | 顯示標記為 system_admin 的知識 |

**實際過濾邏輯**：(`vendor_knowledge_retriever.py:245-257`)

```sql
WHERE (kb.target_user IS NULL OR kb.target_user && ['tenant']::text[])
```

- `NULL` = 通用知識，適用所有角色
- 有值 = 只顯示給指定角色

**範例：**

- 「我的租金怎麼繳？」→ target_user='tenant'
- 「租客的租金何時入帳？」→ target_user='landlord'
- 「如何處理客訴案件？」→ target_user='property_manager'

---

### 3. 優先級判斷（答案來源排序）

當系統找到多個可能答案時，會按照以下**三層排序規則**：

#### 第一優先：Scope 權重

```
🥇 customized（客製化）: 權重 1000
   └─ 針對特定業者的專屬知識

🥈 vendor（業者）: 權重 500
   └─ 業者層級的知識

🥉 global（全域）: 權重 100
   └─ 通用知識，適用所有業者
```

#### 第二優先：語義相似度（向量相似度 + 意圖加成）

```
基礎相似度計算：
similarity = 1 - (embedding <=> query_embedding)

意圖加成：
• 主要意圖匹配：相似度 × 1.3
• 次要意圖匹配：相似度 × 1.1
• 無意圖匹配：相似度 × 1.0

最終排序分數 = 基礎相似度 × 意圖加成
```

#### 第三優先：人工優先級

```
知識庫中每筆知識都有 priority 欄位（預設 0）
數字越大，優先級越高
```

**完整排序 SQL**：(`vendor_knowledge_retriever.py:339-342`)

```sql
ORDER BY
    scope_weight DESC,        -- 1st: Scope 優先級
    boosted_similarity DESC,  -- 2nd: 加成後的相似度
    kb.priority DESC          -- 3rd: 人工優先級
```

---

### 4. SOP 檢索優先策略

系統遵循「**SOP 優先**」原則：

```
步驟 4（SOP 檢索）在步驟 7（知識庫檢索）之前執行
↓
不管意圖是什麼，都先嘗試在 SOP 中尋找答案
↓
只有在 SOP 找不到時，才會繼續檢索知識庫
```

**為什麼 SOP 優先？**

1. ✅ SOP 是標準作業流程，經過業者審核
2. ✅ SOP 更新頻率高，內容更準確
3. ✅ SOP 包含業者特定的操作細節

**實際程式碼**：(`chat.py:1141-1151`)

```python
# Step 4: 嘗試檢索 SOP（優先級最高）
if not request.skip_sop:
    sop_items = await _retrieve_sop(request, intent_result)
    if sop_items:
        print(f"✅ 找到 {len(sop_items)} 個 SOP 項目")
        return await _build_sop_response(...)  # 直接返回
    print(f"ℹ️  沒有找到 SOP，繼續其他流程")

# Step 7: 檢索知識庫（只有在 SOP 找不到時才執行）
knowledge_list = await _retrieve_knowledge(...)
```

---

## 如何有效測試

### 測試原則

1. **覆蓋各種角色**：分別用租客、房東、管理師身份測試
2. **測試邊界情況**：問一些模糊、複雜的問題
3. **驗證檢索優先級**：確認 SOP 優先於知識庫
4. **檢查回答品質**：答案是否完整、準確、易懂

---

### 測試方法 1: 基本功能測試

**目的：** 確認系統能正確回答常見問題

**測試步驟：**

1. 訪問測試網址：`http://localhost:8100/api/v1/message`
2. 發送 POST 請求，包含：
   ```json
   {
     "vendor_id": 1,
     "message": "租金怎麼繳？",
     "target_user": "tenant",
     "user_id": "test_user"
   }
   ```
3. 檢查回答內容
4. 記錄測試結果

**測試問題清單：**（見下方「測試檢查清單」）

---

### 測試方法 2: SOP 優先級測試

**目的：** 確認系統會優先使用 SOP

**測試步驟：**

| 步驟 | 操作 | 預期結果 |
|-----|------|---------|
| 1 | 準備一個同時有 SOP 和知識庫的問題 | - |
| 2 | 提問並查看後端日誌 | 應顯示「✅ 找到 X 個 SOP 項目」 |
| 3 | 檢查回答來源 | 應使用 SOP 內容，不使用知識庫 |
| 4 | 刪除該 SOP 後重新測試 | 應改用知識庫 |

---

### 測試方法 3: 意圖理解測試

**目的：** 確認系統能正確理解問題意圖

**測試技巧：**

用**不同說法**問同一件事，系統應該給出相似答案：

| 原始問題 | 變換說法 1 | 變換說法 2 | 變換說法 3 |
|---------|-----------|-----------|-----------|
| 租金怎麼繳？ | 我要付房租 | 如何繳納租金 | 房租繳費方式 |
| 可以養寵物嗎？ | 能養狗嗎？ | 社區允許養貓嗎？ | 寵物飼養規定 |
| 冷氣壞了 | 冷氣不冷 | 空調故障 | 冷氣維修 |

**檢查標準：**

- ✅ **正確**：所有變換說法都得到相同/相似答案
- ❌ **錯誤**：不同說法得到完全不同的答案

---

### 測試方法 4: 角色過濾測試

**目的：** 確認系統會根據角色給出不同答案

**準備工作：**

1. 在知識庫中準備兩筆知識：
   - 知識 A：target_user = ['tenant']，內容「租客版答案」
   - 知識 B：target_user = ['landlord']，內容「房東版答案」

**測試步驟：**

| 步驟 | 操作 | 預期結果 |
|-----|------|---------|
| 1 | 用 target_user='tenant' 提問 | 只返回知識 A |
| 2 | 用 target_user='landlord' 提問 | 只返回知識 B |
| 3 | 檢查後端日誌 | 確認 SQL 包含 target_user 過濾 |

---

### 測試方法 5: 壓力測試

**目的：** 測試系統處理複雜/模糊問題的能力

**測試問題類型：**

#### 5.1 多重問題

```
使用者問：「我想問租金怎麼繳，還有可以養寵物嗎？另外冷氣壞了怎麼辦？」
```

**檢查點：**
- ✅ 系統應該依序回答每個問題
- ✅ 或者建議用戶分開提問

---

#### 5.2 模糊問題

```
使用者問：「那個東西怎麼用？」
```

**檢查點：**
- ✅ 意圖應為 "unclear"
- ✅ 系統應該請用戶說明具體內容

---

#### 5.3 超出範圍問題

```
使用者問：「台北明天天氣如何？」
```

**檢查點：**
- ✅ 系統應該禮貌地說明這不在服務範圍
- ✅ 或返回「找不到相關知識」

---

#### 5.4 情緒化問題

```
使用者問：「你們公司都不處理問題，我要投訴！！！」
```

**檢查點：**
- ✅ 系統應該以安撫語氣回答
- ✅ 提供投訴管道和聯絡方式
- ✅ 意圖應識別為「投訴處理」

---

## 常見問題類型

### 類型 1: 租金相關（高頻）

| 問題 | 優先答案來源 | 涉及角色 |
|-----|------------|---------|
| 租金怎麼繳？ | SOP | tenant |
| 租金幾號繳？ | SOP | tenant |
| 可以延遲繳納嗎？ | SOP | tenant |
| 遲繳會怎樣？ | SOP | tenant |
| 租金何時入帳？ | SOP | landlord |

---

### 類型 2: 設備報修（高頻）

| 問題 | 優先答案來源 | 涉及角色 |
|-----|------------|---------|
| 冷氣壞了 | SOP / 知識庫 | tenant |
| 水管漏水 | SOP | tenant |
| 門鎖壞了 | SOP | tenant |
| 燈泡不亮 | 知識庫 | tenant |

---

### 類型 3: 物業規定（中頻）

| 問題 | 優先答案來源 | 涉及角色 |
|-----|------------|---------|
| 可以養寵物嗎？ | 知識庫 | tenant |
| 可以裝潢嗎？ | SOP / 知識庫 | tenant |
| 垃圾怎麼丟？ | 知識庫 | tenant |
| 可以轉租嗎？ | SOP | tenant, landlord |

---

### 類型 4: 合約相關（中頻）

| 問題 | 優先答案來源 | 涉及角色 |
|-----|------------|---------|
| 如何解約？ | SOP | tenant, landlord |
| 押金何時退？ | SOP | tenant |
| 合約到期怎麼辦？ | SOP | tenant |
| 可以換房嗎？ | 知識庫 | tenant |

---

### 類型 5: 投訴處理（低頻但重要）

| 問題 | 優先答案來源 | 涉及角色 |
|-----|------------|---------|
| 我要投訴 | SOP | all |
| 問題都不處理 | 知識庫 | all |
| 管理師態度差 | SOP | all |

---

## 測試檢查清單

### 基礎功能測試（必測）

```
□ 1. 租金繳納（租客角色）
   問：「租金怎麼繳？」
   target_user: tenant
   預期：提供租客繳納流程

□ 2. 租金入帳（房東角色）
   問：「租金何時入帳？」
   target_user: landlord
   預期：提供房東收款資訊

□ 3. 設備報修
   問：「冷氣壞了」
   target_user: tenant
   預期：提供報修流程和聯絡方式

□ 4. 物業規定
   問：「可以養寵物嗎？」
   target_user: tenant
   預期：說明寵物飼養規定

□ 5. 合約問題
   問：「如何解約？」
   target_user: tenant
   預期：說明解約流程和注意事項

□ 6. SOP 優先檢查
   問：「租金幾號繳？」（同時有 SOP 和知識庫）
   預期：使用 SOP 答案，日誌顯示「找到 X 個 SOP」

□ 7. 模糊問題處理
   問：「那個怎麼用？」
   預期：意圖為 unclear，請求用戶澄清

□ 8. 超出範圍
   問：「台北天氣如何？」
   預期：禮貌說明不在服務範圍或找不到知識

□ 9. 情緒化問題
   問：「你們都不處理！」
   預期：安撫語氣 + 提供解決方案

□ 10. 緩存測試
   問同樣問題兩次
   預期：第二次應更快（使用緩存）
```

---

### 進階測試（選測）

```
□ 11. 多輪對話
   問1：「我想問租金的事」
   答1：「請問您想了解租金的哪方面呢？」
   問2：「繳納方式」
   預期：回答租金繳納方式

□ 12. 同義詞理解
   「租金」vs「房租」vs「租屋費用」
   預期：回答一致

□ 13. 錯別字容忍
   「租金怎麼交？」（交→繳）
   預期：仍能正確理解

□ 14. 口語化問題
   「欸那個房租要怎麼給啊？」
   預期：正確回答

□ 15. 複合問題
   「租金怎麼繳？幾號繳？」
   預期：分別回答或整合回答

□ 16. RAG Fallback 測試
   問一個沒有明確意圖但知識庫有相似內容的問題
   預期：使用向量搜尋找到答案

□ 17. 優先級排序驗證
   創建 3 筆知識：customized、vendor、global
   預期：優先返回 customized

□ 18. 意圖加成驗證
   同一問題匹配主要意圖 vs 次要意圖
   預期：主要意圖的知識排序更前
```

---

## 問題排查指南

### 情況 1: 回答不正確

**可能原因：**

1. ❌ SOP / 知識庫沒有相關資料
2. ❌ 意圖判斷錯誤
3. ❌ 角色過濾錯誤
4. ❌ 優先級排序問題

**排查步驟：**

```
步驟 1: 檢查後端日誌
       └─ 查看意圖分類結果、信心度
       └─ 查看 SOP 檢索結果
       └─ 查看知識庫檢索結果

步驟 2: 確認資料存在
       └─ 登入管理後台檢查 SOP / 知識庫
       └─ 確認 target_user 設定正確

步驟 3: 檢查意圖判斷
       └─ 如果信心度低（< 0.7），可能需要優化問法
       └─ 或在資料庫中添加該意圖的關鍵字

步驟 4: 檢查優先級
       └─ 確認 scope 設定（customized > vendor > global）
       └─ 確認 priority 欄位值

步驟 5: 回報問題
       └─ 記錄：問題內容、實際回答、預期回答、後端日誌
       └─ 提供給技術團隊
```

---

### 情況 2: 回答不完整

**可能原因：**

1. ❌ 知識內容不夠詳細
2. ❌ 系統截斷過長內容
3. ❌ LLM 優化時省略部分資訊

**處理方式：**

- 建議：將完整資訊加入 SOP / 知識庫
- 或：在知識庫中補充詳細說明
- 檢查：LLM 優化配置（max_tokens 設定）

---

### 情況 3: 回答速度慢

**可能原因：**

1. ⏱️ 系統負載高
2. ⏱️ AI 處理複雜問題
3. ⏱️ 向量搜尋效能問題
4. ⏱️ 緩存未命中

**正常回應時間：**

- 緩存命中：< 0.5 秒
- 簡單問題：1-3 秒
- 一般問題：3-5 秒
- 複雜問題：5-8 秒

**超過 10 秒：** 建議回報技術團隊

---

### 情況 4: 系統無法理解問題

**可能原因：**

1. ❓ 問題太模糊
2. ❓ 使用非標準用詞
3. ❓ 問題超出範圍
4. ❓ 意圖分類器未訓練該類型

**改善方式：**

- ✅ 使用更具體的問法
- ✅ 加入關鍵字（如：租金、報修、合約）
- ✅ 分段提問（一次問一件事）
- ✅ 建議技術團隊新增該意圖類型

---

### 情況 5: SOP 應該優先但沒有

**可能原因：**

1. ❌ SOP 未正確關聯意圖
2. ❌ SOP 的 is_active 設為 false
3. ❌ SOP 的向量嵌入未生成

**排查步驟：**

```
步驟 1: 檢查後端日誌
       └─ 查看是否顯示「沒有找到 SOP」

步驟 2: 檢查 SOP 配置
       └─ 確認 vendor_sop_item_intents 表有正確關聯
       └─ 確認 is_active = true

步驟 3: 檢查向量嵌入
       └─ 確認 primary_embedding 或 fallback_embedding 不為 NULL

步驟 4: 重新生成嵌入
       └─ 執行 SOP 嵌入生成腳本
```

---

## 測試記錄範本

### 測試報告表格

```markdown
## 測試日期：2025-12-05
## 測試人員：XXX
## 系統版本：v2.0

| 編號 | 測試問題 | target_user | 預期答案來源 | 實際答案來源 | 結果 | 備註 |
|-----|---------|------------|------------|------------|------|------|
| 1 | 租金怎麼繳？ | tenant | SOP | ✅ SOP | PASS | 信心度 0.95 |
| 2 | 冷氣壞了 | tenant | SOP | ✅ SOP | PASS | - |
| 3 | 可以養寵物嗎？ | tenant | 知識庫 | ✅ 知識庫 | PASS | customized scope |
| 4 | 那個怎麼用？ | tenant | unclear → RAG | ✅ unclear | PASS | 返回兜底答案 |
| 5 | 租金何時入帳？ | landlord | SOP | ❌ 知識庫 | FAIL | SOP 未關聯房東角色 |
```

---

## 最佳實踐建議

### 給測試人員

1. **系統化測試**：按照檢查清單逐項測試
2. **記錄詳細**：每個問題都記錄結果和後端日誌
3. **覆蓋多樣**：測試各種角色、情境
4. **定期測試**：每次系統更新後都要重測
5. **關注日誌**：後端日誌包含關鍵判斷資訊

### 給客服人員

1. **理解系統**：知道 AI 如何判斷和回答（9 步驟流程）
2. **補充說明**：AI 回答不完整時人工補充
3. **回報問題**：遇到錯誤答案立即回報（附上問題和預期答案）
4. **優化知識**：建議新增常見問題到 SOP / 知識庫

### 給管理層

1. **監控品質**：定期檢查回答準確度
2. **分析趨勢**：了解使用者常問哪些問題（從測試場景庫分析）
3. **持續優化**：根據數據調整 SOP / 知識庫
4. **訓練團隊**：確保所有人了解系統運作邏輯

---

## 附錄：測試用問題庫

### A. 租金類（15 題）

```
1. 租金怎麼繳？
2. 租金幾號要繳？
3. 可以延遲繳租嗎？
4. 忘記繳租金怎麼辦？
5. 租金可以分期嗎？
6. 租金包含什麼費用？
7. 租金會調漲嗎？
8. 如何查詢繳費紀錄？
9. 可以用現金繳租嗎？
10. 租金收據在哪裡？
11. 遲繳會罰款嗎？
12. 租金可以退還嗎？
13. 提前繳租有優惠嗎？
14. 租金發票怎麼開？
15. 租金匯款帳號是？（房東角色）
```

### B. 設備報修類（10 題）

```
1. 冷氣壞了怎麼辦？
2. 水管漏水
3. 馬桶不通
4. 門鎖壞了
5. 燈泡不亮
6. 熱水器壞了
7. 窗戶關不緊
8. 牆壁漏水
9. 網路不通
10. 瓦斯爐故障
```

### C. 物業規定類（10 題）

```
1. 可以養寵物嗎？
2. 可以裝潢嗎？
3. 可以釘牆壁嗎？
4. 垃圾怎麼丟？
5. 可以轉租嗎？
6. 可以分租嗎？
7. 可以開伙嗎？
8. 可以養貓嗎？
9. 幾點後不能吵鬧？
10. 可以在陽台曬衣服嗎？
```

### D. 合約類（10 題）

```
1. 如何解約？
2. 押金何時退？
3. 合約到期怎麼辦？
4. 可以續約嗎？
5. 提前解約要賠償嗎？
6. 合約可以更改嗎？
7. 如何申請退租？
8. 合約到期多久前要通知？
9. 押金可以抵租金嗎？
10. 合約遺失怎麼辦？
```

### E. 緊急狀況類（5 題）

```
1. 火災怎麼辦？
2. 地震怎麼辦？
3. 瓦斯外洩
4. 停電了
5. 淹水了
```

### F. 邊界測試類（10 題）

```
1. 那個怎麼用？（模糊問題）
2. 幫我處理一下（不明確）
3. 台北天氣如何？（超出範圍）
4. 你們都不處理！（情緒化）
5. 租金怎麼繳？可以養寵物嗎？冷氣壞了（複合問題）
6. 租金幾號交？（錯別字：交→繳）
7. 欸那個房租要怎麼給啊？（口語化）
8. 我要問問租金的事情（不具體）
9. ？？？（無意義）
10. 123456（無意義數字）
```

---

## 技術細節參考

### 程式碼位置對照表

| 功能 | 檔案路徑 | 行數 |
|-----|---------|-----|
| 主對話流程 | `rag-orchestrator/routers/chat.py` | 1111-1185 |
| 意圖分類器 | `rag-orchestrator/services/intent_classifier.py` | 184-363 |
| 知識庫檢索（含角色過濾） | `rag-orchestrator/services/vendor_knowledge_retriever.py` | 191-400 |
| SOP 檢索 | `rag-orchestrator/services/vendor_sop_retriever.py` | 66-148, 150-400 |
| 答案優化 | `rag-orchestrator/services/llm_answer_optimizer.py` | 149-975 |

### 環境變數配置

| 變數名稱 | 預設值 | 說明 |
|---------|-------|------|
| `KB_SIMILARITY_THRESHOLD` | 0.65 | 知識庫相似度門檻 |
| `FALLBACK_SIMILARITY_THRESHOLD` | 0.55 | RAG Fallback 相似度門檻 |
| `RAG_TOP_K` | 3 | 檢索結果數量 |
| `INTENT_CLASSIFIER_MODEL` | gpt-3.5-turbo | 意圖分類模型 |

---

## 聯絡資訊

**遇到問題時：**

- 📧 Email: support@shinyi.com
- 📞 客服專線: 0800-XXX-XXX
- 💬 內部群組: Slack #ai-support

**文件維護者：** AI 開發團隊
**最後更新：** 2025-12-05

---

## 版本記錄

| 版本 | 日期 | 更新內容 |
|-----|------|---------|
| v1.0 | 2025-12-05 | 初版發布 |
| v2.0 | 2025-12-05 | 🔥 **重大更新**：根據實際程式碼驗證並修正<br>• 修正對話流程：從 6 步驟改為 9 步驟<br>• 修正意圖信心度：改用 0-1 小數表示<br>• 刪除金流動態調整（實際不存在此功能）<br>• 新增 SOP 優先策略說明<br>• 新增角色過濾機制詳細說明<br>• 新增優先級排序三層規則<br>• 更新所有範例以符合實際行為 |

---

## 文件驗證記錄

**驗證日期**：2025-12-05
**驗證方法**：逐行比對實際程式碼
**驗證檔案**：
- ✅ `chat.py` (主流程)
- ✅ `intent_classifier.py` (意圖判斷)
- ✅ `vendor_knowledge_retriever.py` (知識檢索、角色過濾、優先級)
- ✅ `vendor_sop_retriever.py` (SOP 檢索)
- ✅ `llm_answer_optimizer.py` (答案優化)
- ✅ `sop_utils.py` (工具函數)
- ✅ `database/init/11-create-sop-system.sql` (資料庫結構)

**驗證結果**：所有描述已與實際程式碼一致 ✅
