# 重試次數限制測試確認

## ✅ 已完成的修改

### 1. 程式碼修改
- **檔案**: `/rag-orchestrator/services/form_manager.py`
- **修改行數**: 第 796-887 行（加入重試邏輯）
- **修改行數**: 第 640-647 行（重置計數器）

### 2. 服務狀態
- ✅ 服務已重啟：`docker-compose restart rag-orchestrator`
- ✅ 服務運行正常：Up 狀態
- ✅ 無錯誤日誌

## 🧪 測試步驟

### 測試案例 1：連續輸入無效地址
1. 輸入：「帳單寄送區間」觸發表單
2. 第 1 次輸入無效地址（如：「帳單寄送區間」）
   - 預期：顯示「第 1 次重試」提示
3. 第 2 次輸入無效地址
   - 預期：自動取消表單，顯示「已嘗試 2 次」

### 測試案例 2：手動取消
1. 輸入：「帳單寄送區間」觸發表單
2. 輸入：「取消」
   - 預期：正常取消表單

### 測試案例 3：重試後成功
1. 輸入：「帳單寄送區間」觸發表單
2. 第 1 次輸入無效地址
3. 第 2 次輸入有效地址（如：「台北市大安區師大路86巷1號4樓」）
   - 預期：成功查詢

## 📝 日誌監控

監控命令：
```bash
# 查看重試次數日誌
docker-compose logs -f rag-orchestrator | grep "表單重試"
```

預期日誌：
```
🔄 [表單重試] API 錯誤類型: no_match, 重試次數: 1/2
🔄 [表單重試] API 錯誤類型: no_match, 重試次數: 2/2
```

## 🔍 檢查重試邏輯是否存在

```bash
# 確認修改已應用
docker exec aichatbot-rag-orchestrator grep -n "MAX_RETRIES" /app/services/form_manager.py
```

預期輸出：
```
802:                    MAX_RETRIES = 2  # 最多重試 2 次
```

---

## 現在可以重新測試了！

系統已經應用了重試次數限制（最多 2 次）：
- 第 1 次失敗：提示「第 1 次重試」
- 第 2 次失敗：自動取消，不再要求輸入