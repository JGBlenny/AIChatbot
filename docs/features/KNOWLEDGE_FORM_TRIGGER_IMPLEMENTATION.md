# çŸ¥è­˜åº«è¡¨å–®è§¸ç™¼æ¨¡å¼å¯¦ç¾æ–‡æª”

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2026-02-03
**ç‹€æ…‹**: âœ… å·²å®Œæˆ
**ä½œè€…**: AI Chatbot Development Team

---

## ğŸ“‹ ç›®éŒ„

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [èƒŒæ™¯èˆ‡å•é¡Œ](#èƒŒæ™¯èˆ‡å•é¡Œ)
3. [ç³»çµ±æ¶æ§‹](#ç³»çµ±æ¶æ§‹)
4. [è§¸ç™¼æ¨¡å¼èªªæ˜](#è§¸ç™¼æ¨¡å¼èªªæ˜)
5. [å¯¦ç¾ç´°ç¯€](#å¯¦ç¾ç´°ç¯€)
6. [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ)
7. [æ¸¬è©¦æ¡ˆä¾‹](#æ¸¬è©¦æ¡ˆä¾‹)
8. [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)
9. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## æ¦‚è¿°

### åŠŸèƒ½ç›®æ¨™

å¯¦ç¾çŸ¥è­˜åº«èˆ‡ SOP ç³»çµ±çš„è¡¨å–®è§¸ç™¼æ¨¡å¼çµ±ä¸€ï¼Œæ”¯æ´ä»¥ä¸‹ä¸‰ç¨®è§¸ç™¼æ¨¡å¼ï¼š

- âœ… **Manualï¼ˆæ’æŸ¥å‹ï¼‰**ï¼šé¡¯ç¤ºå…§å®¹ â†’ ç­‰å¾…ç”¨æˆ¶é—œéµè©ç¢ºèª â†’ è§¸ç™¼è¡¨å–®
- âœ… **Immediateï¼ˆè¡Œå‹•å‹ï¼‰**ï¼šé¡¯ç¤ºå…§å®¹ â†’ ç«‹å³è©¢å•ç¢ºèª â†’ ç­‰å¾…é—œéµè© â†’ è§¸ç™¼è¡¨å–®
- âœ… **Autoï¼ˆè‡ªå‹•å‹ï¼‰**ï¼šé¡¯ç¤ºå…§å®¹ â†’ è‡ªå‹•è§¸ç™¼è¡¨å–®

### æ ¸å¿ƒç‰¹æ€§

1. **çµ±ä¸€æ¶æ§‹**ï¼šçŸ¥è­˜åº«ä½¿ç”¨ SOP çš„è§¸ç™¼è™•ç†é‚è¼¯
2. **å…§å­˜å‚™æ´**ï¼šRedis æœªå•Ÿç”¨æ™‚ä½¿ç”¨å…§å­˜å­˜å„² context
3. **é¿å…é‡è¤‡**ï¼šè¡¨å–®å®Œæˆå¾Œä¸é‡è¤‡é¡¯ç¤ºçŸ¥è­˜å…§å®¹
4. **é—œéµè©é…ç½®**ï¼šé è¨­è§¸ç™¼é—œéµè©ç‚º `['æ˜¯', 'è¦']`
5. **æ¸¬è©¦å‹å¥½**ï¼šæä¾›å®Œæ•´çš„æ¸¬è©¦çŸ¥è­˜åº«é …ç›®

---

## èƒŒæ™¯èˆ‡å•é¡Œ

### æ¥­å‹™éœ€æ±‚

åœ¨åŒ…ç§Ÿä»£ç®¡æ¥­å‹™ä¸­ï¼ŒçŸ¥è­˜åº«é …ç›®éœ€è¦æ”¯æ´èˆ‡ SOP ç›¸åŒçš„è¡¨å–®è§¸ç™¼æ¨¡å¼ï¼š

**å ´æ™¯ 1ï¼šæ’æŸ¥å‹ï¼ˆManualï¼‰**
```
ç”¨æˆ¶ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€
AIï¼šï¼ˆé¡¯ç¤ºç§Ÿæˆ¿æµç¨‹èªªæ˜ï¼‰

    ğŸ’¡ éœ€è¦å®‰æ’è™•ç†å—ï¼Ÿ
    â€¢ å›è¦†ã€Œæ˜¯ã€æˆ–ã€Œè¦ã€â†’ ç«‹å³å¡«å¯«è¡¨å–®
    â€¢ å›è¦†ã€Œä¸ç”¨ã€â†’ ç¹¼çºŒç‚ºæ‚¨è§£ç­”å…¶ä»–å•é¡Œ

ç”¨æˆ¶ï¼šã€Œæ˜¯ã€
AIï¼šï¼ˆè§¸ç™¼ç§Ÿæˆ¿ç”³è«‹è¡¨å–®ï¼‰
```

**å ´æ™¯ 2ï¼šè¡Œå‹•å‹ï¼ˆImmediateï¼‰**
```
ç”¨æˆ¶ï¼šã€Œæˆ‘è¦é€€ç§Ÿã€
AIï¼šï¼ˆé¡¯ç¤ºé€€ç§Ÿæµç¨‹èªªæ˜ï¼‰
    æ˜¯å¦éœ€è¦å”åŠ©æ‚¨å¡«å¯«é€€ç§Ÿç”³è«‹è¡¨ï¼Ÿ

ç”¨æˆ¶ï¼šã€Œè¦ã€
AIï¼šï¼ˆè§¸ç™¼é€€ç§Ÿè¡¨å–®ï¼‰
```

**å ´æ™¯ 3ï¼šè‡ªå‹•å‹ï¼ˆAutoï¼‰**
```
ç”¨æˆ¶ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€
AIï¼šï¼ˆé¡¯ç¤ºç§Ÿæˆ¿æµç¨‹èªªæ˜ï¼‰
    ï¼ˆè‡ªå‹•è§¸ç™¼ç§Ÿæˆ¿ç”³è«‹è¡¨å–®ï¼Œç„¡éœ€ç¢ºèªï¼‰
```

### é‡åˆ°çš„å•é¡Œ

#### å•é¡Œ 1ï¼šçŸ¥è­˜åº«ä¸æ”¯æ´ Manual/Immediate æ¨¡å¼

**ç¾è±¡**ï¼š
```python
# routers/chat.py:1540-1545
elif trigger_mode in ['manual', 'immediate']:
    print(f"   âš ï¸ trigger_mode={trigger_mode} æš«ä¸æ”¯æ´ï¼Œé™ç´šç‚º direct_answer")
    return _build_simple_answer(...)
```

**å½±éŸ¿**ï¼š
- çŸ¥è­˜åº«åªæ”¯æ´ auto æ¨¡å¼ï¼ˆç›´æ¥è§¸ç™¼ï¼‰
- Manual å’Œ Immediate æ¨¡å¼è¢«é™ç´šç‚ºç´”çŸ¥è­˜å•ç­”
- ç„¡æ³•å¯¦ç¾ã€Œè©¢å•ç¢ºèª â†’ è§¸ç™¼è¡¨å–®ã€çš„æµç¨‹

#### å•é¡Œ 2ï¼šç¼ºå°‘å…§å­˜å‚™æ´æ©Ÿåˆ¶

**ç¾è±¡**ï¼š
```
âš ï¸ Redis æœªå•Ÿç”¨ï¼Œè·³é SOP Context å­˜å„²
```

**å½±éŸ¿**ï¼š
- ç”¨æˆ¶ç¬¬ä¸€æ¬¡å•ã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€â†’ é¡¯ç¤ºå…§å®¹ + æç¤º
- ç”¨æˆ¶å›è¦†ã€Œæ˜¯ã€â†’ ç³»çµ±ç„¡æ³•è­˜åˆ¥é€™æ˜¯ç¢ºèªï¼Œç•¶ä½œæ–°å•é¡Œè™•ç†

#### å•é¡Œ 3ï¼šSQL æŸ¥è©¢ç¼ºå°‘æ¬„ä½

**ç¾è±¡**ï¼š
context ä¸­çš„ trigger_keywords ç‚ºç©ºé™£åˆ—

**åŸå› **ï¼š
`vendor_knowledge_retriever.py` çš„ SQL æŸ¥è©¢æœªé¸å– `trigger_keywords` å’Œ `trigger_mode` æ¬„ä½

#### å•é¡Œ 4ï¼šè¡¨å–®å®Œæˆå¾Œé‡è¤‡é¡¯ç¤ºçŸ¥è­˜å…§å®¹

**ç¾è±¡**ï¼š
```
ç”¨æˆ¶ï¼šã€Œæ˜¯ã€
AIï¼šâœ… è¡¨å–®å¡«å¯«å®Œæˆï¼

ï¼ˆåˆé¡¯ç¤ºä¸€æ¬¡ç§Ÿæˆ¿æµç¨‹èªªæ˜ï¼‰
```

**åŸå› **ï¼š
è¡¨å–®è¨­å®š `on_complete_action='show_knowledge'`ï¼Œä½†ç”¨æˆ¶åœ¨è§¸ç™¼è¡¨å–®æ™‚å·²ç¶“çœ‹éçŸ¥è­˜å…§å®¹äº†ã€‚

---

## ç³»çµ±æ¶æ§‹

### æ•´é«”æ¶æ§‹

```
ç”¨æˆ¶å•é¡Œ
    â†“
æª¢ç´¢çŸ¥è­˜åº«
    â†“
æª¢æŸ¥ action_type å’Œ trigger_mode
    â†“
    â”œâ”€ action_type = 'direct_answer' â”€â”€â”€â”€â†’ ç›´æ¥è¿”å›ç­”æ¡ˆ
    â”‚
    â”œâ”€ action_type = 'form_fill'
    â”‚       â†“
    â”‚   trigger_mode æ˜¯ä»€éº¼ï¼Ÿ
    â”‚       â”œâ”€ NULL â”€â”€â”€â”€â”€â”€â†’ ç›´æ¥è§¸ç™¼è¡¨å–®ï¼ˆèˆŠè¡Œç‚ºï¼Œä¿æŒå…¼å®¹ï¼‰
    â”‚       â”œâ”€ 'auto' â”€â”€â”€â”€â†’ ç›´æ¥è§¸ç™¼è¡¨å–®
    â”‚       â”œâ”€ 'manual' â”€â”€â†’ ä½¿ç”¨ SOP Orchestrator è™•ç†
    â”‚       â””â”€ 'immediate' â†’ ä½¿ç”¨ SOP Orchestrator è™•ç†
    â”‚
    â””â”€ action_type = 'api_call' â”€â”€â”€â”€â”€â”€â†’ èª¿ç”¨ API
```

### SOP Orchestrator è™•ç†æµç¨‹

```
SOP Orchestrator
    â†“
æª¢æŸ¥æ˜¯å¦æœ‰å¾…è™•ç† context
    â”œâ”€ æœ‰ context
    â”‚   â†“
    â”‚   æª¢æŸ¥ç”¨æˆ¶è¨Šæ¯æ˜¯å¦åŒ¹é…é—œéµè©
    â”‚       â”œâ”€ åŒ¹é… â†’ åˆªé™¤ contextï¼Œè¿”å› triggered
    â”‚       â””â”€ ä¸åŒ¹é… â†’ ä¿æŒç­‰å¾…ï¼Œè¿”å›æç¤º
    â”‚
    â””â”€ ç„¡ context
        â†“
        é¦–æ¬¡è§¸ç™¼
            â”œâ”€ auto æ¨¡å¼ â†’ è¿”å› execute_immediately
            â”œâ”€ manual æ¨¡å¼ â†’ å„²å­˜ contextï¼Œè¿”å›ç­‰å¾…å›æ‡‰ï¼ˆå¸¶é—œéµè©æç¤ºï¼‰
            â””â”€ immediate æ¨¡å¼ â†’ å„²å­˜ contextï¼Œè¿”å›ç­‰å¾…å›æ‡‰ï¼ˆå¸¶è©¢å•æç¤ºï¼‰
```

### Context å­˜å„²æ©Ÿåˆ¶

```
Context å­˜å„²
    â”œâ”€ Redis å•Ÿç”¨
    â”‚   â””â”€ ä½¿ç”¨ Redis å­˜å„²ï¼ˆTTL: 600 ç§’ï¼‰
    â”‚
    â””â”€ Redis æœªå•Ÿç”¨
        â””â”€ ä½¿ç”¨å…§å­˜å­—å…¸å­˜å„²ï¼ˆTTL: 600 ç§’ï¼‰
            â””â”€ çµæ§‹ï¼š{session_id: {data: {...}, expires_at: timestamp}}
```

---

## è§¸ç™¼æ¨¡å¼èªªæ˜

### æ¨¡å¼å°æ¯”è¡¨

| æ¨¡å¼ | trigger_mode | è¡Œç‚º | é©ç”¨å ´æ™¯ | é è¨­é—œéµè© |
|-----|-------------|------|---------|-----------|
| **ç›´æ¥å›ç­”** | NULL | ç´”çŸ¥è­˜å•ç­”ï¼Œä¸è§¸ç™¼è¡¨å–® | ä¸€èˆ¬ FAQ | - |
| **è‡ªå‹•å‹** | `auto` | é¡¯ç¤ºå…§å®¹å¾Œè‡ªå‹•è§¸ç™¼è¡¨å–® | æ˜ç¢ºçš„è¡¨å–®éœ€æ±‚ | - |
| **æ’æŸ¥å‹** | `manual` | é¡¯ç¤ºå…§å®¹ â†’ ç­‰å¾…é—œéµè© â†’ è§¸ç™¼è¡¨å–® | éœ€è¦ç¢ºèªçš„æ“ä½œ | `['æ˜¯', 'è¦']` |
| **è¡Œå‹•å‹** | `immediate` | é¡¯ç¤ºå…§å®¹ â†’ ç«‹å³è©¢å• â†’ ç­‰å¾…é—œéµè© â†’ è§¸ç™¼è¡¨å–® | ç·Šæ€¥æˆ–é‡è¦æ“ä½œ | `['æ˜¯', 'è¦']` |

### Manual æ¨¡å¼è©³è§£

**é…ç½®ç¯„ä¾‹**ï¼š
```json
{
  "question_summary": "æˆ‘æƒ³ç§Ÿæˆ¿å­",
  "answer": "ğŸ“‹ **ç§Ÿæˆ¿ç”³è«‹æµç¨‹èªªæ˜**\n\n...",
  "action_type": "form_fill",
  "trigger_mode": "manual",
  "form_id": "rental_inquiry",
  "trigger_keywords": ["æ˜¯", "è¦", "å¥½"]
}
```

**å°è©±æµç¨‹**ï¼š
```
ç”¨æˆ¶ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€
â†“
ç³»çµ±ï¼šæª¢ç´¢çŸ¥è­˜åº« â†’ ID 1264 (trigger_mode=manual)
â†“
ç³»çµ±ï¼šå°‡çŸ¥è­˜é …ç›®è½‰ç‚º SOP æ ¼å¼ï¼Œèª¿ç”¨ SOPOrchestrator.handle_knowledge_trigger()
â†“
ç³»çµ±ï¼šé¦–æ¬¡è§¸ç™¼ â†’ å„²å­˜ contextï¼ˆsession_id, knowledge_id, trigger_keywordsï¼‰
â†“
è¿”å›ï¼šçŸ¥è­˜å…§å®¹ + é—œéµè©æç¤º
    ã€ŒğŸ“‹ ç§Ÿæˆ¿ç”³è«‹æµç¨‹èªªæ˜...

     ğŸ’¡ éœ€è¦å®‰æ’è™•ç†å—ï¼Ÿ
     â€¢ å›è¦†ã€Œæ˜¯ã€æˆ–ã€Œè¦ã€â†’ ç«‹å³å¡«å¯«è¡¨å–®
     â€¢ å›è¦†ã€Œä¸ç”¨ã€â†’ ç¹¼çºŒç‚ºæ‚¨è§£ç­”å…¶ä»–å•é¡Œã€

ç”¨æˆ¶ï¼šã€Œæ˜¯ã€
â†“
ç³»çµ±ï¼šæª¢æ¸¬åˆ° context â†’ åŒ¹é…é—œéµè©æˆåŠŸ
â†“
ç³»çµ±ï¼šåˆªé™¤ contextï¼Œè¿”å› triggered
â†“
ç³»çµ±ï¼šè§¸ç™¼è¡¨å–® â†’ form_manager.trigger_form_by_knowledge()
```

### Immediate æ¨¡å¼è©³è§£

**é…ç½®ç¯„ä¾‹**ï¼š
```json
{
  "question_summary": "æˆ‘è¦é€€ç§Ÿ",
  "answer": "ğŸ“‹ **é€€ç§Ÿç”³è«‹æµç¨‹**\n\n...",
  "action_type": "form_fill",
  "trigger_mode": "immediate",
  "form_id": "rental_inquiry",
  "trigger_keywords": ["æ˜¯", "è¦"],
  "immediate_prompt": "æ˜¯å¦éœ€è¦å”åŠ©æ‚¨å¡«å¯«é€€ç§Ÿç”³è«‹è¡¨ï¼Ÿ"
}
```

**å°è©±æµç¨‹**ï¼š
```
ç”¨æˆ¶ï¼šã€Œæˆ‘è¦é€€ç§Ÿã€
â†“
ç³»çµ±ï¼šæª¢ç´¢çŸ¥è­˜åº« â†’ ID 1269 (trigger_mode=immediate)
â†“
ç³»çµ±ï¼šå°‡çŸ¥è­˜é …ç›®è½‰ç‚º SOP æ ¼å¼ï¼Œèª¿ç”¨ SOPOrchestrator.handle_knowledge_trigger()
â†“
ç³»çµ±ï¼šé¦–æ¬¡è§¸ç™¼ â†’ å„²å­˜ context
â†“
è¿”å›ï¼šçŸ¥è­˜å…§å®¹ + immediate_prompt
    ã€ŒğŸ“‹ é€€ç§Ÿç”³è«‹æµç¨‹...

     æ˜¯å¦éœ€è¦å”åŠ©æ‚¨å¡«å¯«é€€ç§Ÿç”³è«‹è¡¨ï¼Ÿã€

ç”¨æˆ¶ï¼šã€Œè¦ã€
â†“
ç³»çµ±ï¼šæª¢æ¸¬åˆ° context â†’ åŒ¹é…é—œéµè©æˆåŠŸ
â†“
ç³»çµ±ï¼šåˆªé™¤ contextï¼Œè¿”å› triggered
â†“
ç³»çµ±ï¼šè§¸ç™¼è¡¨å–®
```

---

## å¯¦ç¾ç´°ç¯€

### 1. è·¯ç”±å±¤è™•ç†ï¼ˆchat.pyï¼‰

**ä½ç½®**ï¼š`/Users/lenny/jgb/AIChatbot/rag-orchestrator/routers/chat.py:1540-1590`

**è®Šæ›´å‰**ï¼š
```python
elif trigger_mode in ['manual', 'immediate']:
    print(f"   âš ï¸ trigger_mode={trigger_mode} æš«ä¸æ”¯æ´ï¼Œé™ç´šç‚º direct_answer")
    return _build_simple_answer(...)
```

**è®Šæ›´å¾Œ**ï¼š
```python
elif trigger_mode in ['manual', 'immediate']:
    # æ’æŸ¥å‹/è¡Œå‹•å‹ï¼šä½¿ç”¨ SOP Orchestrator è™•ç†é—œéµè©åŒ¹é…
    print(f"   âœ… ä½¿ç”¨ SOP Orchestrator è™•ç† trigger_mode={trigger_mode}")

    # å°‡çŸ¥è­˜åº«é …ç›®è½‰æ›ç‚º SOP æ ¼å¼
    knowledge_as_sop = {
        'id': best_knowledge['id'],
        'item_name': best_knowledge.get('question_summary', ''),
        'content': best_knowledge.get('answer', ''),
        'trigger_mode': trigger_mode,
        'next_action': 'form_fill',
        'next_form_id': form_id,
        'next_api_config': None,
        'trigger_keywords': best_knowledge.get('trigger_keywords', []),
        'immediate_prompt': best_knowledge.get('immediate_prompt', ''),
        'followup_prompt': None
    }

    # ä½¿ç”¨ SOP Orchestrator è™•ç†
    sop_orchestrator = req.app.state.sop_orchestrator
    result = await sop_orchestrator.handle_knowledge_trigger(
        knowledge_item=knowledge_as_sop,
        user_message=request.message,
        session_id=request.session_id,
        user_id=request.user_id,
        vendor_id=request.vendor_id
    )

    # æ ¹æ“šçµæœè¿”å›
    if result.get('action') == 'triggered':
        # è§¸ç™¼è¡¨å–®
        form_manager = req.app.state.form_manager
        form_result = await form_manager.trigger_form_by_knowledge(
            knowledge_id=best_knowledge['id'],
            form_id=form_id,
            session_id=request.session_id,
            user_id=request.user_id,
            vendor_id=request.vendor_id,
            trigger_question=request.message
        )
        return _convert_form_result_to_response(form_result, request)
    else:
        # è¿”å›ç­‰å¾…ç‹€æ…‹çš„å›æ‡‰
        return VendorChatResponse(
            answer=result.get('response', best_knowledge.get('answer', '')),
            vendor_id=request.vendor_id,
            mode=request.mode,
            session_id=request.session_id,
            timestamp=datetime.utcnow().isoformat(),
            source_count=0
        )
```

### 2. SOP Orchestrator æ–°å¢æ–¹æ³•

**ä½ç½®**ï¼š`/Users/lenny/jgb/AIChatbot/rag-orchestrator/services/sop_orchestrator.py:567-636`

**æ–°å¢æ–¹æ³•**ï¼š
```python
async def handle_knowledge_trigger(
    self,
    knowledge_item: Dict,
    user_message: str,
    session_id: str,
    user_id: str,
    vendor_id: int
) -> Dict:
    """
    è™•ç†çŸ¥è­˜åº«é …ç›®çš„è§¸ç™¼ï¼ˆæ”¯æ´ manual å’Œ immediate æ¨¡å¼ï¼‰

    Args:
        knowledge_item: çŸ¥è­˜åº«é …ç›®ï¼ˆå·²è½‰æ›ç‚º SOP æ ¼å¼ï¼‰
        user_message: ç”¨æˆ¶è¨Šæ¯
        session_id: æœƒè©± ID
        user_id: ç”¨æˆ¶ ID
        vendor_id: æ¥­è€… ID

    Returns:
        è™•ç†çµæœ {'action': 'triggered'/'wait_for_confirmation', 'response': str}
    """
    print(f"ğŸ¯ [Knowledge Trigger] è™•ç†çŸ¥è­˜åº«è§¸ç™¼ ID={knowledge_item.get('id')}, mode={knowledge_item.get('trigger_mode')}")

    # æª¢æŸ¥æ˜¯å¦æœ‰å¾…è™•ç†çš„ context
    existing_context = self.trigger_handler.get_context(session_id)

    if existing_context:
        # æœ‰å¾…è™•ç†çš„ contextï¼Œæª¢æŸ¥é—œéµè©åŒ¹é…
        print(f"   ğŸ“– æª¢æ¸¬åˆ°å¾…è™•ç† context: knowledge_id={existing_context.get('sop_id')}")

        trigger_keywords = existing_context.get('trigger_keywords', [])
        matched, matched_keyword = self.keyword_matcher.match(user_message, trigger_keywords)

        if matched:
            print(f"   âœ… é—œéµè©åŒ¹é…æˆåŠŸ: {matched_keyword}")
            # åˆªé™¤ context
            self.trigger_handler.delete_context(session_id)
            return {
                'action': 'triggered',
                'response': '',
                'matched_keyword': matched_keyword
            }
        else:
            print(f"   âŒ é—œéµè©æœªåŒ¹é…ï¼Œä¿æŒç­‰å¾…")
            return {
                'action': 'wait_for_keywords',
                'response': 'è«‹å‘Šè¨´æˆ‘æ‚¨æ˜¯å¦éœ€è¦å”åŠ©ï¼Ÿ'
            }
    else:
        # æ²’æœ‰ contextï¼Œé¦–æ¬¡è§¸ç™¼
        result = self.trigger_handler.handle(
            sop_item=knowledge_item,
            user_message=user_message,
            session_id=session_id,
            user_id=user_id,
            vendor_id=vendor_id
        )

        if result.get('action') == 'execute_immediately':
            # auto æ¨¡å¼ï¼šç›´æ¥è§¸ç™¼
            return {
                'action': 'triggered',
                'response': result.get('response', '')
            }
        else:
            # manual/immediate æ¨¡å¼ï¼šè¿”å›ç­‰å¾…å›æ‡‰
            return {
                'action': 'wait_for_confirmation',
                'response': result.get('response', '')
            }
```

### 3. å…§å­˜å‚™æ´æ©Ÿåˆ¶

**ä½ç½®**ï¼š`/Users/lenny/jgb/AIChatbot/rag-orchestrator/services/sop_trigger_handler.py`

**åˆå§‹åŒ–å…§å­˜å­˜å„²**ï¼ˆLine 76ï¼‰ï¼š
```python
def __init__(self, redis_client = None):
    self.redis_client = redis_client or self._get_redis_client()

    # å…§å­˜å­˜å„²ï¼ˆç•¶ Redis æœªå•Ÿç”¨æ™‚ä½¿ç”¨ï¼‰
    self._memory_store = {}

    # é…ç½®åƒæ•¸
    self.context_ttl = {
        TriggerMode.MANUAL: int(os.getenv("SOP_MANUAL_TTL", "600")),
        TriggerMode.IMMEDIATE: int(os.getenv("SOP_IMMEDIATE_TTL", "600")),
    }
```

**å„²å­˜ Context**ï¼ˆLine 424-431ï¼‰ï¼š
```python
def _save_context(self, context_key: str, context_data: Dict, ttl: int) -> bool:
    """å„²å­˜ SOP è§¸ç™¼ contextï¼ˆæ”¯æ´ Redis æˆ–å…§å­˜ï¼‰"""

    # å¦‚æœ Redis è¢«ç¦ç”¨ï¼Œä½¿ç”¨å…§å­˜å­˜å„²
    if self.redis_client is None:
        self._memory_store[context_key] = {
            'data': context_data,
            'expires_at': datetime.now().timestamp() + ttl
        }
        print(f"   ğŸ’¾ SOP Context å·²å„²å­˜åˆ°å…§å­˜: {context_key} (TTL: {ttl}s)")
        return True

    # ... Redis å­˜å„²é‚è¼¯ ...
```

**è®€å– Context**ï¼ˆLine 460-477ï¼‰ï¼š
```python
def get_context(self, session_id: str) -> Optional[Dict]:
    """å–å¾— SOP è§¸ç™¼ contextï¼ˆæ”¯æ´ Redis æˆ–å…§å­˜ï¼‰"""
    context_key = f"sop_trigger:{session_id}"

    # å¦‚æœ Redis è¢«ç¦ç”¨ï¼Œä½¿ç”¨å…§å­˜å­˜å„²
    if self.redis_client is None:
        stored = self._memory_store.get(context_key)
        if stored:
            # æª¢æŸ¥æ˜¯å¦éæœŸ
            if datetime.now().timestamp() > stored['expires_at']:
                # å·²éæœŸï¼Œåˆªé™¤
                del self._memory_store[context_key]
                print(f"   âš ï¸  SOP Context å·²éæœŸ: {context_key}")
                return None

            context = stored['data']
            print(f"   ğŸ“– è®€å–å…§å­˜ SOP Context: {context_key}")
            print(f"      ç‹€æ…‹: {context.get('state')}")
            return context
        else:
            print(f"   âš ï¸  ç„¡å…§å­˜ SOP Context: {context_key}")
            return None

    # ... Redis è®€å–é‚è¼¯ ...
```

**åˆªé™¤ Context**ï¼ˆLine 509-513ï¼‰ï¼š
```python
def delete_context(self, session_id: str) -> bool:
    """åˆªé™¤ SOP è§¸ç™¼ contextï¼ˆæ”¯æ´ Redis æˆ–å…§å­˜ï¼‰"""
    context_key = f"sop_trigger:{session_id}"

    # å¦‚æœ Redis è¢«ç¦ç”¨ï¼Œå¾å…§å­˜åˆªé™¤
    if self.redis_client is None:
        if context_key in self._memory_store:
            del self._memory_store[context_key]
            print(f"   ğŸ—‘ï¸  å…§å­˜ SOP Context å·²åˆªé™¤: {context_key}")
        return True

    # ... Redis åˆªé™¤é‚è¼¯ ...
```

### 4. SQL æŸ¥è©¢æ¬„ä½è£œå……

**ä½ç½®**ï¼š`/Users/lenny/jgb/AIChatbot/rag-orchestrator/services/vendor_knowledge_retriever.py`

**ç¬¬ä¸€è™•**ï¼ˆLine 115-117ï¼‰ï¼š
```sql
kb.trigger_mode,
kb.trigger_keywords,
kb.immediate_prompt,
```

**ç¬¬äºŒè™•**ï¼ˆLine 382-384ï¼‰ï¼š
```sql
kb.trigger_mode,
kb.trigger_keywords,
kb.immediate_prompt,
```

### 5. é¿å…é‡è¤‡é¡¯ç¤ºçŸ¥è­˜å…§å®¹

**ä½ç½®**ï¼š`/Users/lenny/jgb/AIChatbot/rag-orchestrator/services/form_manager.py`

**æ·»åŠ è§¸ç™¼ä¾†æºæª¢æŸ¥**ï¼ˆLine 801-808ï¼‰ï¼š
```python
# 5. æ ¼å¼åŒ–å®Œæˆè¨Šæ¯
# âš ï¸ å¦‚æœè¡¨å–®ç”±çŸ¥è­˜åº«è§¸ç™¼ï¼Œç”¨æˆ¶å·²çœ‹éçŸ¥è­˜å…§å®¹ï¼Œä¸å†é‡è¤‡é¡¯ç¤º
triggered_by_knowledge = session_state.get('knowledge_id') is not None
completion_message = await self._format_completion_message(
    on_complete_action=on_complete_action,
    knowledge_answer=knowledge_answer,
    api_result=api_result,
    triggered_by_knowledge=triggered_by_knowledge
)
```

**ä¿®æ”¹æ ¼å¼åŒ–é‚è¼¯**ï¼ˆLine 853-873ï¼‰ï¼š
```python
async def _format_completion_message(
    self,
    on_complete_action: str,
    knowledge_answer: Optional[str],
    api_result: Optional[Dict],
    triggered_by_knowledge: bool = False
) -> str:
    """æ ¼å¼åŒ–è¡¨å–®å®Œæˆè¨Šæ¯

    Args:
        triggered_by_knowledge: è¡¨å–®æ˜¯å¦ç”±çŸ¥è­˜åº«è§¸ç™¼ï¼ˆç”¨æˆ¶å·²çœ‹éçŸ¥è­˜å…§å®¹ï¼‰
    """
    # æƒ…æ³ 1: åªé¡¯ç¤ºçŸ¥è­˜ç­”æ¡ˆ
    if on_complete_action == 'show_knowledge':
        # âš ï¸ å¦‚æœè¡¨å–®ç”±çŸ¥è­˜åº«è§¸ç™¼ï¼Œç”¨æˆ¶å·²çœ‹éçŸ¥è­˜å…§å®¹ï¼Œä¸å†é‡è¤‡é¡¯ç¤º
        if triggered_by_knowledge:
            return "âœ… **è¡¨å–®å¡«å¯«å®Œæˆï¼**\n\næ„Ÿè¬æ‚¨å®Œæˆè¡¨å–®ï¼æˆ‘å€‘æœƒå„˜å¿«èˆ‡æ‚¨è¯ç¹«ã€‚"
        elif knowledge_answer:
            return f"âœ… **è¡¨å–®å¡«å¯«å®Œæˆï¼**\n\n{knowledge_answer}"
        else:
            return "âœ… **è¡¨å–®å¡«å¯«å®Œæˆï¼**\n\næ„Ÿè¬æ‚¨å®Œæˆè¡¨å–®ï¼æˆ‘å€‘æœƒå„˜å¿«è™•ç†æ‚¨çš„è³‡æ–™ã€‚"
```

### 6. é è¨­é—œéµè©é…ç½®

**Manual æ¨¡å¼é è¨­**ï¼ˆLine 216ï¼‰ï¼š
```python
trigger_keywords = sop_item.get('trigger_keywords') or ['æ˜¯', 'è¦']
```

**Immediate æ¨¡å¼é è¨­**ï¼ˆLine 270ï¼‰ï¼š
```python
trigger_keywords = sop_item.get('trigger_keywords', ['æ˜¯', 'è¦'])
```

---

## è³‡æ–™åº«è¨­è¨ˆ

### knowledge_base è¡¨çµæ§‹

```sql
-- è§¸ç™¼æ¨¡å¼æ¬„ä½
trigger_mode VARCHAR(20) CHECK (
    trigger_mode IS NULL OR
    trigger_mode IN ('manual', 'immediate', 'auto')
);

-- è§¸ç™¼é—œéµè©ï¼ˆé™£åˆ—ï¼‰
trigger_keywords TEXT[];

-- è¡Œå‹•å‹æç¤ºè¨Šæ¯
immediate_prompt TEXT;

-- è¡Œç‚ºé¡å‹
action_type VARCHAR(50) DEFAULT 'direct_answer' CHECK (
    action_type IN ('direct_answer', 'form_fill', 'api_call')
);

-- è¡¨å–® IDï¼ˆç•¶ action_type='form_fill' æ™‚å¿…å¡«ï¼‰
form_id VARCHAR(100);
```

### ç´„æŸèªªæ˜

#### trigger_mode ç´„æŸ
```sql
CHECK (
    trigger_mode IS NULL OR
    trigger_mode IN ('manual', 'immediate', 'auto')
)
```

**æ³¨æ„**ï¼šæ²’æœ‰ 'none' é¸é …ã€‚ç´”çŸ¥è­˜å•ç­”ä½¿ç”¨ `trigger_mode = NULL`ã€‚

#### action_type ç´„æŸ
```sql
CHECK (
    action_type IN ('direct_answer', 'form_fill', 'api_call')
)
```

### é…ç½®ç¯„ä¾‹

**ç¯„ä¾‹ 1ï¼šManual æ¨¡å¼**
```sql
INSERT INTO knowledge_base (
    question_summary,
    answer,
    vendor_id,
    scope,
    priority,
    trigger_mode,
    action_type,
    form_id,
    trigger_keywords,
    business_types,
    created_at,
    updated_at
) VALUES (
    'æˆ‘æƒ³ç§Ÿæˆ¿å­',
    'ğŸ“‹ **ç§Ÿæˆ¿ç”³è«‹æµç¨‹èªªæ˜**...',
    1,
    'customized',
    500,
    'manual',
    'form_fill',
    'rental_inquiry',
    ARRAY['æ˜¯', 'è¦'],
    ARRAY['property_management'],
    NOW(),
    NOW()
);
```

**ç¯„ä¾‹ 2ï¼šImmediate æ¨¡å¼**
```sql
INSERT INTO knowledge_base (
    question_summary,
    answer,
    vendor_id,
    scope,
    priority,
    trigger_mode,
    action_type,
    form_id,
    trigger_keywords,
    immediate_prompt,
    business_types,
    created_at,
    updated_at
) VALUES (
    'æˆ‘è¦é€€ç§Ÿ',
    'ğŸ“‹ **é€€ç§Ÿç”³è«‹æµç¨‹**...',
    2,
    'customized',
    500,
    'immediate',
    'form_fill',
    'rental_inquiry',
    ARRAY['æ˜¯', 'è¦'],
    'æ˜¯å¦éœ€è¦å”åŠ©æ‚¨å¡«å¯«é€€ç§Ÿç”³è«‹è¡¨ï¼Ÿ',
    ARRAY['property_management'],
    NOW(),
    NOW()
);
```

**ç¯„ä¾‹ 3ï¼šDirect Answerï¼ˆç´”çŸ¥è­˜ï¼‰**
```sql
INSERT INTO knowledge_base (
    question_summary,
    answer,
    vendor_id,
    scope,
    priority,
    trigger_mode,
    action_type,
    form_id,
    trigger_keywords,
    business_types,
    created_at,
    updated_at
) VALUES (
    'åˆç´„å•é¡Œ',
    'ğŸ“‹ **ç§Ÿè³ƒåˆç´„èªªæ˜**...',
    2,
    'customized',
    400,
    NULL,  -- NULL è¡¨ç¤ºç´”çŸ¥è­˜å•ç­”
    'direct_answer',
    NULL,
    NULL,
    ARRAY['property_management'],
    NOW(),
    NOW()
);
```

---

## æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦çŸ¥è­˜åº«é …ç›®

ç³»çµ±å·²å»ºç«‹ä»¥ä¸‹æ¸¬è©¦çŸ¥è­˜ï¼ˆVendor 2 / VENDOR_B / ä¿¡ç¾©åŒ…ç§Ÿä»£ç®¡ï¼‰ï¼š

| ID | å•é¡Œæ‘˜è¦ | è§¸ç™¼æ¨¡å¼ | è¡Œç‚ºé¡å‹ | è¡¨å–® ID | é—œéµè© |
|----|---------|---------|---------|---------|--------|
| 1264 | æˆ‘æƒ³ç§Ÿæˆ¿å­ | manual | form_fill | rental_inquiry | ['æ˜¯', 'è¦'] |
| 1269 | æˆ‘è¦é€€ç§Ÿ | immediate | form_fill | rental_inquiry | ['æ˜¯', 'è¦'] |
| 1294 | æˆ‘æƒ³å ±ä¿® | manual | form_fill | rental_inquiry | ['æ˜¯', 'è¦', 'å¥½'] |
| 1295 | åˆç´„å•é¡Œ | NULL | direct_answer | NULL | NULL |

### æ¸¬è©¦å ´æ™¯

#### æ¸¬è©¦ 1ï¼šManual æ¨¡å¼

**æ¸¬è©¦çŸ¥è­˜**ï¼šID 1264ã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
```
1. è¨ªå• http://localhost:8087/#/vendor-b/chat
2. è¼¸å…¥ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€
   é æœŸï¼šé¡¯ç¤ºç§Ÿæˆ¿æµç¨‹ + é—œéµè©æç¤º

3. è¼¸å…¥ï¼šã€Œæ˜¯ã€
   é æœŸï¼šè§¸ç™¼è¡¨å–®

4. å®Œæˆè¡¨å–®
   é æœŸï¼šåªé¡¯ç¤ºã€Œâœ… è¡¨å–®å¡«å¯«å®Œæˆï¼ã€ï¼Œä¸é‡è¤‡é¡¯ç¤ºç§Ÿæˆ¿æµç¨‹
```

**é©—è­‰é»**ï¼š
- [ ] é¦–æ¬¡å•é¡Œè¿”å›çŸ¥è­˜å…§å®¹
- [ ] é¡¯ç¤ºé—œéµè©æç¤ºï¼šã€Œâ€¢ å›è¦†ã€Œæ˜¯ã€æˆ–ã€Œè¦ã€â†’ ç«‹å³å¡«å¯«è¡¨å–®ã€
- [ ] å›è¦†ã€Œæ˜¯ã€å¾ŒæˆåŠŸè§¸ç™¼è¡¨å–®
- [ ] è¡¨å–®å®Œæˆå¾Œä¸é‡è¤‡é¡¯ç¤ºçŸ¥è­˜å…§å®¹
- [ ] å›è¦†ã€Œä¸ç”¨ã€å¾Œç¹¼çºŒå°è©±ï¼ˆä¸è§¸ç™¼è¡¨å–®ï¼‰

#### æ¸¬è©¦ 2ï¼šImmediate æ¨¡å¼

**æ¸¬è©¦çŸ¥è­˜**ï¼šID 1269ã€Œæˆ‘è¦é€€ç§Ÿã€

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
```
1. è¨ªå• http://localhost:8087/#/vendor-b/chat
2. è¼¸å…¥ï¼šã€Œæˆ‘è¦é€€ç§Ÿã€
   é æœŸï¼šé¡¯ç¤ºé€€ç§Ÿæµç¨‹ + immediate_prompt

3. è¼¸å…¥ï¼šã€Œè¦ã€
   é æœŸï¼šè§¸ç™¼è¡¨å–®

4. å®Œæˆè¡¨å–®
   é æœŸï¼šåªé¡¯ç¤ºã€Œâœ… è¡¨å–®å¡«å¯«å®Œæˆï¼ã€
```

**é©—è­‰é»**ï¼š
- [ ] é¦–æ¬¡å•é¡Œè¿”å›çŸ¥è­˜å…§å®¹
- [ ] é¡¯ç¤º immediate_promptï¼šã€Œæ˜¯å¦éœ€è¦å”åŠ©æ‚¨å¡«å¯«é€€ç§Ÿç”³è«‹è¡¨ï¼Ÿã€
- [ ] å›è¦†ã€Œè¦ã€å¾ŒæˆåŠŸè§¸ç™¼è¡¨å–®
- [ ] è¡¨å–®å®Œæˆå¾Œä¸é‡è¤‡é¡¯ç¤ºçŸ¥è­˜å…§å®¹

#### æ¸¬è©¦ 3ï¼šDirect Answer

**æ¸¬è©¦çŸ¥è­˜**ï¼šID 1295ã€Œåˆç´„å•é¡Œã€

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
```
1. è¼¸å…¥ï¼šã€Œåˆç´„å•é¡Œã€
   é æœŸï¼šç›´æ¥é¡¯ç¤ºåˆç´„èªªæ˜ï¼Œä¸è§¸ç™¼è¡¨å–®
```

**é©—è­‰é»**ï¼š
- [ ] è¿”å›å®Œæ•´åˆç´„èªªæ˜
- [ ] ä¸å‡ºç¾ä»»ä½•è¡¨å–®ç›¸é—œæç¤º
- [ ] å°è©±å¯ä»¥ç¹¼çºŒé€²è¡Œ

#### æ¸¬è©¦ 4ï¼šContext éæœŸ

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
```
1. è¼¸å…¥ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€
   é æœŸï¼šé¡¯ç¤ºå…§å®¹ + æç¤º

2. ç­‰å¾… 10 åˆ†é˜ä»¥ä¸Šï¼ˆTTL: 600 ç§’ï¼‰

3. è¼¸å…¥ï¼šã€Œæ˜¯ã€
   é æœŸï¼šç³»çµ±ç•¶ä½œæ–°å•é¡Œè™•ç†ï¼ˆcontext å·²éæœŸï¼‰
```

**é©—è­‰é»**ï¼š
- [ ] Context TTL æ­£ç¢ºé‹ä½œ
- [ ] éæœŸå¾Œä¸æœƒè§¸ç™¼è¡¨å–®
- [ ] æ—¥èªŒé¡¯ç¤ºã€ŒSOP Context å·²éæœŸã€

#### æ¸¬è©¦ 5ï¼šå…§å­˜å‚™æ´æ©Ÿåˆ¶

**å‰ç½®æ¢ä»¶**ï¼šç¢ºèª `CACHE_ENABLED=false`

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
```
1. è¼¸å…¥ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€
   æª¢æŸ¥æ—¥èªŒï¼šæ‡‰é¡¯ç¤ºã€ŒğŸ’¾ SOP Context å·²å„²å­˜åˆ°å…§å­˜ã€

2. è¼¸å…¥ï¼šã€Œæ˜¯ã€
   æª¢æŸ¥æ—¥èªŒï¼šæ‡‰é¡¯ç¤ºã€ŒğŸ“– è®€å–å…§å­˜ SOP Contextã€
   é æœŸï¼šæˆåŠŸè§¸ç™¼è¡¨å–®
```

**é©—è­‰é»**ï¼š
- [ ] Redis æœªå•Ÿç”¨æ™‚ä½¿ç”¨å…§å­˜å­˜å„²
- [ ] å…§å­˜å­˜å„²å¯ä»¥æ­£ç¢ºè®€å–å’Œåˆªé™¤
- [ ] TTL æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ

---

## æœ€ä½³å¯¦è¸

### 1. é¸æ“‡æ­£ç¢ºçš„è§¸ç™¼æ¨¡å¼

| å ´æ™¯ | æ¨è–¦æ¨¡å¼ | ç†ç”± |
|-----|---------|------|
| ä¸€èˆ¬ FAQ | NULL (direct_answer) | ç´”è³‡è¨ŠæŸ¥è©¢ï¼Œç„¡éœ€è¡¨å–® |
| æ˜ç¢ºçš„è¡¨å–®éœ€æ±‚ | auto | ç”¨æˆ¶æ„åœ–æ˜ç¢ºï¼Œç›´æ¥è§¸ç™¼ |
| éœ€è¦ç¢ºèªçš„æ“ä½œ | manual | çµ¦ç”¨æˆ¶é¸æ“‡æ¬Š |
| ç·Šæ€¥æˆ–é‡è¦æ“ä½œ | immediate | æ˜ç¢ºè©¢å•ï¼Œæ¸›å°‘èª¤è§¸ç™¼ |

### 2. é—œéµè©é…ç½®å»ºè­°

**æ¨è–¦é—œéµè©**ï¼š
- è‚¯å®šï¼š`['æ˜¯', 'è¦', 'å¥½', 'éœ€è¦', 'å¯ä»¥']`
- å¦å®šï¼š`['ä¸ç”¨', 'ä¸è¦', 'ä¸éœ€è¦', 'å–æ¶ˆ']`ï¼ˆç³»çµ±è‡ªå‹•è­˜åˆ¥ï¼Œç„¡éœ€é…ç½®ï¼‰

**é¿å…ä½¿ç”¨**ï¼š
- å¤ªçŸ­çš„è©ï¼ˆå¦‚ã€Œå¥½ã€å–®ç¨ä½¿ç”¨ï¼‰
- æ­§ç¾©è©ï¼ˆå¦‚ã€Œå°ã€ã€ã€Œå—¯ã€ï¼‰

### 3. immediate_prompt æ’°å¯«å»ºè­°

**å¥½çš„ç¯„ä¾‹**ï¼š
```
æ˜¯å¦éœ€è¦å”åŠ©æ‚¨å¡«å¯«é€€ç§Ÿç”³è«‹è¡¨ï¼Ÿ
```

**ä¸å¥½çš„ç¯„ä¾‹**ï¼š
```
è¦ä¸è¦å¡«è¡¨ï¼Ÿ  // å¤ªéš¨ä¾¿
æ‚¨æ˜¯å¦å¸Œæœ›ç³»çµ±ç‚ºæ‚¨å•Ÿå‹•é€€ç§Ÿç”³è«‹è¡¨å–®å¡«å¯«æµç¨‹ï¼Ÿ  // å¤ªå†—é•·
```

### 4. çŸ¥è­˜å…§å®¹æ’°å¯«

**çµæ§‹åŒ–å…§å®¹**ï¼š
```markdown
ğŸ“‹ **æ¨™é¡Œ**

1. ç¬¬ä¸€é»èªªæ˜
2. ç¬¬äºŒé»èªªæ˜
3. ç¬¬ä¸‰é»èªªæ˜

æ³¨æ„äº‹é …ï¼š
â€¢ æ³¨æ„äº‹é … 1
â€¢ æ³¨æ„äº‹é … 2
```

**é¿å…**ï¼š
- éé•·çš„æ®µè½
- ç¼ºå°‘çµæ§‹
- æ²’æœ‰æ˜ç¢ºçš„è¡Œå‹•æŒ‡å¼•

### 5. æ¸¬è©¦æª¢æŸ¥æ¸…å–®

åœ¨éƒ¨ç½²å‰ç¢ºèªï¼š
- [ ] æ‰€æœ‰ trigger_mode éƒ½æœ‰å°æ‡‰çš„æ¸¬è©¦æ¡ˆä¾‹
- [ ] é—œéµè©åŒ¹é…æ­£ç¢º
- [ ] Context å­˜å„²å’Œè®€å–æ­£å¸¸
- [ ] è¡¨å–®å®Œæˆå¾Œä¸é‡è¤‡é¡¯ç¤ºå…§å®¹
- [ ] æ—¥èªŒè¨˜éŒ„å®Œæ•´

---

## æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šé—œéµè©ç„¡æ³•åŒ¹é…

**ç¾è±¡**ï¼š
```
ç”¨æˆ¶ï¼šã€Œæ˜¯ã€
ç³»çµ±ï¼šï¼ˆç•¶ä½œæ–°å•é¡Œè™•ç†ï¼‰
```

**å¯èƒ½åŸå› **ï¼š
1. Context æœªæ­£ç¢ºå­˜å„²
2. Context å·²éæœŸï¼ˆè¶…é TTLï¼‰
3. session_id ä¸ä¸€è‡´

**æ’æŸ¥æ­¥é©Ÿ**ï¼š
```bash
# 1. æª¢æŸ¥æ—¥èªŒ
docker-compose logs rag-orchestrator | grep "SOP Context"

# 2. æª¢æŸ¥ Redis
docker-compose exec redis redis-cli
> keys sop_trigger:*

# 3. æª¢æŸ¥å…§å­˜å­˜å„²ï¼ˆå¦‚æœ Redis æœªå•Ÿç”¨ï¼‰
# æ—¥èªŒæ‡‰é¡¯ç¤ºï¼šã€ŒğŸ’¾ SOP Context å·²å„²å­˜åˆ°å…§å­˜ã€
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```python
# ç¢ºèª session_id ä¸€è‡´
# ç¢ºèª TTL æœªéæœŸï¼ˆé è¨­ 600 ç§’ï¼‰
# ç¢ºèªå…§å­˜å­˜å„²æ©Ÿåˆ¶é‹ä½œæ­£å¸¸
```

### å•é¡Œ 2ï¼šè¡¨å–®å®Œæˆå¾Œé‡è¤‡é¡¯ç¤ºçŸ¥è­˜å…§å®¹

**ç¾è±¡**ï¼š
```
âœ… è¡¨å–®å¡«å¯«å®Œæˆï¼

ğŸ“‹ ç§Ÿæˆ¿ç”³è«‹æµç¨‹èªªæ˜...  // é‡è¤‡äº†
```

**åŸå› **ï¼š
è¡¨å–®çš„ `on_complete_action='show_knowledge'` ä¸”æœªæª¢æŸ¥ `triggered_by_knowledge`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```python
# form_manager.py
triggered_by_knowledge = session_state.get('knowledge_id') is not None
if triggered_by_knowledge:
    return "âœ… è¡¨å–®å¡«å¯«å®Œæˆï¼"
```

### å•é¡Œ 3ï¼šçŸ¥è­˜åº«æŸ¥è©¢ç¼ºå°‘æ¬„ä½

**ç¾è±¡**ï¼š
context ä¸­çš„ trigger_keywords ç‚ºç©º

**åŸå› **ï¼š
SQL æŸ¥è©¢æœªé¸å– `trigger_keywords`, `trigger_mode`, `immediate_prompt` æ¬„ä½

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```python
# vendor_knowledge_retriever.py
# ç¢ºèª SQL åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š
"""
kb.trigger_mode,
kb.trigger_keywords,
kb.immediate_prompt,
"""
```

### å•é¡Œ 4ï¼šRedis æœªå•Ÿç”¨å°è‡´ Context ä¸Ÿå¤±

**ç¾è±¡**ï¼š
```
âš ï¸ Redis æœªå•Ÿç”¨ï¼Œè·³é SOP Context å­˜å„²
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
å·²å¯¦ç¾å…§å­˜å‚™æ´æ©Ÿåˆ¶ï¼Œç„¡éœ€ä¿®å¾©ã€‚ç¢ºèªæ—¥èªŒé¡¯ç¤ºï¼š
```
ğŸ’¾ SOP Context å·²å„²å­˜åˆ°å…§å­˜
```

### å•é¡Œ 5ï¼šConstraint é•åéŒ¯èª¤

**ç¾è±¡**ï¼š
```sql
ERROR: new row for relation "knowledge_base" violates check constraint "check_kb_trigger_mode"
```

**åŸå› **ï¼š
ä½¿ç”¨äº†ä¸å…è¨±çš„ trigger_mode å€¼ï¼ˆå¦‚ 'none'ï¼‰

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```sql
-- æ­£ç¢ºçš„å€¼ï¼š
trigger_mode = NULL        -- ç´”çŸ¥è­˜å•ç­”
trigger_mode = 'manual'    -- æ’æŸ¥å‹
trigger_mode = 'immediate' -- è¡Œå‹•å‹
trigger_mode = 'auto'      -- è‡ªå‹•å‹

-- éŒ¯èª¤çš„å€¼ï¼š
trigger_mode = 'none'      -- âŒ ä¸å…è¨±
```

---

## ç›¸é—œæ–‡æª”

- [SOP ç³»çµ±å®Œæ•´æŒ‡å—](../guides/SOP_GUIDE.md)
- [çŸ¥è­˜åº«å‹•ä½œç³»çµ±è¨­è¨ˆ](./KNOWLEDGE_ACTION_SYSTEM_DESIGN.md)
- [è¡¨å–®ç®¡ç†ç³»çµ±](./FORM_MANAGEMENT_SYSTEM.md)
- [SOP è§¸ç™¼æ¨¡å¼ UI æ›´æ–°](./SOP_TRIGGER_MODE_UI_UPDATE_2026-02-03.md)

---

## è®Šæ›´æ­·å²

| æ—¥æœŸ | ç‰ˆæœ¬ | èªªæ˜ |
|------|------|------|
| 2026-02-03 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå¯¦ç¾çŸ¥è­˜åº«è¡¨å–®è§¸ç™¼æ¨¡å¼ |

---

**æ–‡æª”ç¶­è­·**: AI Chatbot Development Team
**æœ€å¾Œå¯©æŸ¥**: 2026-02-03
