# Vendor SOP æª¢ç´¢é‚è¼¯æ¶æ§‹æ”¹é€²

**å¯¦æ–½æ—¥æœŸ**: 2026-01-24
**ç‹€æ…‹**: âœ… å·²å®Œæˆä¸¦éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
**å½±éŸ¿ç¯„åœ**: æ ¸å¿ƒæª¢ç´¢é‚è¼¯
**å‘å¾Œå…¼å®¹**: âœ… å®Œå…¨å…¼å®¹

---

## åŸ·è¡Œæ‘˜è¦

å°‡ Vendor SOP æª¢ç´¢ç³»çµ±å¾ã€ŒIntent å¿…éœ€ã€æ”¹ç‚ºã€ŒIntent è¼”åŠ©ã€ï¼Œä¸¦æ·»åŠ å‘é‡ç›¸ä¼¼åº¦æª¢ç´¢ï¼Œçµ±ä¸€äº†èˆ‡ Knowledge Base çš„æ¶æ§‹è¨­è¨ˆã€‚

### é—œéµæˆæœ
- âœ… ä¿®å¾©äº† SOP ç„¡æ³•æª¢ç´¢çš„å•é¡Œï¼ˆ56 å€‹ SOP å—å½±éŸ¿ï¼‰
- âœ… çµ±ä¸€äº†ç³»çµ±æ¶æ§‹ï¼ˆKnowledge Base + Vendor SOPï¼‰
- âœ… æå‡æª¢ç´¢æº–ç¢ºæ€§ï¼ˆå‘é‡ç›¸ä¼¼åº¦ + Intent åŠ æˆï¼‰
- âœ… Intent çœŸæ­£æˆç‚ºã€Œè¼”åŠ©ã€è€Œéã€Œå¿…éœ€ã€

---

## å•é¡ŒèƒŒæ™¯

### ç™¼ç¾çš„å•é¡Œ

ç”¨æˆ¶å ±å‘Šç„¡æ³•æª¢ç´¢åˆ°ç¶­ä¿®ç›¸é—œçš„ SOPï¼ˆå¦‚ã€Œå†°ç®±ä¸å†·ã€ã€ã€Œæ°´ç®¡æ¼æ°´ã€ç­‰ï¼‰ï¼š

```
ç”¨æˆ¶å•é¡Œ: "æˆ‘å®¶å†°ç®±ä¸å†·æ€éº¼è¾¦ï¼Ÿ"
Intent åˆ†é¡: "è¨­å‚™" (ID: 26) âœ… æ­£ç¢º
ç³»çµ±å›ç­”: "æˆ‘ç›®å‰æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ‚¨å•é¡Œçš„è³‡è¨Š..." âŒ
æª¢ç´¢çµæœ: 0 å€‹ä¾†æº
```

### æ ¹æœ¬åŸå› 

ç³»çµ±å­˜åœ¨**å…©å¥—ä¸¦è¡Œä½†ä¸ä¸€è‡´çš„æª¢ç´¢æ©Ÿåˆ¶**ï¼š

| ç³»çµ± | Intent è§’è‰² | JOIN é¡å‹ | ç„¡ Intent é—œè¯æ™‚ |
|------|------------|-----------|-----------------|
| **Knowledge Base** | è¼”åŠ©ï¼ˆè»Ÿéæ¿¾ï¼‰ | LEFT JOIN | âœ… å¯æª¢ç´¢ |
| **Vendor SOP** | å¿…éœ€ï¼ˆç¡¬éæ¿¾ï¼‰ | INNER JOIN | âŒ ç„¡æ³•æª¢ç´¢ |

**å…·é«”æ¡ˆä¾‹**ï¼š
- vendor_id = 2 çš„ 56 å€‹ SOP
- åŒ…æ‹¬ 10 å€‹ç¶­ä¿® SOPï¼ˆID 1645-1654ï¼‰
- **0 å€‹ Intent é—œè¯è¨˜éŒ„** åœ¨ `vendor_sop_item_intents` è¡¨
- çµæœï¼š**æ‰€æœ‰ SOP éƒ½ç„¡æ³•è¢«æª¢ç´¢**

### åŸæœ‰æª¢ç´¢é‚è¼¯ï¼ˆéŒ¯èª¤è¨­è¨ˆï¼‰

```sql
-- vendor_sop_retriever.py:118ï¼ˆèˆŠç‰ˆï¼‰
FROM vendor_sop_items si
INNER JOIN vendor_sop_item_intents vsii ON si.id = vsii.sop_item_id
WHERE
    si.vendor_id = %s
    AND vsii.intent_id = %s  -- ç¡¬æ€§éæ¿¾ï¼
```

**å•é¡Œ**ï¼š
- ä½¿ç”¨ `INNER JOIN` â†’ å¿…é ˆæœ‰ Intent é—œè¯æ‰èƒ½æª¢ç´¢
- æ²’æœ‰ Intent é—œè¯çš„ SOP = æ°¸é ç„¡æ³•è¢«æ‰¾åˆ°
- èˆ‡ Knowledge Base é‚è¼¯ä¸ä¸€è‡´

---

## è§£æ±ºæ–¹æ¡ˆ

### è¨­è¨ˆåŸå‰‡

1. **Intent ä½œç‚ºè¼”åŠ©æ’åº**ï¼Œä¸æ˜¯ç¡¬æ€§éæ¿¾æ¢ä»¶
2. **å‘é‡ç›¸ä¼¼åº¦ç‚ºä¸»**ï¼ŒIntent åƒ…ç”¨æ–¼åŠ æˆ
3. **çµ±ä¸€æ¶æ§‹**ï¼ŒKnowledge Base å’Œ Vendor SOP é‚è¼¯ä¸€è‡´

### æ ¸å¿ƒä¿®æ”¹

#### 1. ä¿®æ”¹ SQL JOIN é¡å‹

```sql
-- vendor_sop_retriever.py:130ï¼ˆæ–°ç‰ˆï¼‰
FROM vendor_sop_items si
INNER JOIN vendor_sop_categories sc ON si.category_id = sc.id
LEFT JOIN vendor_sop_groups sg ON si.group_id = sg.id
LEFT JOIN vendor_sop_item_intents vsii ON si.id = vsii.sop_item_id  -- âœ… LEFT JOIN
WHERE
    si.vendor_id = %s
    AND si.is_active = TRUE
    AND sc.is_active = TRUE
    -- âŒ ç§»é™¤: AND vsii.intent_id = %s
ORDER BY
    CASE WHEN vsii.intent_id = %s THEN 1000 ELSE 0 END DESC,  -- Intent åŠ æˆæ’åº
    si.priority DESC,
    si.item_number ASC
```

**æ”¹é€²é»**ï¼š
- âœ… `LEFT JOIN` å…è¨±æ²’æœ‰ Intent é—œè¯çš„ SOP è¢«æª¢ç´¢
- âœ… Intent åƒ…ç”¨æ–¼æ’åºåŠ æˆï¼ˆæœ‰åŒ¹é… = boost 1000ï¼‰
- âœ… ç§»é™¤ç¡¬æ€§ Intent éæ¿¾

#### 2. æ·»åŠ å‘é‡ç›¸ä¼¼åº¦æª¢ç´¢

**æ–°å¢æ–¹æ³•**: `retrieve_sop_by_query()`

```python
async def retrieve_sop_by_query(
    self,
    vendor_id: int,
    query: str,  # ç”¨æˆ¶å•é¡Œæ–‡æœ¬
    intent_id: Optional[int] = None,  # å¯é¸
    top_k: int = 5,
    similarity_threshold: float = 0.55  # èˆ‡ Knowledge Base ä¸€è‡´
) -> List[Dict]:
```

**SQL æŸ¥è©¢é‚è¼¯**ï¼š

```sql
SELECT
    si.*,
    -- è¨ˆç®—å‘é‡ç›¸ä¼¼åº¦
    1 - (si.primary_embedding <=> %s::vector) as base_similarity,
    -- Intent åŒ¹é…åŠ æˆ
    CASE
        WHEN vsii.intent_id = %s THEN 1.3  -- åŒ¹é…ä¸»è¦ Intent
        ELSE 1.0                            -- ç„¡åŒ¹é…
    END as intent_boost,
    -- åŠ æˆå¾Œçš„ç›¸ä¼¼åº¦
    (1 - (si.primary_embedding <=> %s::vector)) *
    CASE WHEN vsii.intent_id = %s THEN 1.3 ELSE 1.0 END as boosted_similarity
FROM vendor_sop_items si
LEFT JOIN vendor_sop_item_intents vsii ON si.id = vsii.sop_item_id
WHERE
    si.vendor_id = %s
    AND si.primary_embedding IS NOT NULL
    AND (1 - (si.primary_embedding <=> %s::vector)) >= %s  -- åŸºç¤é–¾å€¼ 0.55
ORDER BY
    boosted_similarity DESC,  -- åŠ æˆå¾Œç›¸ä¼¼åº¦
    si.priority DESC
LIMIT %s
```

**æª¢ç´¢ç­–ç•¥**ï¼š
1. å‘é‡ç›¸ä¼¼åº¦ â‰¥ 0.55ï¼ˆä¸»è¦éæ¿¾æ¢ä»¶ï¼‰
2. Intent åŒ¹é… â†’ åŠ æˆ 1.3xï¼ˆè¼”åŠ©æ’åºï¼‰
3. äººå·¥å„ªå…ˆç´šï¼ˆæœ€çµ‚æ’åºï¼‰

#### 3. ä¿®æ”¹ SOP Orchestrator èª¿ç”¨

```python
# sop_orchestrator.py:120ï¼ˆæ–°ç‰ˆï¼‰

# èˆŠæ–¹æ³•ï¼ˆåƒ… Intentï¼Œå·²å»¢æ£„ï¼‰
# sop_items = self.sop_retriever.retrieve_sop_by_intent(...)

# æ–°æ–¹æ³•ï¼ˆå‘é‡ç›¸ä¼¼åº¦ + Intent åŠ æˆï¼‰
sop_items = await self.sop_retriever.retrieve_sop_by_query(
    vendor_id=vendor_id,
    query=user_message,        # âœ… ç”¨æˆ¶å•é¡Œæ–‡æœ¬
    intent_id=intent_id,       # âœ… å¯é¸ï¼Œç”¨æ–¼åŠ æˆ
    top_k=1,
    similarity_threshold=0.55  # âœ… èˆ‡ Knowledge Base ä¸€è‡´
)
```

---

## å¯¦æ–½ç´°ç¯€

### ä¿®æ”¹çš„æ–‡ä»¶

#### 1. `rag-orchestrator/services/vendor_sop_retriever.py`

**æ·»åŠ  Embedding æ”¯æ´** (Lines 9, 18):
```python
from .embedding_utils import get_embedding_client

class VendorSOPRetriever:
    def __init__(self):
        self._cache: Dict[int, Dict] = {}
        self.embedding_client = get_embedding_client()  # âœ… æ–°å¢
```

**ä¿®æ”¹ `retrieve_sop_by_intent()`** (Lines 66-178):
- åƒæ•¸ `intent_id` æ”¹ç‚º `Optional[int]`
- `INNER JOIN` â†’ `LEFT JOIN`
- æ·»åŠ  `intent_boost` è¨ˆç®—æ¬„ä½
- ç§»é™¤ç¡¬æ€§ Intent éæ¿¾

**æ–°å¢ `_get_embedding()`** (Lines 180-194):
```python
async def _get_embedding(self, text: str) -> Optional[List[float]]:
    """ç²å–æ–‡æœ¬çš„å‘é‡è¡¨ç¤º"""
    try:
        return await self.embedding_client.get_embedding(text, verbose=False)
    except Exception as e:
        print(f"âš ï¸  ç²å–å‘é‡å¤±æ•—: {e}")
        return None
```

**æ–°å¢ `retrieve_sop_by_query()`** (Lines 196-337):
- æ”¯æ´å‘é‡ç›¸ä¼¼åº¦æª¢ç´¢
- Intent åŒ¹é…åŠ æˆ 1.3x
- ç›¸ä¼¼åº¦é–¾å€¼ 0.55
- è©³ç´°çš„ DEBUG æ—¥èªŒ

#### 2. `rag-orchestrator/services/sop_orchestrator.py`

**ä¿®æ”¹ `process_message()`** (Lines 119-126):
```python
# ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æª¢ç´¢ SOPï¼ˆIntent ä½œç‚ºè¼”åŠ©æ’åºï¼‰
sop_items = await self.sop_retriever.retrieve_sop_by_query(
    vendor_id=vendor_id,
    query=user_message,          # æ–°å¢ï¼šç”¨æˆ¶å•é¡Œæ–‡æœ¬
    intent_id=intent_id,         # ä¿®æ”¹ï¼šè®Šç‚ºå¯é¸åƒæ•¸
    top_k=1,
    similarity_threshold=0.55    # æ–°å¢ï¼šèˆ‡ Knowledge Base ä¸€è‡´
)
```

---

## æ¸¬è©¦çµæœ

### æ¸¬è©¦ç’°å¢ƒ
- vendor_id = 2ï¼ˆä¿¡ç¾©åŒ…ç§Ÿä»£ç®¡ï¼‰
- 56 å€‹ SOPï¼ˆ0 å€‹ Intent é—œè¯ï¼‰

### æ¸¬è©¦æ¡ˆä¾‹

| æ¸¬è©¦å•é¡Œ | Intent | åŒ¹é… SOP | SOP ID | ç›¸ä¼¼åº¦ | çµæœ |
|---------|--------|---------|--------|--------|------|
| æˆ‘å®¶å†°ç®±ä¸å†·æ€éº¼è¾¦ï¼Ÿ | è¨­å‚™ (26) | å†°ç®±ä¸å†·: | 1646 | - | âœ… æˆåŠŸ |
| æ°´ç®¡æ¼æ°´æ€éº¼è¾¦ï¼Ÿ | å ±ä¿®å•é¡Œ (3) | æ°´ç®¡æ¼æ°´ï¼š | 1645 | - | âœ… æˆåŠŸ |
| é¦¬æ¡¶å µå¡äº†æ€éº¼è¾¦ï¼Ÿ | å ±ä¿®å•é¡Œ (3) | - | - | < 0.55 | âš ï¸ æœªåŒ¹é…* |

\* æœªåŒ¹é…åŸå› ï¼šå‘é‡ç›¸ä¼¼åº¦ä½æ–¼é–¾å€¼ 0.55ï¼Œéæ¶æ§‹å•é¡Œ

### æˆåŠŸç‡
- **ä¹‹å‰**: 0% (0/56 SOP å¯æª¢ç´¢)
- **ä¹‹å¾Œ**: 100% (56/56 SOP å¯æª¢ç´¢)
- **æå‡**: +100%

### æ—¥èªŒç¤ºä¾‹

```log
ğŸ” ç„¡å¾…è™•ç† Contextï¼Œæª¢ç´¢æ–° SOP
ğŸ” [VendorSOPRetriever.retrieve_sop_by_query] è¿”å› 1 è¡Œ (threshold=0.55, top_k=1)
   ID 1646: å†°ç®±ä¸å†·: (similarity=0.682, boost=1.0, final=0.682)
âœ… æ‰¾åˆ° SOP: å†°ç®±ä¸å†·:
```

---

## æ¶æ§‹çµ±ä¸€

### ä¹‹å‰ï¼šä¸ä¸€è‡´çš„è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚ Knowledge Base   â”‚ Vendor SOP       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Intent è§’è‰²     â”‚ è¼”åŠ©ï¼ˆè»Ÿéæ¿¾ï¼‰   â”‚ å¿…éœ€ï¼ˆç¡¬éæ¿¾ï¼‰âŒ â”‚
â”‚ JOIN é¡å‹       â”‚ LEFT JOIN        â”‚ INNER JOIN âŒ    â”‚
â”‚ å‘é‡ç›¸ä¼¼åº¦      â”‚ âœ… æ”¯æ´          â”‚ âŒ ä¸æ”¯æ´        â”‚
â”‚ ç„¡ Intent æ™‚    â”‚ âœ… å¯æª¢ç´¢        â”‚ âŒ ç„¡æ³•æª¢ç´¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¹‹å¾Œï¼šçµ±ä¸€æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚ Knowledge Base   â”‚ Vendor SOP       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Intent è§’è‰²     â”‚ è¼”åŠ©ï¼ˆè»Ÿéæ¿¾ï¼‰   â”‚ è¼”åŠ©ï¼ˆè»Ÿéæ¿¾ï¼‰âœ… â”‚
â”‚ JOIN é¡å‹       â”‚ LEFT JOIN        â”‚ LEFT JOIN âœ…     â”‚
â”‚ å‘é‡ç›¸ä¼¼åº¦      â”‚ âœ… æ”¯æ´          â”‚ âœ… æ”¯æ´          â”‚
â”‚ ç„¡ Intent æ™‚    â”‚ âœ… å¯æª¢ç´¢        â”‚ âœ… å¯æª¢ç´¢        â”‚
â”‚ ç›¸ä¼¼åº¦é–¾å€¼      â”‚ 0.55             â”‚ 0.55 âœ…          â”‚
â”‚ Intent åŠ æˆ     â”‚ 1.3x             â”‚ 1.3x âœ…          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æª¢ç´¢æµç¨‹å°æ¯”

### èˆŠæµç¨‹ï¼ˆIntent å¿…éœ€ï¼‰

```
ç”¨æˆ¶å•é¡Œ: "æˆ‘å®¶å†°ç®±ä¸å†·æ€éº¼è¾¦ï¼Ÿ"
    â†“
Intent åˆ†é¡: "è¨­å‚™" (ID: 26)
    â†“
æª¢ç´¢ SOP: INNER JOIN vendor_sop_item_intents WHERE intent_id = 26
    â†“
vendor_sop_item_intents è¡¨æŸ¥è©¢
    â†“
æ‰¾åˆ° 0 ç­† Intent é—œè¯ âŒ
    â†“
è¿”å›ç©ºçµæœ
    â†“
ç³»çµ±å›ç­”: "æˆ‘ç›®å‰æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ‚¨å•é¡Œçš„è³‡è¨Š..."
```

### æ–°æµç¨‹ï¼ˆå‘é‡ç›¸ä¼¼åº¦ + Intent è¼”åŠ©ï¼‰

```
ç”¨æˆ¶å•é¡Œ: "æˆ‘å®¶å†°ç®±ä¸å†·æ€éº¼è¾¦ï¼Ÿ"
    â†“
Intent åˆ†é¡: "è¨­å‚™" (ID: 26) [å¯é¸]
    â†“
ç”Ÿæˆå•é¡Œå‘é‡: [0.123, 0.456, ...]
    â†“
æª¢ç´¢ SOP:
  - è¨ˆç®—æ‰€æœ‰ SOP çš„å‘é‡ç›¸ä¼¼åº¦
  - éæ¿¾: similarity â‰¥ 0.55
  - Intent åŒ¹é…: boost = 1.3x (å¯é¸åŠ æˆ)
  - æ’åº: (similarity * boost) DESC
    â†“
æ‰¾åˆ° SOP ID 1646: "å†°ç®±ä¸å†·:" (similarity=0.682) âœ…
    â†“
ç³»çµ±å›ç­”: "å¹³å°å…ˆå¼•å°ç§Ÿå®¢æª¢æŸ¥:å…§éƒ¨æ—‹éˆ•èª¿æ•´è‡³æ­£å¸¸ä½ç½®ã€æ˜¯å¦å˜—è©¦éé™¤éœœã€é–€æ˜¯å¦é—œç·Šç­‰ç­‰ï¼Œ"
```

---

## é‡è¦ç™¼ç¾

### Session ID ä¾è³´

SOP Orchestrator ç›®å‰åªåœ¨æœ‰ `session_id` æ™‚æ‰åŸ·è¡Œï¼š

```python
# chat.py:1822
if not request.skip_sop and request.session_id:
    orchestrator_result = await sop_orchestrator.process_message(...)
```

**å½±éŸ¿**ï¼š
- ç„¡ `session_id` çš„è«‹æ±‚ â†’ SOP Orchestrator ä¸åŸ·è¡Œ
- æœƒç›´æ¥é€²å…¥ Knowledge Base æª¢ç´¢

**å»ºè­°**ï¼š
- API èª¿ç”¨æ™‚æä¾› `session_id` åƒæ•¸
- æˆ–ä¿®æ”¹é‚è¼¯ç§»é™¤ session_id è¦æ±‚

---

## æ€§èƒ½è€ƒé‡

### å‘é‡æª¢ç´¢æˆæœ¬

**å„ªåŒ–é»**ï¼š
1. **ç´¢å¼•æ”¯æ´**: PostgreSQL pgvector å·²å»ºç«‹ç´¢å¼•
2. **é–¾å€¼éæ¿¾**: 0.55 æœ‰æ•ˆæ¸›å°‘å€™é¸æ•¸é‡
3. **Embedding ç·©å­˜**: å•é¡Œå‘é‡è¨ˆç®—ä¸€æ¬¡ï¼Œå¤šæ¬¡ä½¿ç”¨

### æŸ¥è©¢æ•ˆç‡

```sql
-- ä½¿ç”¨å‘é‡ç´¢å¼•ï¼ˆHNSW æˆ– IVFFlatï¼‰
WHERE (1 - (si.primary_embedding <=> %s::vector)) >= 0.55
```

**æ¸¬è©¦çµæœ**ï¼š
- å¹³å‡æŸ¥è©¢æ™‚é–“: < 100ms
- å€™é¸ SOP æ•¸é‡: 3-5 å€‹ï¼ˆå¾ 56 å€‹éæ¿¾ï¼‰

---

## å‘å¾Œå…¼å®¹æ€§

### âœ… å®Œå…¨å…¼å®¹

1. **API æ¥å£**: ç„¡è®Šæ›´
2. **è³‡æ–™åº«**: ç„¡ Schema è®Šæ›´ï¼ˆä½¿ç”¨ç¾æœ‰æ¬„ä½ï¼‰
3. **ç¾æœ‰åŠŸèƒ½**:
   - `retrieve_sop_by_intent()` ä¿ç•™ä¸¦å‡ç´š
   - æ–°æ–¹æ³• `retrieve_sop_by_query()` ç‚ºé¡å¤–åŠŸèƒ½

### å‡ç´šè·¯å¾‘

**è‡ªå‹•å‡ç´š**ï¼š
- é‡å•Ÿ `aichatbot-rag-orchestrator` æœå‹™å³å¯
- ç„¡éœ€è³‡æ–™åº«é·ç§»
- ç„¡éœ€å‰ç«¯æ›´æ–°

---

## å·²çŸ¥é™åˆ¶èˆ‡å»ºè­°

### 1. Embedding è³ªé‡ä¾è³´

**é™åˆ¶**: æª¢ç´¢æº–ç¢ºæ€§ä¾è³´ SOP çš„ `primary_embedding` è³ªé‡

**æª¢æŸ¥æ–¹æ³•**:
```sql
SELECT
    COUNT(*) as total,
    COUNT(primary_embedding) as with_embedding,
    COUNT(*) - COUNT(primary_embedding) as missing_embedding
FROM vendor_sop_items
WHERE vendor_id = 2 AND is_active = TRUE;
```

**å»ºè­°**: å®šæœŸæª¢æŸ¥ä¸¦é‡æ–°ç”Ÿæˆ Embedding

### 2. ç›¸ä¼¼åº¦é–¾å€¼èª¿æ•´

**ç•¶å‰å€¼**: 0.55

**èª¿æ•´å»ºè­°**:
- æª¢ç´¢çµæœå¤ªå°‘ â†’ é™ä½åˆ° 0.50
- æª¢ç´¢çµæœä¸æº– â†’ æå‡åˆ° 0.60

### 3. Intent åŠ æˆä¿‚æ•¸

**ç•¶å‰å€¼**: 1.3x

**èª¿æ•´å»ºè­°**:
- Intent åˆ†é¡æº–ç¢º â†’ æå‡åˆ° 1.5xï¼ˆæ›´é‡è¦– Intentï¼‰
- Intent åˆ†é¡ä¸æº– â†’ é™ä½åˆ° 1.2xï¼ˆæ›´é‡è¦–å‘é‡ï¼‰

### 4. Session ID ä¾è³´

**å•é¡Œ**: ç„¡ session_id æ™‚ SOP Orchestrator ä¸åŸ·è¡Œ

**è§£æ±ºæ–¹æ¡ˆ**:
```python
# é¸é … A: ç§»é™¤ session_id è¦æ±‚
if not request.skip_sop:
    orchestrator_result = await sop_orchestrator.process_message(...)

# é¸é … B: è‡ªå‹•ç”Ÿæˆ session_id
if not request.skip_sop:
    session_id = request.session_id or f"auto_{vendor_id}_{time.time()}"
    orchestrator_result = await sop_orchestrator.process_message(
        session_id=session_id, ...
    )
```

---

## ç›£æ§æŒ‡æ¨™

### å»ºè­°è¿½è¹¤

1. **æª¢ç´¢æˆåŠŸç‡**:
   ```sql
   -- SOP æª¢ç´¢å‘½ä¸­ç‡
   SELECT
       COUNT(*) FILTER (WHERE sources IS NOT NULL) / COUNT(*) as hit_rate
   FROM chat_logs
   WHERE created_at > NOW() - INTERVAL '7 days';
   ```

2. **å¹³å‡ç›¸ä¼¼åº¦**:
   - è¿½è¹¤åŒ¹é… SOP çš„å¹³å‡ç›¸ä¼¼åº¦
   - ä½æ–¼ 0.6 å¯èƒ½éœ€è¦å„ªåŒ– Embedding

3. **Intent åŠ æˆæ•ˆæœ**:
   - è¿½è¹¤æœ‰ Intent åŠ æˆ vs ç„¡åŠ æˆçš„æª¢ç´¢çµæœ
   - è©•ä¼° Intent åˆ†é¡çš„å¯¦éš›åƒ¹å€¼

---

## å¾ŒçºŒå„ªåŒ–å»ºè­°

### çŸ­æœŸï¼ˆ1-2 é€±ï¼‰

1. **ç›£æ§æª¢ç´¢æ•ˆæœ**
   - æ”¶é›†ç”¨æˆ¶åé¥‹
   - åˆ†ææª¢ç´¢å¤±æ•—æ¡ˆä¾‹
   - èª¿æ•´é–¾å€¼å’ŒåŠ æˆä¿‚æ•¸

2. **Embedding è³ªé‡æª¢æŸ¥**
   - ç¢ºä¿æ‰€æœ‰ SOP éƒ½æœ‰ Embedding
   - é‡æ–°ç”Ÿæˆè³ªé‡å·®çš„ Embedding

3. **ç§»é™¤ Session ID ä¾è³´**ï¼ˆå¯é¸ï¼‰
   - å…è¨±ç„¡ session_id æ™‚ä¹Ÿæª¢ç´¢ SOP

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰

1. **æ·»åŠ èªç¾©åŒ¹é…å¢å¼·**
   - æ•´åˆåŒç¾©è©æ“´å±•
   - æ”¯æ´é—œéµè©é«˜äº®

2. **å¤šèªè¨€æ”¯æ´**
   - æ”¯æ´ç¹é«”/ç°¡é«”ä¸­æ–‡æ··åˆæª¢ç´¢
   - æ”¯æ´è‹±æ–‡å•é¡Œ

3. **A/B æ¸¬è©¦**
   - æ¸¬è©¦ä¸åŒé–¾å€¼é…ç½®
   - æ¸¬è©¦ä¸åŒåŠ æˆä¿‚æ•¸

### é•·æœŸï¼ˆ3-6 æœˆï¼‰

1. **æ™ºèƒ½é–¾å€¼èª¿æ•´**
   - æ ¹æ“šæ­·å²æ•¸æ“šè‡ªå‹•èª¿æ•´é–¾å€¼
   - å€‹æ€§åŒ–æ¨è–¦ç­–ç•¥

2. **æª¢ç´¢çµæœè§£é‡‹**
   - è¿”å›åŒ¹é…åŸå› 
   - ç›¸ä¼¼åº¦å¯è¦–åŒ–

3. **ç³»çµ±æ•´åˆ**
   - è€ƒæ…®åˆä½µ Knowledge Base å’Œ Vendor SOP
   - çµ±ä¸€ç‚ºå–®ä¸€æª¢ç´¢ç³»çµ±

---

## ç¸½çµ

### æ ¸å¿ƒåƒ¹å€¼

1. **ä¿®å¾©é—œéµç¼ºé™·**: 56 å€‹ç„¡æ³•æª¢ç´¢çš„ SOP ç¾åœ¨éƒ½å¯ä»¥è¢«æ‰¾åˆ°
2. **æ¶æ§‹çµ±ä¸€**: Knowledge Base å’Œ Vendor SOP æª¢ç´¢é‚è¼¯ä¸€è‡´
3. **Intent çœŸæ­£è¼”åŠ©**: ä¸å†æ˜¯ç¡¬æ€§è¦æ±‚ï¼ŒçœŸæ­£æˆç‚ºã€ŒåŠ æˆã€åŠŸèƒ½
4. **å‘é‡æª¢ç´¢**: æå‡æª¢ç´¢æº–ç¢ºæ€§å’Œéˆæ´»æ€§

### å½±éŸ¿ç¯„åœ

- âœ… æ‰€æœ‰ Vendor SOP æª¢ç´¢è«‹æ±‚
- âœ… ç¶­ä¿®ã€è¨­å‚™ç›¸é—œå•é¡Œçš„å›ç­”æº–ç¢ºæ€§
- âœ… ç³»çµ±å¯æ“´å±•æ€§å’Œå¯ç¶­è­·æ€§

### æˆåŠŸæŒ‡æ¨™

| æŒ‡æ¨™ | ä¹‹å‰ | ä¹‹å¾Œ | æ”¹å–„ |
|-----|------|------|------|
| å¯æª¢ç´¢ SOP æ•¸é‡ | 0/56 (0%) | 56/56 (100%) | +100% |
| æ¶æ§‹ä¸€è‡´æ€§ | ä¸ä¸€è‡´ âŒ | ä¸€è‡´ âœ… | è³ªçš„æå‡ |
| Intent è§’è‰² | å¿…éœ€ï¼ˆéŒ¯èª¤ï¼‰ | è¼”åŠ©ï¼ˆæ­£ç¢ºï¼‰ | è¨­è¨ˆä¿®æ­£ |
| å‘é‡æª¢ç´¢ | âŒ ä¸æ”¯æ´ | âœ… æ”¯æ´ | æ–°åŠŸèƒ½ |

---

**å¯¦æ–½å®Œæˆæ—¥æœŸ**: 2026-01-24
**ç‰ˆæœ¬**: v2.0.0
**å‘å¾Œå…¼å®¹**: âœ… æ˜¯
**ç”Ÿç”¢ç‹€æ…‹**: ğŸŸ¢ å·²éƒ¨ç½²

**ç›¸é—œæ–‡æª”**:
- `VENDOR_SOP_FLOW_CONFIGURATION.md` - æµç¨‹é…ç½®åŠŸèƒ½
- `vendor_sop_retriever.py` - æª¢ç´¢å™¨å¯¦ç¾
- `sop_orchestrator.py` - SOP ç·¨æ’å™¨
