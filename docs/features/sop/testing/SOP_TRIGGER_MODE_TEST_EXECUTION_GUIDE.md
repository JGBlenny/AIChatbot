# 🧪 SOP 觸發模式測試執行指南

**測試日期**: 2026-02-03
**預估時間**: 30-45 分鐘
**測試人員**: _____________

---

## 🎯 測試目標

驗證所有表單組合場景正常運作,確保:
1. ✅ 欄位顯示順序正確
2. ✅ 觸發模式預設值正確
3. ✅ 欄位顯示邏輯正確
4. ✅ 資料儲存和載入正確
5. ✅ 舊資料相容性正確

---

## 📊 測試資料準備

### 已準備 7 筆測試資料

| ID | 標題 | action_type | trigger_mode | 測試目的 |
|----|------|-------------|--------------|---------|
| 1284 | 測試-無後續動作 | direct_answer | NULL | 驗證無後續動作時不顯示觸發模式 |
| 1285 | 測試-舊資料-NULL | form_fill | NULL | 驗證 NULL 值 fallback 為 'manual' |
| 1286 | 測試-排查型-完整 | form_fill | manual | 驗證排查型完整資料顯示 |
| 1287 | 測試-排查型-空關鍵詞 | form_fill | manual | 驗證關鍵詞必填驗證 |
| 1288 | 測試-行動型-完整 | form_fill | immediate | 驗證行動型完整資料顯示 |
| 1289 | 測試-行動型-空提示詞 | form_fill | immediate | 驗證提示詞為選填 |
| 1290 | 測試-行動型-NULL提示詞 | form_fill | immediate | 驗證 NULL 提示詞顯示 |

### 資料已插入資料庫

測試資料已準備完成，無需手動操作。

---

## 🧪 測試執行步驟

### 準備工作

**1. 開啟瀏覽器開發者工具**
```
按 F12 → Console 分頁
```

**2. 清除瀏覽器快取**
```
右鍵重新整理按鈕 → 「清除快取並強制重新整理」
```

**3. 訪問知識庫管理頁面**
```
http://localhost:8080/#/knowledge
```

---

## 📋 測試場景清單

### 場景 1: 新增知識庫 - 排查型 ⭐

**測試步驟**:
1. 點擊「新增知識庫」
2. 填寫「知識庫標題」: "手動測試-排查型"
3. 填寫「知識庫內容」: "排查步驟：1. 檢查 2. 確認 3. 測試"
4. 選擇「後續動作」= 「觸發表單（引導用戶填寫表單）」
5. **觀察**: 「選擇表單 *」欄位是否出現？ □ 是 □ 否
6. 選擇表單 = 「報修申請表 (maintenance_request)」
7. **觀察**: 控制台是否顯示 `📋 表單選擇後 trigger_mode: manual`？ □ 是 □ 否
8. **檢查**: 「觸發模式 *」欄位是否顯示？ □ 是 □ 否
9. **檢查**: 觸發模式下拉選單預設值是否為「排查型」？ □ 是 □ 否
10. **檢查**: 「觸發關鍵詞 *」欄位是否顯示？ □ 是 □ 否
11. **檢查**: 欄位顯示順序是否為: 後續動作 → 選擇表單 → 觸發模式 → 觸發關鍵詞？ □ 是 □ 否
12. 填寫關鍵詞: "還是不行"
13. 點擊「儲存」
14. **驗證**: 儲存是否成功？ □ 是 □ 否

**預期結果**:
- ✅ 所有欄位按順序顯示
- ✅ 觸發模式預設為「排查型」
- ✅ 控制台有 log 訊息
- ✅ 關鍵詞欄位顯示
- ✅ 儲存成功

**實際結果**: _____________

---

### 場景 2: 新增知識庫 - 行動型 ⭐

**測試步驟**:
1. 點擊「新增知識庫」
2. 填寫「知識庫標題」: "手動測試-行動型"
3. 填寫「知識庫內容」: "租金繳納方式說明..."
4. 選擇「後續動作」= 「觸發表單」
5. 選擇表單 = 「租屋申請表 (rental_application)」
6. **檢查**: 觸發模式預設為「排查型」？ □ 是 □ 否
7. 切換「觸發模式」為「行動型（主動詢問用戶是否執行）」
8. **觀察**: 「觸發關鍵詞 *」欄位是否消失？ □ 是 □ 否
9. **觀察**: 「確認提示詞（選填）」欄位是否出現？ □ 是 □ 否
10. 填寫提示詞: "是否要填寫租屋申請表？"
11. 點擊「儲存」
12. **驗證**: 儲存是否成功？ □ 是 □ 否

**預期結果**:
- ✅ 切換觸發模式時，欄位正確切換
- ✅ 關鍵詞欄位消失，提示詞欄位出現
- ✅ 提示詞為選填，可以填寫
- ✅ 儲存成功

**實際結果**: _____________

---

### 場景 3: 編輯舊資料 - NULL trigger_mode ⭐⭐⭐

**測試目的**: 驗證 NULL 值 fallback 邏輯

**測試步驟**:
1. 在知識庫列表中找到「測試-舊資料-NULL」(ID: 1285)
2. 點擊「編輯」
3. **檢查**: 「後續動作」是否顯示為「觸發表單」？ □ 是 □ 否
4. **檢查**: 「選擇表單」是否顯示為「報修申請表」？ □ 是 □ 否
5. **檢查**: 「觸發模式 *」欄位是否顯示？ □ 是 □ 否
6. **重點檢查**: 觸發模式下拉選單是否顯示「排查型」(fallback 值)？ □ 是 □ 否
7. **檢查**: 下拉選單是否為空白？ □ 是 □ 否
8. 不修改任何內容，點擊「儲存」
9. 重新編輯，確認觸發模式仍顯示「排查型」

**預期結果**:
- ✅ NULL 值正確 fallback 為 'manual'
- ✅ 下拉選單顯示「排查型」，不是空白
- ✅ 儲存後不修改原值 (仍為 NULL)

**實際結果**: _____________

**資料庫驗證**:
```sql
SELECT id, question_summary, trigger_mode
FROM knowledge_base
WHERE id = 1285;
-- 預期: trigger_mode 仍為 NULL (因為沒有修改)
```

---

### 場景 4: 編輯現有資料 - manual 模式

**測試步驟**:
1. 編輯「測試-排查型-完整」(ID: 1286)
2. **檢查**: 觸發模式顯示為「排查型」？ □ 是 □ 否
3. **檢查**: 觸發關鍵詞顯示 3 個: "還是不冷", "還是不行", "試過了還是不冷"？ □ 是 □ 否
4. 新增一個關鍵詞: "試過了沒效"
5. 點擊「儲存」
6. 重新編輯，確認新關鍵詞已保存

**預期結果**:
- ✅ manual 模式正確顯示
- ✅ 現有關鍵詞正確顯示
- ✅ 可以新增/刪除關鍵詞
- ✅ 儲存成功

**實際結果**: _____________

---

### 場景 5: 編輯現有資料 - immediate 模式

**測試步驟**:
1. 編輯「測試-行動型-完整」(ID: 1288)
2. **檢查**: 觸發模式顯示為「行動型」？ □ 是 □ 否
3. **檢查**: 確認提示詞顯示為「是否要填寫租屋申請表？」？ □ 是 □ 否
4. 修改提示詞為: "需要協助填寫租屋申請表嗎？"
5. 點擊「儲存」
6. 重新編輯，確認新提示詞已保存

**預期結果**:
- ✅ immediate 模式正確顯示
- ✅ 現有提示詞正確顯示
- ✅ 可以修改提示詞
- ✅ 儲存成功

**實際結果**: _____________

---

### 場景 6: 切換觸發模式

**測試步驟**:
1. 編輯「測試-排查型-空關鍵詞」(ID: 1287)
2. 當前為「排查型」，顯示「觸發關鍵詞 *」欄位
3. 填寫關鍵詞: "還是不行"
4. 切換為「行動型」
5. **觀察**: 關鍵詞欄位是否消失？ □ 是 □ 否
6. **觀察**: 提示詞欄位是否出現？ □ 是 □ 否
7. 填寫提示詞: "是否要提交維修申請？"
8. 點擊「儲存」
9. 重新編輯，確認為行動型且提示詞正確

**預期結果**:
- ✅ 切換模式時欄位正確切換
- ✅ 排查型的關鍵詞被清空
- ✅ 行動型的提示詞正確儲存

**實際結果**: _____________

---

### 場景 7: 無後續動作

**測試步驟**:
1. 編輯「測試-無後續動作」(ID: 1284)
2. **檢查**: 「後續動作」顯示為「無」？ □ 是 □ 否
3. **重點檢查**: 「選擇表單」欄位不顯示？ □ 是 □ 否
4. **重點檢查**: 「觸發模式」欄位不顯示？ □ 是 □ 否
5. **重點檢查**: 「觸發關鍵詞」欄位不顯示？ □ 是 □ 否
6. **重點檢查**: 「確認提示詞」欄位不顯示？ □ 是 □ 否
7. 修改內容，點擊「儲存」

**預期結果**:
- ✅ 所有表單相關欄位都不顯示
- ✅ 只顯示基本知識庫欄位
- ✅ 儲存成功

**實際結果**: _____________

---

### 場景 8: 必填欄位驗證

**測試步驟**:
1. 點擊「新增知識庫」
2. 選擇「後續動作」= 「觸發表單」
3. 選擇表單 = 「報修申請表」
4. 觸發模式預設為「排查型」
5. **不填寫觸發關鍵詞**
6. 嘗試點擊「儲存」
7. **檢查**: 是否顯示錯誤提示？ □ 是 □ 否
8. **檢查**: 錯誤訊息是否清楚說明需要填寫關鍵詞？ □ 是 □ 否

**預期結果**:
- ✅ 阻止儲存
- ✅ 顯示錯誤訊息: 「排查型模式必須填寫觸發關鍵詞」
- ✅ 錯誤訊息清晰

**實際結果**: _____________

---

### 場景 9: 提示文字檢查

**測試步驟**:
1. 點擊「新增知識庫」
2. 選擇「後續動作」= 「觸發表單」
3. 選擇表單
4. **檢查**: 觸發模式下方是否有詳細提示文字？ □ 是 □ 否
5. **閱讀提示**: 排查型的說明是否清楚？ □ 是 □ 否
6. **閱讀提示**: 行動型的說明是否清楚？ □ 是 □ 否
7. **閱讀提示**: 是否包含具體範例？ □ 是 □ 否
8. **閱讀提示**: 是否說明排查步驟應寫在「知識庫內容」？ □ 是 □ 否

**預期結果**:
- ✅ 提示文字清晰
- ✅ 包含具體範例
- ✅ 說明內容位置

**實際結果**: _____________

---

## 🔍 控制台檢查

### 必須檢查的 Log 訊息

測試過程中，控制台應該顯示:

```
✅ 選擇表單時:
📋 表單選擇後 trigger_mode: manual

❌ 不應該出現:
- Vue warn: ...
- Error: ...
- 404 錯誤
```

**控制台檢查**: □ 正常 □ 有錯誤

**錯誤訊息** (如果有): _____________

---

## 💾 資料庫驗證

### 驗證指令

```bash
# 查看測試資料
docker-compose exec -T postgres psql -U aichatbot -d aichatbot_admin < /tmp/verify_test_data.sql

# 查看特定記錄
docker-compose exec -T postgres psql -U aichatbot -d aichatbot_admin -c "
SELECT
    id,
    question_summary,
    trigger_mode,
    trigger_keywords,
    immediate_prompt
FROM knowledge_base
WHERE question_summary LIKE '測試-%' OR question_summary LIKE '手動測試-%'
ORDER BY id DESC
LIMIT 10;
"
```

### 驗證項目

- [ ] 排查型資料的 trigger_mode = 'manual'
- [ ] 行動型資料的 trigger_mode = 'immediate'
- [ ] 關鍵詞儲存為陣列格式
- [ ] 提示詞正確儲存
- [ ] 無後續動作的 trigger_mode = NULL

---

## 📊 測試結果統計

### 場景測試結果

| 場景 | 通過 | 失敗 | 阻塞 | 備註 |
|------|------|------|------|------|
| 1. 新增知識庫 - 排查型 | □ | □ | □ | |
| 2. 新增知識庫 - 行動型 | □ | □ | □ | |
| 3. 編輯舊資料 - NULL | □ | □ | □ | |
| 4. 編輯現有 - manual | □ | □ | □ | |
| 5. 編輯現有 - immediate | □ | □ | □ | |
| 6. 切換觸發模式 | □ | □ | □ | |
| 7. 無後續動作 | □ | □ | □ | |
| 8. 必填欄位驗證 | □ | □ | □ | |
| 9. 提示文字檢查 | □ | □ | □ | |

### 總計

- **通過**: _____ / 9
- **失敗**: _____ / 9
- **阻塞**: _____ / 9
- **通過率**: _____ %

---

## 🐛 發現的問題

### 問題 1

- **嚴重程度**: □ 高 □ 中 □ 低
- **問題描述**: _____________
- **重現步驟**: _____________
- **預期行為**: _____________
- **實際行為**: _____________
- **截圖/錯誤訊息**: _____________

### 問題 2

- **嚴重程度**: □ 高 □ 中 □ 低
- **問題描述**: _____________
- **重現步驟**: _____________
- **預期行為**: _____________
- **實際行為**: _____________
- **截圖/錯誤訊息**: _____________

---

## 🧹 測試後清理

### 清理測試資料

```bash
# 清理所有測試資料
docker-compose exec -T postgres psql -U aichatbot -d aichatbot_admin < /tmp/cleanup_test_data.sql

# 確認清理結果
docker-compose exec -T postgres psql -U aichatbot -d aichatbot_admin -c "
SELECT COUNT(*) AS 剩餘測試資料
FROM knowledge_base
WHERE question_summary LIKE '測試-%' OR question_summary LIKE '手動測試-%';
"
```

**清理完成**: □ 是 □ 否

---

## ✅ 測試完成簽核

- **測試執行人**: _____________
- **測試日期**: _____________
- **測試時長**: _____ 分鐘
- **整體評價**: □ 優秀 □ 良好 □ 需改進
- **建議**: _____________

---

## 📎 附件

- 測試詳細計畫: `SOP_TRIGGER_MODE_COMPREHENSIVE_TEST_PLAN.md`
- 準備資料腳本: `/tmp/prepare_sop_test_data_corrected.sql`
- 驗證腳本: `/tmp/verify_test_data.sql`
- 清理腳本: `/tmp/cleanup_test_data.sql`

---

**文件版本**: v1.0
**最後更新**: 2026-02-03
