# ğŸ”§ SOP å¾ŒçºŒå‹•ä½œè¨­è¨ˆæ–‡æª”

**æ—¥æœŸ**: 2026-01-22
**åŠŸèƒ½**: vendor_sop_items æ”¯æ´å¾ŒçºŒå‹•ä½œï¼ˆè¡¨å–®/APIï¼‰
**ç›®çš„**: è®“ SOP æ’æŸ¥æ­¥é©Ÿåœ¨ç„¡æ•ˆæ™‚ï¼Œè‡ªå‹•è§¸ç™¼ç¶­ä¿®è¡¨å–®

---

## ğŸ“‹ æ¥­å‹™å ´æ™¯

### å®Œæ•´å°è©±æµç¨‹

```
ç”¨æˆ¶ï¼šã€Œå†·æ°£ç„¡æ³•å•Ÿå‹•ã€
  â†“
ç³»çµ±ï¼šè¿”å› SOP æ’æŸ¥æ­¥é©Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€æ’æŸ¥æ­¥é©Ÿã€‘                        â”‚
â”‚ 1ï¸âƒ£ æª¢æŸ¥é›»æºæ’åº§æ˜¯å¦æ­£å¸¸            â”‚
â”‚ 2ï¸âƒ£ æª¢æŸ¥æ§åˆ¶é¢æ¿                    â”‚
â”‚ 3ï¸âƒ£ æª¢æŸ¥é™æ§å™¨                      â”‚
â”‚ 4ï¸âƒ£ æª¢æŸ¥é›»ç®±                        â”‚
â”‚                                    â”‚
â”‚ è‹¥ä»¥ä¸Šæ­¥é©Ÿéƒ½ç„¡æ³•è§£æ±ºï¼Œè«‹æäº¤ç¶­ä¿®è«‹æ±‚ã€‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ç”¨æˆ¶ï¼šã€Œéƒ½è©¦éäº†ï¼Œé‚„æ˜¯ä¸è¡Œã€â† è§¸ç™¼é—œéµè©
  â†“
ç³»çµ±ï¼šè‡ªå‹•è§¸ç™¼è¡¨å–®
ã€Œå¥½çš„ï¼Œæˆ‘ä¾†å”åŠ©æ‚¨æäº¤ç¶­ä¿®è«‹æ±‚ã€‚è«‹æä¾›ä¸€äº›è©³ç´°è³‡è¨Šã€‚ã€
  â†“
é–‹å§‹å¡«å¯« maintenance_troubleshooting è¡¨å–®
  â†“
è¡¨å–®å®Œæˆ â†’ èª¿ç”¨ maintenance_request API
  â†“
å‰µå»ºå·¥å–® â†’ æ´¾å·¥
```

---

## ğŸ—„ï¸ è³‡æ–™åº«è¨­è¨ˆ

### æ–°å¢æ¬„ä½

```sql
ALTER TABLE vendor_sop_items
ADD COLUMN next_action VARCHAR(50) DEFAULT 'none',           -- å¾ŒçºŒå‹•ä½œé¡å‹
ADD COLUMN next_form_id VARCHAR(100),                        -- è¦è§¸ç™¼çš„è¡¨å–®
ADD COLUMN next_api_config JSONB,                            -- è¦èª¿ç”¨çš„ API
ADD COLUMN trigger_keywords TEXT[],                          -- è§¸ç™¼é—œéµè©
ADD COLUMN followup_prompt TEXT;                             -- å¼•å°èª
```

### æ¬„ä½èªªæ˜

| æ¬„ä½ | é¡å‹ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|------|
| `next_action` | VARCHAR(50) | å¾ŒçºŒå‹•ä½œé¡å‹ | `none`, `form_fill`, `api_call`, `form_then_api` |
| `next_form_id` | VARCHAR(100) | è¦è§¸ç™¼çš„è¡¨å–® ID | `maintenance_troubleshooting` |
| `next_api_config` | JSONB | API é…ç½® | `{"endpoint": "maintenance_request", "params": {...}}` |
| `trigger_keywords` | TEXT[] | è§¸ç™¼é—œéµè©é™£åˆ— | `["é‚„æ˜¯ä¸è¡Œ", "è©¦éäº†", "éœ€è¦ç¶­ä¿®"]` |
| `followup_prompt` | TEXT | è§¸ç™¼æ™‚çš„å¼•å°èª | `å¥½çš„ï¼Œæˆ‘ä¾†å”åŠ©æ‚¨æäº¤ç¶­ä¿®è«‹æ±‚ã€‚` |

### SOP é…ç½®ç¯„ä¾‹

```sql
INSERT INTO vendor_sop_items (
    item_name,
    content,
    next_action,
    next_form_id,
    next_api_config,
    trigger_keywords,
    followup_prompt
) VALUES (
    'ç©ºèª¿ç„¡æ³•å•Ÿå‹•',

    -- SOP å…§å®¹ï¼ˆæ’æŸ¥æ­¥é©Ÿï¼‰
    'ã€æ’æŸ¥æ­¥é©Ÿã€‘
1ï¸âƒ£ æª¢æŸ¥é›»æºæ’åº§æ˜¯å¦æ­£å¸¸
2ï¸âƒ£ æª¢æŸ¥æ§åˆ¶é¢æ¿
3ï¸âƒ£ æª¢æŸ¥é™æ§å™¨
4ï¸âƒ£ æª¢æŸ¥é›»ç®±
è‹¥ä»¥ä¸Šæ­¥é©Ÿéƒ½ç„¡æ³•è§£æ±ºï¼Œè«‹æäº¤ç¶­ä¿®è«‹æ±‚ã€‚',

    -- å¾ŒçºŒå‹•ä½œé…ç½®
    'form_then_api',                          -- å…ˆå¡«è¡¨å–®ï¼Œå†èª¿ç”¨ API
    'maintenance_troubleshooting',            -- è¡¨å–® ID
    '{
        "endpoint": "maintenance_request",
        "params": {
            "problem_category": "ac_maintenance",
            "specific_problem": "ac_not_starting",
            "urgency_level": "urgent"
        }
    }'::jsonb,

    -- è§¸ç™¼é—œéµè©ï¼ˆç”¨æˆ¶èªªé€™äº›è©±æ™‚ï¼Œè‡ªå‹•è§¸ç™¼ï¼‰
    ARRAY['é‚„æ˜¯ä¸è¡Œ', 'è©¦éäº†', 'éƒ½è©¦éäº†', 'éœ€è¦ç¶­ä¿®', 'è«‹å¹«æˆ‘å ±ä¿®'],

    -- å¼•å°èª
    'å¥½çš„ï¼Œæˆ‘ä¾†å”åŠ©æ‚¨æäº¤ç¶­ä¿®è«‹æ±‚ã€‚è«‹æä¾›ä¸€äº›è©³ç´°è³‡è¨Šã€‚'
);
```

---

## ğŸ”„ å¯¦ç¾é‚è¼¯

### 1. SOP è¿”å›æ™‚ï¼Œè¨˜éŒ„åˆ° session

**ä½ç½®**: `rag-orchestrator/routers/chat.py` â†’ `_build_sop_response`

```python
async def _build_sop_response(...):
    # åŸæœ‰é‚è¼¯ï¼šè¿”å› SOP å…§å®¹
    raw_answer = _format_sop_answer(sop_items, group_name)

    # âœ… æ–°å¢ï¼šå¦‚æœ SOP æœ‰ next_actionï¼Œè¨˜éŒ„åˆ° session
    if sop_items and sop_items[0].get('next_action') != 'none':
        sop_item = sop_items[0]
        await _save_sop_context_to_session(
            session_id=request.session_id,
            user_id=request.user_id,
            vendor_id=request.vendor_id,
            sop_item_id=sop_item['id'],
            next_action=sop_item['next_action'],
            next_form_id=sop_item.get('next_form_id'),
            next_api_config=sop_item.get('next_api_config'),
            trigger_keywords=sop_item.get('trigger_keywords'),
            followup_prompt=sop_item.get('followup_prompt')
        )

    return response
```

### 2. ä¸‹ä¸€è¼ªå°è©±æª¢æŸ¥é—œéµè©

**ä½ç½®**: `rag-orchestrator/routers/chat.py` â†’ `vendor_chat` ä¸»æµç¨‹

```python
async def vendor_chat(...):
    # Step 1: æª¢æŸ¥æ˜¯å¦æœ‰å¾…è™•ç†çš„ SOP å¾ŒçºŒå‹•ä½œ
    sop_context = await _get_sop_context_from_session(
        session_id=request.session_id,
        user_id=request.user_id
    )

    if sop_context:
        # æª¢æŸ¥ç”¨æˆ¶è¨Šæ¯æ˜¯å¦åŒ…å«è§¸ç™¼é—œéµè©
        user_message = request.message.lower()
        trigger_keywords = sop_context.get('trigger_keywords', [])

        if any(keyword in user_message for keyword in trigger_keywords):
            # âœ… è§¸ç™¼å¾ŒçºŒå‹•ä½œ
            next_action = sop_context['next_action']

            if next_action in ['form_fill', 'form_then_api']:
                # è§¸ç™¼è¡¨å–®
                return await _trigger_form_from_sop(
                    request=request,
                    sop_context=sop_context
                )
            elif next_action == 'api_call':
                # ç›´æ¥èª¿ç”¨ API
                return await _trigger_api_from_sop(
                    request=request,
                    sop_context=sop_context
                )

    # åŸæœ‰æµç¨‹ï¼šæ„åœ–åˆ†é¡ â†’ SOP æª¢ç´¢ â†’ çŸ¥è­˜åº«æª¢ç´¢...
    ...
```

### 3. è§¸ç™¼è¡¨å–®

```python
async def _trigger_form_from_sop(request, sop_context):
    """å¾ SOP è§¸ç™¼è¡¨å–®å¡«å¯«"""
    form_id = sop_context['next_form_id']
    followup_prompt = sop_context.get('followup_prompt', 'è«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Š')

    # 1. é¡¯ç¤ºå¼•å°èª
    # 2. å‰µå»ºè¡¨å–®æœƒè©±
    # 3. é–‹å§‹æ”¶é›†ç¬¬ä¸€å€‹æ¬„ä½

    form_manager = get_form_manager()
    form_result = await form_manager.start_form(
        session_id=request.session_id,
        user_id=request.user_id,
        vendor_id=request.vendor_id,
        form_id=form_id,
        intro_message=followup_prompt,
        prefill_data=sop_context.get('next_api_config', {}).get('params', {})  # é å¡« SOP å·²çŸ¥è³‡è¨Š
    )

    # 4. å¦‚æœæ˜¯ form_then_apiï¼Œåœ¨è¡¨å–®å®Œæˆæ™‚è‡ªå‹•èª¿ç”¨ API
    if sop_context['next_action'] == 'form_then_api':
        await _save_form_callback(
            form_session_id=form_result['form_session_id'],
            api_config=sop_context['next_api_config']
        )

    return form_result
```

---

## ğŸ“Š Session è³‡æ–™çµæ§‹

### éœ€è¦æ–°å¢çš„ session è¿½è¹¤

**Option 1: ä½¿ç”¨ç¾æœ‰çš„ form_sessions è¡¨**

åœ¨ `form_sessions.collected_data` ä¸­æ–°å¢ `_sop_context` æ¬„ä½ï¼š

```json
{
  "_sop_context": {
    "sop_item_id": 123,
    "next_action": "form_then_api",
    "next_form_id": "maintenance_troubleshooting",
    "next_api_config": {...},
    "trigger_keywords": ["é‚„æ˜¯ä¸è¡Œ", "è©¦éäº†"],
    "followup_prompt": "å¥½çš„ï¼Œæˆ‘ä¾†å”åŠ©æ‚¨...",
    "created_at": "2026-01-22T10:30:00"
  },
  "tenant_name": "ç‹å°æ˜",
  ...
}
```

**Option 2: æ–°å¢å°ˆé–€çš„ sop_followup_sessions è¡¨**

```sql
CREATE TABLE sop_followup_sessions (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(100) NOT NULL,
    user_id VARCHAR(100),
    vendor_id INTEGER,
    sop_item_id INTEGER NOT NULL,

    next_action VARCHAR(50) NOT NULL,
    next_form_id VARCHAR(100),
    next_api_config JSONB,
    trigger_keywords TEXT[],
    followup_prompt TEXT,

    is_triggered BOOLEAN DEFAULT FALSE,
    triggered_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP DEFAULT NOW() + INTERVAL '1 hour'  -- 1å°æ™‚å¾ŒéæœŸ
);
```

**æ¨è–¦ Option 1** - åˆ©ç”¨ç¾æœ‰è¡¨çµæ§‹ï¼Œæ¸›å°‘è¤‡é›œåº¦ã€‚

---

## ğŸ¯ å„ªå…ˆç´šè™•ç†

### è‡ªå‹•å„ªå…ˆç´šè¨ˆç®—

å¾ SOP çš„ `next_api_config.params` ä¸­æå–å„ªå…ˆç´šè³‡è¨Šï¼š

```json
{
  "endpoint": "maintenance_request",
  "params": {
    "problem_category": "ac_maintenance",
    "specific_problem": "ac_not_starting",
    "urgency_level": "urgent"  â† è‡ªå‹•è¨­å®šå„ªå…ˆç´š
  }
}
```

å°æ‡‰åˆ°å·¥å–®å„ªå…ˆç´šï¼š
- `urgency_level: critical` â†’ P0ï¼ˆ1å°æ™‚å…§è™•ç†ï¼‰
- `urgency_level: urgent` â†’ P1ï¼ˆ4å°æ™‚å…§è™•ç†ï¼‰
- `urgency_level: normal` â†’ P2ï¼ˆ24å°æ™‚å…§è™•ç†ï¼‰
- `urgency_level: low` â†’ P3ï¼ˆ72å°æ™‚å…§è™•ç†ï¼‰

---

## ğŸ”„ å®Œæ•´æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ¶ï¼šã€Œå†·æ°£ç„¡æ³•å•Ÿå‹•ã€                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ„åœ–åˆ†é¡                                             â”‚
â”‚ â†’ intent: å†·æ°£ç¶­ä¿®                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: SOP æª¢ç´¢ï¼ˆå„ªå…ˆç´šæœ€é«˜ï¼‰                                â”‚
â”‚ â†’ æ‰¾åˆ° SOP: ã€Œç©ºèª¿ç„¡æ³•å•Ÿå‹•ã€                                  â”‚
â”‚ â†’ next_action: form_then_api                                â”‚
â”‚ â†’ trigger_keywords: ["é‚„æ˜¯ä¸è¡Œ", "è©¦éäº†", ...]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: è¿”å› SOP å…§å®¹ + è¨˜éŒ„ context åˆ° session              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ã€æ’æŸ¥æ­¥é©Ÿã€‘                                           â”‚   â”‚
â”‚ â”‚ 1ï¸âƒ£ æª¢æŸ¥é›»æºæ’åº§æ˜¯å¦æ­£å¸¸                               â”‚   â”‚
â”‚ â”‚ 2ï¸âƒ£ æª¢æŸ¥æ§åˆ¶é¢æ¿                                       â”‚   â”‚
â”‚ â”‚ 3ï¸âƒ£ æª¢æŸ¥é™æ§å™¨                                         â”‚   â”‚
â”‚ â”‚ 4ï¸âƒ£ æª¢æŸ¥é›»ç®±                                           â”‚   â”‚
â”‚ â”‚ è‹¥ä»¥ä¸Šæ­¥é©Ÿéƒ½ç„¡æ³•è§£æ±ºï¼Œè«‹æäº¤ç¶­ä¿®è«‹æ±‚ã€‚                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚ Session è¨˜éŒ„ï¼š                                               â”‚
â”‚ {                                                            â”‚
â”‚   "sop_item_id": 123,                                        â”‚
â”‚   "next_action": "form_then_api",                            â”‚
â”‚   "trigger_keywords": ["é‚„æ˜¯ä¸è¡Œ", "è©¦éäº†", ...]            â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ¶ï¼šã€Œéƒ½è©¦éäº†ï¼Œé‚„æ˜¯ä¸è¡Œã€â† åŒ…å«è§¸ç™¼é—œéµè©                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: æª¢æ¸¬åˆ°è§¸ç™¼é—œéµè©                                      â”‚
â”‚ â†’ "é‚„æ˜¯ä¸è¡Œ" in trigger_keywords                             â”‚
â”‚ â†’ è§¸ç™¼å¾ŒçºŒå‹•ä½œï¼šform_then_api                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: è§¸ç™¼è¡¨å–® (maintenance_troubleshooting)               â”‚
â”‚ â†’ é¡¯ç¤ºå¼•å°èªï¼šã€Œå¥½çš„ï¼Œæˆ‘ä¾†å”åŠ©æ‚¨æäº¤ç¶­ä¿®è«‹æ±‚ã€‚ã€              â”‚
â”‚ â†’ é å¡«è³‡æ–™ï¼š                                                  â”‚
â”‚   {                                                          â”‚
â”‚     "problem_category": "ac_maintenance",                    â”‚
â”‚     "specific_problem": "ac_not_starting",                   â”‚
â”‚     "urgency_level": "urgent"                                â”‚
â”‚   }                                                          â”‚
â”‚ â†’ é–‹å§‹æ”¶é›†æ¬„ä½ï¼šã€Œè«‹èªªæ˜å•é¡Œç™¼ç”Ÿçš„å…·é«”ä½ç½®ã€                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: è¡¨å–®å¡«å¯«æµç¨‹...                                       â”‚
â”‚ â†’ æ”¶é›†æ‰€æœ‰æ¬„ä½                                                â”‚
â”‚ â†’ ç”¨æˆ¶ç¢ºèªæäº¤                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: è¡¨å–®å®Œæˆ â†’ è‡ªå‹•èª¿ç”¨ API                               â”‚
â”‚ â†’ endpoint: maintenance_request                              â”‚
â”‚ â†’ params: {è¡¨å–®è³‡æ–™ + SOP é è¨­åƒæ•¸}                           â”‚
â”‚ â†’ å‰µå»ºå·¥å–®                                                    â”‚
â”‚ â†’ ç™¼é€é€šçŸ¥                                                    â”‚
â”‚ â†’ è¿”å›å·¥å–®ç·¨è™Ÿçµ¦ç”¨æˆ¶                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å¯¦æ–½æ­¥é©Ÿ

### Phase 1: è³‡æ–™åº«é·ç§»ï¼ˆ1 å¤©ï¼‰
1. âœ… åŸ·è¡Œ `add_sop_next_action_fields.sql` - æ“´å±•è¡¨çµæ§‹
2. âœ… åŸ·è¡Œ `insert_maintenance_sop_examples.sql` - æ’å…¥ç¤ºç¯„è³‡æ–™
3. é©—è­‰è³‡æ–™æ­£ç¢ºæ€§

### Phase 2: å¾Œç«¯é‚è¼¯å¯¦ä½œï¼ˆ3 å¤©ï¼‰
4. ä¿®æ”¹ `vendor_sop_retriever.py` - æŸ¥è©¢æ™‚åŒ…å«æ–°æ¬„ä½
5. ä¿®æ”¹ `chat.py` - åœ¨è¿”å› SOP æ™‚è¨˜éŒ„ context
6. æ–°å¢ session context ç®¡ç†å‡½æ•¸
7. æ–°å¢é—œéµè©æª¢æ¸¬é‚è¼¯
8. æ–°å¢å¾ SOP è§¸ç™¼è¡¨å–®çš„å‡½æ•¸
9. æ–°å¢å¾ SOP è§¸ç™¼ API çš„å‡½æ•¸

### Phase 3: æ¸¬è©¦èˆ‡å„ªåŒ–ï¼ˆ2 å¤©ï¼‰
10. ç«¯åˆ°ç«¯æ¸¬è©¦ï¼šSOP è¿”å› â†’ é—œéµè©è§¸ç™¼ â†’ è¡¨å–®å¡«å¯« â†’ API èª¿ç”¨
11. é‚Šç•Œæƒ…æ³æ¸¬è©¦ï¼šsession éæœŸã€é‡è¤‡è§¸ç™¼ã€é—œéµè©èª¤åˆ¤ç­‰
12. å„ªåŒ–è§¸ç™¼é—œéµè©ï¼ˆæ ¹æ“šå¯¦éš›å°è©±èª¿æ•´ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. Session éæœŸè™•ç†
- SOP context æ‡‰è©²æœ‰éæœŸæ™‚é–“ï¼ˆå»ºè­° 1 å°æ™‚ï¼‰
- éæœŸå¾Œä¸å†æª¢æ¸¬é—œéµè©ï¼Œé¿å…èª¤è§¸ç™¼

### 2. é‡è¤‡è§¸ç™¼é˜²è­·
- åŒä¸€å€‹ SOP context åªèƒ½è§¸ç™¼ä¸€æ¬¡
- è§¸ç™¼å¾Œç«‹å³æ¨™è¨˜ç‚º `is_triggered = true`

### 3. é—œéµè©èª¤åˆ¤
- è§¸ç™¼å‰å¯ä»¥å¢åŠ äºŒæ¬¡ç¢ºèªæ©Ÿåˆ¶
- ä¾‹å¦‚ï¼šã€Œçœ‹èµ·ä¾†æ’æŸ¥ç„¡æ•ˆï¼Œæ˜¯å¦è¦æäº¤ç¶­ä¿®è«‹æ±‚ï¼Ÿ(æ˜¯/å¦)ã€

### 4. å¤šè¼ªå°è©±è¿½è¹¤
- å¦‚æœç”¨æˆ¶åœ¨å¡«è¡¨å–®ä¸­é€”åˆå•å…¶ä»–å•é¡Œï¼Œéœ€è¦æ­£ç¢ºæ¢å¾© context
- åˆ©ç”¨ç¾æœ‰çš„ `form_sessions.state = 'DIGRESSION'` æ©Ÿåˆ¶

---

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

1. âœ… SOP è¿”å›å¾Œï¼Œç”¨æˆ¶èªªã€Œé‚„æ˜¯ä¸è¡Œã€èƒ½è‡ªå‹•è§¸ç™¼è¡¨å–®
2. âœ… è¡¨å–®é å¡« SOP å·²çŸ¥çš„è³‡è¨Šï¼ˆå•é¡Œé¡å‹ã€ç·Šæ€¥ç¨‹åº¦ï¼‰
3. âœ… è¡¨å–®å®Œæˆå¾Œè‡ªå‹•èª¿ç”¨ API å‰µå»ºå·¥å–®
4. âœ… æ•´å€‹æµç¨‹ç„¡ç¸«éŠœæ¥ï¼Œç”¨æˆ¶é«”é©—æµæš¢

---

**æ–‡æª”ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2026-01-22
