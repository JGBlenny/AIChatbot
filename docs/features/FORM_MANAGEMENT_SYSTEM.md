# ğŸ“‹ å‹•æ…‹è¡¨å–®æ”¶é›†ç³»çµ±

## æ¦‚è¿°

å‹•æ…‹è¡¨å–®æ”¶é›†ç³»çµ±å…è¨± AI èŠå¤©æ©Ÿå™¨äººåœ¨å°è©±éç¨‹ä¸­è‡ªå‹•è§¸ç™¼è¡¨å–®å¡«å¯«æµç¨‹ï¼Œæ”¶é›†çµæ§‹åŒ–æ•¸æ“šï¼Œä¸¦å°‡è¡¨å–®ç­”æ¡ˆèˆ‡çŸ¥è­˜åº«å›ç­”æ•´åˆï¼Œæä¾›ç„¡ç¸«çš„ç”¨æˆ¶é«”é©—ã€‚

**å¯¦ä½œæ™‚é–“**ï¼š2025-01-10
**ç‰ˆæœ¬**ï¼š1.0
**ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆä¸¦é©—è­‰

---

## ğŸ¯ æ¥­å‹™éœ€æ±‚

### å•é¡ŒèƒŒæ™¯

åœ¨å¯¦éš›æ¥­å‹™å ´æ™¯ä¸­ï¼ŒAI å®¢æœç³»çµ±éœ€è¦æ”¶é›†çµæ§‹åŒ–æ•¸æ“šï¼š

- **ã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€** â†’ éœ€è¦æ”¶é›†å§“åã€åœ°å€ã€é›»è©±ç­‰è³‡è¨Š
- **ã€Œæˆ‘è¦å ±ä¿®ã€** â†’ éœ€è¦æ”¶é›†å ±ä¿®é …ç›®ã€æè¿°ã€è¯çµ¡æ–¹å¼
- **ã€Œæˆ‘æƒ³é€€ç§Ÿã€** â†’ éœ€è¦æ”¶é›†é€€ç§ŸåŸå› ã€é è¨ˆæ—¥æœŸã€è¯çµ¡æ–¹å¼

å‚³çµ±åšæ³•æ˜¯è·³è½‰åˆ°å¤–éƒ¨è¡¨å–®é é¢ï¼Œä½†é€™æœƒï¼š
1. ä¸­æ–·å°è©±æµç¨‹
2. é™ä½ç”¨æˆ¶é«”é©—
3. å¢åŠ ç”¨æˆ¶æµå¤±ç‡

### è§£æ±ºæ–¹æ¡ˆ

å¯¦ä½œå°è©±å¼è¡¨å–®æ”¶é›†ç³»çµ±ï¼š
- **ç„¡ç¸«æ•´åˆ**ï¼šåœ¨å°è©±ä¸­è‡ªå‹•è§¸ç™¼è¡¨å–®
- **å¤šæ¬„ä½é©—è­‰**ï¼šæ”¯æ´å¤šç¨®æ¬„ä½é¡å‹ï¼ˆæ–‡å­—ã€æ•¸å­—ã€é¸é …ã€æ—¥æœŸç­‰ï¼‰
- **é›¢é¡Œè™•ç†**ï¼šå…è¨±ç”¨æˆ¶åœ¨å¡«è¡¨æ™‚æå•
- **çŸ¥è­˜æ•´åˆ**ï¼šè¡¨å–®å®Œæˆå¾Œé¡¯ç¤ºçŸ¥è­˜åº«ç­”æ¡ˆ

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### æ ¸å¿ƒçµ„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ¶å•é¡Œ                                â”‚
â”‚                   ã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Knowledge Retrieval (çŸ¥è­˜æª¢ç´¢)                     â”‚
â”‚  - æª¢ç´¢åˆ°çŸ¥è­˜ ID: 123                                        â”‚
â”‚  - çŸ¥è­˜é¡å‹: form (è¡¨å–®é¡å‹)                                  â”‚
â”‚  - é—œè¯è¡¨å–®: rental_application                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Form Manager (trigger_form_by_knowledge)           â”‚
â”‚  - å‰µå»ºè¡¨å–®æœƒè©± (session_id, vendor_id, form_id)             â”‚
â”‚  - å„²å­˜è§¸ç™¼å•é¡Œ: "æˆ‘æƒ³ç§Ÿæˆ¿å­"                                 â”‚
â”‚  - å„²å­˜çŸ¥è­˜ ID: 123                                          â”‚
â”‚  - ç‹€æ…‹: COLLECTING                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è¡¨å–®å¡«å¯«æµç¨‹                                â”‚
â”‚                                                              â”‚
â”‚  ç³»çµ±: è«‹æä¾›æ‚¨çš„å§“å                                         â”‚
â”‚  ç”¨æˆ¶: é™³æ…¶ç…Œ                      â† æ”¶é›†ç¬¬ä¸€å€‹æ¬„ä½            â”‚
â”‚                                                              â”‚
â”‚  ç³»çµ±: è«‹æä¾›æ‚¨çš„åœ°å€                                         â”‚
â”‚  ç”¨æˆ¶: å¸³å–®æ€éº¼ç¹³ï¼Ÿ                â† é›¢é¡Œæå•                  â”‚
â”‚                                                              â”‚
â”‚  ç³»çµ±: ğŸ’¡ æ‚¨çš„ç§Ÿå±‹ç”³è«‹è¡¨é‚„æœªå®Œæˆï¼Œéœ€è¦ç¹¼çºŒå¡«å¯«å—ï¼Ÿ             â”‚
â”‚       â€¢ è¼¸å…¥ã€Œç¹¼çºŒã€æ¢å¾©å¡«å¯«                                  â”‚
â”‚       â€¢ è¼¸å…¥ã€Œå›ç­”ã€å›ç­”æ‚¨çš„å•é¡Œ                              â”‚
â”‚       â€¢ è¼¸å…¥ã€Œå–æ¶ˆã€çµæŸ                                      â”‚
â”‚                                                              â”‚
â”‚  ç”¨æˆ¶: å›ç­”                        â† é¸æ“‡å›ç­”å•é¡Œ              â”‚
â”‚  ç³»çµ±: [å›ç­”å¸³å–®å•é¡Œ...]                                      â”‚
â”‚  ç‹€æ…‹: CANCELLED (è¡¨å–®å–æ¶ˆ)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¡¨å–®å®Œæˆæµç¨‹ (knowledge_id æ•´åˆ)                 â”‚
â”‚                                                              â”‚
â”‚  ç³»çµ±: è«‹æä¾›æ‚¨çš„å§“å                                         â”‚
â”‚  ç”¨æˆ¶: é™³æ…¶ç…Œ                                                â”‚
â”‚                                                              â”‚
â”‚  ç³»çµ±: è«‹æä¾›æ‚¨çš„åœ°å€                                         â”‚
â”‚  ç”¨æˆ¶: æ–°åŒ—å¸‚æ¨¹æ—å€                                           â”‚
â”‚                                                              â”‚
â”‚  ç³»çµ±: è«‹æä¾›æ‚¨çš„è¯çµ¡é›»è©±                                     â”‚
â”‚  ç”¨æˆ¶: 0911111111                                            â”‚
â”‚                                                              â”‚
â”‚  âœ… è¡¨å–®å¡«å¯«å®Œæˆï¼                                            â”‚
â”‚                                                              â”‚
â”‚  [å¾çŸ¥è­˜åº«è®€å–ç­”æ¡ˆï¼ŒçŸ¥è­˜ ID: 123]                             â”‚
â”‚  æ„Ÿè¬æ‚¨æäº¤ç§Ÿå±‹ç”³è«‹ï¼æˆ‘å€‘æœƒåœ¨ 3 å€‹å·¥ä½œå¤©å…§èˆ‡æ‚¨è¯ç¹«...          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ è³‡æ–™åº«è¨­è¨ˆ

### è¡¨å–®çµæ§‹è¡¨ (form_schemas)

å„²å­˜è¡¨å–®å®šç¾©å’Œæ¬„ä½é…ç½®ã€‚

```sql
CREATE TABLE form_schemas (
    id SERIAL PRIMARY KEY,
    form_id VARCHAR(100) UNIQUE NOT NULL,              -- è¡¨å–®å”¯ä¸€ID
    form_name VARCHAR(200) NOT NULL,                   -- è¡¨å–®åç¨±
    description TEXT,                                  -- è¡¨å–®æè¿°
    default_intro TEXT,                                -- é è¨­å¼•å°èª
    fields JSONB NOT NULL,                             -- è¡¨å–®æ¬„ä½å®šç¾©
    vendor_id INTEGER REFERENCES vendors(id),          -- æ¥­è€…ID (NULL=å…¨å±€)
    is_active BOOLEAN DEFAULT true,                    -- æ˜¯å¦å•Ÿç”¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_form_schemas_vendor ON form_schemas(vendor_id);
CREATE INDEX idx_form_schemas_active ON form_schemas(is_active);
```

#### æ¬„ä½å®šç¾© (fields JSONB)

```json
[
  {
    "field_name": "name",
    "field_label": "å§“å",
    "field_type": "text",
    "prompt": "è«‹æä¾›æ‚¨çš„å§“å",
    "required": true,
    "validation_type": "taiwan_name",
    "max_length": 50
  },
  {
    "field_name": "address",
    "field_label": "åœ°å€",
    "field_type": "text",
    "prompt": "è«‹æä¾›æ‚¨çš„åœ°å€",
    "required": true,
    "validation_type": "address",
    "max_length": 200
  },
  {
    "field_name": "phone",
    "field_label": "è¯çµ¡é›»è©±",
    "field_type": "text",
    "prompt": "è«‹æä¾›æ‚¨çš„è¯çµ¡é›»è©±",
    "required": true,
    "validation_type": "phone",
    "max_length": 20
  }
]
```

**æ”¯æ´çš„æ¬„ä½é¡å‹**ï¼š
- `text` - å–®è¡Œæ–‡å­—
- `textarea` - å¤šè¡Œæ–‡å­—
- `select` - å–®é¸é¸é …
- `multiselect` - å¤šé¸é¸é …
- `number` - æ•¸å­—
- `email` - Email
- `date` - æ—¥æœŸ

**é©—è­‰é¡å‹**ï¼š
- `taiwan_name` - å°ç£å§“åæ ¼å¼
- `taiwan_id` - å°ç£èº«åˆ†è­‰å­—è™Ÿ
- `phone` - é›»è©±è™Ÿç¢¼
- `email` - Email æ ¼å¼
- `address` - åœ°å€æ ¼å¼
- `none` - ç„¡é©—è­‰

---

### è¡¨å–®æœƒè©±è¡¨ (form_sessions)

è¿½è¹¤ç”¨æˆ¶è¡¨å–®å¡«å¯«é€²åº¦å’Œç‹€æ…‹ã€‚

```sql
CREATE TABLE form_sessions (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(100) NOT NULL,                  -- æœƒè©±ID (UUID)
    user_id VARCHAR(100) NOT NULL,                     -- ç”¨æˆ¶ID
    vendor_id INTEGER REFERENCES vendors(id),          -- æ¥­è€…ID
    form_id VARCHAR(100) REFERENCES form_schemas(form_id), -- è¡¨å–®ID
    state VARCHAR(20) NOT NULL,                        -- ç‹€æ…‹: COLLECTING/DIGRESSION/COMPLETED/CANCELLED
    current_field_index INTEGER DEFAULT 0,             -- ç•¶å‰æ¬„ä½ç´¢å¼•
    collected_data JSONB DEFAULT '{}',                 -- å·²æ”¶é›†çš„è³‡æ–™
    trigger_question TEXT,                             -- è§¸ç™¼è¡¨å–®çš„å•é¡Œ
    pending_question TEXT,                             -- å¾…è™•ç†çš„é›¢é¡Œå•é¡Œ
    knowledge_id INTEGER,                              -- é—œè¯çš„çŸ¥è­˜ID
    last_activity_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    cancelled_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_form_sessions_session ON form_sessions(session_id);
CREATE INDEX idx_form_sessions_state ON form_sessions(state);
CREATE INDEX idx_form_sessions_user ON form_sessions(user_id);
```

**ç‹€æ…‹èªªæ˜**ï¼š
- `COLLECTING` - æ”¶é›†ä¸­ï¼ˆæ­£åœ¨å¡«è¡¨ï¼‰
- `DIGRESSION` - é›¢é¡Œä¸­ï¼ˆç”¨æˆ¶æå•ï¼‰
- `COMPLETED` - å·²å®Œæˆ
- `CANCELLED` - å·²å–æ¶ˆ

---

### è¡¨å–®æäº¤è¨˜éŒ„è¡¨ (form_submissions)

å„²å­˜å·²å®Œæˆçš„è¡¨å–®æäº¤è³‡æ–™ã€‚

```sql
CREATE TABLE form_submissions (
    id SERIAL PRIMARY KEY,
    form_session_id INTEGER REFERENCES form_sessions(id), -- é—œè¯çš„æœƒè©±ID
    form_id VARCHAR(100) NOT NULL,                     -- è¡¨å–®ID
    user_id VARCHAR(100) NOT NULL,                     -- ç”¨æˆ¶ID
    vendor_id INTEGER REFERENCES vendors(id),          -- æ¥­è€…ID
    submitted_data JSONB NOT NULL,                     -- æäº¤çš„è³‡æ–™
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_form_submissions_form ON form_submissions(form_id);
CREATE INDEX idx_form_submissions_user ON form_submissions(user_id);
CREATE INDEX idx_form_submissions_vendor ON form_submissions(vendor_id);
CREATE INDEX idx_form_submissions_session ON form_submissions(form_session_id);
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å¯¦ä½œ

### 1. è¡¨å–®è§¸ç™¼ (trigger_form_by_knowledge)

**æª”æ¡ˆ**ï¼š`rag-orchestrator/services/form_manager.py`

ç•¶çŸ¥è­˜æª¢ç´¢ç™¼ç¾çŸ¥è­˜é—œè¯åˆ°è¡¨å–®æ™‚ï¼Œè‡ªå‹•è§¸ç™¼è¡¨å–®æ”¶é›†æµç¨‹ã€‚

```python
async def trigger_form_by_knowledge(
    self,
    knowledge_id: int,
    form_id: str,
    intro_message: str,
    session_id: str,
    user_id: str,
    vendor_id: int,
    trigger_question: str = None,  # æ–°å¢ï¼šè§¸ç™¼å•é¡Œ
    knowledge_id: int = None       # æ–°å¢ï¼šçŸ¥è­˜ID
) -> Dict:
    """
    æ ¹æ“šçŸ¥è­˜è§¸ç™¼è¡¨å–®

    Returns:
        {
            "answer": "å¼•å°èª + ç¬¬ä¸€å€‹æ¬„ä½æç¤º",
            "form_triggered": True,
            "form_id": "rental_application",
            "current_field": "name"
        }
    """
    # 1. å–å¾—è¡¨å–®çµæ§‹
    form_schema = await self.get_form_schema(form_id, vendor_id)
    if not form_schema:
        return {"answer": "æ‰¾ä¸åˆ°è¡¨å–®å®šç¾©", "error": True}

    # 2. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨é€²è¡Œä¸­çš„æœƒè©±ï¼ˆé¿å…é‡è¤‡å‰µå»ºï¼‰
    existing_session = await self.get_session_state(session_id)
    if existing_session and existing_session['state'] in ['COLLECTING', 'DIGRESSION']:
        session_state = existing_session
    else:
        # 3. å‰µå»ºæ–°çš„è¡¨å–®æœƒè©±
        session_state = await self.create_form_session(
            session_id=session_id,
            user_id=user_id,
            vendor_id=vendor_id,
            form_id=form_id,
            trigger_question=trigger_question,  # å„²å­˜è§¸ç™¼å•é¡Œ
            knowledge_id=knowledge_id           # å„²å­˜çŸ¥è­˜ID
        )

    # 4. ç²å–ç¬¬ä¸€å€‹æ¬„ä½
    first_field = form_schema['fields'][0]

    # 5. è¿”å›å¼•å°èª + ç¬¬ä¸€å€‹æ¬„ä½æç¤º
    return {
        "answer": f"{intro_message}\n\n{first_field['prompt']}",
        "form_triggered": True,
        "form_id": form_id,
        "current_field": first_field['field_name']
    }
```

**é‡è¦ä¿®æ”¹**ï¼š
1. æ–°å¢ `trigger_question` åƒæ•¸ - å„²å­˜è§¸ç™¼è¡¨å–®çš„åŸå§‹å•é¡Œ
2. æ–°å¢ `knowledge_id` åƒæ•¸ - å„²å­˜é—œè¯çš„çŸ¥è­˜IDï¼Œç”¨æ–¼å®Œæˆæ™‚é¡¯ç¤ºç­”æ¡ˆ
3. æ–°å¢é‡è¤‡å‰µå»ºæª¢æŸ¥ - é¿å…åŒä¸€ session_id å‰µå»ºå¤šå€‹è¡¨å–®æœƒè©±

---

### 2. è¡¨å–®æ¬„ä½æ”¶é›† (collect_form_field)

**æª”æ¡ˆ**ï¼š`rag-orchestrator/services/form_manager.py`

é€ä¸€æ”¶é›†è¡¨å–®æ¬„ä½ï¼Œè™•ç†é©—è­‰ã€é›¢é¡Œå•é¡Œã€‚

```python
async def collect_form_field(
    self,
    session_id: str,
    user_message: str,
    vendor_id: int
) -> Dict:
    """
    æ”¶é›†è¡¨å–®æ¬„ä½

    Returns:
        {
            "answer": "ä¸‹ä¸€å€‹æ¬„ä½æç¤º / å®Œæˆè¨Šæ¯",
            "form_completed": False/True,
            "current_field": "address",
            "collected_data": {...}
        }
    """
    # 1. ç²å–æœƒè©±ç‹€æ…‹
    session_state = await self.get_session_state(session_id)
    if not session_state:
        return {"answer": "æ‰¾ä¸åˆ°è¡¨å–®æœƒè©±", "error": True}

    # 2. ç²å–è¡¨å–®çµæ§‹
    form_schema = await self.get_form_schema(
        session_state['form_id'],
        vendor_id
    )

    # 3. æª¢æŸ¥é›¢é¡Œæƒ…æ³
    digression_type = await self._detect_digression(user_message, form_schema)
    if digression_type:
        return await self._handle_digression(
            session_state,
            user_message,
            digression_type,
            form_schema
        )

    # 4. é©—è­‰æ¬„ä½
    current_field = form_schema['fields'][session_state['current_field_index']]
    is_valid, error_message = await self._validate_field(
        user_message,
        current_field
    )

    if not is_valid:
        return {
            "answer": f"âŒ {error_message}\n\n{current_field['prompt']}",
            "validation_failed": True
        }

    # 5. å„²å­˜æ¬„ä½å€¼
    collected_data = session_state.get('collected_data', {})
    collected_data[current_field['field_name']] = user_message

    # 6. ç§»å‹•åˆ°ä¸‹ä¸€å€‹æ¬„ä½
    next_index = session_state['current_field_index'] + 1

    if next_index >= len(form_schema['fields']):
        # è¡¨å–®å®Œæˆ
        return await self._complete_form(session_state, form_schema, collected_data)
    else:
        # ç¹¼çºŒä¸‹ä¸€å€‹æ¬„ä½
        await self.update_session_state(
            session_id=session_id,
            current_field_index=next_index,
            collected_data=collected_data
        )

        next_field = form_schema['fields'][next_index]
        return {
            "answer": next_field['prompt'],
            "form_completed": False,
            "current_field": next_field['field_name']
        }
```

---

### 3. é›¢é¡Œè™•ç† (Digression Handling)

**æª”æ¡ˆ**ï¼š`rag-orchestrator/services/form_manager.py`

ç•¶ç”¨æˆ¶åœ¨å¡«è¡¨éç¨‹ä¸­æå•æ™‚ï¼Œæä¾›ä¸‰å€‹é¸é …ï¼šç¹¼çºŒã€å›ç­”ã€å–æ¶ˆã€‚

```python
async def _handle_digression(
    self,
    session_state: Dict,
    user_message: str,
    digression_type: str,
    form_schema: Dict
) -> Dict:
    """
    è™•ç†é›¢é¡Œæƒ…æ³

    é›¢é¡Œé¡å‹:
    - "cancel": ç”¨æˆ¶è¦å–æ¶ˆè¡¨å–®
    - "question": ç”¨æˆ¶å•å•é¡Œ
    """
    session_id = session_state['session_id']

    # 1. è™•ç†å–æ¶ˆè«‹æ±‚
    if digression_type == "cancel":
        await self.update_session_state(
            session_id=session_id,
            state=FormState.CANCELLED
        )

        # æª¢æŸ¥æ˜¯å¦æœ‰å¾…è™•ç†çš„å•é¡Œ
        pending_question = await asyncio.to_thread(
            self._get_pending_question_sync,
            session_id
        )

        if pending_question:
            return {
                "answer": "",
                "answer_pending_question": True,
                "pending_question": pending_question,
                "form_cancelled": True
            }
        else:
            return {
                "answer": "âœ… å·²å–æ¶ˆè¡¨å–®å¡«å¯«ã€‚"
            }

    # 2. è™•ç†å•é¡Œï¼ˆé›¢é¡Œï¼‰
    elif digression_type == "question":
        # å„²å­˜å¾…è™•ç†çš„å•é¡Œ
        await asyncio.to_thread(
            self._save_pending_question_sync,
            session_id,
            user_message
        )

        # æ›´æ–°ç‹€æ…‹ç‚ºé›¢é¡Œ
        await self.update_session_state(
            session_id=session_id,
            state=FormState.DIGRESSION
        )

        # æä¾›ä¸‰å€‹é¸é …
        return {
            "answer": f"ğŸ’¡ æ‚¨çš„**{form_schema['form_name']}**é‚„æœªå®Œæˆï¼Œéœ€è¦ç¹¼çºŒå¡«å¯«å—ï¼Ÿ\n"
                     f"â€¢ è¼¸å…¥ã€Œ**ç¹¼çºŒ**ã€æ¢å¾©å¡«å¯«\n"
                     f"â€¢ è¼¸å…¥ã€Œ**å›ç­”**ã€å›ç­”æ‚¨çš„å•é¡Œ\n"
                     f"â€¢ è¼¸å…¥ã€Œ**å–æ¶ˆ**ã€çµæŸ",
            "allow_resume": True,
            "pending_question": user_message
        }
```

#### è™•ç†ç”¨æˆ¶é¸æ“‡

```python
# åœ¨ collect_form_field å‡½æ•¸é–‹é ­æª¢æŸ¥ç‹€æ…‹
if session_state['state'] == FormState.DIGRESSION:
    user_choice = user_message.strip()

    if user_choice in ["ç¹¼çºŒ", "continue"]:
        # æ¢å¾©å¡«å¯«
        await self.update_session_state(
            session_id=session_id,
            state=FormState.COLLECTING
        )

        current_field = form_schema['fields'][session_state['current_field_index']]
        return {
            "answer": f"âœ… ç¹¼çºŒå¡«å¯«è¡¨å–®\n\n{current_field['prompt']}",
            "form_resumed": True
        }

    elif user_choice in ["å›ç­”", "å›ç­”å•é¡Œ", "answer"]:
        # å–æ¶ˆè¡¨å–®ä¸¦å›ç­”å•é¡Œ
        pending_question = await asyncio.to_thread(
            self._get_pending_question_sync,
            session_id
        )

        await self.update_session_state(
            session_id=session_id,
            state=FormState.CANCELLED
        )

        if pending_question:
            return {
                "answer": "",
                "answer_pending_question": True,
                "pending_question": pending_question,
                "form_cancelled": True
            }

    elif user_choice in ["å–æ¶ˆ", "cancel"]:
        # å–æ¶ˆè¡¨å–®
        # ... åŒä¸Š cancel è™•ç†
```

---

### 4. è¡¨å–®å®Œæˆèˆ‡çŸ¥è­˜æ•´åˆ

**æª”æ¡ˆ**ï¼š`rag-orchestrator/services/form_manager.py`

è¡¨å–®å®Œæˆå¾Œï¼Œå¾çŸ¥è­˜åº«è®€å–ç­”æ¡ˆä¸¦é¡¯ç¤ºã€‚

```python
async def _complete_form(
    self,
    session_state: Dict,
    form_schema: Dict,
    collected_data: Dict
) -> Dict:
    """
    å®Œæˆè¡¨å–®å¡«å¯«
    """
    # 1. æ›´æ–°æœƒè©±ç‹€æ…‹ç‚ºå·²å®Œæˆ
    await self.update_session_state(
        session_id=session_state['session_id'],
        state=FormState.COMPLETED,
        collected_data=collected_data
    )

    # 2. ä¿å­˜è¡¨å–®æäº¤è¨˜éŒ„
    submission_id = await self.save_form_submission(
        session_id=session_state['id'],
        form_id=session_state['form_id'],
        user_id=session_state['user_id'],
        vendor_id=session_state['vendor_id'],
        submitted_data=collected_data
    )

    # 3. å–å¾—å®Œæˆè¨Šæ¯ï¼ˆå¾çŸ¥è­˜åº«è®€å–ï¼‰
    completion_message = "âœ… **è¡¨å–®å¡«å¯«å®Œæˆï¼**\n\næ„Ÿè¬æ‚¨å®Œæˆè¡¨å–®ï¼æˆ‘å€‘æœƒå„˜å¿«è™•ç†æ‚¨çš„è³‡æ–™ã€‚"

    knowledge_id = session_state.get('knowledge_id')
    if knowledge_id:
        # å¾çŸ¥è­˜åº«è®€å–ç­”æ¡ˆ
        knowledge_answer = await asyncio.to_thread(
            self._get_knowledge_answer_sync,
            knowledge_id
        )

        if knowledge_answer:
            completion_message = f"âœ… **è¡¨å–®å¡«å¯«å®Œæˆï¼**\n\n{knowledge_answer}"

    return {
        "answer": completion_message,
        "form_completed": True,
        "submission_id": submission_id,
        "collected_data": collected_data
    }
```

**çŸ¥è­˜ç­”æ¡ˆè®€å–**ï¼š

```python
def _get_knowledge_answer_sync(self, knowledge_id: int) -> Optional[str]:
    """å¾è³‡æ–™åº«å–å¾—çŸ¥è­˜ç­”æ¡ˆï¼ˆåŒæ­¥ï¼‰"""
    try:
        with get_db_cursor(dict_cursor=True) as cursor:
            cursor.execute("""
                SELECT answer
                FROM knowledge_base
                WHERE id = %s
            """, (knowledge_id,))
            result = cursor.fetchone()
            return result['answer'] if result else None
    except Exception as e:
        print(f"âŒ å–å¾—çŸ¥è­˜ç­”æ¡ˆå¤±æ•—: {e}")
        return None
```

---

### 5. Chat API æ•´åˆ

**æª”æ¡ˆ**ï¼š`rag-orchestrator/routers/chat.py`

åœ¨ä¸»å°è©±æµç¨‹ä¸­æ•´åˆè¡¨å–®è™•ç†ã€‚

#### è§¸ç™¼è¡¨å–®

```python
# åœ¨ _build_knowledge_response å‡½æ•¸ä¸­
if best_knowledge.get('form_id'):
    # è§¸ç™¼è¡¨å–®
    form_intro = best_knowledge.get('form_intro') or \
                 f"æˆ‘éœ€è¦æ”¶é›†ä¸€äº›è³‡æ–™ä¾†å¹«åŠ©æ‚¨ã€‚"

    form_result = await form_manager.trigger_form_by_knowledge(
        knowledge_id=best_knowledge['id'],
        form_id=best_knowledge['form_id'],
        intro_message=form_intro,
        session_id=request.session_id,
        user_id=request.user_id,
        vendor_id=request.vendor_id,
        trigger_question=request.message  # å„²å­˜è§¸ç™¼å•é¡Œ
    )

    return _convert_form_result_to_response(form_result, request)
```

#### è™•ç†è¡¨å–®å–æ¶ˆèˆ‡å¾…è™•ç†å•é¡Œ

```python
# åœ¨ vendor_chat_message å‡½æ•¸ä¸­
if form_result.get('form_cancelled'):
    pending_question = form_result.get('pending_question')

    if pending_question:
        # æ›¿æ› request.message ç‚ºå¾…è™•ç†çš„å•é¡Œ
        request.message = pending_question
        # ç¹¼çºŒå¾€ä¸‹èµ°æ­£å¸¸æµç¨‹ï¼ˆçŸ¥è­˜æª¢ç´¢ï¼‰
    else:
        # æ²’æœ‰å¾…è™•ç†çš„å•é¡Œï¼Œç›´æ¥è¿”å›å–æ¶ˆè¨Šæ¯
        return _convert_form_result_to_response(form_result, request)
else:
    # è¡¨å–®æœªå–æ¶ˆï¼Œè¿”å›è¡¨å–®çµæœ
    return _convert_form_result_to_response(form_result, request)
```

---

## ğŸ“Š API ç«¯é»

### 1. è¡¨å–®ç®¡ç† API

#### åˆ—å‡ºæ‰€æœ‰è¡¨å–®

```http
GET /rag-api/v1/forms?vendor_id=1&is_active=true
```

**Response**:
```json
[
  {
    "id": 1,
    "form_id": "rental_application",
    "form_name": "ç§Ÿå±‹ç”³è«‹è¡¨",
    "description": "ç”¨æ–¼æ”¶é›†ç§Ÿå®¢ç§Ÿå±‹ç”³è«‹è³‡æ–™",
    "default_intro": "æˆ‘éœ€è¦æ”¶é›†ä¸€äº›è³‡æ–™ä¾†å”åŠ©æ‚¨ç§Ÿå±‹ã€‚",
    "fields": [...],
    "vendor_id": 1,
    "is_active": true,
    "created_at": "2025-01-10T10:00:00Z",
    "updated_at": "2025-01-10T10:00:00Z"
  }
]
```

#### å–å¾—å–®ä¸€è¡¨å–®

```http
GET /rag-api/v1/forms/{form_id}
```

#### å‰µå»ºè¡¨å–®

```http
POST /rag-api/v1/forms
Content-Type: application/json

{
  "form_id": "repair_request",
  "form_name": "ç¶­ä¿®ç”³è«‹è¡¨",
  "description": "ç”¨æ–¼æ”¶é›†ç¶­ä¿®ç”³è«‹è³‡æ–™",
  "default_intro": "è«‹æä¾›ç¶­ä¿®ç›¸é—œè³‡è¨Š",
  "fields": [
    {
      "field_name": "name",
      "field_label": "å§“å",
      "field_type": "text",
      "prompt": "è«‹æä¾›æ‚¨çš„å§“å",
      "required": true,
      "validation_type": "taiwan_name",
      "max_length": 50
    },
    {
      "field_name": "issue",
      "field_label": "ç¶­ä¿®é …ç›®",
      "field_type": "select",
      "prompt": "è«‹é¸æ“‡ç¶­ä¿®é …ç›®ï¼ˆå›è¦†ç·¨è™Ÿï¼‰ï¼š\n1. æ°´é›»\n2. é–€çª—\n3. å…¶ä»–",
      "required": true,
      "options": ["æ°´é›»", "é–€çª—", "å…¶ä»–"]
    }
  ],
  "vendor_id": 1,
  "is_active": true
}
```

#### æ›´æ–°è¡¨å–®

```http
PUT /rag-api/v1/forms/{form_id}
Content-Type: application/json

{
  "form_name": "æ›´æ–°å¾Œçš„è¡¨å–®åç¨±",
  "is_active": false
}
```

#### åˆªé™¤è¡¨å–®

```http
DELETE /rag-api/v1/forms/{form_id}
```

---

### 2. è¡¨å–®æäº¤è¨˜éŒ„ API

#### æŸ¥è©¢æäº¤è¨˜éŒ„

```http
GET /rag-api/v1/form-submissions?form_id=rental_application&vendor_id=1&limit=50&offset=0
```

**Response**:
```json
{
  "items": [
    {
      "id": 123,
      "form_id": "rental_application",
      "form_name": "ç§Ÿå±‹ç”³è«‹è¡¨",
      "user_id": "user_001",
      "vendor_id": 1,
      "vendor_name": "æ¥­è€…A",
      "submitted_data": {
        "name": "é™³æ…¶ç…Œ",
        "address": "æ–°åŒ—å¸‚æ¨¹æ—å€",
        "phone": "0911111111"
      },
      "submitted_at": "2025-01-10T14:30:00Z",
      "trigger_question": "æˆ‘æƒ³ç§Ÿæˆ¿å­"
    }
  ],
  "total": 100,
  "limit": 50,
  "offset": 0
}
```

---

## ğŸ¨ å‰ç«¯å¯¦ä½œ

### è¡¨å–®æäº¤è¨˜éŒ„é é¢

**æª”æ¡ˆ**ï¼š`knowledge-admin/frontend/src/views/FormSubmissionsView.vue`

#### ä¸»è¦åŠŸèƒ½

1. **éæ¿¾å™¨**ï¼šæŒ‰è¡¨å–®ã€æ¥­è€…éæ¿¾
2. **åˆ—è¡¨é¡¯ç¤º**ï¼šé¡¯ç¤ºæäº¤è¨˜éŒ„ï¼ˆå«è§¸ç™¼å•é¡Œï¼‰
3. **åˆ†é **ï¼šæ”¯æ´å¤§é‡è³‡æ–™åˆ†é 
4. **è©³æƒ… Modal**ï¼šæŸ¥çœ‹å®Œæ•´æäº¤è³‡æ–™

#### é—œéµä»£ç¢¼

```vue
<template>
  <div>
    <h2>ğŸ“‹ è¡¨å–®æäº¤è¨˜éŒ„</h2>

    <!-- éæ¿¾å™¨ -->
    <div class="toolbar">
      <div class="filters">
        <select v-model="filterFormId" @change="loadSubmissions">
          <option value="">å…¨éƒ¨è¡¨å–®</option>
          <option v-for="form in availableForms" :key="form.form_id" :value="form.form_id">
            {{ form.form_name }}
          </option>
        </select>

        <select v-model="filterVendorId" @change="loadSubmissions">
          <option value="">å…¨éƒ¨æ¥­è€…</option>
          <option v-for="vendor in availableVendors" :key="vendor.id" :value="vendor.id">
            {{ vendor.name }}
          </option>
        </select>
      </div>
    </div>

    <!-- æäº¤è¨˜éŒ„åˆ—è¡¨ -->
    <div class="submissions-list">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>è¡¨å–®åç¨±</th>
            <th>æ¥­è€…</th>
            <th>ç”¨æˆ¶ID</th>
            <th>è§¸ç™¼å•é¡Œ</th>  <!-- æ–°å¢æ¬„ä½ -->
            <th>æäº¤è³‡æ–™</th>
            <th>æäº¤æ™‚é–“</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="item in submissions" :key="item.id">
            <td>{{ item.id }}</td>
            <td>{{ item.form_name }}</td>
            <td>{{ item.vendor_name || 'å…¨åŸŸ' }}</td>
            <td>{{ item.user_id }}</td>
            <td>
              <div class="trigger-question">
                {{ item.trigger_question || '-' }}  <!-- é¡¯ç¤ºè§¸ç™¼å•é¡Œ -->
              </div>
            </td>
            <td>
              <div class="submitted-data">
                <span v-for="(value, key) in item.submitted_data" :key="key">
                  <strong>{{ getFieldLabel(item.form_id, key) }}:</strong> {{ value }}
                </span>
              </div>
            </td>
            <td>{{ formatDate(item.submitted_at) }}</td>
            <td>
              <button @click="viewDetails(item)">è©³æƒ…</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      submissions: [],
      availableForms: [],
      availableVendors: [],
      filterFormId: '',
      filterVendorId: '',
      formSchemas: {}
    };
  },
  async mounted() {
    await this.loadForms();
    await this.loadVendors();
    await this.loadSubmissions();
  },
  methods: {
    async loadSubmissions() {
      const params = {
        limit: 50,
        offset: 0
      };

      if (this.filterFormId) params.form_id = this.filterFormId;
      if (this.filterVendorId) params.vendor_id = this.filterVendorId;

      const response = await axios.get('/rag-api/v1/form-submissions', { params });
      this.submissions = response.data.items.map(item => ({
        ...item,
        submitted_data: typeof item.submitted_data === 'string'
          ? JSON.parse(item.submitted_data)
          : item.submitted_data
      }));
    },

    getFieldLabel(formId, fieldName) {
      const schema = this.formSchemas[formId];
      if (!schema?.fields) return fieldName;

      const field = schema.fields.find(f => f.field_name === fieldName);
      return field ? field.field_label : fieldName;
    }
  }
};
</script>
```

---

## ğŸ§ª æ¸¬è©¦é©—è­‰

### æ¸¬è©¦å ´æ™¯ 1ï¼šå®Œæ•´è¡¨å–®æµç¨‹

**ç”¨æˆ¶è¼¸å…¥**ï¼š
```
ç”¨æˆ¶: æˆ‘æƒ³ç§Ÿæˆ¿å­
ç³»çµ±: æˆ‘éœ€è¦æ”¶é›†ä¸€äº›è³‡æ–™ä¾†å”åŠ©æ‚¨ç§Ÿå±‹ã€‚è«‹æä¾›æ‚¨çš„å§“å

ç”¨æˆ¶: é™³æ…¶ç…Œ
ç³»çµ±: è«‹æä¾›æ‚¨çš„åœ°å€

ç”¨æˆ¶: æ–°åŒ—å¸‚æ¨¹æ—å€
ç³»çµ±: è«‹æä¾›æ‚¨çš„è¯çµ¡é›»è©±

ç”¨æˆ¶: 0911111111
ç³»çµ±: âœ… è¡¨å–®å¡«å¯«å®Œæˆï¼
      æ„Ÿè¬æ‚¨æäº¤ç§Ÿå±‹ç”³è«‹ï¼æˆ‘å€‘æœƒåœ¨ 3 å€‹å·¥ä½œå¤©å…§èˆ‡æ‚¨è¯ç¹«...
```

**é©—è­‰çµæœ**ï¼š
- âœ… è¡¨å–®æ­£ç¢ºè§¸ç™¼
- âœ… æ‰€æœ‰æ¬„ä½æ­£ç¢ºæ”¶é›†
- âœ… è¡¨å–®å®Œæˆè¨Šæ¯é¡¯ç¤ºçŸ¥è­˜åº«ç­”æ¡ˆ
- âœ… æäº¤è¨˜éŒ„æ­£ç¢ºå„²å­˜ï¼ŒåŒ…å«è§¸ç™¼å•é¡Œ "æˆ‘æƒ³ç§Ÿæˆ¿å­"

---

### æ¸¬è©¦å ´æ™¯ 2ï¼šé›¢é¡Œè™•ç† - å›ç­”å•é¡Œ

**ç”¨æˆ¶è¼¸å…¥**ï¼š
```
ç”¨æˆ¶: æˆ‘æƒ³ç§Ÿæˆ¿å­
ç³»çµ±: æˆ‘éœ€è¦æ”¶é›†ä¸€äº›è³‡æ–™ä¾†å”åŠ©æ‚¨ç§Ÿå±‹ã€‚è«‹æä¾›æ‚¨çš„å§“å

ç”¨æˆ¶: é™³æ…¶ç…Œ
ç³»çµ±: è«‹æä¾›æ‚¨çš„åœ°å€

ç”¨æˆ¶: å¸³å–®æ€éº¼ç¹³ï¼Ÿ
ç³»çµ±: ğŸ’¡ æ‚¨çš„ç§Ÿå±‹ç”³è«‹è¡¨é‚„æœªå®Œæˆï¼Œéœ€è¦ç¹¼çºŒå¡«å¯«å—ï¼Ÿ
      â€¢ è¼¸å…¥ã€Œç¹¼çºŒã€æ¢å¾©å¡«å¯«
      â€¢ è¼¸å…¥ã€Œå›ç­”ã€å›ç­”æ‚¨çš„å•é¡Œ
      â€¢ è¼¸å…¥ã€Œå–æ¶ˆã€çµæŸ

ç”¨æˆ¶: å›ç­”
ç³»çµ±: [é¡¯ç¤ºå¸³å–®ç¹³è²»ç›¸é—œç­”æ¡ˆ...]
```

**é©—è­‰çµæœ**ï¼š
- âœ… é›¢é¡Œåµæ¸¬æ­£ç¢º
- âœ… ä¸‰å€‹é¸é …é¡¯ç¤ºæ­£ç¢º
- âœ… é¸æ“‡ã€Œå›ç­”ã€å¾Œå–æ¶ˆè¡¨å–®
- âœ… æ­£ç¢ºå›ç­”å¾…è™•ç†å•é¡Œ

---

### æ¸¬è©¦å ´æ™¯ 3ï¼šé›¢é¡Œè™•ç† - ç¹¼çºŒå¡«å¯«

**ç”¨æˆ¶è¼¸å…¥**ï¼š
```
ç”¨æˆ¶: æˆ‘æƒ³ç§Ÿæˆ¿å­
ç³»çµ±: æˆ‘éœ€è¦æ”¶é›†ä¸€äº›è³‡æ–™ä¾†å”åŠ©æ‚¨ç§Ÿå±‹ã€‚è«‹æä¾›æ‚¨çš„å§“å

ç”¨æˆ¶: é™³æ…¶ç…Œ
ç³»çµ±: è«‹æä¾›æ‚¨çš„åœ°å€

ç”¨æˆ¶: å¸³å–®æ€éº¼ç¹³ï¼Ÿ
ç³»çµ±: ğŸ’¡ æ‚¨çš„ç§Ÿå±‹ç”³è«‹è¡¨é‚„æœªå®Œæˆï¼Œéœ€è¦ç¹¼çºŒå¡«å¯«å—ï¼Ÿ
      â€¢ è¼¸å…¥ã€Œç¹¼çºŒã€æ¢å¾©å¡«å¯«
      â€¢ è¼¸å…¥ã€Œå›ç­”ã€å›ç­”æ‚¨çš„å•é¡Œ
      â€¢ è¼¸å…¥ã€Œå–æ¶ˆã€çµæŸ

ç”¨æˆ¶: ç¹¼çºŒ
ç³»çµ±: âœ… ç¹¼çºŒå¡«å¯«è¡¨å–®

      è«‹æä¾›æ‚¨çš„åœ°å€

ç”¨æˆ¶: æ–°åŒ—å¸‚æ¨¹æ—å€
ç³»çµ±: è«‹æä¾›æ‚¨çš„è¯çµ¡é›»è©±

ç”¨æˆ¶: 0911111111
ç³»çµ±: âœ… è¡¨å–®å¡«å¯«å®Œæˆï¼...
```

**é©—è­‰çµæœ**ï¼š
- âœ… é›¢é¡Œåµæ¸¬æ­£ç¢º
- âœ… é¸æ“‡ã€Œç¹¼çºŒã€å¾Œæ¢å¾©è¡¨å–®
- âœ… æ¬„ä½ç´¢å¼•æ­£ç¢ºï¼ˆå›åˆ°åœ°å€æ¬„ä½ï¼‰
- âœ… è¡¨å–®æ­£å¸¸å®Œæˆ

---

## ğŸ› å¸¸è¦‹å•é¡Œèˆ‡ä¿®å¾©

### å•é¡Œ 1ï¼šAttributeError - 'VendorChatRequest' object has no attribute 'question'

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
AttributeError: 'VendorChatRequest' object has no attribute 'question'
```

**åŸå› **ï¼šVendorChatRequest æ¨¡å‹ä½¿ç”¨ `message` æ¬„ä½ï¼Œä¸æ˜¯ `question`

**ä¿®å¾©**ï¼š
```python
# âŒ éŒ¯èª¤
trigger_question=request.question

# âœ… æ­£ç¢º
trigger_question=request.message
```

**æª”æ¡ˆ**ï¼š`rag-orchestrator/routers/chat.py:1155`

---

### å•é¡Œ 2ï¼šè¡¨å–®æ”¶é›†ä¸­æ–·ï¼ˆç¬¬äºŒå€‹æ¬„ä½å¾Œç„¡æ³•ç¹¼çºŒï¼‰

**ç—‡ç‹€**ï¼š
- ç¬¬ä¸€å€‹æ¬„ä½æ­£å¸¸æ”¶é›†
- ç¬¬äºŒã€ä¸‰å€‹æ¬„ä½è¼¸å…¥å¾Œç³»çµ±å›åˆ°çŸ¥è­˜æª¢ç´¢ï¼Œæ²’æœ‰ç¹¼çºŒè¡¨å–®æµç¨‹

**åŸå› **ï¼š
1. è³‡æ–™åº«ä¸­å­˜åœ¨å¤šå€‹ `session_id` ç›¸åŒçš„è¨˜éŒ„
2. `_get_session_state_sync()` ä½¿ç”¨ `ORDER BY last_activity_at DESC`
3. ç•¶å¤šå€‹è¨˜éŒ„çš„ `last_activity_at` ç›¸åŒæ™‚ï¼Œå¯èƒ½è¿”å›å·²å–æ¶ˆçš„æœƒè©±

**ä¿®å¾©**ï¼š

**ä¿®å¾© 1ï¼šè®Šæ›´æ’åºæ¬„ä½**
```python
# âŒ éŒ¯èª¤ï¼ˆå¯èƒ½è¿”å›éŒ¯èª¤çš„è¨˜éŒ„ï¼‰
ORDER BY last_activity_at DESC

# âœ… æ­£ç¢ºï¼ˆè¿”å›æœ€æ–°çš„è¨˜éŒ„ï¼‰
ORDER BY id DESC
```

**ä¿®å¾© 2ï¼šé¿å…é‡è¤‡å‰µå»ºæœƒè©±**
```python
# åœ¨ trigger_form_by_knowledge ä¸­æ–°å¢æª¢æŸ¥
existing_session = await self.get_session_state(session_id)
if existing_session and existing_session['state'] in ['COLLECTING', 'DIGRESSION']:
    # å·²æœ‰é€²è¡Œä¸­çš„è¡¨å–®æœƒè©±ï¼Œä¸é‡è¤‡å‰µå»º
    session_state = existing_session
else:
    # å‰µå»ºæ–°çš„è¡¨å–®æœƒè©±
    session_state = await self.create_form_session(...)
```

**ä¿®å¾© 3ï¼šæ¸…ç†èˆŠæœƒè©±**
```sql
UPDATE form_sessions
SET state = 'CANCELLED', cancelled_at = NOW()
WHERE state IN ('COLLECTING', 'DIGRESSION');
```

**æª”æ¡ˆ**ï¼š`rag-orchestrator/services/form_manager.py:127-142, 418-436`

---

## ğŸ“ˆ æ•ˆèƒ½è€ƒé‡

### 1. Session æŸ¥è©¢å„ªåŒ–

**å•é¡Œ**ï¼šæ¯æ¬¡ç”¨æˆ¶è¼¸å…¥éƒ½è¦æŸ¥è©¢ `form_sessions` è¡¨

**å„ªåŒ–**ï¼š
- ä½¿ç”¨ `ORDER BY id DESC LIMIT 1` æå‡æŸ¥è©¢é€Ÿåº¦
- å»ºç«‹ç´¢å¼•ï¼š`CREATE INDEX idx_form_sessions_session ON form_sessions(session_id)`

### 2. Redis Cache

**å»ºè­°**ï¼šå°‡è¡¨å–®æœƒè©±ç‹€æ…‹å¿«å–åˆ° Redis

```python
# å¿«å–è¡¨å–®æœƒè©±ç‹€æ…‹
await redis_client.setex(
    f"form_session:{session_id}",
    3600,  # 1å°æ™‚éæœŸ
    json.dumps(session_state)
)

# è®€å–å¿«å–
cached = await redis_client.get(f"form_session:{session_id}")
if cached:
    session_state = json.loads(cached)
```

### 3. è¡¨å–®çµæ§‹å¿«å–

**å»ºè­°**ï¼šè¡¨å–®çµæ§‹ä¸å¸¸è®Šå‹•ï¼Œæ‡‰è©²å¿«å–

```python
# å¿«å–è¡¨å–®çµæ§‹
await redis_client.setex(
    f"form_schema:{form_id}",
    86400,  # 24å°æ™‚éæœŸ
    json.dumps(form_schema)
)
```

---

## ğŸš€ æœªä¾†æ“´å±•

### 1. æ›´å¤šæ¬„ä½é¡å‹

- [ ] `checkbox` - å¤šé¸æ¡†
- [ ] `radio` - å–®é¸æ¡†
- [ ] `file` - æª”æ¡ˆä¸Šå‚³
- [ ] `rating` - è©•åˆ†
- [ ] `slider` - æ»‘æ¡¿

### 2. æ¢ä»¶é‚è¼¯

æ ¹æ“šå‰ä¸€å€‹æ¬„ä½çš„ç­”æ¡ˆï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºä¸‹ä¸€å€‹æ¬„ä½ã€‚

```json
{
  "field_name": "pet_type",
  "field_label": "å¯µç‰©é¡å‹",
  "field_type": "select",
  "prompt": "è«‹é¸æ“‡å¯µç‰©é¡å‹",
  "options": ["è²“", "ç‹—", "å…¶ä»–"],
  "condition": {
    "field": "has_pet",
    "value": "æ˜¯"
  }
}
```

### 3. è¡¨å–®æ¨¡æ¿

æä¾›å¸¸ç”¨è¡¨å–®æ¨¡æ¿ï¼Œå¿«é€Ÿå‰µå»ºã€‚

- ç§Ÿå±‹ç”³è«‹è¡¨
- ç¶­ä¿®ç”³è«‹è¡¨
- é€€ç§Ÿç”³è«‹è¡¨
- è¨ªå®¢ç™»è¨˜è¡¨

### 4. è¡¨å–®ç‰ˆæœ¬æ§åˆ¶

è¿½è¹¤è¡¨å–®çµæ§‹è®Šæ›´æ­·å²ã€‚

```sql
CREATE TABLE form_schema_versions (
    id SERIAL PRIMARY KEY,
    form_id VARCHAR(100),
    version INTEGER,
    fields JSONB,
    created_at TIMESTAMP
);
```

### 5. Email é€šçŸ¥

è¡¨å–®æäº¤å¾Œè‡ªå‹•ç™¼é€ Email é€šçŸ¥ã€‚

### 6. Webhook æ•´åˆ

è¡¨å–®æäº¤å¾Œå‘¼å«å¤–éƒ¨ APIã€‚

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [çŸ¥è­˜ç®¡ç†ç³»çµ±](./KNOWLEDGE_IMPORT_FEATURE.md)
- [å¤šæ„åœ–åˆ†é¡](./MULTI_INTENT_CLASSIFICATION.md)
- [API åƒè€ƒæ–‡ä»¶](../api/API_REFERENCE_PHASE1.md)
- [ç³»çµ±æ¶æ§‹](../architecture/SYSTEM_ARCHITECTURE.md)

---

**å»ºç«‹æ—¥æœŸ**: 2025-01-10
**æœ€å¾Œæ›´æ–°**: 2025-01-10
**ç‰ˆæœ¬**: 1.0
**ç¶­è­·è€…**: Development Team
