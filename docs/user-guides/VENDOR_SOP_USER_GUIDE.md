# Vendor SOP 流程配置完整使用指南

**文檔版本**: 1.0
**最後更新**: 2026-01-24
**適用範圍**: Platform SOP 管理員 + Vendor SOP Manager 業者

---

## 📚 目錄

- [第一部分：功能概覽](#第一部分功能概覽)
- [第二部分：Platform SOP 管理員指南](#第二部分platform-sop-管理員指南)
- [第三部分：Vendor SOP Manager 業者指南](#第三部分vendor-sop-manager-業者指南)
- [第四部分：流程配置最佳實踐](#第四部分流程配置最佳實踐)
- [第五部分：常見問題解答](#第五部分常見問題解答)
- [附錄：配置範例集](#附錄配置範例集)

---

## 第一部分：功能概覽

### 🎯 系統架構

Vendor SOP 系統採用**兩層架構**：

```
┌─────────────────────────────────────┐
│  Platform SOP (平台管理員)          │
│  - 創建和管理 SOP 範本              │
│  - 配置完整的流程設定                │
│  - 包租業/代管業/通用範本            │
└──────────────┬──────────────────────┘
               │ 複製
               ↓
┌─────────────────────────────────────┐
│  Vendor SOP Manager (業者)          │
│  - 複製範本到自己的工作區            │
│  - 查看流程配置（唯讀）              │
│  - 編輯內容和後續提示詞              │
└─────────────────────────────────────┘
```

### 🔄 流程配置功能

**新增功能** (2026-01-24):
- ✅ 4 種觸發模式（none, manual, immediate, auto）
- ✅ 4 種後續動作（none, form_fill, api_call, form_then_api）
- ✅ 關鍵詞觸發（manual 模式）
- ✅ 主動詢問確認（immediate 模式）
- ✅ 表單整合（form_fill, form_then_api）
- ✅ API 整合（api_call, form_then_api）
- ✅ 後續提示詞自訂

### 👥 角色權限

| 功能 | Platform 管理員 | Vendor 業者 |
|------|----------------|-------------|
| 創建 SOP 範本 | ✅ | ❌ |
| 配置流程設定 | ✅ | ❌ |
| 複製範本 | ✅ | ✅ |
| 查看流程配置 | ✅ | ✅ (唯讀) |
| 編輯 SOP 內容 | ✅ | ✅ |
| 編輯後續提示詞 | ✅ | ✅ |

---

## 第二部分：Platform SOP 管理員指南

### 📖 2.1 進入管理介面

**訪問路徑**:
```
http://localhost:8087/platform-sop
```

**介面說明**:
- 🏠 包租業範本
- 🔑 代管業範本
- 🌐 通用範本

點擊「管理 SOP」進入對應業態的範本管理。

---

### 📝 2.2 創建新範本

#### 步驟 1: 點擊「新增範本」

進入範本編輯表單。

#### 步驟 2: 填寫基本資訊

**必填欄位**:
- **所屬分類**: 選擇 SOP 分類
- **業種類型**: 包租型/代管型/通用（新增後無法修改）
- **項次編號**: 自動遞增，可手動調整
- **項目名稱**: SOP 標題
- **範本內容**: SOP 詳細說明

**選填欄位**:
- **關聯意圖**: 連結到特定意圖
- **優先級**: 0-100，預設 50
- **範本說明**: 解釋 SOP 目的
- **自訂提示**: 給業者的調整建議

#### 步驟 3: 配置流程設定 ⭐

這是**新增的進階功能**，位於「🔄 流程配置（進階）」區塊。

---

### 🔄 2.3 流程配置詳解

#### 2.3.1 觸發模式選擇

**4 種觸發模式**:

##### ① 資訊型（none）- 預設
```
用途: 純粹回答 SOP 內容，無後續動作
場景: FAQ、說明文件、標準流程說明
範例: "租金繳納規定"、"公設使用說明"
```

**特點**:
- ✅ 最簡單
- ✅ 只需設定 SOP 內容
- ✅ 系統回答後不執行任何動作

---

##### ② 排查型（manual）- 等待關鍵詞

```
用途: 回答 SOP 後，等待用戶說出關鍵詞才觸發動作
場景: 需要用戶確認是否需要進一步協助
範例: "維修排查 SOP" → 用戶說「還是不行」→ 觸發報修表單
```

**必要配置**:
- ✅ **觸發關鍵詞** (必填): 至少 1 個，最多 10 個
  - 例如: "我要看房", "預約看房", "安排看房"
  - 支援 Enter 或逗號分隔
  - 支援批量貼上

**配置步驟**:
1. 選擇觸發模式 = 「排查型」
2. 輸入關鍵詞，按 Enter 或逗號新增
3. 可點擊 ✕ 刪除關鍵詞
4. 選擇後續動作（通常搭配表單或 API）

**使用場景**:
```
SOP: "冷氣不冷排查步驟：
      1. 檢查是否開啟冷氣模式
      2. 確認溫度設定
      3. 清潔濾網"

關鍵詞: ["還是不行", "需要維修", "我要報修"]

流程:
  用戶閱讀排查步驟 → 嘗試自行處理
  ↓
  仍無法解決，說「還是不行」
  ↓
  系統觸發報修表單
```

---

##### ③ 緊急型（immediate）- 主動詢問

```
用途: 回答 SOP 後，立即主動詢問用戶是否執行動作
場景: 緊急事件、重要通知、需要立即處理的情況
範例: "漏水處理 SOP" → 系統主動問「需要立即報修嗎？」
```

**必要配置**:
- ✅ **確認提示詞** (必填): 詢問用戶的文字
  - 例如: "需要立即為您申請報修嗎？（輸入「確認」開始）"
  - 多行文字，建議包含確認指示

**配置步驟**:
1. 選擇觸發模式 = 「緊急型」
2. 輸入確認提示詞
3. 選擇後續動作

**使用場景**:
```
SOP: "發現漏水時的緊急處理步驟：
      1. 關閉總水閥
      2. 清理積水
      3. 通知管理員"

確認提示詞: "需要立即為您申請緊急報修嗎？
            （輸入「確認」、「是的」或「好」開始填寫報修單）"

流程:
  用戶詢問漏水問題
  ↓
  系統回答 SOP 內容
  ↓
  立即主動詢問是否報修
  ↓
  用戶回覆「確認」
  ↓
  觸發報修表單
```

---

##### ④ 自動執行型（auto）⚠️ 暫不實作

> **⚠️ 重要通知**：此模式**現階段不會實作**，以下內容僅供未來參考。

```
用途: 回答 SOP 後，立即自動執行後續動作
場景: 查詢類、確定性需求、標準流程
範例: "查詢租金帳單" → 自動調用 API 查詢
```

**特點**（未來規劃）:
- 無需用戶確認
- 適合確定性需求
- 通常搭配 API 調用

**配置步驟**（未來規劃）:
1. 選擇觸發模式 = 「自動執行型」
2. 選擇後續動作（通常是 api_call）

**使用場景**:
```
SOP: "租金帳單說明：
      - 每月 5 號前繳納
      - 可透過系統查詢"

後續動作: api_call (調用租金查詢 API)

流程:
  用戶問「我要查詢租金」
  ↓
  系統回答 SOP
  ↓
  自動調用 API 查詢該用戶的租金帳單
  ↓
  顯示查詢結果
```

---

#### 2.3.2 後續動作選擇

**4 種後續動作**:

##### ① 無（none）- 預設

```
說明: 只顯示 SOP 內容，不執行任何動作
適用: 資訊型 SOP
```

---

##### ② 觸發表單（form_fill）

```
說明: 引導用戶填寫表單
適用: 報修、預約、申請等需要收集資料的場景
```

**必要配置**:
- ✅ **選擇表單** (必填): 從系統表單列表中選擇

**配置步驟**:
1. 選擇後續動作 = 「觸發表單」
2. 從下拉選單選擇表單
3. 看到「✅ 已關聯表單：[表單名稱]」確認

**可用表單** (範例):
- 報修申請表單 (repair_request)
- 租屋申請表單 (rental_application)
- 看房預約表單 (viewing_appointment)

**表單顯示方式**:
```
用戶觸發後 → 系統顯示表單 → 用戶逐步填寫 → 提交
```

---

##### ③ 調用 API（api_call）

```
說明: 直接調用 API 查詢或處理資料
適用: 查詢類、自動化處理
```

**必要配置**:
- ✅ **API 配置** (必填): 選擇 API 端點或手動編輯 JSON

**配置方式 A: 選擇預定義 API**

1. 選擇後續動作 = 「調用 API」
2. 從「選擇 API 端點」下拉選單選擇
3. 看到「✅ 已選擇 API：[端點名稱]」確認

**配置方式 B: 手動編輯 JSON** (進階)

1. 勾選「手動編輯 API 配置 JSON（進階）」
2. 在文字框中輸入 JSON 配置

**JSON 格式範例**:
```json
{
  "method": "POST",
  "endpoint": "http://api.example.com/rental/submit",
  "params": {
    "user_id": "${user_id}",
    "type": "inquiry"
  }
}
```

**支援的變數**:
- `${user_id}`: 當前用戶 ID
- `${vendor_id}`: 業者 ID
- 其他系統變數

---

##### ④ 先填表單再調用 API（form_then_api）⭐

```
說明: 最完整的流程，先收集表單資料，再調用 API 提交
適用: 租屋申請、合約簽署等需要完整資料處理的場景
```

**必要配置**:
- ✅ **選擇表單** (必填)
- ✅ **API 配置** (必填)

**配置步驟**:
1. 選擇後續動作 = 「先填表單再調用 API」
2. 選擇表單（用於收集資料）
3. 選擇或配置 API（用於提交資料）
4. 看到兩個確認訊息

**執行流程**:
```
觸發
  ↓
系統引導填寫表單
  ↓
用戶完成表單填寫
  ↓
系統自動調用 API 提交表單資料
  ↓
返回處理結果
```

**範例場景**:
```
SOP: 租屋申請說明
表單: rental_application (收集申請人資料)
API: POST /rental/submit (提交到業務系統)

流程:
  用戶說「我要租房」
  ↓
  系統顯示租屋申請 SOP
  ↓
  引導填寫申請表單（姓名、電話、需求等）
  ↓
  填寫完成後自動提交到業務系統
  ↓
  返回申請單號
```

---

#### 2.3.3 後續提示詞（可選）

**說明**: 觸發後續動作時顯示的自訂提示語

**適用**: 所有有後續動作的場景（next_action ≠ none）

**範例**:
```
觸發表單時: "好的，我來協助您填寫表單"
調用 API 時: "正在為您查詢資料，請稍候..."
form_then_api: "好的，請填寫以下資訊，完成後將自動提交"
```

**留空**: 使用系統預設提示

---

### ✅ 2.4 驗證邏輯說明

系統會**自動驗證**配置的完整性，確保不會遺漏必填項目。

#### 驗證規則

| 觸發模式 | 必填欄位 | 錯誤訊息 |
|---------|---------|---------|
| manual | trigger_keywords (至少 1 個) | ❌ 必須設定至少一個觸發關鍵詞 |
| immediate | immediate_prompt (非空) | ❌ 必須設定確認提示詞 |

| 後續動作 | 必填欄位 | 錯誤訊息 |
|---------|---------|---------|
| form_fill | next_form_id | ❌ 必須選擇表單 |
| api_call | next_api_config | ❌ 必須配置 API |
| form_then_api | next_form_id + next_api_config | ❌ 必須選擇表單和配置 API |

**驗證時機**: 點擊「儲存」按鈕時

**驗證失敗**: 顯示錯誤訊息，不允許儲存

---

### 🎨 2.5 模式切換行為

為避免資料殘留，系統會在切換模式時**自動清空**無關欄位。

#### 清空邏輯

**切換觸發模式時**:
- 離開 manual → 清空 trigger_keywords
- 離開 immediate → 清空 immediate_prompt

**切換後續動作時**:
- 離開 form_fill/form_then_api → 清空 next_form_id
- 離開 api_call/form_then_api → 清空 next_api_config
- 切換到 none → 清空 followup_prompt

**目的**: 確保配置乾淨，避免無效資料

---

### 💾 2.6 儲存範本

**步驟**:
1. 檢查所有必填欄位
2. 點擊「儲存」按鈕
3. 等待驗證和儲存

**成功**: 顯示「✅ 範本已建立/已更新」

**失敗**: 顯示錯誤訊息，檢查並修正

---

### ✏️ 2.7 編輯現有範本

**步驟**:
1. 在範本列表找到目標範本
2. 點擊「編輯」按鈕
3. 修改需要的欄位
4. 點擊「儲存」

**注意**:
- ✅ 所有欄位都會正確載入
- ✅ 流程配置完整保留
- ✅ 修改後重新驗證

**驗證載入**:
- 查看 Console 會顯示載入的配置資訊
- 確認所有欄位正確顯示

---

## 第三部分：Vendor SOP Manager 業者指南

### 📖 3.1 進入業者介面

**訪問路徑**:
```
http://localhost:8087/vendor-sop
```

**兩個標籤**:
- 📚 **SOP 範本概覽**: 查看和複製範本
- 📝 **我的 SOP**: 管理已複製的 SOP

---

### 📋 3.2 複製範本

#### 方式 1: 複製整個業態

**步驟**:
1. 點擊「SOP 範本概覽」標籤
2. 找到對應的業態卡片（例如：🏠 包租型）
3. 點擊「查看詳情」展開分類列表
4. 點擊「📋 複製此業態」按鈕
5. 確認複製（⚠️ 會覆蓋現有 SOP）

**結果**:
- ✅ 複製所有分類、群組、SOP 項目
- ✅ 包含完整的流程配置
- ✅ 自動生成 embeddings

#### 方式 2: Excel 匯入

**步驟**:
1. 點擊「我的 SOP」標籤
2. 點擊「📤 匯入 Excel」按鈕
3. 選擇 Excel 檔案
4. 確認匯入

**Excel 格式**:
```
欄位順序:
1. 分類名稱
2. 分類說明
3. 項目序號
4. 項目名稱
5. 項目內容
```

---

### ✏️ 3.3 編輯 SOP

**步驟**:
1. 點擊「我的 SOP」標籤
2. 找到要編輯的 SOP
3. 點擊「✏️ 編輯」按鈕

**編輯介面說明**:

---

#### 3.3.1 可編輯欄位

**✅ 可以編輯**:
- **項目名稱**: SOP 標題
- **內容**: SOP 詳細說明
- **後續提示詞**: 觸發動作時的提示語（如果有後續動作）

**範例**:
```
項目名稱: 【我的版本】看房預約
內容: (根據自己的營業時間調整)
後續提示詞: "好的！我馬上為您安排看房，請稍候..."
```

---

#### 3.3.2 唯讀資訊 - 流程配置

**❌ 無法編輯** (顯示為唯讀灰色區塊):

如果 SOP 包含流程配置，會顯示「🔄 流程配置（唯讀）」區塊：

**顯示內容**:
- **觸發模式**: 例如「排查型（等待關鍵詞）」
- **後續動作**: 例如「觸發表單」
- **觸發關鍵詞**: 以藍色標籤顯示（如果有）
- **確認提示詞**: 顯示提示文字（如果有）
- **關聯表單**: 顯示表單 ID（如果有）
- **API 配置**: 顯示「✅ 已配置」（如果有）

**視覺設計**:
```
┌────────────────────────────────────────┐
│ 🔄 流程配置（唯讀）                     │
├────────────────────────────────────────┤
│ ┌────────────────────────────────────┐ │
│ │  觸發模式     排查型（等待關鍵詞）  │ │
│ │  後續動作     觸發表單              │ │
│ │  觸發關鍵詞   [我要看房] [預約看房] │ │
│ │  關聯表單     repair_request       │ │
│ └────────────────────────────────────┘ │
│                                        │
│ 💡 流程配置需要聯絡管理員修改。        │
│    您可以編輯下方的「後續提示詞」來     │
│    自訂觸發時的提示語。                │
└────────────────────────────────────────┘
```

**特點**:
- ✅ 清楚了解 SOP 如何執行
- ✅ 灰色背景 + 邊框，明確標示唯讀
- ✅ Grid 佈局，桌面版兩欄，手機版單欄
- ✅ 關鍵詞以藍色圓角標籤顯示

---

#### 3.3.3 後續提示詞編輯

**顯示時機**: 只在 next_action ≠ none 時顯示

**用途**: 自訂觸發動作時的提示語

**範例**:
```
預設提示: "系統將為您處理..."

業者自訂: "好的！我們的客服團隊會立即為您處理，
          請稍候片刻..."
```

**編輯步驟**:
1. 在編輯表單中找到「後續提示詞（可選）」
2. 輸入自訂提示語
3. 點擊「💾 儲存」

---

### 🔒 3.4 資料保護機制

**重要**: 業者編輯**絕對不會**破壞流程配置！

**保護機制**:
1. ✅ **前端限制**: 只發送 3 個欄位 (item_name, content, followup_prompt)
2. ✅ **唯讀顯示**: 流程配置以唯讀方式顯示
3. ✅ **後端驗證**: API 只接受允許編輯的欄位

**測試驗證**:
```
編輯前:
  trigger_mode: manual
  trigger_keywords: ["我要看房", "預約看房"]
  next_form_id: repair_request

業者編輯後（只修改 item_name 和 followup_prompt）:
  trigger_mode: manual  ← 保持不變 ✅
  trigger_keywords: ["我要看房", "預約看房"]  ← 保持不變 ✅
  next_form_id: repair_request  ← 保持不變 ✅
```

**結論**: 業者可以放心編輯，不會破壞管理員設定的流程配置。

---

### 📱 3.5 響應式設計

**桌面版** (螢幕 > 768px):
- 流程配置以兩欄 Grid 顯示
- 左欄：觸發模式、後續動作
- 右欄：關聯表單、API 配置

**手機版** (螢幕 < 768px):
- 自動切換為單欄垂直佈局
- 關鍵詞標籤自動換行
- 所有資訊清晰可讀

**測試方法**:
1. 按 F12 打開開發者工具
2. 切換裝置模擬（Ctrl+Shift+M）
3. 選擇 iPhone SE 查看效果

---

### 🗑️ 3.6 刪除 SOP

**步驟**:
1. 在「我的 SOP」中找到要刪除的項目
2. 點擊「🗑️ 刪除」按鈕
3. 確認刪除

**注意**: 刪除操作無法復原！

---

## 第四部分：流程配置最佳實踐

### 🎯 4.1 選擇觸發模式指南

#### 決策樹

```
是否需要後續動作？
  ↓ 否
  選擇: none (資訊型)

  ↓ 是
  用戶是否需要閱讀說明後再決定？
    ↓ 是
    用戶能否明確表達需求？
      ↓ 是
      選擇: manual (排查型)

      ↓ 否
      選擇: immediate (緊急型)

    ↓ 否
    選擇: auto (自動執行型)
```

#### 模式對比

> **⚠️ 注意**：auto（自動執行型）現階段不會實作。

| 模式 | 適用場景 | 優點 | 缺點 | 狀態 |
|------|---------|------|------|------|
| **none** | FAQ、說明 | 簡單快速 | 無互動 | ✅ 可用 |
| **manual** | 排查、可選服務 | 用戶主動控制 | 需要用戶明確表達 | ✅ 可用 |
| **immediate** | 緊急事件 | 主動引導 | 可能打斷對話 | ✅ 可用 |
| **auto** | 確定性查詢 | 自動化高 | 不適合複雜場景 | ⚠️ **暫不實作** |

---

### 📊 4.2 選擇後續動作指南

#### 決策樹

```
需要收集用戶資料？
  ↓ 否
  只需查詢/處理現有資料？
    ↓ 是
    選擇: api_call

    ↓ 否
    選擇: none

  ↓ 是
  收集後需要調用 API？
    ↓ 是
    選擇: form_then_api

    ↓ 否
    選擇: form_fill
```

#### 動作對比

| 動作 | 適用場景 | 範例 |
|------|---------|------|
| **none** | 純資訊提供 | FAQ、規定說明 |
| **form_fill** | 收集資料即可 | 問卷調查、意見回饋 |
| **api_call** | 自動化處理 | 查詢帳單、檢查狀態 |
| **form_then_api** | 完整業務流程 | 租屋申請、合約簽署 |

---

### 💡 4.3 配置組合範例

#### 組合 1: 純資訊型

```yaml
用途: 一般 FAQ、規定說明
觸發模式: none
後續動作: none

範例:
  SOP: "租金繳納規定說明"
  內容: "租金每月 5 號前繳納..."

不需要任何流程配置。
```

---

#### 組合 2: 排查 + 表單

```yaml
用途: 先讓用戶嘗試自行解決，無法解決再填表申請
觸發模式: manual
後續動作: form_fill

範例:
  SOP: "冷氣不冷排查"
  內容: "請先檢查：1. 模式 2. 溫度 3. 濾網"
  關鍵詞: ["還是不行", "需要維修", "我要報修"]
  表單: repair_request

流程:
  顯示排查步驟 → 用戶嘗試 → 說「還是不行」→ 觸發報修表單
```

---

#### 組合 3: 緊急 + 表單

```yaml
用途: 緊急事件，主動詢問是否處理
觸發模式: immediate
後續動作: form_fill

範例:
  SOP: "發現漏水處理"
  內容: "緊急處理步驟：1. 關閉水閥 2. 清理積水..."
  確認提示: "需要立即為您申請緊急報修嗎？（輸入「確認」開始）"
  表單: emergency_repair

流程:
  顯示處理步驟 → 主動詢問報修 → 用戶確認 → 觸發表單
```

---

#### 組合 4: 自動 + API 查詢

```yaml
用途: 確定性查詢，自動執行
觸發模式: auto
後續動作: api_call

範例:
  SOP: "租金帳單查詢"
  內容: "查詢您的租金繳納記錄..."
  API: GET /billing/query?user_id=${user_id}

流程:
  用戶問「租金帳單」→ 顯示說明 → 自動調用 API → 顯示帳單
```

---

#### 組合 5: 自動 + 完整流程 ⭐

```yaml
用途: 完整業務流程，收集資料並提交
觸發模式: auto
後續動作: form_then_api

範例:
  SOP: "租屋申請流程"
  內容: "租屋申請需要以下資料..."
  表單: rental_application
  API: POST /rental/submit
  後續提示: "好的，請填寫以下資訊，完成後將自動提交"

流程:
  用戶說「我要租房」→ 顯示說明 → 引導填寫表單 → 自動提交 API → 返回申請單號
```

---

### ⚠️ 4.4 常見錯誤配置

#### 錯誤 1: manual 模式缺少關鍵詞

```yaml
❌ 錯誤配置:
  觸發模式: manual
  關鍵詞: (空)
  後續動作: form_fill

❌ 系統驗證: "必須設定至少一個觸發關鍵詞"

✅ 正確配置:
  觸發模式: manual
  關鍵詞: ["還是不行", "需要維修"]  ← 至少 1 個
  後續動作: form_fill
```

---

#### 錯誤 2: immediate 模式缺少提示詞

```yaml
❌ 錯誤配置:
  觸發模式: immediate
  確認提示: (空)
  後續動作: form_fill

❌ 系統驗證: "必須設定確認提示詞"

✅ 正確配置:
  觸發模式: immediate
  確認提示: "需要立即報修嗎？（輸入「確認」開始）"
  後續動作: form_fill
```

---

#### 錯誤 3: 有後續動作但未配置

```yaml
❌ 錯誤配置:
  觸發模式: auto
  後續動作: form_fill
  表單: (未選擇)  ← 缺少

❌ 系統驗證: "必須選擇表單"

✅ 正確配置:
  觸發模式: auto
  後續動作: form_fill
  表單: repair_request  ← 已選擇
```

---

#### 錯誤 4: form_then_api 配置不完整

```yaml
❌ 錯誤配置:
  後續動作: form_then_api
  表單: rental_application  ← 有
  API: (未配置)  ← 缺少

❌ 系統驗證: "必須配置 API"

✅ 正確配置:
  後續動作: form_then_api
  表單: rental_application  ← 有
  API: POST /rental/submit  ← 已配置
```

---

### 🎨 4.5 撰寫提示詞技巧

#### 關鍵詞設計

**原則**:
- ✅ 使用自然語言
- ✅ 涵蓋多種表達方式
- ✅ 避免過於籠統

**範例**:

```yaml
❌ 不好的關鍵詞:
  - "是" (太籠統)
  - "report_repair" (不自然)

✅ 好的關鍵詞:
  - "還是不行"
  - "需要維修"
  - "我要報修"
  - "請派人來看"
```

---

#### 確認提示詞設計

**原則**:
- ✅ 清楚說明將執行什麼動作
- ✅ 告知用戶如何確認
- ✅ 語氣友善

**範例**:

```yaml
❌ 不好的提示:
  "報修？"  ← 太簡短
  "你要不要報修啊？"  ← 口語化過度

✅ 好的提示:
  "需要立即為您申請報修嗎？（輸入「確認」、「是的」或「好」開始填寫報修表單）"

  特點:
  - 明確說明動作（申請報修）
  - 告知如何確認（輸入特定詞）
  - 說明後續步驟（填寫表單）
```

---

#### 後續提示詞設計

**原則**:
- ✅ 承接對話脈絡
- ✅ 鼓勵用戶完成動作
- ✅ 可選，留空使用預設

**範例**:

```yaml
觸發表單:
  "好的，我來協助您填寫表單"
  "請提供以下資訊，我們會盡快為您處理"

調用 API:
  "正在為您查詢資料，請稍候..."
  "讓我幫您查一下"

form_then_api:
  "好的，請填寫以下資訊，完成後將自動提交"
  "我會引導您完成申請流程"
```

---

## 第五部分：常見問題解答

### ❓ 5.1 Platform 管理員 FAQ

#### Q1: 創建範本時，觸發模式和後續動作如何搭配？

**A**: 參考「4.3 配置組合範例」，常見組合：
- none + none: 純資訊
- manual + form_fill: 排查後報修
- immediate + form_fill: 緊急報修
- auto + api_call: 自動查詢
- auto + form_then_api: 完整流程

**原則**: 根據用戶體驗需求選擇。

---

#### Q2: 關鍵詞設定多少個比較好？

**A**:
- **最少**: 1 個（系統要求）
- **建議**: 3-5 個（涵蓋常見表達）
- **最多**: 10 個（系統限制）

**範例**:
```
報修場景: ["還是不行", "需要維修", "我要報修", "請派人來"]
預約場景: ["我要看房", "預約看房", "安排看房", "想看房子"]
```

---

#### Q3: API 配置的 JSON 格式有範本嗎？

**A**: 標準格式如下：

```json
{
  "method": "POST",
  "endpoint": "http://api.example.com/path",
  "params": {
    "user_id": "${user_id}",
    "vendor_id": "${vendor_id}",
    "custom_field": "value"
  }
}
```

**支援的變數**:
- `${user_id}`: 當前用戶 ID
- `${vendor_id}`: 業者 ID
- 其他系統變數（查閱 API 文檔）

---

#### Q4: 修改範本後，業者那邊會自動更新嗎？

**A**: **不會**。

- ❌ 業者已複製的 SOP **不會**自動更新
- ✅ 業者需要重新複製範本才能獲得更新

**原因**: 業者可能已自訂內容，自動更新會覆蓋他們的修改。

---

#### Q5: 驗證失敗後如何修正？

**A**: 根據錯誤訊息修正對應欄位：

| 錯誤訊息 | 修正方法 |
|---------|---------|
| "必須設定至少一個觸發關鍵詞" | 新增 1 個以上關鍵詞 |
| "必須設定確認提示詞" | 填寫 immediate_prompt |
| "必須選擇表單" | 從下拉選單選擇表單 |
| "必須配置 API" | 選擇 API 或填寫 JSON |
| "JSON 格式錯誤" | 檢查 JSON 語法 |

---

### ❓ 5.2 Vendor 業者 FAQ

#### Q1: 我可以修改流程配置嗎？

**A**: **不可以**。

- ❌ 流程配置（觸發模式、後續動作等）由管理員設定，業者無法修改
- ✅ 業者可以查看（唯讀顯示）
- ✅ 業者可以修改「後續提示詞」來自訂提示語

**原因**: 確保流程一致性和系統穩定性。

---

#### Q2: 為什麼我的 SOP 沒有顯示流程配置區塊？

**A**: 因為該 SOP 是**簡單型** SOP（trigger_mode=none, next_action=none）。

**簡單型 SOP**:
- 只顯示 SOP 內容
- 無後續動作
- 不需要流程配置

**有流程配置的 SOP**:
- 會顯示「🔄 流程配置（唯讀）」區塊
- 可以查看完整的流程設定

---

#### Q3: 我編輯 SOP 後會不會破壞流程配置？

**A**: **絕對不會**！

**保護機制**:
- ✅ 前端只發送 3 個欄位（item_name, content, followup_prompt）
- ✅ 流程配置欄位完全不包含在更新請求中
- ✅ 即使後端有 bug，前端也不會發送這些欄位

**測試驗證**: 已通過資料完整性測試，100% 保護。

---

#### Q4: 後續提示詞什麼時候會顯示？

**A**: 只在觸發後續動作時顯示。

**顯示時機**:
- 觸發表單前
- 調用 API 時
- form_then_api 流程開始時

**不顯示時機**:
- next_action = none（無後續動作）
- 只回答 SOP 內容的情況

---

#### Q5: 手機上查看 SOP 會正常顯示嗎？

**A**: **會**，系統採用響應式設計。

**桌面版** (> 768px): 雙欄佈局
**手機版** (< 768px): 單欄佈局

**特點**:
- ✅ 關鍵詞標籤自動換行
- ✅ 無水平滾動
- ✅ 所有文字清晰可讀

---

#### Q6: 複製範本會覆蓋我現有的 SOP 嗎？

**A**: **會**，複製範本會刪除現有 SOP。

**警告訊息**:
```
⚠️ 此操作將刪除所有現有 SOP（X 個分類，Y 個項目），
   然後重新複製整份範本。此操作無法復原！
```

**建議**:
- ⚠️ 複製前請確認
- ⚠️ 重要自訂內容請先備份
- ✅ 如果已有大量自訂，建議聯絡管理員單獨更新

---

### ❓ 5.3 技術問題 FAQ

#### Q1: 資料儲存在哪裡？

**A**: PostgreSQL 資料庫 `vendor_sop_items` 表。

**欄位**:
- 基本欄位: id, item_name, content, vendor_id
- 流程配置欄位: trigger_mode, next_action, trigger_keywords, immediate_prompt, followup_prompt, next_form_id, next_api_config

---

#### Q2: trigger_keywords 是什麼資料類型？

**A**: PostgreSQL `text[]` (文字陣列)

**範例**:
```sql
SELECT trigger_keywords FROM vendor_sop_items WHERE id = 1658;

Result: {我要看房,預約看房,安排看房}
```

---

#### Q3: next_api_config 是什麼資料類型？

**A**: PostgreSQL `jsonb`

**範例**:
```sql
SELECT next_api_config FROM vendor_sop_items WHERE id = 1660;

Result: {
  "method": "GET",
  "endpoint": "http://api.example.com/billing",
  "params": {"user_id": "${user_id}"}
}
```

---

#### Q4: 如何查詢包含特定關鍵詞的 SOP？

**A**: 使用陣列查詢語法：

```sql
-- 查詢包含「報修」關鍵詞的 SOP
SELECT * FROM vendor_sop_items
WHERE '報修' = ANY(trigger_keywords);

-- 查詢包含任一關鍵詞的 SOP
SELECT * FROM vendor_sop_items
WHERE trigger_keywords && ARRAY['報修', '維修', '修理'];
```

---

#### Q5: 前端如何處理 JSON 編輯？

**A**: 使用 Vue.js 雙向綁定：

```javascript
// 輔助變數
apiConfigJson: ''  // 儲存 JSON 字串

// 從 JSONB 轉為 JSON 字串
this.apiConfigJson = JSON.stringify(template.next_api_config, null, 2);

// 從 JSON 字串轉回 JSONB
this.templateForm.next_api_config = JSON.parse(this.apiConfigJson);

// 錯誤處理
try {
  const config = JSON.parse(this.apiConfigJson);
  this.templateForm.next_api_config = config;
} catch (e) {
  alert('JSON 格式錯誤：' + e.message);
}
```

---

## 附錄：配置範例集

### 📌 範例 1: 純資訊型 FAQ

**使用場景**: 租金繳納規定

```yaml
基本資訊:
  項目名稱: "租金繳納規定"
  內容: |
    租金繳納相關規定：
    1. 每月 5 號前繳納當月租金
    2. 可透過轉帳或現金繳納
    3. 逾期將酌收滯納金

流程配置:
  觸發模式: none (資訊型)
  後續動作: none (無)

執行流程:
  用戶問「租金幾號繳？」
  → 系統回答 SOP 內容
  → 結束
```

---

### 📌 範例 2: 排查型維修

**使用場景**: 冷氣故障排查

```yaml
基本資訊:
  項目名稱: "冷氣不冷排查"
  內容: |
    冷氣不冷時請先檢查：
    1. 確認已開啟冷氣模式（非送風或除濕）
    2. 溫度設定是否低於室溫
    3. 濾網是否需要清潔
    4. 室外機是否正常運轉

流程配置:
  觸發模式: manual (排查型)
  觸發關鍵詞:
    - "還是不行"
    - "還是不冷"
    - "需要維修"
    - "我要報修"
  後續動作: form_fill (觸發表單)
  表單: repair_request (報修申請)
  後續提示: "好的，我來協助您填寫報修表單"

執行流程:
  用戶問「冷氣不冷怎麼辦？」
  → 系統回答排查步驟
  → 用戶嘗試排查
  → 用戶說「還是不行」
  → 系統顯示後續提示
  → 引導填寫報修表單
  → 提交報修
```

---

### 📌 範例 3: 緊急型報修

**使用場景**: 漏水緊急處理

```yaml
基本資訊:
  項目名稱: "漏水緊急處理"
  內容: |
    發現漏水時的緊急處理步驟：
    1. 立即關閉該區域的水閥
    2. 使用毛巾或水桶收集漏水
    3. 清理地面積水，避免滑倒
    4. 拍照記錄漏水位置

流程配置:
  觸發模式: immediate (緊急型)
  確認提示: |
    需要立即為您申請緊急報修嗎？
    （輸入「確認」、「是的」或「好」開始填寫緊急報修單）
  後續動作: form_fill (觸發表單)
  表單: emergency_repair (緊急報修)
  後續提示: "我會立即為您處理緊急報修，請填寫以下資訊"

執行流程:
  用戶問「天花板漏水！」
  → 系統回答緊急處理步驟
  → 系統立即主動詢問「需要立即報修嗎？」
  → 用戶回覆「確認」
  → 系統顯示後續提示
  → 引導填寫緊急報修表單
  → 優先處理
```

---

### 📌 範例 4: 自動查詢型

**使用場景**: 租金帳單查詢

```yaml
基本資訊:
  項目名稱: "租金帳單查詢"
  內容: |
    為您查詢租金繳納記錄：
    - 當月應繳金額
    - 已繳納記錄
    - 未繳納金額
    - 繳款期限

流程配置:
  觸發模式: auto (自動執行)
  後續動作: api_call (調用 API)
  API 配置:
    method: GET
    endpoint: http://api.example.com/billing/query
    params:
      user_id: "${user_id}"
      vendor_id: "${vendor_id}"
  後續提示: "正在為您查詢租金帳單，請稍候..."

執行流程:
  用戶問「我要查租金帳單」
  → 系統回答說明
  → 自動調用租金查詢 API
  → 顯示查詢結果
  → 結束
```

---

### 📌 範例 5: 完整流程型

**使用場景**: 租屋申請

```yaml
基本資訊:
  項目名稱: "租屋申請流程"
  內容: |
    租屋申請需要準備的資料：
    1. 個人基本資料（姓名、電話、Email）
    2. 身份證明文件
    3. 財力證明（薪資單或存款證明）
    4. 緊急聯絡人資訊
    5. 期望租期

流程配置:
  觸發模式: auto (自動執行)
  後續動作: form_then_api (先填表單再調用 API)
  表單: rental_application (租屋申請表)
  API 配置:
    method: POST
    endpoint: http://api.example.com/rental/submit
    params:
      vendor_id: "${vendor_id}"
      source: "chatbot"
  後續提示: "好的，請填寫以下資訊，完成後將自動提交到業務系統"

執行流程:
  用戶說「我要租房」
  → 系統回答申請說明
  → 顯示後續提示
  → 引導填寫租屋申請表單
    - 姓名
    - 電話
    - Email
    - 身份證號
    - 期望租期
    - 其他備註
  → 用戶完成填寫
  → 系統自動調用 API 提交表單資料
  → 返回申請單號
  → 通知業務人員處理
```

---

### 📌 範例 6: 看房預約（手動觸發）

**使用場景**: 看房預約服務

```yaml
基本資訊:
  項目名稱: "看房預約"
  內容: |
    看房預約說明：
    1. 平日時間：週一至週五 10:00-18:00
    2. 假日時間：週六 10:00-17:00
    3. 需提前一天預約
    4. 每次參觀時間約 30 分鐘

流程配置:
  觸發模式: manual (排查型)
  觸發關鍵詞:
    - "我要看房"
    - "預約看房"
    - "安排看房"
    - "想看房子"
  後續動作: form_fill (觸發表單)
  表單: viewing_appointment (看房預約)
  後續提示: "好的！我來協助您預約看房，請填寫以下資訊"

執行流程:
  用戶問「可以看房嗎？」
  → 系統回答看房說明
  → 用戶說「我要看房」
  → 系統顯示後續提示
  → 引導填寫預約表單
    - 姓名
    - 電話
    - 期望日期
    - 期望時段
  → 提交預約
  → 業務人員聯絡確認
```

---

## 📚 更新日誌

### Version 1.0 (2026-01-24)

**新增功能**:
- ✅ 4 種觸發模式（none, manual, immediate, auto）
- ✅ 4 種後續動作（none, form_fill, api_call, form_then_api）
- ✅ 關鍵詞輸入元件（KeywordsInput）
- ✅ 完整的驗證邏輯
- ✅ 業者唯讀顯示流程配置
- ✅ 業者可編輯後續提示詞
- ✅ 響應式佈局（桌面/手機）

**資料庫**:
- ✅ 新增 7 個流程配置欄位
- ✅ trigger_keywords: text[]
- ✅ next_api_config: jsonb

**測試**:
- ✅ 資料庫驗證: 14/14 (100%)
- ✅ 代碼審查: 26/28 (92.9%)
- ✅ 資料完整性: 2/2 (100%)

---

## 📞 支援與反饋

### 問題回報

**Platform 管理員**:
- 配置問題、驗證失敗、功能建議

**Vendor 業者**:
- 使用問題、顯示異常、介面優化建議

### 聯絡方式

- Email: support@example.com
- 內部工單系統

---

**文檔維護**: 開發團隊
**最後審核**: 2026-01-24
**下次更新**: 根據用戶反饋
