# ç­”æ¡ˆåˆæˆåŠŸèƒ½æ¸¬è©¦æŒ‡å—

**æ¸¬è©¦æ—¥æœŸï¼š** 2025-10-11
**åŠŸèƒ½ç‹€æ…‹ï¼š** âœ… å·²æ•´åˆåˆ° RAG Orchestratorï¼Œç­‰å¾…å•Ÿç”¨æ¸¬è©¦

---

## ğŸ“ é…ç½®ä½ç½®

### 1. RAG Orchestrator é…ç½®

**æª”æ¡ˆï¼š** `rag-orchestrator/app.py` ï¼ˆç¬¬ 66-81 è¡Œï¼‰

å·²æ•´åˆç’°å¢ƒè®Šæ•¸é…ç½®ï¼š
```python
llm_optimizer_config = {
    "enable_synthesis": os.getenv("ENABLE_ANSWER_SYNTHESIS", "false").lower() == "true",
    "synthesis_threshold": float(os.getenv("SYNTHESIS_THRESHOLD", "0.7")),
    "synthesis_min_results": int(os.getenv("SYNTHESIS_MIN_RESULTS", "2")),
    "synthesis_max_results": int(os.getenv("SYNTHESIS_MAX_RESULTS", "3"))
}
```

### 2. ç’°å¢ƒè®Šæ•¸é…ç½®

**æª”æ¡ˆï¼š** `.env` ï¼ˆç¬¬ 19-24 è¡Œï¼‰

```bash
# Answer Synthesis Configuration (Phase 3 æ“´å±•)
ENABLE_ANSWER_SYNTHESIS=false    # é è¨­é—œé–‰ï¼Œç°åº¦æ¸¬è©¦å¾Œå†å•Ÿç”¨
SYNTHESIS_THRESHOLD=0.7           # è§¸ç™¼é–¾å€¼
SYNTHESIS_MIN_RESULTS=2           # æœ€å°‘éœ€è¦ 2 å€‹çµæœ
SYNTHESIS_MAX_RESULTS=3           # æœ€å¤šåˆæˆ 3 å€‹ç­”æ¡ˆä¾†æº
```

---

## ğŸš€ å•Ÿç”¨ç­”æ¡ˆåˆæˆåŠŸèƒ½

### æ–¹å¼ 1ï¼šä¿®æ”¹ .env æª”æ¡ˆï¼ˆæ¨è–¦ï¼‰

```bash
# ç·¨è¼¯ .env æª”æ¡ˆ
nano .env

# ä¿®æ”¹é€™ä¸€è¡Œï¼š
ENABLE_ANSWER_SYNTHESIS=false  â†’  ENABLE_ANSWER_SYNTHESIS=true

# å„²å­˜ä¸¦é‡å•Ÿ RAG Orchestrator
```

### æ–¹å¼ 2ï¼šè‡¨æ™‚å•Ÿç”¨ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰

```bash
# è¨­å®šç’°å¢ƒè®Šæ•¸ä¸¦å•Ÿå‹•
export ENABLE_ANSWER_SYNTHESIS=true
export SYNTHESIS_THRESHOLD=0.7

# é‡å•Ÿ RAG Orchestrator
docker-compose restart rag-orchestrator
```

---

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### éšæ®µ 1ï¼šé©—è­‰é…ç½®å·²è¼‰å…¥

1. **é‡å•Ÿ RAG Orchestratorï¼š**
```bash
docker-compose restart rag-orchestrator
```

2. **æŸ¥çœ‹å•Ÿå‹•æ—¥èªŒï¼š**
```bash
docker-compose logs -f rag-orchestrator | grep "ç­”æ¡ˆåˆæˆ"
```

3. **é æœŸçœ‹åˆ°ï¼š**
```
âœ… LLM ç­”æ¡ˆå„ªåŒ–å™¨å·²åˆå§‹åŒ– (Phase 3 + ç­”æ¡ˆåˆæˆåŠŸèƒ½å·²å•Ÿç”¨)
   åˆæˆé–¾å€¼: 0.7
   åˆæˆä¾†æºæ•¸: 2-3
```

**å¦‚æœçœ‹åˆ°ã€Œç­”æ¡ˆåˆæˆåŠŸèƒ½åœç”¨ã€ï¼Œè¡¨ç¤ºé…ç½®æœªç”Ÿæ•ˆï¼Œæª¢æŸ¥ï¼š**
- `.env` æª”æ¡ˆä¸­ `ENABLE_ANSWER_SYNTHESIS` æ˜¯å¦ç‚º `true`
- Docker æ˜¯å¦æ­£ç¢ºè¼‰å…¥äº†ç’°å¢ƒè®Šæ•¸
- æ˜¯å¦éœ€è¦é‡å»º Docker å®¹å™¨ï¼š`docker-compose up -d --build rag-orchestrator`

---

### éšæ®µ 2ï¼šä½¿ç”¨ Chat API æ¸¬è©¦

#### æ¸¬è©¦æ¡ˆä¾‹ 1ï¼šæ‡‰è©²è§¸ç™¼åˆæˆ

**å•é¡Œï¼š** è¤‡åˆå•é¡Œ + ä½ç›¸ä¼¼åº¦

```bash
curl -X POST http://localhost:8100/api/v1/message \
  -H "Content-Type: application/json" \
  -d '{
    "message": "é€€ç§Ÿæ™‚æŠ¼é‡‘è¦æ€éº¼é€€é‚„ï¼Ÿéœ€è¦ä»€éº¼æµç¨‹ï¼Ÿ",
    "vendor_id": 1,
    "mode": "tenant"
  }'
```

**é æœŸè¡Œç‚ºï¼š**
- ğŸ”„ è§¸ç™¼ç­”æ¡ˆåˆæˆ
- âœ¨ è¿”å›çµæ§‹åŒ–ã€å®Œæ•´çš„ç­”æ¡ˆ
- ğŸ“Š ç­”æ¡ˆæ¶µè“‹å¤šå€‹ä¾†æºçš„è³‡è¨Š

**æª¢æŸ¥æ—¥èªŒï¼š**
```bash
docker-compose logs -f rag-orchestrator | grep -E "åˆæˆ|synthesis"
```

**é æœŸçœ‹åˆ°ï¼š**
```
ğŸ”„ ç­”æ¡ˆåˆæˆè§¸ç™¼ï¼šå•é¡Œé¡å‹=True, æœ€é«˜ç›¸ä¼¼åº¦=0.65 < 0.7
âœ¨ ç­”æ¡ˆåˆæˆå®Œæˆï¼šä½¿ç”¨äº† 3 å€‹ä¾†æºï¼Œtokens: 1138
```

---

#### æ¸¬è©¦æ¡ˆä¾‹ 2ï¼šä¸æ‡‰è©²è§¸ç™¼åˆæˆ

**å•é¡Œï¼š** å–®ä¸€ç°¡å–®å•é¡Œ + é«˜ç›¸ä¼¼åº¦

```bash
curl -X POST http://localhost:8100/api/v1/message \
  -H "Content-Type: application/json" \
  -d '{
    "message": "ç§Ÿé‡‘æ˜¯å¤šå°‘ï¼Ÿ",
    "vendor_id": 1,
    "mode": "tenant"
  }'
```

**é æœŸè¡Œç‚ºï¼š**
- âŒ ä¸è§¸ç™¼ç­”æ¡ˆåˆæˆï¼ˆå–®ä¸€ç­”æ¡ˆå·²è¶³å¤ ï¼‰
- âœ… ä½¿ç”¨å‚³çµ±å„ªåŒ–æ¨¡å¼
- ğŸ“ è¿”å›ç°¡æ½”ç­”æ¡ˆ

---

#### æ¸¬è©¦æ¡ˆä¾‹ 3ï¼šè§¸ç™¼æ¢ä»¶æ¸¬è©¦

| æ¸¬è©¦å•é¡Œ | æ‡‰è©²è§¸ç™¼ï¼Ÿ | åŸå›  |
|---------|----------|------|
| ã€Œå¦‚ä½•è¾¦ç†é€€ç§Ÿï¼Ÿéœ€è¦æº–å‚™ä»€éº¼ï¼Ÿã€ | âœ… æ˜¯ | è¤‡åˆå•é¡Œ |
| ã€Œé€€ç§Ÿæµç¨‹å’Œæ³¨æ„äº‹é …æ˜¯ä»€éº¼ï¼Ÿã€ | âœ… æ˜¯ | å¤šé¢å‘å•é¡Œ |
| ã€Œé€€ç§Ÿéœ€è¦ä»€éº¼æ–‡ä»¶ï¼Ÿã€ | âœ… æ˜¯ | è¤‡åˆéœ€æ±‚ |
| ã€Œç§Ÿé‡‘ã€ | âŒ å¦ | å–®ä¸€ç°¡å–®å•é¡Œ |
| ã€Œç¹³è²»æ—¥æ˜¯å¹¾è™Ÿï¼Ÿã€ | âŒ å¦ | å–®ä¸€å•é¡Œ |

---

### éšæ®µ 3ï¼šå“è³ªè©•ä¼°

#### äººå·¥è©•ä¼°ï¼ˆæ¨è–¦ 50 å€‹æ¸¬è©¦æ¡ˆä¾‹ï¼‰

**è©•ä¼°è¡¨æ ¼ï¼š**

| å•é¡Œ | è§¸ç™¼åˆæˆ | ç­”æ¡ˆå®Œæ•´æ€§ | çµæ§‹æ¸…æ™°åº¦ | æ˜¯å¦é‡è¤‡ | ç¶œåˆè©•åˆ† |
|------|---------|-----------|-----------|---------|---------|
| å•é¡Œ 1 | âœ…/âŒ | 1-5 | 1-5 | âœ…/âŒ | 1-5 |
| å•é¡Œ 2 | ... | ... | ... | ... | ... |

**è©•åˆ†æ¨™æº–ï¼š**
- **å®Œæ•´æ€§ (1-5)ï¼š** ç­”æ¡ˆæ˜¯å¦æ¶µè“‹æ‰€æœ‰å¿…è¦è³‡è¨Š
- **çµæ§‹æ¸…æ™°åº¦ (1-5)ï¼š** æ˜¯å¦ä½¿ç”¨æ¨™é¡Œã€åˆ—è¡¨ã€æ­¥é©Ÿ
- **æ˜¯å¦é‡è¤‡ï¼š** æ˜¯å¦æœ‰é‡è¤‡è³‡è¨Š
- **ç¶œåˆè©•åˆ† (1-5)ï¼š** æ•´é«”å“è³ª

**ç›®æ¨™ï¼š**
- å¹³å‡å®Œæ•´æ€§ â‰¥ 4.0
- å¹³å‡çµæ§‹æ¸…æ™°åº¦ â‰¥ 4.0
- ç„¡é‡è¤‡ç‡ â‰¥ 90%
- ç¶œåˆè©•åˆ† â‰¥ 4.0

---

#### è‡ªå‹•åŒ–è©•ä¼°ï¼ˆä½¿ç”¨ LLMï¼‰

å¦‚æœä½ å·²ç¶“å¯¦æ–½äº† Hybrid å›æ¸¬æ¨¡å¼ï¼Œå¯ä»¥ï¼š

```bash
# åŸ·è¡Œ Hybrid å›æ¸¬ï¼ˆå« LLM å“è³ªè©•ä¼°ï¼‰
export ENABLE_ANSWER_SYNTHESIS=true  # å•Ÿç”¨åˆæˆ
BACKTEST_QUALITY_MODE=hybrid \
BACKTEST_TYPE=smoke \
BACKTEST_SAMPLE_SIZE=10 \
python3 scripts/knowledge_extraction/backtest_framework.py
```

**å°æ¯”ï¼š**
1. åŸ·è¡Œä¸€æ¬¡ã€Œç„¡åˆæˆã€å›æ¸¬ï¼ˆENABLE_ANSWER_SYNTHESIS=falseï¼‰
2. åŸ·è¡Œä¸€æ¬¡ã€Œæœ‰åˆæˆã€å›æ¸¬ï¼ˆENABLE_ANSWER_SYNTHESIS=trueï¼‰
3. æ¯”è¼ƒå®Œæ•´æ€§ã€ç¶œåˆè©•åˆ†çš„è®ŠåŒ–

---

### éšæ®µ 4ï¼šæˆæœ¬ç›£æ§

#### Token ä½¿ç”¨çµ±è¨ˆ

**æ–¹å¼ 1ï¼šæŸ¥çœ‹æ—¥èªŒ**
```bash
docker-compose logs rag-orchestrator | grep "ç­”æ¡ˆåˆæˆå®Œæˆ" | awk '{print $NF}'
```

**æ–¹å¼ 2ï¼šæ‰‹å‹•è¨˜éŒ„**
è¨˜éŒ„æ¯æ¬¡åˆæˆçš„ tokensï¼š
- åˆæˆ 2 å€‹ä¾†æºï¼š~700-800 tokens
- åˆæˆ 3 å€‹ä¾†æºï¼š~1000-1200 tokens

**è¨ˆç®—æ¯æ—¥æˆæœ¬ï¼š**
```
å‡è¨­ï¼š
- æ¯å¤© 1000 æ¬¡æŸ¥è©¢
- 10% è§¸ç™¼åˆæˆï¼ˆ100 æ¬¡ï¼‰
- å¹³å‡ 900 tokens/æ¬¡

æˆæœ¬ = 100 Ã— 900 Ã— $0.00000045 (GPT-4o-mini) = $0.04/å¤© = $1.2/æœˆ
```

---

### éšæ®µ 5ï¼šèª¿æ•´å„ªåŒ–

#### å¦‚æœè§¸ç™¼å¤ªå¤šï¼ˆ> 20%ï¼‰

**èª¿æ•´é–¾å€¼ï¼š**
```bash
# æé«˜è§¸ç™¼é–¾å€¼
SYNTHESIS_THRESHOLD=0.75  # å¾ 0.7 â†’ 0.75
```

**é æœŸæ•ˆæœï¼š** åªæœ‰ç›¸ä¼¼åº¦æ›´ä½ï¼ˆ< 0.75ï¼‰æ™‚æ‰è§¸ç™¼

---

#### å¦‚æœè§¸ç™¼å¤ªå°‘ï¼ˆ< 5%ï¼‰

**èª¿æ•´é–¾å€¼ï¼š**
```bash
# é™ä½è§¸ç™¼é–¾å€¼
SYNTHESIS_THRESHOLD=0.65  # å¾ 0.7 â†’ 0.65
```

**é æœŸæ•ˆæœï¼š** æ›´å®¹æ˜“è§¸ç™¼åˆæˆ

---

#### å¦‚æœåˆæˆå“è³ªä¸ä½³

**å¯èƒ½åŸå› ï¼š**
1. ä¾†æºå¤ªå¤šï¼ˆå°è‡´å†—é•·ï¼‰ â†’ æ¸›å°‘ `SYNTHESIS_MAX_RESULTS`
2. ä¾†æºå¤ªå°‘ï¼ˆä¸å¤ å®Œæ•´ï¼‰ â†’ å¢åŠ  `SYNTHESIS_MAX_RESULTS`
3. LLM prompt éœ€è¦èª¿æ•´ â†’ ä¿®æ”¹ `llm_answer_optimizer.py` ä¸­çš„ `_create_synthesis_system_prompt()`

---

## ğŸ“Š ç›£æ§å„€è¡¨æ¿

### å»ºè­°ç›£æ§æŒ‡æ¨™

| æŒ‡æ¨™ | ç›£æ§æ–¹å¼ | ç›®æ¨™å€¼ |
|------|---------|--------|
| **åˆæˆè§¸ç™¼ç‡** | æ—¥èªŒçµ±è¨ˆ | 5-15% |
| **å¹³å‡å®Œæ•´æ€§** | äººå·¥è©•ä¼° | â‰¥ 4.0 |
| **å¹³å‡ tokens** | æ—¥èªŒçµ±è¨ˆ | 700-1200 |
| **æ¯æ—¥æˆæœ¬** | è¨ˆç®— | < $0.10 |
| **ç”¨æˆ¶æ»¿æ„åº¦** | åé¥‹çµ±è¨ˆ | â‰¥ 4.0 |

---

## âœ… æ±ºç­–é»

### ä½•æ™‚å…¨é¢å•Ÿç”¨ï¼Ÿ

æ»¿è¶³ä»¥ä¸‹æ¢ä»¶å³å¯å…¨é¢å•Ÿç”¨ï¼š

1. âœ… **å“è³ªæŒ‡æ¨™é”æ¨™ï¼š**
   - å¹³å‡å®Œæ•´æ€§ â‰¥ 4.0
   - ç¶œåˆè©•åˆ† â‰¥ 4.0

2. âœ… **æˆæœ¬å¯æ§ï¼š**
   - æ¯æ—¥æˆæœ¬åœ¨é ç®—å…§ï¼ˆ< $0.10ï¼‰

3. âœ… **ç”¨æˆ¶åé¥‹æ­£é¢ï¼š**
   - æ»¿æ„åº¦æå‡
   - ç„¡è² é¢åé¥‹

4. âœ… **æŠ€è¡“ç©©å®šï¼š**
   - ç„¡éŒ¯èª¤æˆ–ç•°å¸¸
   - è§¸ç™¼ç‡åœ¨åˆç†ç¯„åœï¼ˆ5-15%ï¼‰

### ä½•æ™‚åœç”¨ï¼Ÿ

å¦‚æœå‡ºç¾ä»¥ä¸‹æƒ…æ³ï¼Œå»ºè­°æš«æ™‚åœç”¨ï¼š

1. âŒ **å“è³ªä¸‹é™ï¼š** ç­”æ¡ˆå“è³ªåè€Œè®Šå·®
2. âŒ **æˆæœ¬éé«˜ï¼š** è¶…å‡ºé ç®— 2 å€ä»¥ä¸Š
3. âŒ **ç”¨æˆ¶æŠ•è¨´ï¼š** æ”¶åˆ°è² é¢åé¥‹
4. âŒ **ç³»çµ±ä¸ç©©å®šï¼š** é »ç¹å‡ºéŒ¯æˆ–è¶…æ™‚

---

## ğŸ”§ å¿«é€Ÿæ“ä½œæŒ‡ä»¤

### å•Ÿç”¨ç­”æ¡ˆåˆæˆ
```bash
# ä¿®æ”¹ .env
sed -i '' 's/ENABLE_ANSWER_SYNTHESIS=false/ENABLE_ANSWER_SYNTHESIS=true/' .env

# é‡å•Ÿæœå‹™
docker-compose restart rag-orchestrator

# é©—è­‰é…ç½®
docker-compose logs -f rag-orchestrator | grep "ç­”æ¡ˆåˆæˆ"
```

### åœç”¨ç­”æ¡ˆåˆæˆ
```bash
# ä¿®æ”¹ .env
sed -i '' 's/ENABLE_ANSWER_SYNTHESIS=true/ENABLE_ANSWER_SYNTHESIS=false/' .env

# é‡å•Ÿæœå‹™
docker-compose restart rag-orchestrator

# é©—è­‰é…ç½®
docker-compose logs -f rag-orchestrator | grep "ç­”æ¡ˆåˆæˆ"
```

### æ¸¬è©¦å–®ä¸€å•é¡Œ
```bash
# å„²å­˜ç‚º test_synthesis.sh
#!/bin/bash
curl -X POST http://localhost:8100/api/v1/message \
  -H "Content-Type: application/json" \
  -d "{\"message\": \"$1\", \"vendor_id\": 1, \"mode\": \"tenant\"}" \
  | jq '.answer'

# ä½¿ç”¨æ–¹å¼
chmod +x test_synthesis.sh
./test_synthesis.sh "é€€ç§Ÿæ™‚æŠ¼é‡‘è¦æ€éº¼é€€é‚„ï¼Ÿéœ€è¦ä»€éº¼æµç¨‹ï¼Ÿ"
```

---

## ğŸ“ æ¸¬è©¦å ±å‘Šç¯„æœ¬

### ç°åº¦æ¸¬è©¦å ±å‘Š

**æ¸¬è©¦æ™‚é–“ï¼š** 2025-10-XX ~ 2025-10-XX
**æ¸¬è©¦ç¯„åœï¼š** XX å€‹å•é¡Œ

#### æ¸¬è©¦çµæœ

| æŒ‡æ¨™ | çµæœ | ç›®æ¨™ | é”æ¨™ |
|------|------|------|------|
| åˆæˆè§¸ç™¼ç‡ | X.X% | 5-15% | âœ…/âŒ |
| å¹³å‡å®Œæ•´æ€§ | X.X/5 | â‰¥ 4.0 | âœ…/âŒ |
| å¹³å‡ç¶œåˆè©•åˆ† | X.X/5 | â‰¥ 4.0 | âœ…/âŒ |
| å¹³å‡ tokens | XXX | 700-1200 | âœ…/âŒ |
| æ¯æ—¥æˆæœ¬ | $X.XX | < $0.10 | âœ…/âŒ |

#### æ±ºç­–å»ºè­°

- [ ] å…¨é¢å•Ÿç”¨
- [ ] ç¹¼çºŒæ¸¬è©¦ï¼ˆå»¶é•· X é€±ï¼‰
- [ ] èª¿æ•´åƒæ•¸ï¼ˆXXXï¼‰
- [ ] æš«æ™‚åœç”¨

---

## ğŸ¯ ç¸½çµ

### æ¸¬è©¦æ¸…å–®

- [ ] ä¿®æ”¹ `.env` å•Ÿç”¨ç­”æ¡ˆåˆæˆ
- [ ] é‡å•Ÿ RAG Orchestrator
- [ ] é©—è­‰é…ç½®å·²è¼‰å…¥
- [ ] æ¸¬è©¦è§¸ç™¼æ¢ä»¶ï¼ˆ3+ å€‹æ¡ˆä¾‹ï¼‰
- [ ] äººå·¥è©•ä¼°å“è³ªï¼ˆ50 å€‹æ¡ˆä¾‹ï¼‰
- [ ] ç›£æ§æˆæœ¬
- [ ] æ”¶é›†ç”¨æˆ¶åé¥‹
- [ ] è¨˜éŒ„æ¸¬è©¦çµæœ
- [ ] åšå‡ºå•Ÿç”¨/åœç”¨æ±ºç­–

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025-10-11
**ä¸‹ä¸€æ­¥ï¼š** å•Ÿç”¨ç°åº¦æ¸¬è©¦
**é è¨ˆæ¸¬è©¦æ™‚é•·ï¼š** 1-2 é€±
