# 測試驗證報告 - AI 知識生成狀態顯示

## 測試日期
2025-10-27

## 測試目的
驗證測試情境詳情中的 AI 知識生成功能是否根據不同狀態正確顯示：
1. ✅ 已批准 - 顯示知識連結，不能再生成
2. ⏳ 審核中 - 顯示審核狀態，不能再生成
3. 🤖 可生成 - 顯示生成按鈕（已拒絕或無候選）

## API 測試結果

### ✅ 測試通過 - 後端 API 正確返回知識狀態

#### 1. 場景 159「包租代管公司合約補充事項」
- **有知識來源** (source_count: 4)
- **狀態**: pending_review（審核中）
- **候選 ID**: 85
```json
{
  "knowledge_status": {
    "candidate_id": 85,
    "status": "pending_review",
    "created_at": "2025-10-23T10:44:18.059550",
    "reviewed_at": null
  }
}
```
**預期 UI**: 顯示知識來源列表（不顯示 AI 生成按鈕，因為有知識來源）

---

#### 2. 場景 158「借址營登費用及服務內容」
- **無知識來源** (source_count: 0)
- **狀態**: pending_review（審核中）
- **候選 ID**: 84
```json
{
  "knowledge_status": {
    "candidate_id": 84,
    "status": "pending_review",
    "created_at": "2025-10-23T10:44:18.057659",
    "reviewed_at": null
  }
}
```
**預期 UI**:
- 顯示「📚 知識來源 (0個)」
- 顯示「⏳ 審核中」badge
- 提供「前往審核頁面」連結
- **不顯示**生成按鈕

---

#### 3. 場景 132「我想養寵物可以嗎？」
- **無知識來源** (source_count: 0)
- **狀態**: null（無候選知識）
```json
{
  "knowledge_status": null
}
```
**預期 UI**:
- 顯示「📚 知識來源 (0個)」
- 顯示「🤖 AI 生成知識」按鈕
- **可以生成**新的候選知識

---

#### 4. 場景 20「可以養寵物嗎」
- **無知識來源** (source_count: 0)
- **狀態**: rejected（已拒絕）
- **候選 ID**: 2
```json
{
  "knowledge_status": {
    "candidate_id": 2,
    "status": "rejected",
    "created_at": "2025-10-11T13:55:00.590686",
    "reviewed_at": "2025-10-11T15:16:24.780413"
  }
}
```
**預期 UI**:
- 顯示「📚 知識來源 (0個)」
- 顯示「❌ 已拒絕 - 可重新生成」badge
- 顯示「🤖 AI 生成知識」按鈕
- **可以重新生成**候選知識

---

#### 5. 場景 84「我沒有wifi」
- **有知識來源** (source_count: 1)
- **狀態**: approved（已批准）
- **候選 ID**: 53
- **知識 ID**: 498
```json
{
  "knowledge_status": {
    "candidate_id": 53,
    "status": "approved",
    "created_at": "2025-10-13T03:09:56.084083",
    "reviewed_at": "2025-10-13T03:10:13.026269",
    "knowledge_id": 498
  }
}
```
**預期 UI**:
- 顯示知識來源：「[498] 我沒有wifi」
- 提供知識連結可點擊
- **不顯示** AI 生成按鈕（因為已有知識來源）

---

## 前端 UI 測試點

### 測試步驟：
1. 訪問 http://localhost:8087/test-scenarios
2. 點擊展開以下測試情境的詳情：

#### 測試 1: 審核中狀態（無知識來源）
- **場景**: 158「借址營登費用及服務內容」
- **檢查點**:
  - [ ] 顯示「📚 知識來源 (0個)」
  - [ ] 顯示「⏳ 審核中」badge（黃色背景）
  - [ ] 顯示「前往審核頁面」連結
  - [ ] 點擊連結跳轉到 `/ai-knowledge-review?candidate_id=84`
  - [ ] **不顯示**「🤖 AI 生成知識」按鈕

#### 測試 2: 可生成狀態（無候選知識）
- **場景**: 132「我想養寵物可以嗎？」
- **檢查點**:
  - [ ] 顯示「📚 知識來源 (0個)」
  - [ ] 顯示「🤖 AI 生成知識」按鈕（紫色漸變）
  - [ ] 按鈕有 hover 動畫效果
  - [ ] 點擊按鈕可生成知識

#### 測試 3: 可重新生成狀態（已拒絕）
- **場景**: 20「可以養寵物嗎」
- **檢查點**:
  - [ ] 顯示「📚 知識來源 (0個)」
  - [ ] 顯示「❌ 已拒絕 - 可重新生成」badge（紅色背景）
  - [ ] 顯示「🤖 AI 生成知識」按鈕
  - [ ] 點擊按鈕可重新生成知識

#### 測試 4: 有知識來源（不顯示生成按鈕）
- **場景**: 84「我沒有wifi」
- **檢查點**:
  - [ ] 顯示「📚 知識來源 (1個)」
  - [ ] 顯示知識來源：「[498] 我沒有wifi」
  - [ ] 知識 ID 可點擊，跳轉到 `/knowledge?ids=498`
  - [ ] **不顯示** AI 生成按鈕

---

## 技術實現總結

### 後端變更
1. ✅ 修改 `GET /api/test/scenarios/{scenario_id}/results` API
2. ✅ 返回 `knowledge_status` 包含候選知識狀態
3. ✅ 若已批准，自動查找對應的正式知識 ID
4. ✅ 修正欄位名稱：`question` → `question_summary`

### 前端變更
1. ✅ 新增 `knowledgeStatus` 數據欄位
2. ✅ 載入測試詳情時同時獲取知識狀態
3. ✅ 根據狀態動態顯示三種 UI：
   - 已批准：顯示知識連結
   - 審核中：顯示審核中 badge + 審核頁面連結
   - 可生成：顯示生成按鈕（已拒絕或無候選）
4. ✅ 生成知識成功後自動刷新狀態

### CSS 樣式
1. ✅ 狀態 badge（.badge-approved, .badge-pending, .badge-rejected）
2. ✅ 知識連結（.knowledge-link）
3. ✅ 審核連結（.candidate-link）
4. ✅ AI 生成按鈕（.btn-ai-generate）
5. ✅ Hover 動畫效果

---

## 下一步驗證

請前往瀏覽器測試：
```
http://localhost:8087/test-scenarios
```

根據上述測試點逐一驗證 UI 顯示是否符合預期。
