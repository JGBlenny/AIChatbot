# RAG 評分品質深度分析與改善方案

**測試日期：** 2025-10-11
**測試範圍：** 多意圖、單意圖、邊界情況
**評估方法：** LLM 品質評估 + NDCG 排序指標

---

## 📊 測試結果總結

### 整體指標

| 指標 | 分數 | 評級 | 說明 |
|------|------|------|------|
| **NDCG@3** | 0.958 | 🎉 優秀 | 排序品質非常好，意圖加成有效 |
| **相關性** | 3.83/5 | ✅ 良好 | 答案基本相關 |
| **完整性** | 2.92/5 | ⚠️ 較差 | **核心問題** |
| **準確性** | 4.17/5 | ✅ 優秀 | 資訊準確 |
| **意圖匹配** | 3.83/5 | ✅ 良好 | 意圖分類有效 |
| **綜合評分** | 3.42/5 | ⚠️ 中等 | 需要改善 |

---

## 🔍 關鍵發現

### ✅ 成功的部分

1. **意圖加成機制有效**
   - NDCG 0.958 表示排序品質優秀
   - 主要意圖的答案確實排在更前面
   - 多意圖檢索正確運作

2. **準確性高**
   - 返回的答案內容準確
   - 沒有錯誤資訊

3. **相關性良好**
   - 返回的答案與問題基本相關
   - 意圖分類準確

### ⚠️ 發現的問題

#### **問題 1: 排序悖論 - 相似度高 ≠ 品質高**

**案例：測試 1「退租時押金要怎麼退還？」**

| 排名 | 相似度 | 品質評分 | 問題 |
|------|--------|----------|------|
| 1 | 0.659 | 4/5 | 完整性欠缺 (4/5) |
| 2 | 0.594 | **5/5** | **完整性最佳 (5/5)** |
| 3 | 0.546 | 4/5 | 完整性欠缺 (3/5) |

**問題：** 排名第 2 的答案品質最高（5/5），但因相似度較低而排在第 2 位。

**LLM 評語對比：**
- 排名 1: "完整性上可以增加一些具體的步驟或注意事項"
- **排名 2**: "清楚地回答並**詳細列出了每個步驟和注意事項**" ✅
- 排名 3: "未明確說明押金的具體退還流程"

---

#### **問題 2: 完整性普遍不足 (2.92/5)**

**統計分析：**
- 12 個答案中，完整性 ≥4 的只有 3 個 (25%)
- 完整性 ≤2 的有 5 個 (42%)

**常見問題：**
1. 答案只回答部分問題（如只答租金逾期，不答計算方式）
2. 缺乏具體步驟
3. 缺乏操作指引

---

#### **問題 3: 知識庫內容品質不一致**

**發現的具體問題：**

1. **ID 68 - 解除合約知識** (相似度 0.783, 品質 3/5)
   - 問題：提到的「跨越計算」不夠清晰
   - 建議：需要更清楚的表述

2. **租金計算問題**
   - 問題：「租金如何計算？逾期會罰款嗎？」
   - 檢索結果：3 個答案都只回答「逾期處理」，未回答「租金計算」
   - 品質評分：3/5, 3/5, 2/5

---

## 💡 改善方案

### 🎯 方案 A：引入重排序機制 (Reranking)

**目標：** 解決「相似度高 ≠ 品質高」的問題

#### 實施方案

1. **兩階段檢索**
   ```
   階段 1: Intent-Boosted 向量檢索（Top-10）
            ↓
   階段 2: 重排序模型（Top-3）
   ```

2. **重排序因子**
   - **答案長度** (weight: 0.1): 更長的答案通常更完整
   - **問句覆蓋度** (weight: 0.2): 答案是否涵蓋問題的所有部分
   - **結構化程度** (weight: 0.1): 是否有步驟、列表、段落
   - **原始相似度** (weight: 0.6): 保留向量相似度的主導地位

3. **重排序公式**
   ```python
   rerank_score = (
       0.6 * similarity +
       0.2 * question_coverage +
       0.1 * answer_length_score +
       0.1 * structure_score
   )
   ```

#### 預期效果
- 完整性提升至 3.5-4.0/5
- NDCG 維持在 0.95+
- 綜合評分提升至 3.8-4.0/5

---

### 🎯 方案 B：優化意圖加成權重

**目標：** 微調加成倍數以平衡相似度和意圖匹配

#### 當前配置問題

```
主要意圖: 1.5x  ← 可能過高，導致低相似度答案排太前
次要意圖: 1.2x
其他: 1.0x
```

#### 建議配置

```python
# 方案 B1: 保守調整
primary_boost = 1.3x   # 降低 (1.5 → 1.3)
secondary_boost = 1.15x # 降低 (1.2 → 1.15)

# 方案 B2: 動態加成（根據信心度）
primary_boost = 1.0 + 0.5 * confidence  # 0.85 信心度 → 1.425x
secondary_boost = 1.0 + 0.2 * confidence
```

#### 實施建議
- 先在測試環境用 A/B 測試
- 觀察 NDCG 是否下降（應保持 >0.90）
- 觀察完整性是否提升

---

### 🎯 方案 C：提升知識庫內容品質

**目標：** 從根源解決完整性問題

#### 實施步驟

1. **內容審核**
   - 對評分 <3.5 的知識進行人工審核
   - 特別關注：ID 68, 437, 434, 393 等

2. **內容補強**
   ```markdown
   【補強前】
   Q: 退租時押金要怎麼退還？
   A: 退租後 7-14 天內退還，扣除損壞費用。

   【補強後】
   Q: 退租時押金要怎麼退還？
   A: 退租押金退還流程如下：
   1. 提前 30 天通知退租意願
   2. 約定房屋檢查時間
   3. 確認房屋狀況並拍照記錄
   4. 如無損壞，7-14 天內退還全額押金
   5. 如有損壞，扣除修復費用後退還餘額
   6. 退款方式：原繳款帳戶或現金
   ```

3. **品質檢查清單**
   - [ ] 是否完整回答問題的所有部分？
   - [ ] 是否提供具體步驟/流程？
   - [ ] 是否包含必要的注意事項？
   - [ ] 表述是否清晰無歧義？
   - [ ] 是否包含聯繫方式/進一步資源？

---

### 🎯 方案 D：降低相似度閾值

**目標：** 避免過濾掉高品質但語義稍遠的答案

#### 當前配置
```python
similarity_threshold = 0.6  # 可能過高
```

#### 建議調整
```python
# 方案 D1: 降低閾值
similarity_threshold = 0.5  # 觀察是否引入噪音

# 方案 D2: 意圖相關調整
if intent_matched:
    threshold = 0.5  # 意圖匹配：低閾值
else:
    threshold = 0.7  # 無意圖匹配：高閾值
```

---

### 🎯 方案 E：引入答案合成

**目標：** 結合多個答案的優點，提升完整性

#### 實施方案

當檢索到多個相關但各有側重的答案時，使用 LLM 合成：

```python
def synthesize_answer(question: str, top_answers: List[Dict]) -> str:
    """合成多個答案為一個完整答案"""

    prompt = f"""
    問題：{question}

    以下是多個相關答案：
    {format_answers(top_answers)}

    請綜合以上答案，生成一個完整、準確、結構化的回覆。
    要求：
    1. 涵蓋所有重要資訊
    2. 使用結構化格式（步驟、列表）
    3. 避免重複
    4. 保持準確性
    """

    return llm.generate(prompt)
```

#### 適用場景
- 完整性 <3.5 的答案
- 多個答案各有側重時
- 複雜問題需要綜合回答

---

## 🚀 建議實施順序

### 第 1 階段：快速改善 (1-2 週)

1. ✅ **方案 C - 內容補強** (立即執行)
   - 優先修正評分 <3 的知識
   - 補充缺失的步驟和細節
   - **預期：完整性 +0.5**

2. ✅ **方案 D - 降低閾值** (立即執行)
   - 調整為 0.5，觀察 1 週
   - 監控噪音比例
   - **預期：召回率 +10%**

### 第 2 階段：機制優化 (2-4 週)

3. ✅ **方案 B - 優化加成權重** (A/B 測試)
   - 測試 1.3x/1.15x 配置
   - 比較 NDCG 和完整性變化
   - **預期：平衡性 +15%**

4. ✅ **方案 A - 引入重排序** (開發 + 測試)
   - 實施簡單版重排序
   - 先用規則後考慮模型
   - **預期：綜合評分 +0.3**

### 第 3 階段：進階功能 (1-2 月)

5. ✅ **方案 E - 答案合成** (實驗性)
   - 先在複雜問題上測試
   - 評估成本和效果
   - **預期：完整性 +0.5**

---

## 📈 預期改善效果

| 指標 | 當前 | 階段 1 | 階段 2 | 階段 3 | 目標 |
|------|------|--------|--------|--------|------|
| NDCG@3 | 0.958 | 0.950 | 0.960 | 0.970 | >0.95 |
| 相關性 | 3.83 | 4.0 | 4.1 | 4.2 | >4.0 |
| **完整性** | **2.92** | **3.4** | **3.7** | **4.0** | **>3.8** |
| 準確性 | 4.17 | 4.2 | 4.3 | 4.3 | >4.0 |
| 意圖匹配 | 3.83 | 3.9 | 4.0 | 4.1 | >4.0 |
| **綜合評分** | **3.42** | **3.7** | **3.9** | **4.1** | **>4.0** |

---

## 🎯 關鍵績效指標 (KPI)

### 必達指標
- ✅ **完整性 >3.5** (目前 2.92)
- ✅ **綜合評分 >3.8** (目前 3.42)
- ✅ **NDCG@3 >0.90** (目前 0.958)

### 追蹤指標
- 用戶滿意度評分
- 答案被採納率
- 人工介入次數

---

## 🛠️ 持續優化建議

### 1. 定期評估
- **每週：** 監控 NDCG 和品質分數
- **每月：** 執行完整評分品質測試
- **每季：** 人工審核知識庫內容

### 2. 數據收集
- 記錄用戶回饋（👍/👎）
- 追蹤高頻問題的答案品質
- 分析失敗案例

### 3. A/B 測試
- 測試不同加成權重
- 測試不同閾值配置
- 測試重排序算法

### 4. 人工標註
- 建立黃金標準測試集
- 定期更新測試案例
- 引入真實用戶問題

---

## 📚 相關文檔

- [多意圖 RAG 測試報告](../output/multi_intent_test_*.json)
- [評分品質測試結果](../output/scoring_quality_test_*.json)
- [系統架構文檔](./architecture/SYSTEM_ARCHITECTURE.md)

---

**最後更新：** 2025-10-11
**下次評估：** 2025-10-18
