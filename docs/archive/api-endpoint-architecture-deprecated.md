# API Endpoint 架構說明

> ⚠️ **此文檔已過時** (2026-01-20)
>
> 本文檔描述的是舊架構（改進前），其中每個 API 需要單獨寫函數。
>
> **新架構**: 90% 的 API 現在使用動態配置，不需要寫代碼。請參考：
> - [API 核心函數參考](./design/CORE_API_FUNCTIONS_REFERENCE.md) - 統一處理函數說明
> - [改進的 API 架構設計](./design/IMPROVED_API_ARCHITECTURE.md) - 新架構設計
> - [API 數據流程完整說明](./design/API_DATA_FLOW.md) - 完整流程
>
> 保留此文檔僅供參考舊架構的設計思路。

**日期**: 2026-01-18

---

## 🏗️ 當前架構（分層設計）

```
┌─────────────────────────────────────────────────────────────┐
│                    Layer 1: 前端管理層                      │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  管理頁面 (http://localhost:8087/api-endpoints)       │  │
│  │  • 新增/編輯 API endpoint 選項                        │  │
│  │  • 設定名稱、圖示、描述                               │  │
│  │  • 控制在知識庫/表單中的可見性                        │  │
│  │  • 啟用/停用                                          │  │
│  └───────────────────────────────────────────────────────┘  │
│                           ↕                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  數據庫表 (api_endpoints)                             │  │
│  │  • endpoint_id: "rent_history"                        │  │
│  │  • endpoint_name: "查詢租金紀錄"                      │  │
│  │  • endpoint_icon: "💰"                                │  │
│  │  • available_in_knowledge: true                       │  │
│  │  • is_active: true                                    │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↓
                    用戶在知識庫/表單選擇
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                  Layer 2: 知識庫/表單層                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  知識庫配置                                           │  │
│  │  {                                                    │  │
│  │    "action_type": "api_call",                        │  │
│  │    "api_config": {                                   │  │
│  │      "endpoint": "rent_history",  ←─ 只存儲 ID      │  │
│  │      "params": {                                     │  │
│  │        "user_id": "{session.user_id}"               │  │
│  │      }                                                │  │
│  │    }                                                  │  │
│  │  }                                                    │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↓
                      用戶觸發聊天
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                 Layer 3: API 調用處理層                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  api_call_handler.py                                  │  │
│  │                                                       │  │
│  │  self.api_registry = {                               │  │
│  │    'billing_inquiry': billing_api.get_invoice,       │  │
│  │    'rent_history': billing_api.get_rent_history, ←─┐ │  │
│  │    ...                                             │ │  │
│  │  }                                                  │ │  │
│  │                                                     │ │  │
│  │  ⚠️ 如果沒有註冊，會報錯：                        │ │  │
│  │     "不支援的 API endpoint: rent_history"          │ │  │
│  └──────────────────────────────────────────────────┼──┘  │
│                                                      │     │
│  ┌──────────────────────────────────────────────────┼───┐  │
│  │  billing_api.py                                  ↓  │  │
│  │                                                      │  │
│  │  async def get_rent_history(user_id, ...):          │  │
│  │      # 1. 調用實際的租賃系統 API                    │  │
│  │      response = await http_client.get(              │  │
│  │          "https://rental-api.com/history"           │  │
│  │      )                                               │  │
│  │                                                      │  │
│  │      # 2. 處理響應                                  │  │
│  │      return {                                        │  │
│  │          'success': True,                            │  │
│  │          'data': response.data                       │  │
│  │      }                                               │  │
│  │                                                      │  │
│  │  ⚠️ 如果沒有實作這個方法，會報錯                   │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↓
                        格式化回應
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                   Layer 4: 響應格式化層                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  _format_response()                                   │  │
│  │                                                       │  │
│  │  if endpoint == 'rent_history':                      │  │
│  │      return self._format_rent_history(result)        │  │
│  │                                                       │  │
│  │  輸出：                                               │  │
│  │  ┌─────────────────────────────────────────────────┐ │  │
│  │  │ 📋 您的租金繳納記錄                             │ │  │
│  │  │                                                 │ │  │
│  │  │ • 2025-01: $15,000 ✅ 已繳                     │ │  │
│  │  │   繳款日期: 2025-01-05                         │ │  │
│  │  │ • 2025-02: $15,000 ✅ 已繳                     │ │  │
│  │  │   繳款日期: 2025-02-03                         │ │  │
│  │  │                                                 │ │  │
│  │  │ 💰 總已繳金額: $30,000                         │ │  │
│  │  └─────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↓
                      返回給用戶
```

---

## 📊 三種設計方案對比

### 方案 A: 當前實作（元數據 + 代碼分離）

**優點**:
- ✅ 安全性高（API 邏輯在代碼中，不會被惡意修改）
- ✅ 靈活性強（可以實作複雜的業務邏輯）
- ✅ 性能好（直接調用函數）
- ✅ 易於調試

**缺點**:
- ❌ 新增 API 需要修改代碼並重啟
- ❌ 非技術人員無法新增 API
- ❌ 前端選項和後端邏輯可能不同步

**適用場景**:
- API 邏輯複雜
- 需要嚴格的安全控制
- 開發團隊可以快速迭代

---

### 方案 B: 完全動態配置

```sql
CREATE TABLE api_endpoints (
    -- ... 現有欄位
    api_url VARCHAR(500),           -- 實際的 API URL
    request_method VARCHAR(10),     -- GET, POST, PUT, DELETE
    request_headers JSONB,          -- 請求頭
    request_body_template JSONB,    -- 請求體模板
    response_format_template TEXT,  -- 響應格式化模板
    timeout_seconds INTEGER,        -- 超時設定
    retry_times INTEGER             -- 重試次數
);
```

**優點**:
- ✅ 完全動態（不需要修改代碼）
- ✅ 非技術人員可以配置
- ✅ 快速迭代

**缺點**:
- ❌ 安全風險（URL 可能被篡改）
- ❌ 複雜邏輯難以實現
- ❌ 錯誤處理困難
- ❌ 難以調試

**適用場景**:
- API 邏輯簡單（純 CRUD）
- 內部系統，安全要求不高
- 需要非技術人員管理

---

### 方案 C: 混合方案（推薦）

```
┌─────────────────────────────┐
│  簡單 API (GET, POST CRUD)  │  ← 完全動態配置
│  • 查詢訂單狀態             │
│  • 獲取用戶信息             │
└─────────────────────────────┘
             +
┌─────────────────────────────┐
│  複雜 API (業務邏輯)        │  ← 代碼實作
│  • 租金計算                 │
│  • 身份驗證                 │
│  • 批次操作                 │
└─────────────────────────────┘
```

**實作方式**:
1. 在 `api_endpoints` 表中新增 `implementation_type` 欄位:
   - `code`: 代碼實作（當前方式）
   - `dynamic`: 動態配置

2. 在 `api_call_handler.py` 中判斷:
   ```python
   if endpoint_config['implementation_type'] == 'dynamic':
       # 使用動態配置調用
       return await self._execute_dynamic_api(endpoint_config)
   else:
       # 使用代碼實作調用
       return await self.api_registry[endpoint_id](**params)
   ```

**優點**:
- ✅ 兼顧靈活性和安全性
- ✅ 簡單 API 快速配置
- ✅ 複雜 API 保持可控

---

## 🎯 建議

### 當前階段（MVP）
使用 **方案 A**（當前實作）：
- 適合初期，API 數量不多
- 安全性和可控性最重要
- 開發效率可接受

### 未來擴展
逐步引入 **方案 C**（混合方案）：
- 為常見的簡單 API 提供動態配置
- 保留複雜業務邏輯的代碼實作
- 在管理頁面標註哪些是「動態配置」，哪些是「代碼實作」

---

## 📝 當前狀態檢查

### ✅ 已實作的 API（可以使用）

| endpoint_id | 名稱 | 後端實作 | 格式化 |
|-------------|------|---------|--------|
| billing_inquiry | 帳單查詢 | ✅ | ✅ |
| verify_tenant_identity | 租客身份驗證 | ✅ | ✅ |
| resend_invoice | 重新發送帳單 | ✅ | ✅ |
| maintenance_request | 報修申請 | ✅ | ✅ |

### ❌ 未完成的 API（不能使用）

| endpoint_id | 名稱 | 問題 |
|-------------|------|------|
| rent_history | 查詢租金紀錄 | ❌ 沒有註冊到 api_registry<br>❌ 沒有實作 get_rent_history 方法 |

---

**維護者**: Claude Code
**日期**: 2026-01-18
**版本**: 1.0
