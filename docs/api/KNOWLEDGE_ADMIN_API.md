# çŸ¥è­˜ç®¡ç† API åƒè€ƒ

## æ¦‚è¿°
çŸ¥è­˜ç®¡ç† API æä¾›ç®¡ç†çŸ¥è­˜åº«æ¢ç›®çš„ç«¯é»ï¼ŒåŒ…æ‹¬ CRUD æ“ä½œå’Œæ¥­è€…ç‰¹å®šçš„çŸ¥è­˜ç®¡ç†ã€‚

## åŸºæœ¬è³‡è¨Š

**åŸºç¤ URLï¼š** `http://localhost:8084`

**èªè­‰ï¼š** åŸºæ–¼ JWT çš„èªè­‰

**Content-Typeï¼š** `application/json`

---

## ç›®éŒ„

- [èªè­‰](#èªè­‰)
- [çŸ¥è­˜ç®¡ç†](#çŸ¥è­˜ç®¡ç†)
- [æ¥­è€… API](#æ¥­è€…-api)
- [éŒ¯èª¤è™•ç†](#éŒ¯èª¤è™•ç†)

---

## èªè­‰

### POST /api/login

ä½¿ç”¨è€…ç™»å…¥ç«¯é»

#### è«‹æ±‚

```json
{
  "username": "admin",
  "password": "password"
}
```

#### å›æ‡‰

```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": 1,
    "username": "admin",
    "role": "admin"
  }
}
```

---

## çŸ¥è­˜ç®¡ç†

### GET /api/knowledge

å–å¾—çŸ¥è­˜åº«æ¢ç›®èˆ‡é¸æ“‡æ€§ç¯©é¸

#### æŸ¥è©¢åƒæ•¸

| åƒæ•¸ | é¡å‹ | èªªæ˜ | é è¨­å€¼ |
|-----------|------|-------------|---------|
| `page` | integer | é ç¢¼ | 1 |
| `page_size` | integer | æ¯é é …ç›®æ•¸ | 20 |
| `search` | string | æœå°‹è© | - |
| `vendor_id` | integer | æŒ‰æ¥­è€…ç¯©é¸ | - |
| `intent_id` | integer | æŒ‰æ„åœ–ç¯©é¸ | - |

#### å›æ‡‰

```json
{
  "items": [
    {
      "id": 1,
      "question": "å¦‚ä½•ç¹³ç´ç§Ÿé‡‘ï¼Ÿ",
      "answer": "ç§Ÿé‡‘å¯é€éè½‰å¸³æˆ–ç¾é‡‘ç¹³ç´",
      "vendor_id": null,
      "intent_id": 5,
      "trigger_mode": null,
      "created_at": "2026-02-09T10:00:00Z"
    }
  ],
  "total": 100,
  "page": 1,
  "page_size": 20
}
```

### POST /api/knowledge

å»ºç«‹æ–°çš„çŸ¥è­˜æ¢ç›®

#### è«‹æ±‚ä¸»é«”

| æ¬„ä½ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|-------|------|----------|-------------|
| `question` | string | âœ… | å•é¡Œæ–‡å­— |
| `answer` | string | âœ… | ç­”æ¡ˆæ–‡å­— |
| `vendor_id` | integer | âŒ | æ¥­è€… IDï¼ˆnull ç‚ºå…¨åŸŸï¼‰ |
| `intent_id` | integer | âŒ | é—œè¯çš„æ„åœ– ID |
| `trigger_mode` | string | âŒ | è§¸ç™¼æ¨¡å¼ï¼ˆnull æˆ–ç‰¹å®šæ¨¡å¼ï¼‰ |

#### è«‹æ±‚ç¯„ä¾‹

```json
{
  "question": "å¦‚ä½•ç”³è«‹çºŒç´„ï¼Ÿ",
  "answer": "è«‹åœ¨åˆç´„åˆ°æœŸå‰30å¤©æå‡ºç”³è«‹",
  "vendor_id": null,  // å…¨åŸŸçŸ¥è­˜
  "intent_id": 10,
  "trigger_mode": null
}
```

#### å›æ‡‰

```json
{
  "id": 1301,
  "message": "çŸ¥è­˜å‰µå»ºæˆåŠŸ"
}
```

### PUT /api/knowledge/{id}

æ›´æ–°ç¾æœ‰çš„çŸ¥è­˜æ¢ç›®

#### è«‹æ±‚ä¸»é«”

èˆ‡ POST /api/knowledge ç›¸åŒ

#### å›æ‡‰

```json
{
  "message": "çŸ¥è­˜æ›´æ–°æˆåŠŸ"
}
```

### DELETE /api/knowledge/{id}

åˆªé™¤çŸ¥è­˜æ¢ç›®

#### å›æ‡‰

```json
{
  "message": "çŸ¥è­˜åˆªé™¤æˆåŠŸ"
}
```

---

## æ¥­è€… API

### GET /api/vendors

å–å¾—æ‰€æœ‰æ¥­è€…åˆ—è¡¨ä»¥ä¾›çŸ¥è­˜æŒ‡æ´¾

#### èªªæ˜

è¿”å›ç³»çµ±ä¸­æ‰€æœ‰æ¥­è€…çš„åˆ—è¡¨ã€‚ä¸»è¦ç”¨æ–¼çŸ¥è­˜å‰µå»º/ç·¨è¼¯è¡¨å–®ä¸­çš„æ¥­è€…é¸æ“‡ä¸‹æ‹‰é¸å–®ã€‚

#### è«‹æ±‚

**URLï¼š** `GET /api/vendors`

**æ¨™é ­ï¼š**
```
Authorization: Bearer <token>
```

#### å›æ‡‰

**ç‹€æ…‹ï¼š** 200 OK

**ä¸»é«”ï¼š**
```json
{
  "vendors": [
    {
      "id": 1,
      "name": "æ¥­è€…A"
    },
    {
      "id": 2,
      "name": "æ¥­è€…B"
    },
    {
      "id": 3,
      "name": "æ¥­è€…C"
    }
  ]
}
```

#### å‰ç«¯ä½¿ç”¨

æ­¤ç«¯é»ç”¨æ–¼çŸ¥è­˜ç®¡ç† UI ä¸­å¡«å……æ¥­è€…é¸æ“‡ä¸‹æ‹‰é¸å–®ï¼š

```javascript
// Vue å…ƒä»¶ç¯„ä¾‹
async loadVendors() {
  try {
    const response = await axios.get('/api/vendors', {
      headers: {
        'Authorization': `Bearer ${this.token}`
      }
    });
    this.availableVendors = response.data.vendors;
  } catch (error) {
    console.error('è¼‰å…¥æ¥­è€…å¤±æ•—ï¼š', error);
  }
}
```

#### æ¥­è€…é¸æ“‡ UI

æ¥­è€…åœ¨ä¸‹æ‹‰é¸å–®ä¸­é¡¯ç¤ºï¼Œä¸¦æœ‰æ¸…æ¥šçš„è¦–è¦ºæŒ‡ç¤ºï¼š
- ğŸŒ å…¨åŸŸçŸ¥è­˜ï¼ˆvendor_id = nullï¼‰- å°æ‰€æœ‰æ¥­è€…å¯è¦‹
- ğŸ¢ æ¥­è€…å°ˆå±¬çŸ¥è­˜ï¼ˆvendor_id = idï¼‰- åƒ…å°è©²æ¥­è€…å¯è¦‹

---

## éŒ¯èª¤è™•ç†

### å¸¸è¦‹éŒ¯èª¤å›æ‡‰

#### 400 éŒ¯èª¤è«‹æ±‚
```json
{
  "detail": "ç„¡æ•ˆçš„è«‹æ±‚åƒæ•¸",
  "error_code": "INVALID_REQUEST"
}
```

#### 401 æœªæˆæ¬Š
```json
{
  "detail": "ç„¡æ•ˆæˆ–éæœŸçš„ä»¤ç‰Œ",
  "error_code": "UNAUTHORIZED"
}
```

#### 404 æ‰¾ä¸åˆ°
```json
{
  "detail": "æ‰¾ä¸åˆ°çŸ¥è­˜æ¢ç›®",
  "error_code": "NOT_FOUND"
}
```

#### 500 å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤
```json
{
  "detail": "è³‡æ–™åº«ç´„æŸé•å",
  "error_code": "DATABASE_ERROR"
}
```

### ç‰¹å®šéŒ¯èª¤æƒ…æ³

#### Trigger Mode ç´„æŸé•å
- **åŸå› **ï¼šè¨­å®š trigger_mode ç‚º 'none' è€Œé null
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šä½¿ç”¨ null å€¼è€Œé 'none'
- **éŒ¯èª¤è¨Šæ¯**ï¼šã€Œæ–°åˆ—é•åæª¢æŸ¥ç´„æŸ 'check_kb_trigger_mode'ã€

---

## é·ç§»æ³¨æ„äº‹é …

### å¾åŸºæ–¼ Scope åˆ°åŸºæ–¼ Vendor çš„é‚è¼¯

è‡ª 2026-02-09 èµ·ï¼Œç³»çµ±å·²å¾ä½¿ç”¨é›™æ¬„ä½æ–¹æ³•ï¼ˆscope + vendor_idï¼‰ç°¡åŒ–ç‚ºå–®ä¸€ vendor_id æ¬„ä½ï¼š

**èˆŠé‚è¼¯ï¼š**
- éœ€è¦æª¢æŸ¥ `scope` æ¬„ä½å’Œ `vendor_id`
- æŸ¥è©¢ä¸­çš„è¤‡é›œ WHERE å­å¥
- Scope å€¼ï¼š'global'ã€'vendor'ã€'customized'

**æ–°é‚è¼¯ï¼š**
- åƒ…æª¢æŸ¥ `vendor_id`
- `vendor_id = NULL`ï¼šå…¨åŸŸçŸ¥è­˜
- `vendor_id = <id>`ï¼šæ¥­è€…å°ˆå±¬çŸ¥è­˜

### å° API ä½¿ç”¨çš„å½±éŸ¿

1. **çŸ¥è­˜å‰µå»º/æ›´æ–°**ï¼š
   - ç›´æ¥è¨­å®š `vendor_id`
   - å¿½ç•¥ `scope` æ¬„ä½ï¼ˆç‚ºå‘å¾Œç›¸å®¹è€Œä¿ç•™ï¼‰

2. **æ¥­è€…é¸æ“‡**ï¼š
   - ä½¿ç”¨ `/api/vendors` ç«¯é»å–å¾—æ¥­è€…åˆ—è¡¨
   - ç‚ºå…¨åŸŸçŸ¥è­˜è¨­å®š `vendor_id` ç‚º null

3. **ç¯©é¸**ï¼š
   - æŸ¥è©¢è‡ªå‹•è™•ç†æ¥­è€…å¯è¦‹æ€§
   - ä¸éœ€è¦åœ¨ç¯©é¸ä¸­æŒ‡å®š scope

---

## ç›¸é—œæ–‡ä»¶

- [çŸ¥è­˜ç¯„åœç°¡åŒ–](../features/KNOWLEDGE_SCOPE_SIMPLIFICATION.md)
- [å‰ç«¯ä½¿ç”¨æŒ‡å—](../guides/FRONTEND_USAGE_GUIDE.md)
- [API åƒè€ƒç¬¬ä¸€éšæ®µ](./API_REFERENCE_PHASE1.md)