# çŸ¥è­˜åº«å‹•ä½œç³»çµ±è¨­è¨ˆæ–‡æª”

**ç‰ˆæœ¬**: 1.1
**æ—¥æœŸ**: 2026-02-03ï¼ˆæ›´æ–°ï¼‰
**ç‹€æ…‹**: å·²å¯¦ç¾
**ä½œè€…**: ç³»çµ±æ¶æ§‹åœ˜éšŠ

---

## ğŸ“‹ ç›®éŒ„

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [èƒŒæ™¯èˆ‡å•é¡Œ](#èƒŒæ™¯èˆ‡å•é¡Œ)
3. [ç³»çµ±æ¶æ§‹è¨­è¨ˆ](#ç³»çµ±æ¶æ§‹è¨­è¨ˆ)
4. [å ´æ™¯åˆ†æ](#å ´æ™¯åˆ†æ)
5. [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ)
6. [é…ç½®ç¯„ä¾‹](#é…ç½®ç¯„ä¾‹)
7. [è™•ç†é‚è¼¯](#è™•ç†é‚è¼¯)
8. [å¯¦ä½œæŒ‡å—](#å¯¦ä½œæŒ‡å—)
9. [æ¸¬è©¦å»ºè­°](#æ¸¬è©¦å»ºè­°)
10. [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)

---

## æ¦‚è¿°

### ç³»çµ±ç›®æ¨™

è¨­è¨ˆä¸€å¥—çµ±ä¸€çš„çŸ¥è­˜åº«å‹•ä½œç³»çµ±ï¼Œæ”¯æ´ä»¥ä¸‹åŠŸèƒ½çµ„åˆï¼š

- âœ… **ç´”çŸ¥è­˜å•ç­”**ï¼šç›´æ¥è¿”å› FAQ ç­”æ¡ˆ
- âœ… **è¡¨å–®å¡«å¯«**ï¼šæ”¶é›†çµæ§‹åŒ–è³‡æ–™
- âœ… **API èª¿ç”¨**ï¼šæŸ¥è©¢å¯¦æ™‚æ•¸æ“š
- âœ… **è¡¨å–® + API**ï¼šå…ˆæ”¶é›†è³‡è¨Šå†èª¿ç”¨ API
- âœ… **æ··åˆæ¨¡å¼**ï¼šçµ„åˆçŸ¥è­˜ç­”æ¡ˆèˆ‡ API çµæœ

### æ ¸å¿ƒæ¦‚å¿µ

**çŸ¥è­˜åº« = è§¸ç™¼å™¨ + è¡Œç‚ºå®šç¾© + å›æ‡‰æ¨¡æ¿**

æ¯ç­†çŸ¥è­˜å¯ä»¥å®šç¾©ï¼š
1. **è§¸ç™¼æ¢ä»¶**ï¼šç”¨æˆ¶å•ä»€éº¼å•é¡Œæ™‚è§¸ç™¼
2. **è¡Œç‚ºé¡å‹**ï¼šè§¸ç™¼å¾ŒåŸ·è¡Œä»€éº¼å‹•ä½œï¼ˆè¡¨å–®/API/ç›´æ¥å›ç­”ï¼‰
3. **å›æ‡‰æ–¹å¼**ï¼šå¦‚ä½•å‘ˆç¾çµæœçµ¦ç”¨æˆ¶

---

## èƒŒæ™¯èˆ‡å•é¡Œ

### æ¥­å‹™éœ€æ±‚

åœ¨ AI å®¢æœç³»çµ±ä¸­ï¼Œç”¨æˆ¶çš„å•é¡Œå¯ä»¥åˆ†ç‚ºä¸‰å¤§é¡ï¼š

1. **è³‡è¨ŠæŸ¥è©¢é¡**ï¼šã€Œç§Ÿé‡‘æ€éº¼ç¹³ï¼Ÿã€â†’ éœæ…‹çŸ¥è­˜ï¼Œç›´æ¥å›ç­”
2. **è³‡æ–™æ”¶é›†é¡**ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€â†’ éœ€è¦æ”¶é›†ç”¨æˆ¶è³‡è¨Š
3. **å¯¦æ™‚æŸ¥è©¢é¡**ï¼šã€Œæˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°ã€â†’ éœ€è¦æŸ¥è©¢å³æ™‚æ•¸æ“š

### å¯¦éš›æ¡ˆä¾‹ï¼šå¸³å–®æŸ¥è©¢

**å ´æ™¯ 1ï¼šå·²ç™»å…¥ç”¨æˆ¶**
```
ç”¨æˆ¶ï¼šã€Œæˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°ã€
ç³»çµ±ï¼šå·²çŸ¥ user_id â†’ ç›´æ¥èª¿ç”¨ API â†’ è¿”å›å¸³å–®ç‹€æ…‹
```

**å ´æ™¯ 2ï¼šæœªç™»å…¥ç”¨æˆ¶**
```
ç”¨æˆ¶ï¼šã€Œæˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°ã€
ç³»çµ±ï¼šéœ€è¦é©—è­‰èº«ä»½ â†’ è§¸ç™¼è¡¨å–®æ”¶é›†è³‡è¨Š â†’ èª¿ç”¨ API â†’ è¿”å›çµæœ
```

**å ´æ™¯ 3ï¼šåªæ˜¯è©¢å•æµç¨‹**
```
ç”¨æˆ¶ï¼šã€Œå¸³å–®æ€éº¼å¯„é€ï¼Ÿã€
ç³»çµ±ï¼šé€™æ˜¯ FAQ â†’ ç›´æ¥è¿”å›çŸ¥è­˜åº«ç­”æ¡ˆ
```

### å•é¡Œ

ç¾æœ‰ç³»çµ±åªæ”¯æ´ã€Œè¡¨å–®è§¸ç™¼ã€æ¨¡å¼ï¼ˆé€šé `form_id` æ¬„ä½ï¼‰ï¼Œç„¡æ³•éˆæ´»è™•ç†ã€ŒAPI èª¿ç”¨ã€æˆ–ã€Œè¡¨å–® + APIã€çµ„åˆã€‚

---

## ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### æ ¸å¿ƒæ¶æ§‹

```
ç”¨æˆ¶å•é¡Œ
    â†“
æ„åœ–åˆ†é¡
    â†“
æª¢ç´¢çŸ¥è­˜åº«ï¼ˆå‘é‡æœç´¢ + æ„åœ–éæ¿¾ï¼‰
    â†“
æª¢æŸ¥çŸ¥è­˜çš„ action_type
    â†“
æ ¹æ“š action_type åŸ·è¡Œå°æ‡‰å‹•ä½œ
    â”œâ”€ direct_answer    â†’ ç›´æ¥è¿”å›çŸ¥è­˜ç­”æ¡ˆ
    â”œâ”€ form_fill        â†’ æª¢æŸ¥ trigger_mode
    â”‚   â”œâ”€ NULL/auto   â†’ ç›´æ¥è§¸ç™¼è¡¨å–® â†’ è¿”å›çŸ¥è­˜ç­”æ¡ˆ
    â”‚   â”œâ”€ manual      â†’ é¡¯ç¤ºå…§å®¹ + ç­‰å¾…é—œéµè© â†’ è§¸ç™¼è¡¨å–®
    â”‚   â””â”€ immediate   â†’ é¡¯ç¤ºå…§å®¹ + ç«‹å³è©¢å• â†’ ç­‰å¾…é—œéµè© â†’ è§¸ç™¼è¡¨å–®
    â”œâ”€ api_call         â†’ èª¿ç”¨ API â†’ çµåˆçŸ¥è­˜ç­”æ¡ˆ
    â””â”€ form_then_api    â†’ è§¸ç™¼è¡¨å–® â†’ èª¿ç”¨ API â†’ çµåˆçŸ¥è­˜ç­”æ¡ˆ
```

### è¨­è¨ˆåŸå‰‡

1. **çµ±ä¸€å…¥å£**ï¼šæ‰€æœ‰åŠŸèƒ½éƒ½é€šéçŸ¥è­˜åº«è§¸ç™¼ï¼Œä¿æŒæ¶æ§‹ä¸€è‡´æ€§
2. **é…ç½®é©…å‹•**ï¼šè¡Œç‚ºç”±é…ç½®æ±ºå®šï¼Œä¸éœ€è¦ä¿®æ”¹ç¨‹å¼ç¢¼
3. **å¯çµ„åˆæ€§**ï¼šè¡¨å–®ã€APIã€çŸ¥è­˜ç­”æ¡ˆå¯éˆæ´»çµ„åˆ
4. **å‘å¾Œå…¼å®¹**ï¼šä¿æŒèˆ‡ç¾æœ‰è¡¨å–®ç³»çµ±çš„å…¼å®¹æ€§

---

## å ´æ™¯åˆ†æ

### å ´æ™¯çŸ©é™£

| å ´æ™¯ | è¡¨å–® | API | çŸ¥è­˜ç­”æ¡ˆ | action_type | ç¯„ä¾‹ |
|-----|------|-----|---------|-------------|------|
| **A** | âŒ | âŒ | âœ… | `direct_answer` | ã€Œå¦‚ä½•ç¹³ç´ç§Ÿé‡‘ã€ |
| **B** | âœ… | âŒ | âœ… | `form_fill` | ã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€ |
| **C** | âŒ | âœ… | âœ… | `api_call` | ã€Œæˆ‘çš„å¸³å–®ã€ï¼ˆå·²ç™»å…¥ï¼‰|
| **D** | âœ… | âœ… | âœ… | `form_then_api` | ã€Œæˆ‘çš„å¸³å–®ã€ï¼ˆæœªç™»å…¥ï¼‰|
| **E** | âœ… | âœ… | âŒ | `form_then_api` | ã€Œæˆ‘è¦å ±ä¿®ã€|
| **F** | âŒ | âœ… | âŒ | `api_call` | ã€ŒæŸ¥è©¢ç¹³è²»è¨˜éŒ„ã€|

### å ´æ™¯ Aï¼šç´”çŸ¥è­˜å•ç­”

**ç”¨æˆ¶å•é¡Œ**ï¼šã€Œç§Ÿé‡‘æ€éº¼ç¹³ï¼Ÿã€

**æµç¨‹**ï¼š
```
æª¢ç´¢çŸ¥è­˜åº« â†’ action_type = "direct_answer" â†’ ç›´æ¥è¿”å›ç­”æ¡ˆ
```

**é…ç½®**ï¼š
```json
{
  "question_summary": "å¦‚ä½•ç¹³ç´ç§Ÿé‡‘",
  "answer": "ç§Ÿé‡‘ç¹³ç´æ–¹å¼ï¼š\n1. ç·šä¸Šä¿¡ç”¨å¡\n2. ATMè½‰å¸³\n3. è¶…å•†ç¹³è²»",
  "action_type": "direct_answer"
}
```

---

### å ´æ™¯ Bï¼šè¡¨å–® + çŸ¥è­˜

**ç”¨æˆ¶å•é¡Œ**ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€

**æµç¨‹**ï¼š
```
æª¢ç´¢çŸ¥è­˜åº« â†’ action_type = "form_fill" â†’ è§¸ç™¼è¡¨å–® â†’ æ”¶é›†è³‡æ–™ â†’ è¿”å›çŸ¥è­˜ç­”æ¡ˆ
```

**é…ç½®**ï¼š
```json
{
  "question_summary": "ç§Ÿæˆ¿ç”³è«‹",
  "answer": "æ„Ÿè¬æ‚¨çš„ç”³è«‹ï¼æˆ‘å€‘æœƒåœ¨ 24 å°æ™‚å…§èˆ‡æ‚¨è¯ç¹«ã€‚",
  "action_type": "form_fill",
  "form_id": "rental_application"
}
```

**å°è©±ç¯„ä¾‹**ï¼š
```
ç”¨æˆ¶ï¼šã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€
AIï¼šã€Œå¥½çš„ï¼è«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼šã€
AIï¼šã€Œè«‹æä¾›æ‚¨çš„å§“åï¼šã€
ç”¨æˆ¶ï¼šã€Œç‹å°æ˜ã€
AIï¼šã€Œè«‹æä¾›æ‚¨çš„é›»è©±ï¼šã€
ç”¨æˆ¶ï¼šã€Œ0912345678ã€
AIï¼šã€Œè«‹æä¾›æ‚¨çš„é ç®—ï¼šã€
ç”¨æˆ¶ï¼šã€Œ20000ã€
AIï¼šã€Œâœ… è¡¨å–®å¡«å¯«å®Œæˆï¼
     æ„Ÿè¬æ‚¨çš„ç”³è«‹ï¼æˆ‘å€‘æœƒåœ¨ 24 å°æ™‚å…§èˆ‡æ‚¨è¯ç¹«ã€‚ã€
```

---

### å ´æ™¯ Cï¼šAPI + çŸ¥è­˜ï¼ˆå·²ç™»å…¥ç”¨æˆ¶ï¼‰

**ç”¨æˆ¶å•é¡Œ**ï¼šã€Œæˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°ã€ï¼ˆå·²ç™»å…¥ï¼‰

**æµç¨‹**ï¼š
```
æª¢ç´¢çŸ¥è­˜åº« â†’ action_type = "api_call"
    â†’ æª¢æŸ¥åƒæ•¸ï¼ˆuser_id å¾ session å–å¾—ï¼‰
    â†’ èª¿ç”¨ API
    â†’ çµåˆçŸ¥è­˜ç­”æ¡ˆè¿”å›
```

**é…ç½®**ï¼š
```json
{
  "question_summary": "å¸³å–®æŸ¥è©¢ï¼ˆå·²ç™»å…¥ï¼‰",
  "answer": "å¦‚ä»æœªæ”¶åˆ°ï¼Œå»ºè­°æª¢æŸ¥åƒåœ¾éƒµä»¶æˆ–è¯ç¹«å®¢æœ {{service_hotline}}ã€‚",
  "action_type": "api_call",
  "api_config": {
    "endpoint": "billing_inquiry",
    "params": {
      "user_id": "{session.user_id}",
      "month": "{user_input.month}"
    },
    "combine_with_knowledge": true,
    "response_template": "æŸ¥è©¢çµæœï¼š\n{api_response}\n\n{knowledge_answer}"
  }
}
```

**å°è©±ç¯„ä¾‹**ï¼š
```
ç”¨æˆ¶ï¼šã€Œæˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°ã€
AIï¼šã€ŒæŸ¥è©¢ä¸­...ã€ï¼ˆèª¿ç”¨ APIï¼‰
AIï¼šã€ŒæŸ¥è©¢çµæœï¼š
     ğŸ“„ å¸³å–®ç·¨è™Ÿï¼šINV-2026-01-001
     ğŸ’° é‡‘é¡ï¼š$15,000
     ğŸ“… åˆ°æœŸæ—¥ï¼š2026-01-05

     å¯„é€ç‹€æ…‹ï¼šâœ… å·²å¯„é€
     å¯„é€æ™‚é–“ï¼š01/01 10:00
     å¯„é€ä¿¡ç®±ï¼šuser_***@example.com

     å¦‚ä»æœªæ”¶åˆ°ï¼Œå»ºè­°æª¢æŸ¥åƒåœ¾éƒµä»¶æˆ–è¯ç¹«å®¢æœ 02-1234-5678ã€‚ã€
```

---

### å ´æ™¯ Dï¼šè¡¨å–® + API + çŸ¥è­˜ï¼ˆæœªç™»å…¥ç”¨æˆ¶ï¼‰

**ç”¨æˆ¶å•é¡Œ**ï¼šã€Œæˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°ã€ï¼ˆæœªç™»å…¥ï¼‰

**æµç¨‹**ï¼š
```
æª¢ç´¢çŸ¥è­˜åº« â†’ action_type = "form_then_api"
    â†’ è§¸ç™¼è¡¨å–®æ”¶é›†èº«ä»½è³‡è¨Š
    â†’ è¡¨å–®å®Œæˆå¾Œè‡ªå‹•èª¿ç”¨ API
    â†’ çµåˆçŸ¥è­˜ç­”æ¡ˆè¿”å›
```

**é…ç½®**ï¼š
```json
{
  "question_summary": "å¸³å–®æŸ¥è©¢ï¼ˆæœªç™»å…¥ï¼‰",
  "answer": "å¦‚ä»æœªæ”¶åˆ°ï¼Œå»ºè­°æª¢æŸ¥åƒåœ¾éƒµä»¶æˆ–è¯ç¹«å®¢æœã€‚",
  "action_type": "form_then_api",
  "form_id": "billing_inquiry_guest",
  "api_config": {
    "endpoint": "billing_inquiry",
    "verify_identity_first": true,
    "params_from_form": {
      "user_id": "tenant_id",
      "month": "inquiry_month"
    },
    "verification_params": {
      "tenant_id": "tenant_id",
      "id_last_4": "verification_code"
    },
    "combine_with_knowledge": true
  }
}
```

**å°è©±ç¯„ä¾‹**ï¼š
```
ç”¨æˆ¶ï¼šã€Œæˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°ã€
AIï¼šã€Œç‚ºäº†ä¿è­·æ‚¨çš„éš±ç§ï¼Œéœ€è¦é©—è­‰èº«ä»½ã€‚ã€
AIï¼šã€Œè«‹æä¾›ç§Ÿå®¢ç·¨è™Ÿï¼šã€
ç”¨æˆ¶ï¼šã€ŒT12345ã€
AIï¼šã€Œè«‹æä¾›èº«ä»½è­‰å¾Œ4ç¢¼ï¼šã€
ç”¨æˆ¶ï¼šã€Œ1234ã€
AIï¼šã€ŒæŸ¥è©¢å“ªå€‹æœˆä»½çš„å¸³å–®ï¼Ÿï¼ˆä¾‹å¦‚ï¼š2026-01ï¼‰ã€
ç”¨æˆ¶ï¼šã€Œ2026-01ã€
AIï¼šã€Œé©—è­‰ä¸­...ã€ï¼ˆé©—è­‰èº«ä»½ APIï¼‰
AIï¼šã€Œâœ… èº«ä»½é©—è­‰é€šéï¼ã€ï¼ˆèª¿ç”¨å¸³å–®æŸ¥è©¢ APIï¼‰
AIï¼šã€ŒæŸ¥è©¢çµæœï¼š
     ğŸ“„ å¸³å–®ç·¨è™Ÿï¼šINV-2026-01-001
     ğŸ’° é‡‘é¡ï¼š$15,000
     ...

     å¦‚ä»æœªæ”¶åˆ°ï¼Œå»ºè­°æª¢æŸ¥åƒåœ¾éƒµä»¶æˆ–è¯ç¹«å®¢æœã€‚ã€
```

---

### å ´æ™¯ Eï¼šè¡¨å–® + APIï¼ˆä¸éœ€è¦çŸ¥è­˜ç­”æ¡ˆï¼‰

**ç”¨æˆ¶å•é¡Œ**ï¼šã€Œæˆ‘è¦å ±ä¿®ã€

**æµç¨‹**ï¼š
```
æª¢ç´¢çŸ¥è­˜åº« â†’ action_type = "form_then_api"
    â†’ è§¸ç™¼è¡¨å–®æ”¶é›†å ±ä¿®è³‡è¨Š
    â†’ è¡¨å–®å®Œæˆå¾Œèª¿ç”¨å ±ä¿®æäº¤ API
    â†’ åªè¿”å› API çµæœï¼ˆä¸çµåˆçŸ¥è­˜ç­”æ¡ˆï¼‰
```

**é…ç½®**ï¼š
```json
{
  "question_summary": "å ±ä¿®ç”³è«‹",
  "answer": null,
  "action_type": "form_then_api",
  "form_id": "repair_request",
  "api_config": {
    "endpoint": "repair_submit",
    "params_from_form": {
      "user_id": "session.user_id",
      "item": "repair_item",
      "description": "description",
      "urgency": "urgency"
    },
    "combine_with_knowledge": false,
    "response_template": "âœ… å ±ä¿®ç”³è«‹å·²æäº¤ï¼\n\nğŸ”§ å ±ä¿®å–®è™Ÿï¼š{ticket_id}\nğŸ“… é è¨ˆè™•ç†æ™‚é–“ï¼š{estimated_time}\nğŸ“ å¦‚æœ‰ç–‘å•è«‹æ’¥ï¼š{{service_hotline}}"
  }
}
```

**å°è©±ç¯„ä¾‹**ï¼š
```
ç”¨æˆ¶ï¼šã€Œæˆ‘è¦å ±ä¿®ã€
AIï¼šã€Œè«‹æä¾›å ±ä¿®é …ç›®ï¼šã€
ç”¨æˆ¶ï¼šã€Œå†·æ°£ä¸å†·ã€
AIï¼šã€Œè«‹æè¿°å•é¡Œï¼šã€
ç”¨æˆ¶ï¼šã€Œå†·æ°£é–‹äº†ä½†å®Œå…¨ä¸å†·ï¼Œå¯èƒ½å£æ‰äº†ã€
AIï¼šã€Œè«‹é¸æ“‡ç·Šæ€¥ç¨‹åº¦ï¼š[ä¸€èˆ¬] [ç·Šæ€¥] [éå¸¸ç·Šæ€¥]ã€
ç”¨æˆ¶ï¼šã€Œç·Šæ€¥ã€
AIï¼šã€Œâœ… å ±ä¿®ç”³è«‹å·²æäº¤ï¼

     ğŸ”§ å ±ä¿®å–®è™Ÿï¼šR-2026-001
     ğŸ“… é è¨ˆè™•ç†æ™‚é–“ï¼š24å°æ™‚å…§
     ğŸ“ å¦‚æœ‰ç–‘å•è«‹æ’¥ï¼š02-1234-5678ã€
```

---

### å ´æ™¯ Fï¼šç´” APIï¼ˆä¸éœ€è¦çŸ¥è­˜ç­”æ¡ˆï¼‰

**ç”¨æˆ¶å•é¡Œ**ï¼šã€ŒæŸ¥è©¢æˆ‘çš„ç¹³è²»è¨˜éŒ„ã€

**æµç¨‹**ï¼š
```
æª¢ç´¢çŸ¥è­˜åº« â†’ action_type = "api_call"
    â†’ èª¿ç”¨ API
    â†’ åªè¿”å› API çµæœï¼ˆæ ¼å¼åŒ–çš„åˆ—è¡¨ï¼‰
```

**é…ç½®**ï¼š
```json
{
  "question_summary": "ç¹³è²»è¨˜éŒ„æŸ¥è©¢",
  "answer": null,
  "action_type": "api_call",
  "api_config": {
    "endpoint": "payment_history",
    "params": {
      "user_id": "{session.user_id}",
      "limit": "10"
    },
    "combine_with_knowledge": false,
    "response_template": "ğŸ“‹ **æ‚¨çš„ç¹³è²»è¨˜éŒ„**\n\n{formatted_history}"
  }
}
```

---

## è³‡æ–™åº«è¨­è¨ˆ

### knowledge_base è¡¨æ“´å±•

```sql
-- æ·»åŠ æ¬„ä½
ALTER TABLE knowledge_base
ADD COLUMN IF NOT EXISTS action_type VARCHAR(50) DEFAULT 'direct_answer',
ADD COLUMN IF NOT EXISTS api_config JSONB;

-- æ·»åŠ è¨»è§£
COMMENT ON COLUMN knowledge_base.action_type IS '
è¡Œç‚ºé¡å‹ï¼š
- direct_answer: ç´”çŸ¥è­˜å•ç­”
- form_fill: è§¸ç™¼è¡¨å–®å¡«å¯«
- api_call: èª¿ç”¨ API
- form_then_api: å…ˆè¡¨å–®å¾Œ API
';

COMMENT ON COLUMN knowledge_base.api_config IS '
API é…ç½® (JSON):
{
  "endpoint": "billing_inquiry",          // API ç«¯é»
  "params": {...},                        // API åƒæ•¸æ˜ å°„
  "verify_identity_first": true,          // æ˜¯å¦å…ˆé©—è­‰èº«ä»½
  "verification_params": {...},           // é©—è­‰åƒæ•¸æ˜ å°„
  "combine_with_knowledge": true,         // æ˜¯å¦çµåˆçŸ¥è­˜ç­”æ¡ˆ
  "response_template": "...",             // å›æ‡‰æ¨¡æ¿
  "fallback_message": "..."               // å¤±æ•—é™ç´šè¨Šæ¯
}
';

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_kb_action_type ON knowledge_base(action_type);
CREATE INDEX idx_kb_api_endpoint ON knowledge_base((api_config->>'endpoint'));
```

### form_schemas è¡¨æ“´å±•

```sql
-- æ·»åŠ æ¬„ä½ï¼ˆæ”¯æ´è¡¨å–®å®Œæˆå¾Œèª¿ç”¨ APIï¼‰
ALTER TABLE form_schemas
ADD COLUMN IF NOT EXISTS on_complete_action VARCHAR(50) DEFAULT 'show_knowledge',
ADD COLUMN IF NOT EXISTS api_config JSONB;

COMMENT ON COLUMN form_schemas.on_complete_action IS '
è¡¨å–®å®Œæˆå¾Œçš„å‹•ä½œï¼š
- show_knowledge: é¡¯ç¤ºçŸ¥è­˜åº«ç­”æ¡ˆ
- call_api: èª¿ç”¨ API
- both: å…©è€…éƒ½åŸ·è¡Œ
';

COMMENT ON COLUMN form_schemas.api_config IS '
è¡¨å–®å®Œæˆå¾Œèª¿ç”¨çš„ API é…ç½® (JSON):
{
  "endpoint": "billing_inquiry",
  "param_mapping": {
    "user_id": "tenant_id",              // è¡¨å–®æ¬„ä½ â†’ API åƒæ•¸
    "month": "inquiry_month"
  },
  "verify_identity_first": true,
  "verification_params": {...},
  "response_template": "..."
}
';
```

### å®Œæ•´çš„ api_config çµæ§‹

```json
{
  // === åŸºæœ¬é…ç½® ===
  "endpoint": "billing_inquiry",          // API ç«¯é»åç¨±

  // === åƒæ•¸é…ç½® ===
  "params": {
    "user_id": "{session.user_id}",      // å¾ session å–å¾—
    "month": "{form.inquiry_month}",     // å¾è¡¨å–®å–å¾—
    "vendor_id": "{vendor.id}"           // å¾æ¥­è€…é…ç½®å–å¾—
  },

  // === æˆ–ï¼šå¾è¡¨å–®æ˜ å°„åƒæ•¸ ===
  "params_from_form": {
    "user_id": "tenant_id",              // è¡¨å–®æ¬„ä½å â†’ API åƒæ•¸å
    "month": "inquiry_month"
  },

  // === èº«ä»½é©—è­‰é…ç½® ===
  "verify_identity_first": true,         // æ˜¯å¦å…ˆé©—è­‰èº«ä»½
  "verification_params": {
    "tenant_id": "tenant_id",
    "id_last_4": "verification_code"
  },

  // === å›æ‡‰é…ç½® ===
  "combine_with_knowledge": true,        // æ˜¯å¦çµåˆçŸ¥è­˜ç­”æ¡ˆ
  "response_template": "æŸ¥è©¢çµæœï¼š\n{api_response}\n\n{knowledge_answer}",
  "fallback_message": "ç›®å‰ç„¡æ³•æŸ¥è©¢ï¼Œ{knowledge_answer}",

  // === æ¢ä»¶é…ç½® ===
  "skip_if": "user.is_logged_in",        // æ¢ä»¶è·³éï¼ˆå¯é¸ï¼‰
  "required_role": "tenant"              // æ¬Šé™è¦æ±‚ï¼ˆå¯é¸ï¼‰
}
```

---

## é…ç½®ç¯„ä¾‹

### ç¯„ä¾‹ 1ï¼šå¸³å–®æŸ¥è©¢ï¼ˆå·²ç™»å…¥ï¼‰

```sql
INSERT INTO knowledge_base (
    question_summary,
    answer,
    action_type,
    api_config,
    scope,
    is_active
) VALUES (
    'å¸³å–®å¯„é€ç‹€æ…‹æŸ¥è©¢ï¼ˆå·²ç™»å…¥ï¼‰',
    'å¦‚ä»æœªæ”¶åˆ°ï¼Œå»ºè­°æª¢æŸ¥åƒåœ¾éƒµä»¶æˆ–è¯ç¹«å®¢æœ {{service_hotline}}ã€‚',
    'api_call',
    '{
        "endpoint": "billing_inquiry",
        "params": {
            "user_id": "{session.user_id}",
            "month": "{user_input.month}"
        },
        "combine_with_knowledge": true,
        "response_template": "æŸ¥è©¢çµæœï¼š\n\n{api_response}\n\n{knowledge_answer}",
        "fallback_message": "ç›®å‰ç„¡æ³•æŸ¥è©¢å¸³å–®ç‹€æ…‹ã€‚\n\n{knowledge_answer}"
    }'::jsonb,
    'global',
    true
);
```

### ç¯„ä¾‹ 2ï¼šå¸³å–®æŸ¥è©¢ï¼ˆæœªç™»å…¥ï¼‰- çŸ¥è­˜åº«é…ç½®

```sql
INSERT INTO knowledge_base (
    question_summary,
    answer,
    action_type,
    form_id,
    api_config,
    scope,
    is_active
) VALUES (
    'å¸³å–®å¯„é€ç‹€æ…‹æŸ¥è©¢ï¼ˆæœªç™»å…¥ï¼‰',
    'å¦‚ä»æœªæ”¶åˆ°ï¼Œå»ºè­°æª¢æŸ¥åƒåœ¾éƒµä»¶æˆ–è¯ç¹«å®¢æœã€‚',
    'form_then_api',
    'billing_inquiry_guest',
    '{
        "endpoint": "billing_inquiry",
        "verify_identity_first": true,
        "verification_params": {
            "tenant_id": "tenant_id",
            "id_last_4": "verification_code"
        },
        "params_from_form": {
            "user_id": "tenant_id",
            "month": "inquiry_month"
        },
        "combine_with_knowledge": true,
        "response_template": "âœ… èº«ä»½é©—è­‰é€šéï¼\n\næŸ¥è©¢çµæœï¼š\n{api_response}\n\n{knowledge_answer}"
    }'::jsonb,
    'global',
    true
);
```

### ç¯„ä¾‹ 2ï¼šå¸³å–®æŸ¥è©¢ï¼ˆæœªç™»å…¥ï¼‰- è¡¨å–®é…ç½®

```sql
INSERT INTO form_schemas (
    form_id,
    form_name,
    description,
    fields,
    trigger_intents,
    on_complete_action,
    api_config,
    is_active
) VALUES (
    'billing_inquiry_guest',
    'å¸³å–®æŸ¥è©¢ï¼ˆè¨ªå®¢ï¼‰',
    'æœªç™»å…¥ç”¨æˆ¶æŸ¥è©¢å¸³å–®æ™‚çš„èº«ä»½é©—è­‰è¡¨å–®',
    '[
        {
            "name": "tenant_id",
            "label": "ç§Ÿå®¢ç·¨è™Ÿï¼ˆåˆç´„ä¸Šçš„ç·¨è™Ÿï¼‰",
            "type": "text",
            "required": true,
            "validation": {
                "pattern": "^T\\d+$",
                "message": "è«‹è¼¸å…¥æ­£ç¢ºçš„ç§Ÿå®¢ç·¨è™Ÿæ ¼å¼ï¼ˆä¾‹å¦‚ï¼šT12345ï¼‰"
            }
        },
        {
            "name": "verification_code",
            "label": "èº«ä»½è­‰å¾Œ4ç¢¼",
            "type": "text",
            "required": true,
            "validation": {
                "pattern": "^\\d{4}$",
                "message": "è«‹è¼¸å…¥4ä½æ•¸å­—"
            }
        },
        {
            "name": "inquiry_month",
            "label": "æŸ¥è©¢æœˆä»½ï¼ˆä¾‹å¦‚ï¼š2026-01ï¼‰",
            "type": "text",
            "required": true,
            "validation": {
                "pattern": "^\\d{4}-\\d{2}$",
                "message": "è«‹è¼¸å…¥æ­£ç¢ºçš„æœˆä»½æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š2026-01ï¼‰"
            }
        }
    ]'::jsonb,
    '["å¸³å–®æŸ¥è©¢"]'::jsonb,
    'call_api',
    '{
        "endpoint": "billing_inquiry",
        "verify_identity_first": true,
        "verification_params": {
            "tenant_id": "tenant_id",
            "id_last_4": "verification_code"
        },
        "param_mapping": {
            "user_id": "tenant_id",
            "month": "inquiry_month"
        },
        "combine_with_knowledge": true,
        "response_template": "âœ… èº«ä»½é©—è­‰é€šéï¼\n\n{api_response}\n\n{knowledge_answer}",
        "fallback_message": "é©—è­‰å¤±æ•—æˆ–ç„¡æ³•æŸ¥è©¢ã€‚\n\n{knowledge_answer}"
    }'::jsonb,
    true
);
```

### ç¯„ä¾‹ 3ï¼šå ±ä¿®ç”³è«‹

```sql
INSERT INTO knowledge_base (
    question_summary,
    answer,
    action_type,
    form_id,
    api_config,
    scope,
    is_active
) VALUES (
    'å ±ä¿®ç”³è«‹',
    null,
    'form_then_api',
    'repair_request',
    '{
        "endpoint": "repair_submit",
        "params_from_form": {
            "user_id": "session.user_id",
            "item": "repair_item",
            "description": "description",
            "urgency": "urgency"
        },
        "combine_with_knowledge": false,
        "response_template": "âœ… å ±ä¿®ç”³è«‹å·²æäº¤ï¼\n\nğŸ”§ å ±ä¿®å–®è™Ÿï¼š{ticket_id}\nğŸ“… é è¨ˆè™•ç†æ™‚é–“ï¼š{estimated_time}\nğŸ“ å¦‚æœ‰ç–‘å•è«‹æ’¥ï¼š{{service_hotline}}"
    }'::jsonb,
    'global',
    true
);
```

---

## è™•ç†é‚è¼¯

### ä¸»è¦æµç¨‹ï¼ˆchat.pyï¼‰

```python
async def _build_knowledge_response(
    request: VendorChatRequest,
    req: Request,
    intent_result: dict,
    knowledge_list: list,
    resolver,
    vendor_info: dict,
    cache_service
) -> VendorChatResponse:
    """ä½¿ç”¨çŸ¥è­˜åº«çµæœæ§‹å»ºå„ªåŒ–å›æ‡‰"""

    if not knowledge_list:
        return await _handle_no_knowledge_found(...)

    best_knowledge = knowledge_list[0]
    action_type = best_knowledge.get('action_type', 'direct_answer')

    # === æ±ºç­–æ¨¹ ===

    if action_type == 'direct_answer':
        # å ´æ™¯ Aï¼šç´”çŸ¥è­˜å•ç­”
        return await _build_simple_answer(
            best_knowledge, request, intent_result
        )

    elif action_type == 'form_fill':
        # å ´æ™¯ Bï¼šè§¸ç™¼è¡¨å–®
        form_id = best_knowledge.get('form_id')
        if not form_id:
            raise ValueError(f"Knowledge {best_knowledge['id']} has action_type=form_fill but no form_id")

        return await _trigger_form(
            form_id=form_id,
            knowledge_id=best_knowledge['id'],
            request=request,
            req=req
        )

    elif action_type == 'api_call':
        # å ´æ™¯ C/Fï¼šç›´æ¥èª¿ç”¨ API
        api_config = best_knowledge.get('api_config')
        if not api_config:
            raise ValueError(f"Knowledge {best_knowledge['id']} has action_type=api_call but no api_config")

        # æª¢æŸ¥åƒæ•¸æ˜¯å¦é½Šå…¨
        params_check = await _check_api_params(api_config, request)

        if not params_check['all_ready']:
            # ç¼ºå°‘åƒæ•¸ â†’ è©¢å•ç”¨æˆ¶æˆ–è§¸ç™¼è¡¨å–®
            if api_config.get('use_form_for_params'):
                return await _trigger_form(
                    form_id=api_config['form_id'],
                    knowledge_id=best_knowledge['id'],
                    request=request,
                    req=req
                )
            else:
                return _ask_missing_params(
                    params_check['missing'],
                    request,
                    intent_result
                )

        # åƒæ•¸é½Šå…¨ â†’ èª¿ç”¨ API
        api_result = await _call_api(api_config, params_check['params'], request)

        # æ ¼å¼åŒ–å›æ‡‰
        combine_knowledge = api_config.get('combine_with_knowledge', True)
        if combine_knowledge and best_knowledge.get('answer'):
            return _format_api_with_knowledge(
                api_result, best_knowledge, api_config, request, intent_result
            )
        else:
            return _format_api_only(
                api_result, api_config, request, intent_result
            )

    elif action_type == 'form_then_api':
        # å ´æ™¯ D/Eï¼šå…ˆè¡¨å–®å¾Œ API
        form_id = best_knowledge.get('form_id')
        if not form_id:
            raise ValueError(f"Knowledge {best_knowledge['id']} has action_type=form_then_api but no form_id")

        # è§¸ç™¼è¡¨å–®ï¼ˆè¡¨å–®å®Œæˆå¾Œæœƒè‡ªå‹•èª¿ç”¨ APIï¼‰
        return await _trigger_form_with_api(
            form_id=form_id,
            knowledge_id=best_knowledge['id'],
            api_config=best_knowledge.get('api_config'),
            request=request,
            req=req
        )

    else:
        raise ValueError(f"Unknown action_type: {action_type}")
```

### æ±ºç­–æ¨¹åœ–ç¤º

```
ç”¨æˆ¶å•é¡Œ
    â†“
æ„åœ–åˆ†é¡
    â†“
æª¢ç´¢çŸ¥è­˜åº«
    â†“
æª¢æŸ¥ action_type
    â†“
    â”œâ”€ direct_answer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç›´æ¥è¿”å›çŸ¥è­˜ç­”æ¡ˆ
    â”‚
    â”œâ”€ form_fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è§¸ç™¼è¡¨å–®
    â”‚                              â†“
    â”‚                          è¡¨å–®å®Œæˆ
    â”‚                              â†“
    â”‚                          è¿”å›çŸ¥è­˜ç­”æ¡ˆ
    â”‚
    â”œâ”€ api_call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æª¢æŸ¥åƒæ•¸
    â”‚                              â”œâ”€ åƒæ•¸ä¸è¶³ â†’ è©¢å•ç”¨æˆ¶æˆ–è§¸ç™¼è¡¨å–®
    â”‚                              â””â”€ åƒæ•¸é½Šå…¨ â†’ èª¿ç”¨ API
    â”‚                                             â†“
    â”‚                                         æˆåŠŸ/å¤±æ•—
    â”‚                                             â†“
    â”‚                                         æ ¼å¼åŒ–å›æ‡‰
    â”‚                                             â”œâ”€ combine=true â†’ APIçµæœ + çŸ¥è­˜ç­”æ¡ˆ
    â”‚                                             â””â”€ combine=false â†’ åªè¿”å› API çµæœ
    â”‚
    â””â”€ form_then_api â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è§¸ç™¼è¡¨å–®
                                   â†“
                               è¡¨å–®å®Œæˆ
                                   â†“
                               èª¿ç”¨ APIï¼ˆè‡ªå‹•å¾è¡¨å–®å–åƒæ•¸ï¼‰
                                   â†“
                               æ ¼å¼åŒ–å›æ‡‰
```

---

## å¯¦ä½œæŒ‡å—

### Phase 1ï¼šè³‡æ–™åº«æº–å‚™ï¼ˆ30 åˆ†é˜ï¼‰

```sql
-- Step 1: æ·»åŠ æ¬„ä½
ALTER TABLE knowledge_base
ADD COLUMN IF NOT EXISTS action_type VARCHAR(50) DEFAULT 'direct_answer',
ADD COLUMN IF NOT EXISTS api_config JSONB;

ALTER TABLE form_schemas
ADD COLUMN IF NOT EXISTS on_complete_action VARCHAR(50) DEFAULT 'show_knowledge',
ADD COLUMN IF NOT EXISTS api_config JSONB;

-- Step 2: æ·»åŠ ç´¢å¼•
CREATE INDEX idx_kb_action_type ON knowledge_base(action_type);
CREATE INDEX idx_kb_api_endpoint ON knowledge_base((api_config->>'endpoint'));

-- Step 3: æ›´æ–°ç¾æœ‰çŸ¥è­˜çš„ action_type
UPDATE knowledge_base
SET action_type = 'form_fill'
WHERE form_id IS NOT NULL;

UPDATE knowledge_base
SET action_type = 'direct_answer'
WHERE form_id IS NULL AND action_type IS NULL;
```

### Phase 2ï¼šå‰µå»º API æœå‹™ï¼ˆ1-2 å¤©ï¼‰

**æª”æ¡ˆçµæ§‹**ï¼š
```
rag-orchestrator/services/
â”œâ”€â”€ billing_api.py          # å¸³å–®æŸ¥è©¢ API æœå‹™
â”œâ”€â”€ api_call_handler.py     # çµ±ä¸€çš„ API èª¿ç”¨è™•ç†å™¨
â””â”€â”€ form_manager.py         # ä¿®æ”¹ï¼šæ·»åŠ è¡¨å–®å®Œæˆå¾Œèª¿ç”¨ API
```

**billing_api.py**ï¼š
```python
"""
å¸³å–®æŸ¥è©¢ API æœå‹™
æ•´åˆ JGB ä¸»ç³»çµ±çš„å¸³å–®æŸ¥è©¢åŠŸèƒ½
"""
import httpx
import os
from typing import Optional, Dict

class BillingAPIService:
    def __init__(self):
        self.base_url = os.getenv("JGB_BILLING_API_URL")
        self.api_key = os.getenv("JGB_BILLING_API_KEY")
        self.timeout = 10.0

    async def get_invoice_status(
        self,
        user_id: str,
        month: Optional[str] = None,
        requester_role: str = 'tenant'
    ) -> Dict:
        """æŸ¥è©¢å¸³å–®ç‹€æ…‹"""
        # å¯¦ä½œé‚è¼¯...
        pass

    async def verify_tenant_identity(
        self,
        tenant_id: str,
        id_last_4: str
    ) -> Dict:
        """é©—è­‰ç§Ÿå®¢èº«ä»½"""
        # å¯¦ä½œé‚è¼¯...
        pass
```

### Phase 3ï¼šä¿®æ”¹è™•ç†é‚è¼¯ï¼ˆ2-3 å¤©ï¼‰

**ä¿®æ”¹ chat.py**ï¼š
1. åœ¨ `_build_knowledge_response` æ·»åŠ  action_type æª¢æŸ¥
2. å¯¦ä½œå„ç¨® action_type çš„è™•ç†é‚è¼¯
3. æ·»åŠ åƒæ•¸æª¢æŸ¥èˆ‡æ”¶é›†æ©Ÿåˆ¶

**ä¿®æ”¹ form_manager.py**ï¼š
1. åœ¨ `_complete_form` æ·»åŠ  API èª¿ç”¨é‚è¼¯
2. å¯¦ä½œ `_execute_form_api` æ–¹æ³•
3. å¯¦ä½œ `_verify_user_identity` æ–¹æ³•
4. å¯¦ä½œ `_format_completion_message` æ–¹æ³•

### Phase 4ï¼šæ¸¬è©¦èˆ‡é©—è­‰ï¼ˆ1-2 å¤©ï¼‰

**æ¸¬è©¦æ¡ˆä¾‹**ï¼š
1. å ´æ™¯ Aï¼šç´”çŸ¥è­˜å•ç­”
2. å ´æ™¯ Bï¼šè¡¨å–®å¡«å¯«
3. å ´æ™¯ Cï¼šå·²ç™»å…¥ç”¨æˆ¶ API æŸ¥è©¢
4. å ´æ™¯ Dï¼šæœªç™»å…¥ç”¨æˆ¶è¡¨å–® + API
5. å ´æ™¯ Eï¼šå ±ä¿®ç”³è«‹ï¼ˆè¡¨å–® + APIï¼Œç„¡çŸ¥è­˜ç­”æ¡ˆï¼‰
6. API å¤±æ•—é™ç´šæ¸¬è©¦
7. åƒæ•¸é©—è­‰æ¸¬è©¦

---

## æ¸¬è©¦å»ºè­°

### å–®å…ƒæ¸¬è©¦

```python
# tests/test_action_system.py

import pytest
from services.api_call_handler import APICallHandler

@pytest.mark.asyncio
async def test_direct_answer():
    """æ¸¬è©¦å ´æ™¯ Aï¼šç´”çŸ¥è­˜å•ç­”"""
    knowledge = {
        "action_type": "direct_answer",
        "answer": "ç§Ÿé‡‘ç¹³ç´æ–¹å¼ï¼š..."
    }
    result = await handle_knowledge(knowledge)
    assert result['answer'] == knowledge['answer']

@pytest.mark.asyncio
async def test_api_call_with_params():
    """æ¸¬è©¦å ´æ™¯ Cï¼šAPI èª¿ç”¨ï¼ˆåƒæ•¸é½Šå…¨ï¼‰"""
    knowledge = {
        "action_type": "api_call",
        "api_config": {
            "endpoint": "billing_inquiry",
            "params": {"user_id": "T12345"}
        }
    }
    result = await handle_knowledge(knowledge)
    assert 'api_response' in result

@pytest.mark.asyncio
async def test_form_then_api():
    """æ¸¬è©¦å ´æ™¯ Dï¼šè¡¨å–® + API"""
    # æ¨¡æ“¬è¡¨å–®å®Œæˆ
    form_data = {
        "tenant_id": "T12345",
        "verification_code": "1234",
        "inquiry_month": "2026-01"
    }
    result = await complete_form_with_api(form_data)
    assert result['form_completed'] == True
    assert 'api_result' in result
```

### é›†æˆæ¸¬è©¦

```python
# tests/integration/test_billing_inquiry.py

@pytest.mark.asyncio
async def test_billing_inquiry_logged_in():
    """æ¸¬è©¦ï¼šå·²ç™»å…¥ç”¨æˆ¶æŸ¥è©¢å¸³å–®"""
    response = await client.post("/api/v1/message", json={
        "message": "æˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°",
        "vendor_id": 1,
        "user_id": "T12345",
        "session_id": "test_session"
    })
    assert response.status_code == 200
    data = response.json()
    assert "å¸³å–®ç·¨è™Ÿ" in data['answer']
    assert data['debug_info']['processing_path'] == 'api_call'

@pytest.mark.asyncio
async def test_billing_inquiry_guest():
    """æ¸¬è©¦ï¼šæœªç™»å…¥ç”¨æˆ¶æŸ¥è©¢å¸³å–®ï¼ˆè§¸ç™¼è¡¨å–®ï¼‰"""
    # ç¬¬ä¸€è¼ªï¼šè§¸ç™¼è¡¨å–®
    response1 = await client.post("/api/v1/message", json={
        "message": "æˆ‘çš„å¸³å–®æ€éº¼æ²’æ”¶åˆ°",
        "vendor_id": 1,
        "session_id": "test_session"
    })
    assert "è«‹æä¾›ç§Ÿå®¢ç·¨è™Ÿ" in response1.json()['answer']

    # ç¬¬äºŒè¼ªï¼šæä¾›ç§Ÿå®¢ç·¨è™Ÿ
    response2 = await client.post("/api/v1/message", json={
        "message": "T12345",
        "vendor_id": 1,
        "session_id": "test_session"
    })
    assert "èº«ä»½è­‰å¾Œ4ç¢¼" in response2.json()['answer']

    # ... ç¹¼çºŒå¡«å¯«è¡¨å–®
```

### æ‰‹å‹•æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] å ´æ™¯ Aï¼šè©¢å•ã€Œç§Ÿé‡‘æ€éº¼ç¹³ã€â†’ ç›´æ¥è¿”å› FAQ
- [ ] å ´æ™¯ Bï¼šè©¢å•ã€Œæˆ‘æƒ³ç§Ÿæˆ¿å­ã€â†’ è§¸ç™¼è¡¨å–® â†’ è¿”å›çŸ¥è­˜ç­”æ¡ˆ
- [ ] å ´æ™¯ Cï¼šå·²ç™»å…¥ç”¨æˆ¶è©¢å•ã€Œæˆ‘çš„å¸³å–®ã€â†’ èª¿ç”¨ API â†’ è¿”å›çµæœ + çŸ¥è­˜ç­”æ¡ˆ
- [ ] å ´æ™¯ Dï¼šæœªç™»å…¥ç”¨æˆ¶è©¢å•ã€Œæˆ‘çš„å¸³å–®ã€â†’ è§¸ç™¼è¡¨å–® â†’ èª¿ç”¨ API â†’ è¿”å›çµæœ
- [ ] å ´æ™¯ Eï¼šè©¢å•ã€Œæˆ‘è¦å ±ä¿®ã€â†’ è§¸ç™¼è¡¨å–® â†’ èª¿ç”¨ API â†’ åªè¿”å› API çµæœ
- [ ] API å¤±æ•—æ™‚é¡¯ç¤ºé™ç´šè¨Šæ¯
- [ ] ç¼ºå°‘åƒæ•¸æ™‚æ­£ç¢ºè©¢å•ç”¨æˆ¶
- [ ] èº«ä»½é©—è­‰å¤±æ•—æ™‚æ­£ç¢ºæç¤º

---

## æœ€ä½³å¯¦è¸

### 1. é…ç½®å‘½åè¦ç¯„

**çŸ¥è­˜åº«å‘½å**ï¼š
- æ ¼å¼ï¼š`{åŠŸèƒ½}ï¼ˆ{æ¢ä»¶}ï¼‰`
- ç¯„ä¾‹ï¼š
  - `å¸³å–®æŸ¥è©¢ï¼ˆå·²ç™»å…¥ï¼‰`
  - `å¸³å–®æŸ¥è©¢ï¼ˆæœªç™»å…¥ï¼‰`
  - `å ±ä¿®ç”³è«‹`

**è¡¨å–® ID å‘½å**ï¼š
- æ ¼å¼ï¼š`{åŠŸèƒ½}_{è§’è‰²}`
- ç¯„ä¾‹ï¼š
  - `billing_inquiry_guest`ï¼ˆè¨ªå®¢å¸³å–®æŸ¥è©¢ï¼‰
  - `repair_request`ï¼ˆå ±ä¿®ç”³è«‹ï¼‰
  - `rental_application`ï¼ˆç§Ÿæˆ¿ç”³è«‹ï¼‰

### 2. API ç«¯é»å‘½å

**å»ºè­°ä½¿ç”¨èªç¾©åŒ–å‘½å**ï¼š
- `billing_inquiry` - å¸³å–®æŸ¥è©¢
- `repair_submit` - å ±ä¿®æäº¤
- `contract_info` - åˆç´„è³‡è¨ŠæŸ¥è©¢
- `payment_history` - ç¹³è²»è¨˜éŒ„æŸ¥è©¢

### 3. éŒ¯èª¤è™•ç†

**API èª¿ç”¨å¤±æ•—æ™‚çš„é™ç´šç­–ç•¥**ï¼š

```json
{
  "api_config": {
    "endpoint": "billing_inquiry",
    "fallback_message": "ç›®å‰ç„¡æ³•æŸ¥è©¢å¸³å–®ç‹€æ…‹ã€‚\n\nå»ºè­°ï¼š\n1. æª¢æŸ¥åƒåœ¾éƒµä»¶å¤¾\n2. è¯ç¹«å®¢æœ {{service_hotline}}\n\n{knowledge_answer}"
  }
}
```

**è¡¨å–®é©—è­‰å¤±æ•—**ï¼š
- æä¾›æ¸…æ¥šçš„éŒ¯èª¤è¨Šæ¯
- å…è¨±ç”¨æˆ¶é‡æ–°è¼¸å…¥
- è¨˜éŒ„é©—è­‰å¤±æ•—æ¬¡æ•¸ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰

### 4. å®‰å…¨æ€§è€ƒé‡

**èº«ä»½é©—è­‰**ï¼š
```json
{
  "api_config": {
    "verify_identity_first": true,
    "verification_params": {
      "tenant_id": "tenant_id",
      "id_last_4": "verification_code"
    }
  }
}
```

**æ•æ„Ÿè³‡è¨Šé®ç½©**ï¼š
- Emailï¼š`user_***@example.com`
- æ‰‹æ©Ÿï¼š`0912***678`
- èº«ä»½è­‰ï¼šåªè¦æ±‚å¾Œ 4 ç¢¼

**é »ç‡é™åˆ¶**ï¼š
- é™åˆ¶æ¯å€‹ session 10 åˆ†é˜å…§æœ€å¤šæŸ¥è©¢ 10 æ¬¡
- èº«ä»½é©—è­‰å¤±æ•— 3 æ¬¡å¾Œé–å®š 1 å°æ™‚

### 5. ç›£æ§èˆ‡æ—¥èªŒ

**é—œéµæŒ‡æ¨™**ï¼š
- API èª¿ç”¨æˆåŠŸç‡
- å¹³å‡å›æ‡‰æ™‚é–“
- è¡¨å–®å®Œæˆç‡
- ç”¨æˆ¶æ»¿æ„åº¦

**æ—¥èªŒè¨˜éŒ„**ï¼š
```python
# è¨˜éŒ„ API èª¿ç”¨
logger.info(f"API Call: endpoint={endpoint}, user={user_id}, result={result['status']}")

# è¨˜éŒ„è¡¨å–®å®Œæˆ
logger.info(f"Form Completed: form_id={form_id}, user={user_id}, api_called={api_called}")
```

### 6. æ€§èƒ½å„ªåŒ–

**ç·©å­˜ç­–ç•¥**ï¼š
- å·²ç™»å…¥ç”¨æˆ¶çš„å¸³å–®ç‹€æ…‹ç·©å­˜ 5 åˆ†é˜
- API é…ç½®ç·©å­˜ 1 å°æ™‚
- çŸ¥è­˜åº«æª¢ç´¢çµæœç·©å­˜ 10 åˆ†é˜

**ç•°æ­¥è™•ç†**ï¼š
- API èª¿ç”¨ä½¿ç”¨ç•°æ­¥ httpx
- å¤šå€‹ API èª¿ç”¨æ™‚ä¸¦è¡Œè™•ç†
- è¶…æ™‚è¨­å®šï¼š10 ç§’

---

## é™„éŒ„

### A. å®Œæ•´çš„ action_type æšèˆ‰

```sql
CREATE TYPE action_type_enum AS ENUM (
    'direct_answer',      -- ç´”çŸ¥è­˜å•ç­”
    'form_fill',          -- è§¸ç™¼è¡¨å–®å¡«å¯«
    'api_call',           -- èª¿ç”¨ API
    'form_then_api'       -- å…ˆè¡¨å–®å¾Œ API
);
```

### B. API ç«¯é»æ¸…å–®

| ç«¯é»åç¨± | åŠŸèƒ½ | åƒæ•¸ | å›æ‡‰ |
|---------|------|------|------|
| `billing_inquiry` | å¸³å–®æŸ¥è©¢ | user_id, month | å¸³å–®è©³æƒ… |
| `auth/verify_tenant` | ç§Ÿå®¢èº«ä»½é©—è­‰ | tenant_id, id_last_4 | é©—è­‰çµæœ |
| `repair_submit` | å ±ä¿®æäº¤ | user_id, item, description | å ±ä¿®å–®è™Ÿ |
| `payment_history` | ç¹³è²»è¨˜éŒ„ | user_id, limit | ç¹³è²»åˆ—è¡¨ |
| `contract_info` | åˆç´„è³‡è¨Š | user_id | åˆç´„è©³æƒ… |

### C. å¸¸è¦‹å•é¡Œ (FAQ)

**Q1ï¼šå¦‚ä½•æ±ºå®šä½¿ç”¨ `api_call` é‚„æ˜¯ `form_then_api`ï¼Ÿ**

Aï¼šæ ¹æ“šæ˜¯å¦éœ€è¦æ”¶é›†åƒæ•¸æ±ºå®šï¼š
- å·²ç™»å…¥ç”¨æˆ¶ï¼Œåƒæ•¸å¾ session å–å¾— â†’ `api_call`
- æœªç™»å…¥ç”¨æˆ¶ï¼Œéœ€è¦æ”¶é›†èº«ä»½è³‡è¨Š â†’ `form_then_api`

**Q2ï¼š`combine_with_knowledge` è¨­ç‚º true é‚„æ˜¯ falseï¼Ÿ**

Aï¼š
- å¦‚æœçŸ¥è­˜ç­”æ¡ˆæœ‰è£œå……è³‡è¨Šï¼ˆFAQã€æ³¨æ„äº‹é …ï¼‰â†’ `true`
- å¦‚æœåªéœ€è¦ API çµæœï¼ˆå¦‚å ±ä¿®å–®è™Ÿï¼‰â†’ `false`

**Q3ï¼šå¦‚ä½•è™•ç† API å¤±æ•—ï¼Ÿ**

Aï¼šé…ç½® `fallback_message`ï¼Œç³»çµ±æœƒè‡ªå‹•é™ç´šé¡¯ç¤ºè©²è¨Šæ¯ã€‚

**Q4ï¼šå¯ä»¥åœ¨è¡¨å–®ä¸­é–“èª¿ç”¨ API å—ï¼Ÿ**

Aï¼šç›®å‰ä¸æ”¯æ´ã€‚API èª¿ç”¨åªèƒ½åœ¨è¡¨å–®å®Œæˆå¾Œè§¸ç™¼ã€‚

**Q5ï¼šå¦‚ä½•æ”¯æ´å¤šæ­¥é©Ÿ API èª¿ç”¨ï¼ˆå¦‚å…ˆé©—è­‰å†æŸ¥è©¢ï¼‰ï¼Ÿ**

Aï¼šä½¿ç”¨ `verify_identity_first: true` é…ç½®ï¼Œç³»çµ±æœƒè‡ªå‹•å…ˆèª¿ç”¨é©—è­‰ APIã€‚

---

## è®Šæ›´æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è®Šæ›´å…§å®¹ |
|-----|------|------|---------|
| 1.1 | 2026-02-03 | ç³»çµ±æ¶æ§‹åœ˜éšŠ | å¯¦ç¾ trigger_mode æ”¯æ´ï¼ˆmanual, immediate, autoï¼‰ï¼Œçµ±ä¸€çŸ¥è­˜åº«èˆ‡ SOP è§¸ç™¼æ©Ÿåˆ¶ |
| 1.0 | 2026-01-16 | ç³»çµ±æ¶æ§‹åœ˜éšŠ | åˆå§‹ç‰ˆæœ¬ |

---

## ç›¸é—œæ–‡æª”

- [çŸ¥è­˜åº«è¡¨å–®è§¸ç™¼æ¨¡å¼å¯¦ç¾](../features/KNOWLEDGE_FORM_TRIGGER_IMPLEMENTATION.md) - **NEW**
- [SOP ç³»çµ±å®Œæ•´æŒ‡å—](../guides/SOP_GUIDE.md)
- [è¡¨å–®ç®¡ç†ç³»çµ±](./FORM_MANAGEMENT_SYSTEM.md)
- [API åƒè€ƒæ–‡æª”](../api/API_REFERENCE_PHASE1.md)
- [è³‡æ–™åº« Schema](../architecture/DATABASE_SCHEMA.md)
- [çŸ¥è­˜åº«ç®¡ç†æŒ‡å—](../guides/KNOWLEDGE_MANAGEMENT.md)

---

**æ–‡æª”çµæŸ**
