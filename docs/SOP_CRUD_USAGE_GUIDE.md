# SOP 介面CRUD 完整使用指南

> ✅ **最新更新**: 2025-10-18 - 已實現完整的 SOP CRUD 功能（Create, Read, Update, Delete）

---

## 🎯 功能總覽

現在您可以**完全在介面上**管理 SOP，無需編寫 SQL！

### 已實現的功能

| 功能 | 狀態 | 說明 |
|------|------|------|
| ✅ **Create (新增)** | 完成 | 新增 SOP 分類和項目 |
| ✅ **Read (讀取)** | 完成 | 查看所有 SOP 分類和項目 |
| ✅ **Update (編輯)** | 完成 | 編輯 SOP 項目內容 |
| ✅ **Delete (刪除)** | 完成 | 刪除 SOP 項目（軟刪除）|

---

## 📍 訪問路徑

1. 訪問管理介面：`http://localhost:8080`
2. 點擊左側選單「業者管理」
3. 選擇一個業者，點擊「配置」按鈕
4. 點擊頂部標籤「📋 SOP 管理」

**完整路徑**: `http://localhost:8080/#/vendors/1/configs` → 點擊「SOP 管理」標籤

---

## 🚀 使用步驟

### 1️⃣ 新增 SOP 分類

**場景**: 當您需要新增一個全新的 SOP 類別時（如：寵物飼養規定、停車管理等）

**步驟**:
1. 在 SOP 管理介面，點擊「➕ 新增分類」按鈕
2. 填寫表單：
   - **分類名稱** *（必填）: 例如「寵物飼養規定」
   - **分類說明**: 例如「寵物飼養許可、限制、費用、押金、責任與違規處理」
   - **顯示順序**: 數字越小越靠前，預設為 0
3. 點擊「✅ 建立分類」
4. 系統會立即顯示新建立的分類

**範例**:
```
分類名稱: 寵物飼養規定
分類說明: 寵物飼養許可、限制、費用、押金、責任與違規處理
顯示順序: 11
```

---

### 2️⃣ 新增 SOP 項目

**場景**: 在已有的分類下新增具體的 SOP 項目

**步驟**:
1. 點擊「➕ 新增項目」按鈕
2. 填寫表單：

#### 基本資訊
- **選擇分類** *（必填）: 從下拉選單選擇分類
- **項次編號** *（必填）: 建議按順序 1, 2, 3...
- **優先級**: 0-100，數字越大優先級越高（預設 50）
- **項目名稱** *（必填）: 例如「是否允許飼養寵物」

#### 內容類型選擇

**情況 A: 非金流敏感項目**（物業規定、設備說明等）

勾選「☐ 金流敏感項目」= **不勾選**

- **項目內容** *（必填）: 填寫統一的 SOP 內容

**範例**:
```
項目名稱: 是否允許飼養寵物
項目內容: 本物業允許房客飼養寵物，但需遵守以下規定：
1️⃣ 事前申請：需事前提出書面申請並獲得公司同意
2️⃣ 寵物限制：僅限小型犬貓，體重不超過10公斤
3️⃣ 押金繳納：需額外繳交寵物押金NT$5,000元
4️⃣ 遵守規範：須遵守社區寵物管理規範
```

**情況 B: 金流敏感項目**（租金繳納、押金、收據等）

勾選「☑ 金流敏感項目」= **勾選**

需分別填寫兩個版本：

- **💼 包租型版本（金流過我家）** *（必填）
  - 語氣：主動服務、公司負責
  - 關鍵詞：「公司」「我們會」「主動通知」「系統自動」

- **🤝 代管型版本（金流不過我家）** *（必填）
  - 語氣：協助引導、房東負責
  - 關鍵詞：「房東」「請您」「建議」「協助」

**範例**:
```
項目名稱: 寵物押金如何繳納

包租型版本:
登入 JGB 系統查看公司收款帳號，寵物押金NT$5,000元可透過以下方式繳納：
- 銀行轉帳：轉入指定公司帳戶
- 信用卡支付：系統線上刷卡
系統會在收款後主動發送確認通知。

代管型版本:
請向房東索取收款帳號，寵物押金NT$5,000元建議使用銀行轉帳並留存交易記錄。
JGB 系統僅提供繳款提醒服務，實際收款由房東負責。
```

#### 關聯設定
- **關聯意圖**: 選擇相關意圖（如「寵物飼養」），提升檢索精準度

3. 點擊「✅ 建立項目」
4. 系統會立即顯示新建立的項目

---

### 3️⃣ 編輯 SOP 項目

**場景**: 修改已存在的 SOP 項目內容

**步驟**:
1. 找到要編輯的項目，點擊「✏️ 編輯」按鈕
2. 修改任何欄位（項目名稱、內容、金流版本、關聯意圖等）
3. 點擊「💾 儲存」

**特色功能**:
- **金流版本對比**: 編輯金流敏感項目時，會即時顯示兩個版本的對比
- **內容一致性檢查**: 如果兩個版本內容相同，系統會警告您

---

### 4️⃣ 刪除 SOP 項目

**場景**: 移除不需要的 SOP 項目

**步驟**:
1. 找到要刪除的項目，點擊「🗑️ 刪除」按鈕
2. 確認刪除操作
3. 項目會立即從列表中移除

**注意**:
- 刪除是**軟刪除**（`is_active = FALSE`），資料不會真正被刪除
- 如需恢復，可以使用 SQL 直接修改資料庫

---

## 💡 使用技巧

### 技巧 1: 快速建立完整 SOP

如果需要為新業者建立完整的 SOP：

1. **先建立分類**（例如：租賃流程、租金繳費、維護修繕等）
2. **逐一新增項目**（每個分類下新增相關項目）
3. **使用複製功能**（如果多個業者 SOP 相似，可以使用 SQL 範本複製）

### 技巧 2: 金流版本撰寫建議

| 金流模式 | 語氣特色 | 常用詞彙 |
|---------|---------|---------|
| **包租型（金流過我家）** | 主動、負責、確認 | 「公司將」「我們會」「主動通知」「系統自動」「確保」 |
| **代管型（金流不過我家）** | 協助、建議、引導 | 「房東」「請您」「建議」「可協助」「提供參考」 |

**範例對比**:

❌ **錯誤**（兩個版本內容相同）:
```
包租型: 請繳納押金NT$5,000元
代管型: 請繳納押金NT$5,000元  ← 內容相同，無法體現差異
```

✅ **正確**（體現金流模式差異）:
```
包租型: 登入 JGB 系統繳納押金NT$5,000元，公司會開立收據並專戶保管
代管型: 請向房東繳納押金NT$5,000元並索取收據，JGB 可提供押金保管建議
```

### 技巧 3: 優先級設定策略

```
100: 核心問題（如：租金如何繳納、是否允許養寵物）
90:  重要補充（如：押金退還方式）
70:  一般規範（如：寵物飼養規範）
50:  細節說明（如：違規處理）
```

### 技巧 4: 項次編號規劃

建議每個分類從 1 開始編號，例如：

```
寵物飼養規定
  #1 是否允許飼養寵物
  #2 寵物押金如何繳納
  #3 寵物飼養規範
  #4 寵物造成損壞如何處理
  #5 寵物押金退還方式
  #6 哪些寵物不允許飼養
```

---

## 🔍 介面操作總覽

### SOP 管理介面功能鈕

| 按鈕 | 功能 | 說明 |
|------|------|------|
| **➕ 新增分類** | 建立新 SOP 分類 | 開啟分類建立 Modal |
| **➕ 新增項目** | 建立新 SOP 項目 | 開啟項目建立 Modal |
| **🔄 重新載入** | 刷新 SOP 資料 | 從伺服器重新載入最新資料 |
| **🔀 對比金流版本** | 檢查版本差異 | 分析金流敏感項目的版本一致性 |

### 每個 SOP 項目操作鈕

| 按鈕 | 功能 | 說明 |
|------|------|------|
| **✏️ 編輯** | 編輯項目 | 開啟編輯 Modal |
| **🗑️ 刪除** | 刪除項目 | 軟刪除（需確認）|

### 徽章說明

| 徽章 | 含義 |
|------|------|
| **🔄 金流敏感** | 此項目需根據金流模式區分內容 |
| **🎯 意圖名稱** | 關聯的意圖（有助於檢索） |
| **#編號** | 項次編號 |

---

## 🐛 疑難排解

### Q1: 點擊「新增項目」沒有反應？

**原因**: 還沒有建立任何 SOP 分類

**解決**: 先點擊「新增分類」建立至少一個分類

---

### Q2: 提示「金流敏感項目必須填寫兩個版本」？

**原因**: 勾選了「金流敏感項目」但沒有填寫兩個版本的內容

**解決**: 確保同時填寫「包租型版本」和「代管型版本」的內容

---

### Q3: 刪除後能恢復嗎？

**答案**: 可以，這是軟刪除（`is_active = FALSE`）

**恢復方法**:
```sql
UPDATE vendor_sop_items
SET is_active = TRUE
WHERE id = <項目ID>;
```

---

### Q4: 如何批次新增多個 SOP？

**方法 1**: 在介面上逐一新增（適合少量）

**方法 2**: 使用 SQL 腳本批次新增（適合大量）
- 參考: `docs/SOP_ADDITION_GUIDE.md`
- 範本: `scripts/sop_templates.sql`
- 範例: `scripts/add_pet_policy_sop.sql`

---

## 📊 後端 API 說明（開發者參考）

### 新增的 API 端點

#### 1. 建立 SOP 分類

```http
POST /api/v1/vendors/{vendor_id}/sop/categories
Content-Type: application/json

{
  "category_name": "寵物飼養規定",
  "description": "寵物飼養許可、限制、費用、押金、責任與違規處理",
  "display_order": 11
}
```

#### 2. 建立 SOP 項目

```http
POST /api/v1/vendors/{vendor_id}/sop/items
Content-Type: application/json

{
  "category_id": 123,
  "item_number": 1,
  "item_name": "是否允許飼養寵物",
  "content": "本物業允許...",
  "requires_cashflow_check": false,
  "cashflow_through_company": null,
  "cashflow_direct_to_landlord": null,
  "related_intent_id": 15,
  "priority": 100
}
```

#### 3. 刪除 SOP 項目

```http
DELETE /api/v1/vendors/{vendor_id}/sop/items/{item_id}
```

**回應**:
```json
{
  "message": "SOP 項目已刪除",
  "vendor_id": 1,
  "item_id": 456
}
```

---

## ✅ 功能清單

- [x] SOP 分類新增（介面 + API）
- [x] SOP 項目新增（介面 + API）
- [x] SOP 項目編輯（介面 + API）
- [x] SOP 項目刪除（介面 + API）
- [x] 金流版本對比檢查
- [x] 表單驗證（必填欄位、金流版本完整性）
- [x] 即時資料更新（新增/編輯/刪除後立即顯示）
- [x] 使用者友善提示（成功/失敗訊息）

---

## 🎉 總結

現在您可以**完全在介面上管理 SOP**，享受以下優勢：

✅ **視覺化操作** - 無需編寫 SQL，點擊即可完成
✅ **即時預覽** - 新增/編輯後立即看到效果
✅ **智慧驗證** - 自動檢查必填欄位和金流版本完整性
✅ **版本對比** - 編輯時即時對比金流版本差異
✅ **安全刪除** - 軟刪除機制，可恢復誤刪資料

開始使用吧！訪問 `http://localhost:8080/#/vendors/1/configs` 開始管理您的 SOP！

---

**文檔版本**: 1.0
**建立日期**: 2025-10-18
**維護者**: AI Chatbot Team
